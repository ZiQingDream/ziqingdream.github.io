<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ROS2 Action详解</title>
    <link href="/2025/04/15/-1-%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%80%E6%9C%AF%E6%A0%88/-1-ROS2%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/-1-ROS2-Humble%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/%E3%80%903%E3%80%91ROS2%20Action%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/04/15/-1-%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%80%E6%9C%AF%E6%A0%88/-1-ROS2%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/-1-ROS2-Humble%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/%E3%80%903%E3%80%91ROS2%20Action%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<div class="note note-success">            <p>本文由 ZiQingDream 编写，未经允许禁止转载。</p><p>本文作者：工程课代表[B站] &#x2F; ZiQingDream[Github]</p>          </div><p>在《ROS2 Executor详解》文章中，我们理解了调度器怎么处理回调和回调组。在《ROS2 Service详解》文章中，我们解释了同步、异步服务操作流程和底层细节。本文将分析ROS2动作服务器架构，以阐述动作服务器复杂的回调、反馈、中断等操作。<br>由于动作服务器本质上是“服务+话题”综合体，之前对于回调、服务等机制，这里就不再赘述，仅结合Action的场景，重点关注动作服务器的回调流程。</p><div class="note note-success">            <p>阅读本文需要你有一定ROS2基本理解，至少要有关于动作服务器基础知识。</p>          </div><h1 id="动作服务器"><a href="#动作服务器" class="headerlink" title="动作服务器"></a>动作服务器</h1><h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;example_interfaces/action/fibonacci.hpp&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp/rclcpp.hpp&quot;</span></span><br><span class="hljs-comment">// TODO(jacobperron): Remove this once it is included as part of &#x27;rclcpp.hpp&#x27;</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp_action/rclcpp_action.hpp&quot;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MinimalActionServer</span> : <span class="hljs-keyword">public</span> rclcpp::Node<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">// 类型重命名，可以有效减少代码长度</span><br>  <span class="hljs-keyword">using</span> Fibonacci = example_interfaces::action::Fibonacci;<br>  <span class="hljs-keyword">using</span> GoalHandleFibonacci = rclcpp_action::ServerGoalHandle&lt;Fibonacci&gt;;<br><br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">MinimalActionServer</span><span class="hljs-params">(<span class="hljs-type">const</span> rclcpp::NodeOptions &amp; options = rclcpp::NodeOptions())</span></span><br><span class="hljs-function">  : Node(<span class="hljs-string">&quot;minimal_action_server&quot;</span>, options)</span><br><span class="hljs-function">  &#123;</span><br>    <span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std::placeholders;<br>    <span class="hljs-comment">// 创建动作服务器服务端：</span><br>    <span class="hljs-comment">// 包含有三个回调：handle_goal用于处理请求到达回调</span><br>    <span class="hljs-comment">//              handle_cancel用于处理取消的回调</span><br>    <span class="hljs-comment">//              handle_accepted用于处理请求被接收回调</span><br>    <span class="hljs-keyword">this</span>-&gt;action_server_ = rclcpp_action::<span class="hljs-built_in">create_server</span>&lt;Fibonacci&gt;(<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_base_interface</span>(),<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_clock_interface</span>(),<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_logging_interface</span>(),<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_waitables_interface</span>(),<br>      <span class="hljs-string">&quot;fibonacci&quot;</span>,<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionServer::handle_goal, <span class="hljs-keyword">this</span>, _1, _2),<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionServer::handle_cancel, <span class="hljs-keyword">this</span>, _1),<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionServer::handle_accepted, <span class="hljs-keyword">this</span>, _1));<br>  &#125;<br><br><span class="hljs-keyword">private</span>:<br>  rclcpp_action::Server&lt;Fibonacci&gt;::SharedPtr action_server_;<br><br>  <span class="hljs-function">rclcpp_action::GoalResponse <span class="hljs-title">handle_goal</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> rclcpp_action::GoalUUID &amp; uuid,</span></span><br><span class="hljs-params"><span class="hljs-function">    std::shared_ptr&lt;<span class="hljs-type">const</span> Fibonacci::Goal&gt; goal)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Received goal request with order %d&quot;</span>, goal-&gt;order);<br>    (<span class="hljs-type">void</span>)uuid;<br>    <span class="hljs-comment">// 拒绝9000以上的计算</span><br>    <span class="hljs-keyword">if</span> (goal-&gt;order &gt; <span class="hljs-number">9000</span>) &#123;<br>      <span class="hljs-keyword">return</span> rclcpp_action::GoalResponse::REJECT;<br>    &#125;<br>    <span class="hljs-keyword">return</span> rclcpp_action::GoalResponse::ACCEPT_AND_EXECUTE;<br>  &#125;<br><br>  <span class="hljs-function">rclcpp_action::CancelResponse <span class="hljs-title">handle_cancel</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::shared_ptr&lt;GoalHandleFibonacci&gt; goal_handle)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-comment">// cancel不做任何处理</span><br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Received request to cancel goal&quot;</span>);<br>    (<span class="hljs-type">void</span>)goal_handle;<br>    <span class="hljs-keyword">return</span> rclcpp_action::CancelResponse::ACCEPT;<br>  &#125;<br><br>  <span class="hljs-comment">// 异步执行流程</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(<span class="hljs-type">const</span> std::shared_ptr&lt;GoalHandleFibonacci&gt; goal_handle)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Executing goal&quot;</span>);<br>    <span class="hljs-function">rclcpp::Rate <span class="hljs-title">loop_rate</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span>;<br><br>    <span class="hljs-comment">// 首先获取goal、feedback</span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> goal = goal_handle-&gt;<span class="hljs-built_in">get_goal</span>();<br>    <span class="hljs-keyword">auto</span> feedback = std::<span class="hljs-built_in">make_shared</span>&lt;Fibonacci::Feedback&gt;();<br>    <span class="hljs-keyword">auto</span> &amp; sequence = feedback-&gt;sequence;<br>    sequence.<span class="hljs-built_in">push_back</span>(<span class="hljs-number">0</span>);<br>    sequence.<span class="hljs-built_in">push_back</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">auto</span> result = std::<span class="hljs-built_in">make_shared</span>&lt;Fibonacci::Result&gt;();<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; (i &lt; goal-&gt;order) &amp;&amp; rclcpp::<span class="hljs-built_in">ok</span>(); ++i) &#123;<br>      <span class="hljs-comment">// 检查是否需要取消，执行取消流程，并反馈已经取消完成</span><br>      <span class="hljs-keyword">if</span> (goal_handle-&gt;<span class="hljs-built_in">is_canceling</span>()) &#123;<br>        result-&gt;sequence = sequence;<br>        goal_handle-&gt;<span class="hljs-built_in">canceled</span>(result);<br>        <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Goal Canceled&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>      <span class="hljs-comment">// Update sequence</span><br>      sequence.<span class="hljs-built_in">push_back</span>(sequence[i] + sequence[i - <span class="hljs-number">1</span>]);<br>      <span class="hljs-comment">// 发布feedback（这个可以不断进行）</span><br>      goal_handle-&gt;<span class="hljs-built_in">publish_feedback</span>(feedback);<br>      <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Publish Feedback&quot;</span>);<br><br>      loop_rate.<span class="hljs-built_in">sleep</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// 成功，反馈最后结果</span><br>    <span class="hljs-keyword">if</span> (rclcpp::<span class="hljs-built_in">ok</span>()) &#123;<br>      result-&gt;sequence = sequence;<br>      goal_handle-&gt;<span class="hljs-built_in">succeed</span>(result);<br>      <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Goal Succeeded&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_accepted</span><span class="hljs-params">(<span class="hljs-type">const</span> std::shared_ptr&lt;GoalHandleFibonacci&gt; goal_handle)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std::placeholders;<br>    <span class="hljs-comment">// 接收不能阻塞，这里直接通过新建一个线程，异步处理计算过程（这个过程可能会很耗时）</span><br>    std::thread&#123;std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionServer::execute, <span class="hljs-keyword">this</span>, _1), goal_handle&#125;.<span class="hljs-built_in">detach</span>();<br>  &#125;<br>&#125;;  <span class="hljs-comment">// class MinimalActionServer</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">init</span>(argc, argv);<br><br>  <span class="hljs-keyword">auto</span> action_server = std::<span class="hljs-built_in">make_shared</span>&lt;MinimalActionServer&gt;();<br><br>  rclcpp::<span class="hljs-built_in">spin</span>(action_server);<br><br>  rclcpp::<span class="hljs-built_in">shutdown</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cinttypes&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;future&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;example_interfaces/action/fibonacci.hpp&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp/rclcpp.hpp&quot;</span></span><br><span class="hljs-comment">// TODO(jacobperron): Remove this once it is included as part of &#x27;rclcpp.hpp&#x27;</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp_action/rclcpp_action.hpp&quot;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MinimalActionClient</span> : <span class="hljs-keyword">public</span> rclcpp::Node<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-keyword">using</span> Fibonacci = example_interfaces::action::Fibonacci;<br>  <span class="hljs-keyword">using</span> GoalHandleFibonacci = rclcpp_action::ClientGoalHandle&lt;Fibonacci&gt;;<br><br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">MinimalActionClient</span><span class="hljs-params">(<span class="hljs-type">const</span> rclcpp::NodeOptions &amp; node_options = rclcpp::NodeOptions())</span></span><br><span class="hljs-function">  : Node(<span class="hljs-string">&quot;minimal_action_client&quot;</span>, node_options), goal_done_(false)</span><br><span class="hljs-function">  &#123;</span><br>    <span class="hljs-comment">// 创建客户端</span><br>    <span class="hljs-keyword">this</span>-&gt;client_ptr_ = rclcpp_action::<span class="hljs-built_in">create_client</span>&lt;Fibonacci&gt;(<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_base_interface</span>(),<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_graph_interface</span>(),<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_logging_interface</span>(),<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_waitables_interface</span>(),<br>      <span class="hljs-string">&quot;fibonacci&quot;</span>);<br><br>    <span class="hljs-keyword">this</span>-&gt;timer_ = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_wall_timer</span>(<br>      std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">500</span>),<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::send_goal, <span class="hljs-keyword">this</span>));<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">is_goal_done</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>-&gt;goal_done_;<br>  &#125;<br><br>  <span class="hljs-comment">// 定时回调函数，每隔500ms，由于会取消定时器，其实只执行了一次</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">send_goal</span><span class="hljs-params">()</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std::placeholders;<br><br>    <span class="hljs-keyword">this</span>-&gt;timer_-&gt;<span class="hljs-built_in">cancel</span>();<br><br>    <span class="hljs-keyword">this</span>-&gt;goal_done_ = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>-&gt;client_ptr_) &#123;<br>      <span class="hljs-built_in">RCLCPP_ERROR</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Action client not initialized&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 等待动作服务被建立</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>-&gt;client_ptr_-&gt;<span class="hljs-built_in">wait_for_action_server</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">10</span>))) &#123;<br>      <span class="hljs-built_in">RCLCPP_ERROR</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Action server not available after waiting&quot;</span>);<br>      <span class="hljs-keyword">this</span>-&gt;goal_done_ = <span class="hljs-literal">true</span>;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 建立计算目标</span><br>    <span class="hljs-keyword">auto</span> goal_msg = Fibonacci::<span class="hljs-built_in">Goal</span>();<br>    goal_msg.order = <span class="hljs-number">10</span>;<br><br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Sending goal&quot;</span>);<br><br>    <span class="hljs-comment">// 执行异步发送，注意这里并没有处理future，直接通过回调处理：</span><br>    <span class="hljs-comment">// 1. goal_response_callback 目标被接受或拒绝的反馈</span><br>    <span class="hljs-comment">// 2. feedback_callback 不断反馈中间结果的反馈</span><br>    <span class="hljs-comment">// 3. result_callback 结果反馈</span><br>    <span class="hljs-keyword">auto</span> send_goal_options = rclcpp_action::Client&lt;Fibonacci&gt;::<span class="hljs-built_in">SendGoalOptions</span>();<br>    send_goal_options.goal_response_callback =<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::goal_response_callback, <span class="hljs-keyword">this</span>, _1);<br>    send_goal_options.feedback_callback =<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::feedback_callback, <span class="hljs-keyword">this</span>, _1, _2);<br>    send_goal_options.result_callback =<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::result_callback, <span class="hljs-keyword">this</span>, _1);<br>    <span class="hljs-keyword">auto</span> goal_handle_future = <span class="hljs-keyword">this</span>-&gt;client_ptr_-&gt;<span class="hljs-built_in">async_send_goal</span>(goal_msg, send_goal_options);<br>  &#125;<br><br><span class="hljs-keyword">private</span>:<br>  rclcpp_action::Client&lt;Fibonacci&gt;::SharedPtr client_ptr_;<br>  rclcpp::TimerBase::SharedPtr timer_;<br>  <span class="hljs-type">bool</span> goal_done_;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">goal_response_callback</span><span class="hljs-params">(GoalHandleFibonacci::SharedPtr goal_handle)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">if</span> (!goal_handle) &#123;<br>      <span class="hljs-built_in">RCLCPP_ERROR</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Goal was rejected by server&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Goal accepted by server, waiting for result&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">feedback_callback</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    GoalHandleFibonacci::SharedPtr,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::shared_ptr&lt;<span class="hljs-type">const</span> Fibonacci::Feedback&gt; feedback)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(),<br>      <span class="hljs-string">&quot;Next number in sequence received: %&quot;</span> PRId32,<br>      feedback-&gt;sequence.<span class="hljs-built_in">back</span>());<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">result_callback</span><span class="hljs-params">(<span class="hljs-type">const</span> GoalHandleFibonacci::WrappedResult &amp; result)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">this</span>-&gt;goal_done_ = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">switch</span> (result.code) &#123;<br>      <span class="hljs-keyword">case</span> rclcpp_action::ResultCode::SUCCEEDED:<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> rclcpp_action::ResultCode::ABORTED:<br>        <span class="hljs-built_in">RCLCPP_ERROR</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Goal was aborted&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>      <span class="hljs-keyword">case</span> rclcpp_action::ResultCode::CANCELED:<br>        <span class="hljs-built_in">RCLCPP_ERROR</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Goal was canceled&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">RCLCPP_ERROR</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Unknown result code&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Result received&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> number : result.result-&gt;sequence) &#123;<br>      <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;%&quot;</span> PRId32, number);<br>    &#125;<br>  &#125;<br>&#125;;  <span class="hljs-comment">// class MinimalActionClient</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">init</span>(argc, argv);<br>  <span class="hljs-keyword">auto</span> action_client = std::<span class="hljs-built_in">make_shared</span>&lt;MinimalActionClient&gt;();<br><br>  <span class="hljs-keyword">while</span> (!action_client-&gt;<span class="hljs-built_in">is_goal_done</span>()) &#123;<br>    rclcpp::<span class="hljs-built_in">spin_some</span>(action_client);<br>  &#125;<br><br>  rclcpp::<span class="hljs-built_in">shutdown</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="动作服务器处理机制"><a href="#动作服务器处理机制" class="headerlink" title="动作服务器处理机制"></a>动作服务器处理机制</h1><p>在ROS2官方网站有动作服务器可视化介绍，整个处理流程如图（<a href="https://docs.ros.org/en/humble/Tutorials/Beginner-CLI-Tools/Understanding-ROS2-Actions/Understanding-ROS2-Actions.html">Understanding actions — ROS 2 Documentation: Humble documentation</a>）：</p><p><img src="/img/ros2-action/Action-SingleActionClient.gif"></p><p>动作服务器正常情况下的复杂交互流程可以总结为以下5个阶段：</p><ol><li>Goal Service客户端向Goal Service服务端发送请求</li><li>Goal Service服务端反馈目标接受状态：接收或拒绝</li><li>Result Service客户端向Result Service服务端发送请求</li><li>动作服务器开始计算，并通过Feedback Topic反馈中间结果</li><li>最终结果计算完毕后，Result Service服务端反馈结果给Result Service客户端<br>由以上的交互流程可知：</li></ol><ul><li>动作服务器<strong>客户端</strong>至少包含以下组合：“Goal Service Client + Feedback Subscriber + Result Service Client”；</li><li>动作服务器<strong>服务端</strong>至少包含以下组合：“Goal Service Server + Feedback Publisher + Result Service Server”。</li></ul><h1 id="动作服务器拆分"><a href="#动作服务器拆分" class="headerlink" title="动作服务器拆分"></a>动作服务器拆分</h1><p>为了清楚说明以上交互逻辑，我们将详细拆解“动作服务器服务端+动作服务器客户端”代码，由于整个流程冗长和复杂，读者可以分部阅读：</p><h2 id="动作服务器创建"><a href="#动作服务器创建" class="headerlink" title="动作服务器创建"></a>动作服务器创建</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 客户端创建代码</span><br><span class="hljs-keyword">this</span>-&gt;client_ptr_ = rclcpp_action::create_client&lt;Fibonacci&gt;(<br>  <span class="hljs-keyword">this</span>-&gt;get_node_base_interface(),<br>  <span class="hljs-keyword">this</span>-&gt;get_node_graph_interface(),<br>  <span class="hljs-keyword">this</span>-&gt;get_node_logging_interface(),<br>  <span class="hljs-keyword">this</span>-&gt;get_node_waitables_interface(),<br>  <span class="hljs-string">&quot;fibonacci&quot;</span>);<br><br><span class="hljs-comment">// 服务端创建代码</span><br><span class="hljs-keyword">this</span>-&gt;action_server_ = rclcpp_action::create_server&lt;Fibonacci&gt;(<br>  <span class="hljs-keyword">this</span>-&gt;get_node_base_interface(),<br>  <span class="hljs-keyword">this</span>-&gt;get_node_clock_interface(),<br>  <span class="hljs-keyword">this</span>-&gt;get_node_logging_interface(),<br>  <span class="hljs-keyword">this</span>-&gt;get_node_waitables_interface(),<br>  <span class="hljs-string">&quot;fibonacci&quot;</span>,<br>  std::bind(&amp;MinimalActionServer::handle_goal, <span class="hljs-keyword">this</span>, _1, _2),<br>  std::bind(&amp;MinimalActionServer::handle_cancel, <span class="hljs-keyword">this</span>, _1),<br>  std::bind(&amp;MinimalActionServer::handle_accepted, <span class="hljs-keyword">this</span>, _1));<br></code></pre></td></tr></table></figure><h2 id="动作服务器服务端"><a href="#动作服务器服务端" class="headerlink" title="动作服务器服务端"></a>动作服务器服务端</h2><p>其中rclcpp_action::create_server()执行服务端创建，代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/create_server.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">typename</span> Server&lt;ActionT&gt;::<span class="hljs-function">SharedPtr</span><br><span class="hljs-function"><span class="hljs-title">create_server</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeClockInterface::SharedPtr node_clock_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeWaitablesInterface::SharedPtr node_waitables_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> std::string &amp; name,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-keyword">typename</span> Server&lt;ActionT&gt;::GoalCallback handle_goal,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-keyword">typename</span> Server&lt;ActionT&gt;::CancelCallback handle_cancel,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-keyword">typename</span> Server&lt;ActionT&gt;::AcceptedCallback handle_accepted,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_server_options_t</span> &amp; options = rcl_action_server_get_default_options(),</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::CallbackGroup::SharedPtr group = <span class="hljs-literal">nullptr</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  std::weak_ptr&lt;rclcpp::node_interfaces::NodeWaitablesInterface&gt; weak_node =<br>    node_waitables_interface;<br>  std::weak_ptr&lt;rclcpp::CallbackGroup&gt; weak_group = group;<br>  <span class="hljs-type">bool</span> group_is_null = (<span class="hljs-literal">nullptr</span> == group.<span class="hljs-built_in">get</span>());<br><br>  <span class="hljs-keyword">auto</span> deleter = [weak_node, weak_group, group_is_null](Server&lt;ActionT&gt; * ptr)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> == ptr) &#123;<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>      <span class="hljs-keyword">auto</span> shared_node = weak_node.<span class="hljs-built_in">lock</span>();<br>      <span class="hljs-keyword">if</span> (shared_node) &#123;<br>        <span class="hljs-comment">// API expects a shared pointer, give it one with a deleter that does nothing.</span><br>        std::shared_ptr&lt;Server&lt;ActionT&gt;&gt; <span class="hljs-built_in">fake_shared_ptr</span>(ptr, [](Server&lt;ActionT&gt; *) &#123;&#125;);<br><br>        <span class="hljs-keyword">if</span> (group_is_null) &#123;<br>          <span class="hljs-comment">// Was added to default group</span><br>          shared_node-&gt;<span class="hljs-built_in">remove_waitable</span>(fake_shared_ptr, <span class="hljs-literal">nullptr</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// Was added to a specific group</span><br>          <span class="hljs-keyword">auto</span> shared_group = weak_group.<span class="hljs-built_in">lock</span>();<br>          <span class="hljs-keyword">if</span> (shared_group) &#123;<br>            shared_node-&gt;<span class="hljs-built_in">remove_waitable</span>(fake_shared_ptr, shared_group);<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">delete</span> ptr;<br>    &#125;;<br><br>  std::shared_ptr&lt;Server&lt;ActionT&gt;&gt; <span class="hljs-built_in">action_server</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Server</span>&lt;ActionT&gt;(<br>      node_base_interface,<br>      node_clock_interface,<br>      node_logging_interface,<br>      name,<br>      options,<br>      handle_goal,<br>      handle_cancel,<br>      handle_accepted), deleter);<br><br>  node_waitables_interface-&gt;<span class="hljs-built_in">add_waitable</span>(action_server, group);<br>  <span class="hljs-keyword">return</span> action_server;<br>&#125;<br></code></pre></td></tr></table></figure><p>从create_server()代码中可以看出，程序直接新建Server&lt; ActionT &gt;对象并返回，该对象就是动作服务器内部表示：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> : <span class="hljs-keyword">public</span> ServerBase, <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;Server&lt;ActionT&gt;&gt;<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">RCLCPP_SMART_PTR_DEFINITIONS_NOT_COPYABLE</span>(Server)<br><br>  <span class="hljs-comment">/// Signature of a callback that accepts or rejects goal requests.</span><br>  <span class="hljs-keyword">using</span> GoalCallback = std::function&lt;<span class="hljs-built_in">GoalResponse</span>(<br>        <span class="hljs-type">const</span> GoalUUID &amp;, std::shared_ptr&lt;<span class="hljs-type">const</span> <span class="hljs-keyword">typename</span> ActionT::Goal&gt;)&gt;;<br>  <span class="hljs-comment">/// Signature of a callback that accepts or rejects requests to cancel a goal.</span><br>  <span class="hljs-keyword">using</span> CancelCallback = std::function&lt;<span class="hljs-built_in">CancelResponse</span>(std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;<br>  <span class="hljs-comment">/// Signature of a callback that is used to notify when the goal has been accepted.</span><br>  <span class="hljs-keyword">using</span> AcceptedCallback = std::function&lt;<span class="hljs-built_in">void</span> (std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;<br><br>  <span class="hljs-comment">/// Construct an action server.</span><br>  <span class="hljs-built_in">Server</span>(<br>    rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,<br>    rclcpp::node_interfaces::NodeClockInterface::SharedPtr node_clock,<br>    rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,<br>    <span class="hljs-type">const</span> std::string &amp; name,<br>    <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_server_options_t</span> &amp; options,<br>    GoalCallback handle_goal,<br>    CancelCallback handle_cancel,<br>    AcceptedCallback handle_accepted<br>  )<br>  : <span class="hljs-built_in">ServerBase</span>(<br>      node_base,<br>      node_clock,<br>      node_logging,<br>      name,<br>      rosidl_typesupport_cpp::<span class="hljs-built_in">get_action_type_support_handle</span>&lt;ActionT&gt;(),<br>      options),<br>    <span class="hljs-built_in">handle_goal_</span>(handle_goal),<br>    <span class="hljs-built_in">handle_cancel_</span>(handle_cancel),<br>    <span class="hljs-built_in">handle_accepted_</span>(handle_accepted)<br>  &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Server</span>() = <span class="hljs-keyword">default</span>;<br>  ...... <span class="hljs-comment">// 其他代码逻辑</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>在Server构造函数中构建了ServerBase类，这个类继承自rclcpp::Waitable，表示RCL可等待对象，本质上和ROS2话题等类似，可以被调度、等待。从这个角度看，任何一个动作服务器，都是一个可等待的对象。在ServerBase构造函数中，执行服务初始化动作，具体流程如下代码注释：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/server.hpp</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ServerBase</span> : <span class="hljs-keyword">public</span> rclcpp::Waitable<br>&#123;<br>...... <span class="hljs-comment">// 其他代码</span><br><span class="hljs-keyword">public</span>:<br>  RCLCPP_ACTION_PUBLIC<br>  <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">ServerBase</span>();<br><br><span class="hljs-keyword">protected</span>:<br>  <span class="hljs-function">RCLCPP_ACTION_PUBLIC</span><br><span class="hljs-function">  <span class="hljs-title">ServerBase</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,</span></span><br><span class="hljs-params"><span class="hljs-function">    rclcpp::node_interfaces::NodeClockInterface::SharedPtr node_clock,</span></span><br><span class="hljs-params"><span class="hljs-function">    rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::string &amp; name,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_server_options_t</span> &amp; options)</span></span>;<br>...... <span class="hljs-comment">// 其他代码</span><br>&#125;;<br><br><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/src/server.cpp</span><br>ServerBase::<span class="hljs-built_in">ServerBase</span>(<br>  rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,<br>  rclcpp::node_interfaces::NodeClockInterface::SharedPtr node_clock,<br>  rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,<br>  <span class="hljs-type">const</span> std::string &amp; name,<br>  <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,<br>  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_server_options_t</span> &amp; options<br>)<br><span class="hljs-comment">// 这里初始化内部数据结果ServerBaseImpl</span><br>: <span class="hljs-built_in">pimpl_</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ServerBaseImpl</span>(<br>      node_clock-&gt;<span class="hljs-built_in">get_clock</span>(), node_logging-&gt;<span class="hljs-built_in">get_logger</span>().<span class="hljs-built_in">get_child</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>)))<br>&#123;<br>  <span class="hljs-keyword">auto</span> deleter = [node_base](<span class="hljs-type">rcl_action_server_t</span> * ptr)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> != ptr) &#123;<br>        <span class="hljs-type">rcl_node_t</span> * rcl_node = node_base-&gt;<span class="hljs-built_in">get_rcl_node_handle</span>();<br>        <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_server_fini</span>(ptr, rcl_node);<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>          <span class="hljs-built_in">RCLCPP_DEBUG</span>(<br>            rclcpp::<span class="hljs-built_in">get_logger</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>),<br>            <span class="hljs-string">&quot;failed to fini rcl_action_server_t in deleter&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">delete</span> ptr;<br>      &#125;<br>    &#125;;<br><br>  <span class="hljs-comment">// 首先创建一个动作服务器，并清理服务器数据结构</span><br>  <span class="hljs-comment">// 值得注意的是这里的pimpl_本质上就是动作服务器（PIMPL模式）</span><br>  pimpl_-&gt;action_server_.<span class="hljs-built_in">reset</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">rcl_action_server_t</span>, deleter);<br>  *(pimpl_-&gt;action_server_) = <span class="hljs-built_in">rcl_action_get_zero_initialized_server</span>();<br><br>  <span class="hljs-type">rcl_node_t</span> * rcl_node = node_base-&gt;<span class="hljs-built_in">get_rcl_node_handle</span>();<br>  <span class="hljs-type">rcl_clock_t</span> * rcl_clock = pimpl_-&gt;clock_-&gt;<span class="hljs-built_in">get_clock_handle</span>();<br><br>  <span class="hljs-comment">// 执行动作服务器的初始化（RCL层）</span><br>  <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_server_init</span>(<br>    pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), rcl_node, rcl_clock, type_support, name.<span class="hljs-built_in">c_str</span>(), &amp;options);<br><br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br><br>  ret = <span class="hljs-built_in">rcl_action_server_wait_set_get_num_entities</span>(<br>    pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(),<br>    &amp;pimpl_-&gt;num_subscriptions_,<br>    &amp;pimpl_-&gt;num_guard_conditions_,<br>    &amp;pimpl_-&gt;num_timers_,<br>    &amp;pimpl_-&gt;num_clients_,<br>    &amp;pimpl_-&gt;num_services_);<br><br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ServerBase::ServerBase()程序通过rcl_action_server_init()初始化RCL动作服务器：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rcl/rcl_action/src/rcl_action/action_server_impl.h</span><br><span class="hljs-comment">/// rcl动作服务器内部实现结构体</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcl_action_server_impl_s</span><br>&#123;<br>  <span class="hljs-type">rcl_service_t</span> goal_service;<br>  <span class="hljs-type">rcl_service_t</span> cancel_service;<br>  <span class="hljs-type">rcl_service_t</span> result_service;<br>  <span class="hljs-type">rcl_publisher_t</span> feedback_publisher;<br>  <span class="hljs-type">rcl_publisher_t</span> status_publisher;<br>  <span class="hljs-type">rcl_timer_t</span> expire_timer;<br>  <span class="hljs-type">char</span> * action_name;<br>  <span class="hljs-type">rcl_action_server_options_t</span> options;<br>  <span class="hljs-comment">// Array of goal handles</span><br>  <span class="hljs-type">rcl_action_goal_handle_t</span> ** goal_handles;<br>  <span class="hljs-type">size_t</span> num_goal_handles;<br>  <span class="hljs-comment">// Clock</span><br>  <span class="hljs-type">rcl_clock_t</span> * clock;<br>  <span class="hljs-comment">// Wait set records</span><br>  <span class="hljs-type">size_t</span> wait_set_goal_service_index;<br>  <span class="hljs-type">size_t</span> wait_set_cancel_service_index;<br>  <span class="hljs-type">size_t</span> wait_set_result_service_index;<br>  <span class="hljs-type">size_t</span> wait_set_expire_timer_index;<br>&#125; <span class="hljs-type">rcl_action_server_impl_t</span>;<br><br><span class="hljs-comment">// src/ros2/rcl/rcl_action/include/rcl_action/action_server.h</span><br><span class="hljs-comment">/// Internal rcl_action implementation struct.</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcl_action_server_impl_s</span> <span class="hljs-type">rcl_action_server_impl_t</span>;<br><br><span class="hljs-comment">/// Structure which encapsulates a ROS Action Server.</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcl_action_server_s</span><br>&#123;<br>  <span class="hljs-comment">/// Pointer to the action server implementation</span><br>  <span class="hljs-type">rcl_action_server_impl_t</span> * impl;<br>&#125; <span class="hljs-type">rcl_action_server_t</span>;<br><br><span class="hljs-comment">// src/ros2/rcl/rcl_action/src/rcl_action/action_server.c（注意这里是C代码）</span><br><span class="hljs-function"><span class="hljs-type">rcl_ret_t</span></span><br><span class="hljs-function"><span class="hljs-title">rcl_action_server_init</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">rcl_action_server_t</span> * action_server,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">rcl_node_t</span> * node,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">rcl_clock_t</span> * clock,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">char</span> * action_name,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_server_options_t</span> * options)</span></span><br><span class="hljs-function"></span>&#123;<br>  ......<span class="hljs-comment">// 参数检查代码</span><br>  <span class="hljs-comment">// 为动作服务内部数据结构申请内存</span><br>  action_server-&gt;impl = (<span class="hljs-type">rcl_action_server_impl_t</span> *)allocator.<span class="hljs-built_in">allocate</span>(<br>    <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">rcl_action_server_impl_t</span>), allocator.state);<br>  <span class="hljs-built_in">RCL_CHECK_FOR_NULL_WITH_MSG</span>(<br>    action_server-&gt;impl, <span class="hljs-string">&quot;allocating memory failed&quot;</span>, <span class="hljs-keyword">return</span> RCL_RET_BAD_ALLOC);<br><br>  <span class="hljs-comment">// 对新申请内存进行零初始化</span><br>  action_server-&gt;impl-&gt;goal_service = <span class="hljs-built_in">rcl_get_zero_initialized_service</span>();<br>  action_server-&gt;impl-&gt;cancel_service = <span class="hljs-built_in">rcl_get_zero_initialized_service</span>();<br>  action_server-&gt;impl-&gt;result_service = <span class="hljs-built_in">rcl_get_zero_initialized_service</span>();<br>  action_server-&gt;impl-&gt;expire_timer = <span class="hljs-built_in">rcl_get_zero_initialized_timer</span>();<br>  action_server-&gt;impl-&gt;feedback_publisher = <span class="hljs-built_in">rcl_get_zero_initialized_publisher</span>();<br>  action_server-&gt;impl-&gt;status_publisher = <span class="hljs-built_in">rcl_get_zero_initialized_publisher</span>();<br>  action_server-&gt;impl-&gt;action_name = <span class="hljs-literal">NULL</span>;<br>  action_server-&gt;impl-&gt;options = *options;  <span class="hljs-comment">// copy options</span><br>  action_server-&gt;impl-&gt;goal_handles = <span class="hljs-literal">NULL</span>;<br>  action_server-&gt;impl-&gt;num_goal_handles = <span class="hljs-number">0u</span>;<br>  action_server-&gt;impl-&gt;clock = <span class="hljs-literal">NULL</span>;<br><br>  <span class="hljs-type">rcl_ret_t</span> ret = RCL_RET_OK;<br>  <span class="hljs-comment">// 以下部分是通过C宏函数来初始化rcl变量，这里就不展开了</span><br>  <span class="hljs-comment">// 初始化action_server-&gt;impl-&gt;goal_service</span><br>  <span class="hljs-built_in">SERVICE_INIT</span>(goal);<br>  <span class="hljs-comment">// 初始化action_server-&gt;impl-&gt;cancel_service</span><br>  <span class="hljs-built_in">SERVICE_INIT</span>(cancel);<br>  <span class="hljs-comment">// 初始化action_server-&gt;impl-&gt;result_service</span><br>  <span class="hljs-built_in">SERVICE_INIT</span>(result);<br><br>  <span class="hljs-comment">// 初始化action_server-&gt;impl-&gt;feedback_publisher</span><br>  <span class="hljs-built_in">PUBLISHER_INIT</span>(feedback);<br>  <span class="hljs-comment">// 初始化action_server-&gt;impl-&gt;status_publisher</span><br>  <span class="hljs-built_in">PUBLISHER_INIT</span>(status);<br><br>  <span class="hljs-comment">// Store reference to clock</span><br>  action_server-&gt;impl-&gt;clock = clock;<br><br><span class="hljs-comment">// 初始化action_server-&gt;impl-&gt;expire_timer超时定时器</span><br>  ret = <span class="hljs-built_in">rcl_timer_init</span>(<br>    &amp;action_server-&gt;impl-&gt;expire_timer, action_server-&gt;impl-&gt;clock, node-&gt;context,<br>    options-&gt;result_timeout.nanoseconds, <span class="hljs-literal">NULL</span>, allocator);<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    <span class="hljs-keyword">goto</span> fail;<br>  &#125;<br>  <span class="hljs-comment">// Cancel timer so it doesn&#x27;t start firing</span><br>  ret = <span class="hljs-built_in">rcl_timer_cancel</span>(&amp;action_server-&gt;impl-&gt;expire_timer);<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    <span class="hljs-keyword">goto</span> fail;<br>  &#125;<br><br>  <span class="hljs-comment">// Copy action name</span><br>  action_server-&gt;impl-&gt;action_name = <span class="hljs-built_in">rcutils_strdup</span>(action_name, allocator);<br>  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == action_server-&gt;impl-&gt;action_name) &#123;<br>    ret = RCL_RET_BAD_ALLOC;<br>    <span class="hljs-keyword">goto</span> fail;<br>  &#125;<br>  <span class="hljs-keyword">return</span> ret;<br>fail:<br>  &#123;<br>    <span class="hljs-comment">// Finalize any services/publishers that were initialized and deallocate action_server-&gt;impl</span><br>    <span class="hljs-type">rcl_ret_t</span> ret_throwaway = <span class="hljs-built_in">rcl_action_server_fini</span>(action_server, node);<br>    <span class="hljs-comment">// Since there is already a failure, it is likely that finalize will error on one or more of</span><br>    <span class="hljs-comment">// the action servers members</span><br>    (<span class="hljs-type">void</span>)ret_throwaway;<br>  &#125;<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>rcl_action_server_init()对动作服务器服务端初始化，该函数在RCL层建立了多个调用对象，如前所述包括：</p><ul><li>Goal Service Server：目标服务器服务端，用于Goal接收，并确定是接收还是拒绝目标</li><li>Cancel Service Server：取消服务器服务端，用于Goal取消操作</li><li>Result Service Server：结果服务器服务端，用于Result请求接收，并反馈最后结果</li><li>Feedback Publisher：反馈发布者，用于Feedback的不断反馈</li><li>Status Publiser：状态发布者，用于自身状态发布</li><li>Expire timer：超时定时器</li></ul><h2 id="动作服务器客户端"><a href="#动作服务器客户端" class="headerlink" title="动作服务器客户端"></a>动作服务器客户端</h2><p>rclcpp_action::create_client()创建动作服务器客户端，具体代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/create_client.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">typename</span> Client&lt;ActionT&gt;::<span class="hljs-function">SharedPtr</span><br><span class="hljs-function"><span class="hljs-title">create_client</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeGraphInterface::SharedPtr node_graph_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeWaitablesInterface::SharedPtr node_waitables_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> std::string &amp; name,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::CallbackGroup::SharedPtr group = <span class="hljs-literal">nullptr</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_client_options_t</span> &amp; options = rcl_action_client_get_default_options())</span></span><br><span class="hljs-function"></span>&#123;<br>  std::weak_ptr&lt;rclcpp::node_interfaces::NodeWaitablesInterface&gt; weak_node =<br>    node_waitables_interface;<br>  std::weak_ptr&lt;rclcpp::CallbackGroup&gt; weak_group = group;<br>  <span class="hljs-type">bool</span> group_is_null = (<span class="hljs-literal">nullptr</span> == group.<span class="hljs-built_in">get</span>());<br><br>  <span class="hljs-keyword">auto</span> deleter = [weak_node, weak_group, group_is_null](Client&lt;ActionT&gt; * ptr)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> == ptr) &#123;<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>      <span class="hljs-keyword">auto</span> shared_node = weak_node.<span class="hljs-built_in">lock</span>();<br>      <span class="hljs-keyword">if</span> (shared_node) &#123;<br>        <span class="hljs-comment">// API expects a shared pointer, give it one with a deleter that does nothing.</span><br>        std::shared_ptr&lt;Client&lt;ActionT&gt;&gt; <span class="hljs-built_in">fake_shared_ptr</span>(ptr, [](Client&lt;ActionT&gt; *) &#123;&#125;);<br><br>        <span class="hljs-keyword">if</span> (group_is_null) &#123;<br>          <span class="hljs-comment">// Was added to default group</span><br>          shared_node-&gt;<span class="hljs-built_in">remove_waitable</span>(fake_shared_ptr, <span class="hljs-literal">nullptr</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// Was added to a specific group</span><br>          <span class="hljs-keyword">auto</span> shared_group = weak_group.<span class="hljs-built_in">lock</span>();<br>          <span class="hljs-keyword">if</span> (shared_group) &#123;<br>            shared_node-&gt;<span class="hljs-built_in">remove_waitable</span>(fake_shared_ptr, shared_group);<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">delete</span> ptr;<br>    &#125;;<br><br>  std::shared_ptr&lt;Client&lt;ActionT&gt;&gt; <span class="hljs-built_in">action_client</span>(<br>    <span class="hljs-keyword">new</span> <span class="hljs-built_in">Client</span>&lt;ActionT&gt;(<br>      node_base_interface,<br>      node_graph_interface,<br>      node_logging_interface,<br>      name,<br>      options),<br>    deleter);<br><br>  node_waitables_interface-&gt;<span class="hljs-built_in">add_waitable</span>(action_client, group);<br>  <span class="hljs-keyword">return</span> action_client;<br>&#125;<br></code></pre></td></tr></table></figure><p>代码基本和动作服务器服务端类似，代码新建的Client&lt; ActionT &gt;对象指针， 同样的每一个客户端也是一个可等待对象：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/client.hpp</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> : <span class="hljs-keyword">public</span> ClientBase<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">RCLCPP_SMART_PTR_DEFINITIONS_NOT_COPYABLE</span>(Client&lt;ActionT&gt;)<br><br>  <span class="hljs-keyword">using</span> Goal = <span class="hljs-keyword">typename</span> ActionT::Goal;<br>  <span class="hljs-keyword">using</span> Feedback = <span class="hljs-keyword">typename</span> ActionT::Feedback;<br>  <span class="hljs-keyword">using</span> GoalHandle = ClientGoalHandle&lt;ActionT&gt;;<br>  <span class="hljs-keyword">using</span> WrappedResult = <span class="hljs-keyword">typename</span> GoalHandle::WrappedResult;<br>  <span class="hljs-keyword">using</span> GoalResponseCallback = std::function&lt;<span class="hljs-built_in">void</span> (<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr)&gt;;<br>  <span class="hljs-keyword">using</span> FeedbackCallback = <span class="hljs-keyword">typename</span> GoalHandle::FeedbackCallback;<br>  <span class="hljs-keyword">using</span> ResultCallback = <span class="hljs-keyword">typename</span> GoalHandle::ResultCallback;<br>  <span class="hljs-keyword">using</span> CancelRequest = <span class="hljs-keyword">typename</span> ActionT::Impl::CancelGoalService::Request;<br>  <span class="hljs-keyword">using</span> CancelResponse = <span class="hljs-keyword">typename</span> ActionT::Impl::CancelGoalService::Response;<br>  <span class="hljs-keyword">using</span> CancelCallback = std::function&lt;<span class="hljs-built_in">void</span> (<span class="hljs-keyword">typename</span> CancelResponse::SharedPtr)&gt;;<br><br>  <span class="hljs-comment">/// Options for sending a goal.</span><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * This struct is used to pass parameters to the function `async_send_goal`.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SendGoalOptions</span><br>  &#123;<br>    <span class="hljs-built_in">SendGoalOptions</span>()<br>    : <span class="hljs-built_in">goal_response_callback</span>(<span class="hljs-literal">nullptr</span>),<br>      <span class="hljs-built_in">feedback_callback</span>(<span class="hljs-literal">nullptr</span>),<br>      <span class="hljs-built_in">result_callback</span>(<span class="hljs-literal">nullptr</span>)<br>    &#123;<br>    &#125;<br><br>    <span class="hljs-comment">/// Function called when the goal is accepted or rejected.</span><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Takes a single argument that is a goal handle shared pointer.</span><br><span class="hljs-comment">     * If the goal is accepted, then the pointer points to a valid goal handle.</span><br><span class="hljs-comment">     * If the goal is rejected, then pointer has the value `nullptr`.</span><br><span class="hljs-comment">     */</span><br>    GoalResponseCallback goal_response_callback;<br><br>    <span class="hljs-comment">/// Function called whenever feedback is received for the goal.</span><br>    FeedbackCallback feedback_callback;<br><br>    <span class="hljs-comment">/// Function called when the result for the goal is received.</span><br>    ResultCallback result_callback;<br>  &#125;;<br><br>  <span class="hljs-comment">/// Construct an action client.</span><br>  <span class="hljs-built_in">Client</span>(<br>    rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,<br>    rclcpp::node_interfaces::NodeGraphInterface::SharedPtr node_graph,<br>    rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,<br>    <span class="hljs-type">const</span> std::string &amp; action_name,<br>    <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_client_options_t</span> &amp; client_options = <span class="hljs-built_in">rcl_action_client_get_default_options</span>()<br>  )<br>  : <span class="hljs-built_in">ClientBase</span>(<br>      node_base, node_graph, node_logging, action_name,<br>      rosidl_typesupport_cpp::<span class="hljs-built_in">get_action_type_support_handle</span>&lt;ActionT&gt;(),<br>      client_options)<br>  &#123;<br>  &#125;<br>  ......<span class="hljs-comment">// 其他代码</span><br>&#125;;<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientBase</span> : <span class="hljs-keyword">public</span> rclcpp::Waitable<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  RCLCPP_ACTION_PUBLIC<br>  <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">ClientBase</span>();<br><br>  <span class="hljs-comment">/// Enum to identify entities belonging to the action client</span><br>  <span class="hljs-keyword">enum class</span> <span class="hljs-title class_">EntityType</span> : std::<span class="hljs-type">size_t</span><br>  &#123;<br>    GoalClient,<br>    ResultClient,<br>    CancelClient,<br>    FeedbackSubscription,<br>    StatusSubscription,<br>  &#125;;<br><br><span class="hljs-keyword">protected</span>:<br>  <span class="hljs-function">RCLCPP_ACTION_PUBLIC</span><br><span class="hljs-function">  <span class="hljs-title">ClientBase</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,</span></span><br><span class="hljs-params"><span class="hljs-function">    rclcpp::node_interfaces::NodeGraphInterface::SharedPtr node_graph,</span></span><br><span class="hljs-params"><span class="hljs-function">    rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::string &amp; action_name,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_client_options_t</span> &amp; options)</span></span>;<br>  ......<span class="hljs-comment">// 其他代码逻辑</span><br>&#125;;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientBaseImpl</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">ClientBaseImpl</span>(<br>    rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,<br>    rclcpp::node_interfaces::NodeGraphInterface::SharedPtr node_graph,<br>    rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,<br>    <span class="hljs-type">const</span> std::string &amp; action_name,<br>    <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,<br>    <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_client_options_t</span> &amp; client_options)<br>  : <span class="hljs-built_in">node_graph_</span>(node_graph),<br>    <span class="hljs-built_in">node_handle</span>(node_base-&gt;<span class="hljs-built_in">get_shared_rcl_node_handle</span>()),<br>    <span class="hljs-built_in">logger</span>(node_logging-&gt;<span class="hljs-built_in">get_logger</span>().<span class="hljs-built_in">get_child</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>)),<br>    <span class="hljs-built_in">random_bytes_generator</span>(std::random_device&#123;&#125;())<br>  &#123;<br>    <span class="hljs-function">std::weak_ptr&lt;<span class="hljs-type">rcl_node_t</span>&gt; <span class="hljs-title">weak_node_handle</span><span class="hljs-params">(node_handle)</span></span>;<br>    client_handle = std::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-type">rcl_action_client_t</span>&gt;(<br>      <span class="hljs-keyword">new</span> <span class="hljs-type">rcl_action_client_t</span>, [weak_node_handle](<span class="hljs-type">rcl_action_client_t</span> * client)<br>      &#123;<br>        <span class="hljs-keyword">auto</span> handle = weak_node_handle.<span class="hljs-built_in">lock</span>();<br>        <span class="hljs-keyword">if</span> (handle) &#123;<br>          <span class="hljs-keyword">if</span> (RCL_RET_OK != <span class="hljs-built_in">rcl_action_client_fini</span>(client, handle.<span class="hljs-built_in">get</span>())) &#123;<br>            <span class="hljs-built_in">RCLCPP_ERROR</span>(<br>              rclcpp::<span class="hljs-built_in">get_logger</span>(<span class="hljs-built_in">rcl_node_get_logger_name</span>(handle.<span class="hljs-built_in">get</span>())).<span class="hljs-built_in">get_child</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>),<br>              <span class="hljs-string">&quot;Error in destruction of rcl action client handle: %s&quot;</span>, <span class="hljs-built_in">rcl_get_error_string</span>().str);<br>            <span class="hljs-built_in">rcl_reset_error</span>();<br>          &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-built_in">RCLCPP_ERROR</span>(<br>            rclcpp::<span class="hljs-built_in">get_logger</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>),<br>            <span class="hljs-string">&quot;Error in destruction of rcl action client handle: &quot;</span><br>            <span class="hljs-string">&quot;the Node Handle was destructed too early. You will leak memory&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">delete</span> client;<br>      &#125;);<br>    *client_handle = <span class="hljs-built_in">rcl_action_get_zero_initialized_client</span>();<br>    <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_client_init</span>(<br>      client_handle.<span class="hljs-built_in">get</span>(), node_handle.<span class="hljs-built_in">get</span>(), type_support,<br>      action_name.<span class="hljs-built_in">c_str</span>(), &amp;client_options);<br>    <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>      rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(<br>        ret, <span class="hljs-string">&quot;could not initialize rcl action client&quot;</span>);<br>    &#125;<br><br>    ret = <span class="hljs-built_in">rcl_action_client_wait_set_get_num_entities</span>(<br>      client_handle.<span class="hljs-built_in">get</span>(),<br>      &amp;num_subscriptions,<br>      &amp;num_guard_conditions,<br>      &amp;num_timers,<br>      &amp;num_clients,<br>      &amp;num_services);<br>    <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>      rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(<br>        ret, <span class="hljs-string">&quot;could not retrieve rcl action client details&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-type">size_t</span> num_subscriptions&#123;<span class="hljs-number">0u</span>&#125;;<br>  <span class="hljs-type">size_t</span> num_guard_conditions&#123;<span class="hljs-number">0u</span>&#125;;<br>  <span class="hljs-type">size_t</span> num_timers&#123;<span class="hljs-number">0u</span>&#125;;<br>  <span class="hljs-type">size_t</span> num_clients&#123;<span class="hljs-number">0u</span>&#125;;<br>  <span class="hljs-type">size_t</span> num_services&#123;<span class="hljs-number">0u</span>&#125;;<br><br>  <span class="hljs-comment">// Lock for action_client_</span><br>  std::recursive_mutex action_client_mutex_;<br><br>  <span class="hljs-comment">// next ready event for taking, will be set by is_ready and will be processed by take_data</span><br>  std::atomic&lt;<span class="hljs-type">size_t</span>&gt; next_ready_event;<br>  <span class="hljs-comment">// used to indicate that next_ready_event has no ready event for processing</span><br>  <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> NO_EVENT_READY = std::numeric_limits&lt;<span class="hljs-type">size_t</span>&gt;::<span class="hljs-built_in">max</span>();<br><br>  rclcpp::Context::SharedPtr context_;<br>  rclcpp::node_interfaces::NodeGraphInterface::WeakPtr node_graph_;<br>  <span class="hljs-comment">// node_handle must be destroyed after client_handle to prevent memory leak</span><br>  std::shared_ptr&lt;<span class="hljs-type">rcl_node_t</span>&gt; node_handle&#123;<span class="hljs-literal">nullptr</span>&#125;;<br>  std::shared_ptr&lt;<span class="hljs-type">rcl_action_client_t</span>&gt; client_handle&#123;<span class="hljs-literal">nullptr</span>&#125;;<br>  rclcpp::Logger logger;<br><br>  <span class="hljs-keyword">using</span> ResponseCallback = std::function&lt;<span class="hljs-built_in">void</span> (std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response)&gt;;<br><br>  std::map&lt;<span class="hljs-type">int64_t</span>, ResponseCallback&gt; pending_goal_responses;<br>  std::mutex goal_requests_mutex;<br><br>  std::map&lt;<span class="hljs-type">int64_t</span>, ResponseCallback&gt; pending_result_responses;<br>  std::mutex result_requests_mutex;<br><br>  std::map&lt;<span class="hljs-type">int64_t</span>, ResponseCallback&gt; pending_cancel_responses;<br>  std::mutex cancel_requests_mutex;<br><br>  std::independent_bits_engine&lt;<br>    std::default_random_engine, <span class="hljs-number">8</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>&gt; random_bytes_generator;<br>&#125;;<br><br>ClientBase::<span class="hljs-built_in">ClientBase</span>(<br>  rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,<br>  rclcpp::node_interfaces::NodeGraphInterface::SharedPtr node_graph,<br>  rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,<br>  <span class="hljs-type">const</span> std::string &amp; action_name,<br>  <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,<br>  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_client_options_t</span> &amp; client_options)<br>: <span class="hljs-built_in">pimpl_</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ClientBaseImpl</span>(<br>      node_base, node_graph, node_logging, action_name, type_support, client_options))<br>&#123;<br>&#125;<br><br>ClientBase::~<span class="hljs-built_in">ClientBase</span>()<br>&#123;<br>  <span class="hljs-built_in">clear_on_ready_callback</span>();<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ClientBase::ClientBase()整个代码结构和ServerBase类似，rcl_action_client_init() 负责初始化客户端底层数据结构：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rcl/rcl_action/src/rcl_action/action_client_impl.h</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcl_action_client_impl_s</span><br>&#123;<br>  <span class="hljs-type">rcl_client_t</span> goal_client;<br>  <span class="hljs-type">rcl_client_t</span> cancel_client;<br>  <span class="hljs-type">rcl_client_t</span> result_client;<br>  <span class="hljs-type">rcl_subscription_t</span> feedback_subscription;<br>  <span class="hljs-type">rcl_subscription_t</span> status_subscription;<br>  <span class="hljs-type">rcl_action_client_options_t</span> options;<br>  <span class="hljs-type">char</span> * action_name;<br>  <span class="hljs-comment">// Wait set records</span><br>  <span class="hljs-type">size_t</span> wait_set_goal_client_index;<br>  <span class="hljs-type">size_t</span> wait_set_cancel_client_index;<br>  <span class="hljs-type">size_t</span> wait_set_result_client_index;<br>  <span class="hljs-type">size_t</span> wait_set_feedback_subscription_index;<br>  <span class="hljs-type">size_t</span> wait_set_status_subscription_index;<br>&#125; <span class="hljs-type">rcl_action_client_impl_t</span>;<br><br><span class="hljs-comment">// src/ros2/rcl/rcl_action/include/rcl_action/action_client.h</span><br><span class="hljs-comment">/// Internal action client implementation struct.</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcl_action_client_impl_s</span> <span class="hljs-type">rcl_action_client_impl_t</span>;<br><br><span class="hljs-comment">/// Structure which encapsulates a ROS action client.</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcl_action_client_s</span><br>&#123;<br>  <span class="hljs-comment">/// Pointer to the action client implementation</span><br>  <span class="hljs-type">rcl_action_client_impl_t</span> * impl;<br>&#125; <span class="hljs-type">rcl_action_client_t</span>;<br><br><span class="hljs-comment">// src/ros2/rcl/rcl_action/src/rcl_action/action_client.c（注意C代码）</span><br><span class="hljs-function"><span class="hljs-type">rcl_ret_t</span></span><br><span class="hljs-function"><span class="hljs-title">rcl_action_client_init</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">rcl_action_client_t</span> * action_client,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">rcl_node_t</span> * node,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">char</span> * action_name,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_client_options_t</span> * options)</span></span><br><span class="hljs-function"></span>&#123;<br>  ......<span class="hljs-comment">// 检查代码逻辑</span><br>  <br>  <span class="hljs-comment">// 申请客户端内存数据结构存储，并做零初始化</span><br>  action_client-&gt;impl = allocator.<span class="hljs-built_in">allocate</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">rcl_action_client_impl_t</span>), allocator.state);<br>  <span class="hljs-built_in">RCL_CHECK_FOR_NULL_WITH_MSG</span>(<br>    action_client-&gt;impl, <span class="hljs-string">&quot;allocating memory failed&quot;</span>, <span class="hljs-keyword">return</span> RCL_RET_BAD_ALLOC);<br><br>  <span class="hljs-comment">// Avoid uninitialized pointers should initialization fail</span><br>  *action_client-&gt;impl = _rcl_action_get_zero_initialized_client_impl();<br>  <span class="hljs-comment">// Copy action client name and options.</span><br>  action_client-&gt;impl-&gt;action_name = <span class="hljs-built_in">rcutils_strdup</span>(action_name, allocator);<br>  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == action_client-&gt;impl-&gt;action_name) &#123;<br>    <span class="hljs-built_in">RCL_SET_ERROR_MSG</span>(<span class="hljs-string">&quot;failed to duplicate action name&quot;</span>);<br>    ret = RCL_RET_BAD_ALLOC;<br>    <span class="hljs-keyword">goto</span> fail;<br>  &#125;<br>  action_client-&gt;impl-&gt;options = *options;<br><br>  <span class="hljs-comment">// 初始化action_client-&gt;impl-&gt;goal_client</span><br>  <span class="hljs-built_in">CLIENT_INIT</span>(goal);<br>  <span class="hljs-comment">// 初始化action_client-&gt;impl-&gt;cancel_client</span><br>  <span class="hljs-built_in">CLIENT_INIT</span>(cancel);<br>  <span class="hljs-comment">// 初始化action_client-&gt;impl-&gt;result_client</span><br>  <span class="hljs-built_in">CLIENT_INIT</span>(result);<br><br>  <span class="hljs-comment">// 初始化action_client-&gt;impl-&gt;feedback_subscription</span><br>  <span class="hljs-built_in">SUBSCRIPTION_INIT</span>(feedback);<br>  <span class="hljs-comment">// 初始化action_client-&gt;impl-&gt;status_subscription</span><br>  <span class="hljs-built_in">SUBSCRIPTION_INIT</span>(status);<br><br>  <span class="hljs-built_in">RCUTILS_LOG_DEBUG_NAMED</span>(ROS_PACKAGE_NAME, <span class="hljs-string">&quot;Action client initialized&quot;</span>);<br>  <span class="hljs-keyword">return</span> ret;<br>fail:<br>  fini_ret = _rcl_action_client_fini_impl(action_client, node, allocator);<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != fini_ret) &#123;<br>    <span class="hljs-built_in">RCL_SET_ERROR_MSG</span>(<span class="hljs-string">&quot;failed to cleanup action client&quot;</span>);<br>    ret = RCL_RET_ERROR;<br>  &#125;<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>对动作服务器客户端初始化时，我们在RCL底层建立了多个可调用对象，如前所述包括：</p><ul><li>Goal Service Client：目标服务器客户端，用于发送目标请求、接收请求回复</li><li>Cancel Service Client：取消服务器客户端，用于发送取消请求</li><li>Result Service Client：结果服务器客户端，用于发送结果请求，接收结果回复</li><li>Feedback Subscription：反馈订阅者，用于反馈消息的接收</li><li>Status Subscription：动作服务器状态订阅者</li></ul><h1 id="请求处理过程"><a href="#请求处理过程" class="headerlink" title="请求处理过程"></a>请求处理过程</h1><h2 id="动作服务器客户端发送Goal请求"><a href="#动作服务器客户端发送Goal请求" class="headerlink" title="动作服务器客户端发送Goal请求"></a>动作服务器客户端发送Goal请求</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">auto</span> goal_msg = Fibonacci::<span class="hljs-built_in">Goal</span>();<br>goal_msg.order = <span class="hljs-number">10</span>;<br><br><span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Sending goal&quot;</span>);<br><br><span class="hljs-keyword">auto</span> send_goal_options = rclcpp_action::Client&lt;Fibonacci&gt;::<span class="hljs-built_in">SendGoalOptions</span>();<br>send_goal_options.goal_response_callback =<br>  std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::goal_response_callback, <span class="hljs-keyword">this</span>, _1);<br>send_goal_options.feedback_callback =<br>  std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::feedback_callback, <span class="hljs-keyword">this</span>, _1, _2);<br>send_goal_options.result_callback =<br>  std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::result_callback, <span class="hljs-keyword">this</span>, _1);<br><span class="hljs-keyword">auto</span> goal_handle_future = <span class="hljs-keyword">this</span>-&gt;client_ptr_-&gt;<span class="hljs-built_in">async_send_goal</span>(goal_msg, send_goal_options);<br></code></pre></td></tr></table></figure><p>服务端和客户端初始化完毕后，客户端调用async_send_goal()发送请求，参数除了目标消息外，还有回调用的callback。由于代码比较复杂，这里直接在代码中注释逻辑：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/client.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> : <span class="hljs-keyword">public</span> ClientBase<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">RCLCPP_SMART_PTR_DEFINITIONS_NOT_COPYABLE</span>(Client&lt;ActionT&gt;)<br><br>  <span class="hljs-keyword">using</span> Goal = <span class="hljs-keyword">typename</span> ActionT::Goal;<br>  <span class="hljs-keyword">using</span> Feedback = <span class="hljs-keyword">typename</span> ActionT::Feedback;<br>  <span class="hljs-keyword">using</span> GoalHandle = ClientGoalHandle&lt;ActionT&gt;;<br>  <span class="hljs-keyword">using</span> WrappedResult = <span class="hljs-keyword">typename</span> GoalHandle::WrappedResult;<br>  <span class="hljs-keyword">using</span> GoalResponseCallback = std::function&lt;<span class="hljs-built_in">void</span> (<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr)&gt;;<br>  <span class="hljs-keyword">using</span> FeedbackCallback = <span class="hljs-keyword">typename</span> GoalHandle::FeedbackCallback;<br>  <span class="hljs-keyword">using</span> ResultCallback = <span class="hljs-keyword">typename</span> GoalHandle::ResultCallback;<br>  <span class="hljs-keyword">using</span> CancelRequest = <span class="hljs-keyword">typename</span> ActionT::Impl::CancelGoalService::Request;<br>  <span class="hljs-keyword">using</span> CancelResponse = <span class="hljs-keyword">typename</span> ActionT::Impl::CancelGoalService::Response;<br>  <span class="hljs-keyword">using</span> CancelCallback = std::function&lt;<span class="hljs-built_in">void</span> (<span class="hljs-keyword">typename</span> CancelResponse::SharedPtr)&gt;;<br>  .....<span class="hljs-comment">// 其他代码逻辑</span><br>  <br>  <span class="hljs-function">std::shared_future&lt;<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr&gt;</span><br><span class="hljs-function">  <span class="hljs-title">async_send_goal</span><span class="hljs-params">(<span class="hljs-type">const</span> Goal &amp; goal, <span class="hljs-type">const</span> SendGoalOptions &amp; options = SendGoalOptions())</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-comment">// 建立promise，反馈内容GoalHandle</span><br>    <span class="hljs-keyword">auto</span> promise = std::make_shared&lt;std::promise&lt;<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr&gt;&gt;();<br>    <span class="hljs-comment">// 获取promise的future，注意这个future回复反馈给用户，以便用户等待goal通知</span><br>    <span class="hljs-function">std::shared_future&lt;<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr&gt; <span class="hljs-title">future</span><span class="hljs-params">(promise-&gt;get_future())</span></span>;<br><br>    <span class="hljs-comment">// 填充目标请求，这里每隔goal都有一个uuid</span><br>    <span class="hljs-keyword">using</span> GoalRequest = <span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Request;<br>    <span class="hljs-keyword">auto</span> goal_request = std::<span class="hljs-built_in">make_shared</span>&lt;GoalRequest&gt;();<br>    goal_request-&gt;goal_id.uuid = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">generate_goal_id</span>();<br>    goal_request-&gt;goal = goal;<br><br>    <span class="hljs-comment">// 发送goal请求</span><br>    <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">send_goal_request</span>(<br>      std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(goal_request),<br>      <span class="hljs-comment">// Goal响应，由于调用流程在其他地方，我们暂时不谈</span><br>      [<span class="hljs-keyword">this</span>, goal_request, options, promise](std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response) <span class="hljs-keyword">mutable</span><br>      &#123;<br>        <span class="hljs-keyword">using</span> GoalResponse = <span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Response;<br>        <span class="hljs-keyword">auto</span> goal_response = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;GoalResponse&gt;(response);<br><br>        <span class="hljs-comment">// 如果goal被拒绝（goal响应消息中accepted==false）</span><br>        <span class="hljs-keyword">if</span> (!goal_response-&gt;accepted) &#123;<br>          <span class="hljs-comment">// 通知future goal设置为空</span><br>          promise-&gt;<span class="hljs-built_in">set_value</span>(<span class="hljs-literal">nullptr</span>);<br>          <span class="hljs-comment">// 然后调用goal的回调函数，填充为空</span><br>          <span class="hljs-keyword">if</span> (options.goal_response_callback) &#123;<br>            options.<span class="hljs-built_in">goal_response_callback</span>(<span class="hljs-literal">nullptr</span>);<br>          &#125;<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 到此处goal被接受了</span><br>        GoalInfo goal_info;<br>        goal_info.goal_id.uuid = goal_request-&gt;goal_id.uuid;<br>        goal_info.stamp = goal_response-&gt;stamp;<br>        <span class="hljs-comment">// Do not use std::make_shared as friendship cannot be forwarded.</span><br>        std::shared_ptr&lt;GoalHandle&gt; <span class="hljs-built_in">goal_handle</span>(<br>          <span class="hljs-keyword">new</span> <span class="hljs-built_in">GoalHandle</span>(goal_info, options.feedback_callback, options.result_callback));<br>        &#123;<br>          std::lock_guard&lt;std::mutex&gt; <span class="hljs-built_in">guard</span>(goal_handles_mutex_);<br>          goal_handles_[goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>()] = goal_handle;<br>        &#125;<br><br>        <span class="hljs-comment">// 新建goal_handle，并且通知promise，goal被接受了</span><br>        promise-&gt;<span class="hljs-built_in">set_value</span>(goal_handle);<br>        <br>        <span class="hljs-comment">// 调用goal的回调，此时参数有效</span><br>        <span class="hljs-keyword">if</span> (options.goal_response_callback) &#123;<br>          options.<span class="hljs-built_in">goal_response_callback</span>(goal_handle);<br>        &#125;<br>        <br>        <span class="hljs-comment">// 向服务端发送goal result请求</span><br>        <span class="hljs-keyword">if</span> (options.result_callback) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">make_result_aware</span>(goal_handle);<br>        &#125;<br>      &#125;);<br><br>    <span class="hljs-comment">// 清除不再使用goal，暂不关心</span><br>    &#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(goal_handles_mutex_)</span></span>;<br>      <span class="hljs-keyword">auto</span> goal_handle_it = goal_handles_.<span class="hljs-built_in">begin</span>();<br>      <span class="hljs-keyword">while</span> (goal_handle_it != goal_handles_.<span class="hljs-built_in">end</span>()) &#123;<br>        <span class="hljs-keyword">if</span> (!goal_handle_it-&gt;second.<span class="hljs-built_in">lock</span>()) &#123;<br>          <span class="hljs-built_in">RCLCPP_DEBUG</span>(<br>            <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(),<br>            <span class="hljs-string">&quot;Dropping weak reference to goal handle during send_goal()&quot;</span>);<br>          goal_handle_it = goal_handles_.<span class="hljs-built_in">erase</span>(goal_handle_it);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          ++goal_handle_it;<br>        &#125;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> future;<br>  &#125;<br>  <br>  <span class="hljs-comment">/// \internal</span><br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">make_result_aware</span><span class="hljs-params">(<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr goal_handle)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-comment">// Avoid making more than one request</span><br>    <span class="hljs-keyword">if</span> (goal_handle-&gt;<span class="hljs-built_in">set_result_awareness</span>(<span class="hljs-literal">true</span>)) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">using</span> GoalResultRequest = <span class="hljs-keyword">typename</span> ActionT::Impl::GetResultService::Request;<br>    <span class="hljs-keyword">auto</span> goal_result_request = std::<span class="hljs-built_in">make_shared</span>&lt;GoalResultRequest&gt;();<br>    goal_result_request-&gt;goal_id.uuid = goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 这里发送结果请求</span><br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">send_result_request</span>(<br>        std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(goal_result_request),<br>        [goal_handle, <span class="hljs-keyword">this</span>](std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response) <span class="hljs-keyword">mutable</span><br>        &#123;<br>          <span class="hljs-comment">// Wrap the response in a struct with the fields a user cares about</span><br>          WrappedResult wrapped_result;<br>          <span class="hljs-keyword">using</span> GoalResultResponse = <span class="hljs-keyword">typename</span> ActionT::Impl::GetResultService::Response;<br>          <span class="hljs-comment">// 处理结果，拷贝到wrapped_result</span><br>          <span class="hljs-keyword">auto</span> result_response = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;GoalResultResponse&gt;(response);<br>          wrapped_result.result = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-keyword">typename</span> ActionT::Result&gt;();<br>          *wrapped_result.result = result_response-&gt;result;<br>          wrapped_result.goal_id = goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>();<br>          wrapped_result.code = <span class="hljs-built_in">static_cast</span>&lt;ResultCode&gt;(result_response-&gt;status);<br>          <span class="hljs-comment">// 这里将结果也放到goal_handle中</span><br>          goal_handle-&gt;<span class="hljs-built_in">set_result</span>(wrapped_result);<br>          std::lock_guard&lt;std::mutex&gt; <span class="hljs-built_in">lock</span>(goal_handles_mutex_);<br>          goal_handles_.<span class="hljs-built_in">erase</span>(goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>());<br>        &#125;);<br>    &#125; <span class="hljs-built_in">catch</span> (rclcpp::exceptions::RCLError &amp; ex) &#123;<br>      <span class="hljs-comment">// This will cause an exception when the user tries to access the result</span><br>      goal_handle-&gt;<span class="hljs-built_in">invalidate</span>(exceptions::<span class="hljs-built_in">UnawareGoalHandleError</span>(ex.message));<br>    &#125;<br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/client_goal_handle.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientGoalHandle</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">RCLCPP_SMART_PTR_DEFINITIONS_NOT_COPYABLE</span>(ClientGoalHandle)<br><br>  <span class="hljs-comment">// A wrapper that defines the result of an action</span><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">WrappedResult</span><br>  &#123;<br>    <span class="hljs-comment">/// The unique identifier of the goal</span><br>    GoalUUID goal_id;<br>    <span class="hljs-comment">/// A status to indicate if the goal was canceled, aborted, or suceeded</span><br>    ResultCode code;<br>    <span class="hljs-comment">/// User defined fields sent back with an action</span><br>    <span class="hljs-keyword">typename</span> ActionT::Result::SharedPtr result;<br>  &#125;;<br><br>  <span class="hljs-keyword">using</span> Feedback = <span class="hljs-keyword">typename</span> ActionT::Feedback;<br>  <span class="hljs-keyword">using</span> Result = <span class="hljs-keyword">typename</span> ActionT::Result;<br>  <span class="hljs-keyword">using</span> FeedbackCallback =<br>    std::function&lt;<span class="hljs-built_in">void</span> (<br>        <span class="hljs-keyword">typename</span> ClientGoalHandle&lt;ActionT&gt;::SharedPtr,<br>        <span class="hljs-type">const</span> std::shared_ptr&lt;<span class="hljs-type">const</span> Feedback&gt;)&gt;;<br>  <span class="hljs-keyword">using</span> ResultCallback = std::function&lt;<span class="hljs-built_in">void</span> (<span class="hljs-type">const</span> WrappedResult &amp; result)&gt;;<br><br>  <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">ClientGoalHandle</span>();<br><br>    .....<span class="hljs-comment">// 其他代码逻辑</span><br><br><span class="hljs-keyword">private</span>:<br>  <span class="hljs-comment">// The templated Client creates goal handles</span><br>  <span class="hljs-keyword">friend</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span>&lt;ActionT&gt;;<br><br>  <span class="hljs-built_in">ClientGoalHandle</span>(<br>    <span class="hljs-type">const</span> GoalInfo &amp; info,<br>    FeedbackCallback feedback_callback,<br>    ResultCallback result_callback);<br><br>  .....<span class="hljs-comment">// 其他代码逻辑</span><br>  <br>  GoalInfo info_;<br><br>  std::exception_ptr invalidate_exception_&#123;<span class="hljs-literal">nullptr</span>&#125;;<br><br>  <span class="hljs-type">bool</span> is_result_aware_&#123;<span class="hljs-literal">false</span>&#125;;<br>  std::promise&lt;WrappedResult&gt; result_promise_;<br>  std::shared_future&lt;WrappedResult&gt; result_future_;<br><br>  FeedbackCallback feedback_callback_&#123;<span class="hljs-literal">nullptr</span>&#125;;<br>  ResultCallback result_callback_&#123;<span class="hljs-literal">nullptr</span>&#125;;<br>  <span class="hljs-type">int8_t</span> status_&#123;GoalStatus::STATUS_ACCEPTED&#125;;<br><br>  std::mutex handle_mutex_;<br>&#125;;<br></code></pre></td></tr></table></figure><p>客户端send_goal_request()调用通过Goal Service发送目标请求，具体代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/src/client.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ClientBase::send_goal_request</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; request, ResponseCallback callback)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(pimpl_-&gt;goal_requests_mutex)</span></span>;<br>  <span class="hljs-type">int64_t</span> sequence_number;<br>  <span class="hljs-comment">// 发送请求到rcl层</span><br>  <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_send_goal_request</span>(<br>    pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), request.<span class="hljs-built_in">get</span>(), &amp;sequence_number);<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret, <span class="hljs-string">&quot;failed to send goal request&quot;</span>);<br>  &#125;<br>  <span class="hljs-built_in">assert</span>(pimpl_-&gt;pending_goal_responses.<span class="hljs-built_in">count</span>(sequence_number) == <span class="hljs-number">0</span>);<br>  <span class="hljs-comment">// 建立序列号到callback映射</span><br>  pimpl_-&gt;pending_goal_responses[sequence_number] = callback;<br>&#125;<br></code></pre></td></tr></table></figure><p>动作服务器客户端通过ClientBase调用rcl_action_send_goal_request()将goal发送出去，发送后函数返回代表goal的序列号，动作服务器依据此序列号，建立序列号到callback映射，以便在goal反馈后，执行对应callback函数。</p><h2 id="动作服务器服务端接收到Goal请求"><a href="#动作服务器服务端接收到Goal请求" class="headerlink" title="动作服务器服务端接收到Goal请求"></a>动作服务器服务端接收到Goal请求</h2><p>我们之前说过，动作服务器本身是一个Waitable，当请求到来时，会触发Waitable的数据处理函数：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/src/rclcpp/executor.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">Executor::execute_any_executable</span><span class="hljs-params">(AnyExecutable &amp; any_exec)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!spinning.<span class="hljs-built_in">load</span>()) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  ....<span class="hljs-comment">//其他代码逻辑</span><br>  <span class="hljs-keyword">if</span> (any_exec.waitable) &#123;<br>    any_exec.waitable-&gt;<span class="hljs-built_in">execute</span>(any_exec.data);<br>  &#125;<br>  <span class="hljs-comment">// Reset the callback_group, regardless of type</span><br>  any_exec.callback_group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">store</span>(<span class="hljs-literal">true</span>);<br>  ....<span class="hljs-comment">//其他代码逻辑</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span></span><br><span class="hljs-function"><span class="hljs-title">Executor::get_next_ready_executable_from_map</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  AnyExecutable &amp; any_executable,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> rclcpp::memory_strategy::MemoryStrategy::WeakCallbackGroupsToNodesMap &amp;</span></span><br><span class="hljs-params"><span class="hljs-function">  weak_groups_to_nodes)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">TRACEPOINT</span>(rclcpp_executor_get_next_ready);<br>  <span class="hljs-type">bool</span> success = <span class="hljs-literal">false</span>;<br>  std::lock_guard&lt;std::mutex&gt; guard&#123;mutex_&#125;;<br>  ......<span class="hljs-comment">//其他代码逻辑</span><br>  <span class="hljs-keyword">if</span> (!success) &#123;<br>    <span class="hljs-comment">// Check the waitables to see if there are any that are ready</span><br>    memory_strategy_-&gt;<span class="hljs-built_in">get_next_waitable</span>(any_executable, weak_groups_to_nodes);<br>    <span class="hljs-keyword">if</span> (any_executable.waitable) &#123;<br>      any_executable.data = any_executable.waitable-&gt;<span class="hljs-built_in">take_data</span>();<br>      success = <span class="hljs-literal">true</span>;<br>    &#125;<br>  &#125;<br>  ......<span class="hljs-comment">// 其他代码逻辑</span><br>  <span class="hljs-keyword">if</span> (success) &#123;<br>    <span class="hljs-comment">// If it is valid, check to see if the group is mutually exclusive or</span><br>    <span class="hljs-comment">// not, then mark it accordingly ..Check if the callback_group belongs to this executor</span><br>    <span class="hljs-keyword">if</span> (any_executable.callback_group &amp;&amp; any_executable.callback_group-&gt;<span class="hljs-built_in">type</span>() == \<br>      CallbackGroupType::MutuallyExclusive)<br>    &#123;<br>      <span class="hljs-comment">// It should not have been taken otherwise</span><br>      <span class="hljs-built_in">assert</span>(any_executable.callback_group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">load</span>());<br>      <span class="hljs-comment">// Set to false to indicate something is being run from this group</span><br>      <span class="hljs-comment">// This is reset to true either when the any_executable is executed or when the</span><br>      <span class="hljs-comment">// any_executable is destructued</span><br>      any_executable.callback_group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">store</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// If there is no ready executable, return false</span><br>  <span class="hljs-keyword">return</span> success;<br>&#125;<br></code></pre></td></tr></table></figure><p>当动作服务器客户端请求到来，首先get_next_executable()调用get_next_ready_executable_from_map()，执行Waitable的take_data()首先根据到来请求的类型，做数据处理，然后execute_any_executable()执行Waitable的execute()函数，这两者代码如下，由于代码较长，直接在代码中注释：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;</span><br><span class="hljs-function"><span class="hljs-title">ServerBase::take_data</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">size_t</span> next_ready_event = pimpl_-&gt;next_ready_event.<span class="hljs-built_in">exchange</span>(ServerBaseImpl::NO_EVENT_READY);<br><br>  <span class="hljs-keyword">if</span> (next_ready_event == ServerBaseImpl::NO_EVENT_READY) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Taking data from action server but no ready event&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">// 调用take_data_by_entity_id处理数据</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">take_data_by_entity_id</span>(next_ready_event);<br>&#125;<br><br><span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;</span><br><span class="hljs-function"><span class="hljs-title">ServerBase::take_data_by_entity_id</span><span class="hljs-params">(<span class="hljs-type">size_t</span> id)</span></span><br><span class="hljs-function"></span>&#123;<br>  .....<span class="hljs-comment">//校验逻辑</span><br><br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr;<br>  <span class="hljs-comment">// Mark as ready the entity from which we want to take data</span><br>  <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">static_cast</span>&lt;ActionEventType&gt;(id)) &#123;<br>    <span class="hljs-comment">// GoalService类型</span><br>    <span class="hljs-comment">// </span><br>    <span class="hljs-keyword">case</span> ActionEventType::GoalService:<br>      &#123;<br>        <span class="hljs-type">rcl_ret_t</span> ret;<br>        <span class="hljs-type">rcl_action_goal_info_t</span> goal_info = <span class="hljs-built_in">rcl_action_get_zero_initialized_goal_info</span>();<br>        <span class="hljs-type">rmw_request_id_t</span> request_header;<br><br>        <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br><br>        <span class="hljs-comment">// 调用rcl层处理goal请求，并返回request_header</span><br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; message = <span class="hljs-built_in">create_goal_request</span>();<br>        ret = <span class="hljs-built_in">rcl_action_take_goal_request</span>(<br>          pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(),<br>          &amp;request_header,<br>          message.<span class="hljs-built_in">get</span>());<br><br>        <span class="hljs-comment">// 构建ServerBaseData</span><br>        data_ptr = std::<span class="hljs-built_in">make_shared</span>&lt;ServerBaseData&gt;(<br>          ServerBaseData::<span class="hljs-built_in">GoalRequestData</span>(ret, goal_info, request_header, message));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> ActionEventType::ResultService:<br>      &#123;<br>        <span class="hljs-type">rcl_ret_t</span> ret;<br>        <span class="hljs-comment">// 调用rcl层处理goal请求，并返回request_header</span><br>        <span class="hljs-type">rmw_request_id_t</span> request_header;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_request = <span class="hljs-built_in">create_result_request</span>();<br>        <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>        ret = <span class="hljs-built_in">rcl_action_take_result_request</span>(<br>          pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;request_header, result_request.<span class="hljs-built_in">get</span>());<br><br>         <span class="hljs-comment">// 构建ServerBaseData</span><br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ServerBaseData&gt;(<br>          ServerBaseData::<span class="hljs-built_in">ResultRequestData</span>(ret, result_request, request_header));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> ActionEventType::CancelService:<br>      &#123;<br>        <span class="hljs-type">rcl_ret_t</span> ret;<br>        <span class="hljs-type">rmw_request_id_t</span> request_header;<br><br>        <span class="hljs-comment">// Initialize cancel request</span><br>        <span class="hljs-keyword">auto</span> request = std::<span class="hljs-built_in">make_shared</span>&lt;action_msgs::srv::CancelGoal::Request&gt;();<br><br>        <span class="hljs-comment">// 调用rcl层处理goal请求，并返回request_header</span><br>        <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>        ret = <span class="hljs-built_in">rcl_action_take_cancel_request</span>(<br>          pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(),<br>          &amp;request_header,<br>          request.<span class="hljs-built_in">get</span>());<br>        <span class="hljs-comment">// 调用rcl层处理goal请求，并返回request_header</span><br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ServerBaseData&gt;(<br>          ServerBaseData::<span class="hljs-built_in">CancelRequestData</span>(ret, request, request_header));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> ActionEventType::Expired:<br>      &#123;<br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ServerBaseData&gt;(ServerBaseData::<span class="hljs-built_in">GoalExpiredData</span>());<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(data_ptr);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::execute</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data_in)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!data_in) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Executing action server but &#x27;data&#x27; is empty&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// 首先获取到ServerBaseData</span><br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ServerBaseData&gt;(data_in);<br><br>  <span class="hljs-comment">// 分发请求</span><br>  std::<span class="hljs-built_in">visit</span>(<br>    [&amp;](<span class="hljs-keyword">auto</span> &amp;&amp; data) -&gt; <span class="hljs-type">void</span> &#123;<br>      <span class="hljs-keyword">using</span> T = std::<span class="hljs-type">decay_t</span>&lt;<span class="hljs-keyword">decltype</span>(data)&gt;;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::GoalRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_goal_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::CancelRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_cancel_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::ResultRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_result_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::GoalExpiredData&gt;) &#123;<br>        <span class="hljs-built_in">execute_check_expired_goals</span>();<br>      &#125;<br>    &#125;,<br>    data_ptr-&gt;data);<br>&#125;<br></code></pre></td></tr></table></figure><p>在获取到动作服务器Goal请求后，服务端先建立包含GoalRequestData类型的ServerBaseData，然后调用execute_goal_request_received()执行回调：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::execute_goal_request_received</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// 解包数据</span><br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ServerBaseData&gt;(data);<br>  <span class="hljs-function"><span class="hljs-type">const</span> ServerBaseData::GoalRequestData &amp; <span class="hljs-title">gData</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    std::get&lt;ServerBaseData::GoalRequestData&gt;(data_ptr-&gt;data))</span></span>;<br><br>  <span class="hljs-type">rcl_ret_t</span> ret = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">0</span>&gt;(gData);<br>  <span class="hljs-type">rcl_action_goal_info_t</span> goal_info = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">1</span>&gt;(gData);<br>  <span class="hljs-type">rmw_request_id_t</span> request_header = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">2</span>&gt;(gData);<br>  <span class="hljs-type">const</span> std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; message = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">3</span>&gt;(gData);<br><br>  <span class="hljs-keyword">if</span> (RCL_RET_ACTION_SERVER_TAKE_FAILED == ret) &#123;<br>    <span class="hljs-comment">// Ignore take failure because connext fails if it receives a sample without valid data.</span><br>    <span class="hljs-comment">// This happens when a client shuts down and connext receives a sample saying the client is</span><br>    <span class="hljs-comment">// no longer alive.</span><br>    <span class="hljs-keyword">return</span>;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br><br>  <span class="hljs-comment">// 根据goal信息，获取UUID</span><br>  GoalUUID uuid = <span class="hljs-built_in">get_goal_id_from_goal_request</span>(message.<span class="hljs-built_in">get</span>());<br>  <span class="hljs-built_in">convert</span>(uuid, &amp;goal_info);<br><br>  <span class="hljs-comment">// 调用用户的回调函数</span><br>  <span class="hljs-keyword">auto</span> response_pair = <span class="hljs-built_in">call_handle_goal_callback</span>(uuid, message);<br><br>  <span class="hljs-comment">// 调用rcl给客户端反馈服务端响应</span><br>  <span class="hljs-comment">// 注意：给动作服务器客户端反馈是在调用了用户的goal_handle_后，在goal_accepted_前</span><br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>    ret = <span class="hljs-built_in">rcl_action_send_goal_response</span>(<br>      pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(),<br>      &amp;request_header,<br>      response_pair.second.<span class="hljs-built_in">get</span>());<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    <span class="hljs-keyword">if</span> (ret == RCL_RET_TIMEOUT) &#123;<br>      <span class="hljs-built_in">RCLCPP_WARN</span>(<br>        pimpl_-&gt;logger_,<br>        <span class="hljs-string">&quot;Failed to send goal response %s (timeout): %s&quot;</span>,<br>        <span class="hljs-built_in">to_string</span>(uuid).<span class="hljs-built_in">c_str</span>(), <span class="hljs-built_in">rcl_get_error_string</span>().str);<br>      <span class="hljs-built_in">rcl_reset_error</span>();<br>      <span class="hljs-keyword">return</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> status = response_pair.first;<br><br>  <span class="hljs-comment">// if goal is accepted, create a goal handle, and store it</span><br>  <span class="hljs-keyword">if</span> (GoalResponse::ACCEPT_AND_EXECUTE == status || GoalResponse::ACCEPT_AND_DEFER == status) &#123;<br>    <span class="hljs-built_in">RCLCPP_DEBUG</span>(pimpl_-&gt;logger_, <span class="hljs-string">&quot;Accepted goal %s&quot;</span>, <span class="hljs-built_in">to_string</span>(uuid).<span class="hljs-built_in">c_str</span>());<br>    <span class="hljs-comment">// rcl_action will set time stamp</span><br>    <span class="hljs-keyword">auto</span> deleter = [](<span class="hljs-type">rcl_action_goal_handle_t</span> * ptr)<br>      &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> != ptr) &#123;<br>          <span class="hljs-type">rcl_ret_t</span> fail_ret = <span class="hljs-built_in">rcl_action_goal_handle_fini</span>(ptr);<br>          <span class="hljs-keyword">if</span> (RCL_RET_OK != fail_ret) &#123;<br>            <span class="hljs-built_in">RCLCPP_DEBUG</span>(<br>              rclcpp::<span class="hljs-built_in">get_logger</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>),<br>              <span class="hljs-string">&quot;failed to fini rcl_action_goal_handle_t in deleter&quot;</span>);<br>          &#125;<br>          <span class="hljs-keyword">delete</span> ptr;<br>        &#125;<br>      &#125;;<br>    <span class="hljs-comment">// 当Goal被用户接受，调用rcl创建Goal Handle</span><br>    <span class="hljs-type">rcl_action_goal_handle_t</span> * rcl_handle;<br>    &#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>      rcl_handle = <span class="hljs-built_in">rcl_action_accept_new_goal</span>(pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;goal_info);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!rcl_handle) &#123;<br>      <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Failed to accept new goal\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">rcl_action_goal_handle_t</span>&gt; <span class="hljs-title">handle</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">rcl_action_goal_handle_t</span>, deleter)</span></span>;<br>    <span class="hljs-comment">// Copy out goal handle since action server storage disappears when it is fini&#x27;d</span><br>    *handle = *rcl_handle;<br><br>    <span class="hljs-comment">// 将Goal Handle根据UUID存入Server</span><br>    &#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;unordered_map_mutex_)</span></span>;<br>      pimpl_-&gt;goal_handles_[uuid] = handle;<br>    &#125;<br><br>    <span class="hljs-comment">// 更新底层rcl，表示Goal正在执行</span><br>    <span class="hljs-keyword">if</span> (GoalResponse::ACCEPT_AND_EXECUTE == status) &#123;<br>      <span class="hljs-comment">// Change status to executing</span><br>      ret = <span class="hljs-built_in">rcl_action_update_goal_state</span>(handle.<span class="hljs-built_in">get</span>(), GOAL_EVENT_EXECUTE);<br>      <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>        rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">// publish status since a goal&#x27;s state has changed (was accepted or has begun execution)</span><br>    <span class="hljs-comment">// 将Goal状态发不出去，这个就会使用服务端建立Status Publisher，这个暂不关注</span><br>    <span class="hljs-built_in">publish_status</span>();<br><br>    <span class="hljs-comment">// 调用用户自定义Accepted回调函数</span><br>    <span class="hljs-built_in">call_goal_accepted_callback</span>(handle, uuid, message);<br>  &#125;<br>  data.<span class="hljs-built_in">reset</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>如上述代码，执行器在收到Goal后，首先调用call_handle_goal_callback()，该函数内部调用handle_goal_()，就是我们MinimalActionServer::handle_goal()。然后动作服务器给客户端发送响应。同时开始处理Goal目标，如果接受（Accepted）Goal目标，那么就建立Goal Handle，并通过call_goal_accepted_callback()调用用户handle_accepted_()回调。</p><div class="note note-warning">            <p>给动作服务器客户端反馈是在调用了用户的goal_handle_后，在goal_accepted_前</p>          </div><h2 id="动作服务器服务端发送到Goal回应"><a href="#动作服务器服务端发送到Goal回应" class="headerlink" title="动作服务器服务端发送到Goal回应"></a>动作服务器服务端发送到Goal回应</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> : <span class="hljs-keyword">public</span> ServerBase, <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;Server&lt;ActionT&gt;&gt;<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">RCLCPP_SMART_PTR_DEFINITIONS_NOT_COPYABLE</span>(Server)<br><br>  <span class="hljs-comment">/// Signature of a callback that accepts or rejects goal requests.</span><br>  <span class="hljs-keyword">using</span> GoalCallback = std::function&lt;<span class="hljs-built_in">GoalResponse</span>(<br>        <span class="hljs-type">const</span> GoalUUID &amp;, std::shared_ptr&lt;<span class="hljs-type">const</span> <span class="hljs-keyword">typename</span> ActionT::Goal&gt;)&gt;;<br>  <span class="hljs-comment">/// Signature of a callback that accepts or rejects requests to cancel a goal.</span><br>  <span class="hljs-keyword">using</span> CancelCallback = std::function&lt;<span class="hljs-built_in">CancelResponse</span>(std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;<br>  <span class="hljs-comment">/// Signature of a callback that is used to notify when the goal has been accepted.</span><br>  <span class="hljs-keyword">using</span> AcceptedCallback = std::function&lt;<span class="hljs-built_in">void</span> (std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;<br><br><span class="hljs-keyword">protected</span>:<br>  std::pair&lt;GoalResponse, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;&gt;<br>  <span class="hljs-built_in">call_handle_goal_callback</span>(GoalUUID &amp; uuid, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; message) <span class="hljs-keyword">override</span><br>  &#123;<br>    <span class="hljs-keyword">auto</span> request = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<br>      <span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Request&gt;(message);<br>    <span class="hljs-keyword">auto</span> goal = std::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-keyword">typename</span> ActionT::Goal&gt;(request, &amp;request-&gt;goal);<br>    <span class="hljs-comment">// 调用用户自定义的回调函数</span><br>    GoalResponse user_response = <span class="hljs-built_in">handle_goal_</span>(uuid, goal);<br><br>    <span class="hljs-comment">// 如果返回状态为GoalResponse::ACCEPT_AND_EXECUTE或者GoalResponse::ACCEPT_AND_DEFER，表示Goal被接受</span><br>    <span class="hljs-keyword">auto</span> ros_response = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Response&gt;();<br>    ros_response-&gt;accepted = GoalResponse::ACCEPT_AND_EXECUTE == user_response ||<br>      GoalResponse::ACCEPT_AND_DEFER == user_response;<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_pair</span>(user_response, ros_response);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>如果Goal被用户决定了Accepted，程序会调用用户自定义的Accepted回调handle_goal_()，也就是MinimalActionServer::handle_accepted()，来做用户自定义后处理：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> : <span class="hljs-keyword">public</span> ServerBase, <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;Server&lt;ActionT&gt;&gt;<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">RCLCPP_SMART_PTR_DEFINITIONS_NOT_COPYABLE</span>(Server)<br><br>  <span class="hljs-comment">/// Signature of a callback that accepts or rejects goal requests.</span><br>  <span class="hljs-keyword">using</span> GoalCallback = std::function&lt;<span class="hljs-built_in">GoalResponse</span>(<br>        <span class="hljs-type">const</span> GoalUUID &amp;, std::shared_ptr&lt;<span class="hljs-type">const</span> <span class="hljs-keyword">typename</span> ActionT::Goal&gt;)&gt;;<br>  <span class="hljs-comment">/// Signature of a callback that accepts or rejects requests to cancel a goal.</span><br>  <span class="hljs-keyword">using</span> CancelCallback = std::function&lt;<span class="hljs-built_in">CancelResponse</span>(std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;<br>  <span class="hljs-comment">/// Signature of a callback that is used to notify when the goal has been accepted.</span><br>  <span class="hljs-keyword">using</span> AcceptedCallback = std::function&lt;<span class="hljs-built_in">void</span> (std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;<br><br><span class="hljs-keyword">protected</span>:<br><span class="hljs-comment">/// \internal</span><br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">call_goal_accepted_callback</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    std::shared_ptr&lt;<span class="hljs-type">rcl_action_goal_handle_t</span>&gt; rcl_goal_handle,</span></span><br><span class="hljs-params"><span class="hljs-function">    GoalUUID uuid, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; goal_request_message)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function">  </span>&#123;<br>    std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt; goal_handle;<br>    std::weak_ptr&lt;Server&lt;ActionT&gt;&gt; weak_this = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">shared_from_this</span>();<br><br>    std::function&lt;<span class="hljs-type">void</span>(<span class="hljs-type">const</span> GoalUUID &amp;, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;)&gt; on_terminal_state =<br>      [weak_this](<span class="hljs-type">const</span> GoalUUID &amp; goal_uuid, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_message)<br>      &#123;<br>        std::shared_ptr&lt;Server&lt;ActionT&gt;&gt; shared_this = weak_this.<span class="hljs-built_in">lock</span>();<br>        <span class="hljs-keyword">if</span> (!shared_this) &#123;<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// Send result message to anyone that asked</span><br>        shared_this-&gt;<span class="hljs-built_in">publish_result</span>(goal_uuid, result_message);<br>        <span class="hljs-comment">// Publish a status message any time a goal handle changes state</span><br>        shared_this-&gt;<span class="hljs-built_in">publish_status</span>();<br>        <span class="hljs-comment">// notify base so it can recalculate the expired goal timer</span><br>        shared_this-&gt;<span class="hljs-built_in">notify_goal_terminal_state</span>();<br>        <span class="hljs-comment">// Delete data now (ServerBase and rcl_action_server_t keep data until goal handle expires)</span><br>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(shared_this-&gt;goal_handles_mutex_)</span></span>;<br>        shared_this-&gt;goal_handles_.<span class="hljs-built_in">erase</span>(goal_uuid);<br>      &#125;;<br><br>    std::function&lt;<span class="hljs-type">void</span>(<span class="hljs-type">const</span> GoalUUID &amp;)&gt; on_executing =<br>      [weak_this](<span class="hljs-type">const</span> GoalUUID &amp; goal_uuid)<br>      &#123;<br>        std::shared_ptr&lt;Server&lt;ActionT&gt;&gt; shared_this = weak_this.<span class="hljs-built_in">lock</span>();<br>        <span class="hljs-keyword">if</span> (!shared_this) &#123;<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br>        (<span class="hljs-type">void</span>)goal_uuid;<br>        <span class="hljs-comment">// Publish a status message any time a goal handle changes state</span><br>        shared_this-&gt;<span class="hljs-built_in">publish_status</span>();<br>      &#125;;<br><br>    std::function&lt;<span class="hljs-type">void</span>(std::shared_ptr&lt;<span class="hljs-keyword">typename</span> ActionT::Impl::FeedbackMessage&gt;)&gt; publish_feedback =<br>      [weak_this](std::shared_ptr&lt;<span class="hljs-keyword">typename</span> ActionT::Impl::FeedbackMessage&gt; feedback_msg)<br>      &#123;<br>        std::shared_ptr&lt;Server&lt;ActionT&gt;&gt; shared_this = weak_this.<span class="hljs-built_in">lock</span>();<br>        <span class="hljs-keyword">if</span> (!shared_this) &#123;<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br>        shared_this-&gt;<span class="hljs-built_in">publish_feedback</span>(std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(feedback_msg));<br>      &#125;;<br><br>    <span class="hljs-keyword">auto</span> request = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<br>      <span class="hljs-type">const</span> <span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Request&gt;(goal_request_message);<br>    <span class="hljs-keyword">auto</span> goal = std::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-type">const</span> <span class="hljs-keyword">typename</span> ActionT::Goal&gt;(request, &amp;request-&gt;goal);<br>    goal_handle.<span class="hljs-built_in">reset</span>(<br>      <span class="hljs-keyword">new</span> <span class="hljs-built_in">ServerGoalHandle</span>&lt;ActionT&gt;(<br>        rcl_goal_handle, uuid, goal, on_terminal_state, on_executing, publish_feedback));<br>    &#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(goal_handles_mutex_)</span></span>;<br>      goal_handles_[uuid] = goal_handle;<br>    &#125;<br><br>    <span class="hljs-comment">// 调用handle_accepted_，注意这里goal_handle，作为参数传递到函数中</span><br>    <span class="hljs-built_in">handle_accepted_</span>(goal_handle);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="动作服务器客户端接收到Goal回应"><a href="#动作服务器客户端接收到Goal回应" class="headerlink" title="动作服务器客户端接收到Goal回应"></a>动作服务器客户端接收到Goal回应</h2><p>由于动作服务器客户端也是Waitable，其在执行器层处理是一致的，只不过执行器调用的是动作服务器客户端的take_data()和execute()。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/src/client.cpp</span><br><span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;</span><br><span class="hljs-function"><span class="hljs-title">ClientBase::take_data</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// next_ready_event is an atomic, caching localy</span><br>  <span class="hljs-type">size_t</span> next_ready_event = pimpl_-&gt;next_ready_event.<span class="hljs-built_in">exchange</span>(ClientBaseImpl::NO_EVENT_READY);<br><br>  <span class="hljs-keyword">if</span> (next_ready_event == ClientBaseImpl::NO_EVENT_READY) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Taking data from action client but no ready event&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">take_data_by_entity_id</span>(next_ready_event);<br>&#125;<br><br><span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;</span><br><span class="hljs-function"><span class="hljs-title">ClientBase::take_data_by_entity_id</span><span class="hljs-params">(<span class="hljs-type">size_t</span> id)</span></span><br><span class="hljs-function"></span>&#123;<br>  std::shared_ptr&lt;ClientBaseData&gt; data_ptr;<br>  <span class="hljs-type">rcl_ret_t</span> ret;<br><br>  <span class="hljs-comment">// Mark as ready the entity from which we want to take data</span><br>  <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">static_cast</span>&lt;EntityType&gt;(id)) &#123;<br>    <span class="hljs-comment">// Goal响应</span><br>    <span class="hljs-keyword">case</span> EntityType::GoalClient:<br>      &#123;<br>        <span class="hljs-type">rmw_request_id_t</span> response_header;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; goal_response;<br>        &#123;<br>          <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_client_mutex_)</span></span>;<br><br>          goal_response = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_goal_response</span>();<br>          ret = <span class="hljs-built_in">rcl_action_take_goal_response</span>(<br>            pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), &amp;response_header, goal_response.<span class="hljs-built_in">get</span>());<br>        &#125;<br>        data_ptr = std::<span class="hljs-built_in">make_shared</span>&lt;ClientBaseData&gt;(<br>          ClientBaseData::<span class="hljs-built_in">GoalResponseData</span>(<br>            ret, response_header, goal_response));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> EntityType::ResultClient:<br>      &#123;<br>        <span class="hljs-type">rmw_request_id_t</span> response_header;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_response;<br>        &#123;<br>          <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_client_mutex_)</span></span>;<br>          result_response = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_result_response</span>();<br>          ret = <span class="hljs-built_in">rcl_action_take_result_response</span>(<br>            pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), &amp;response_header, result_response.<span class="hljs-built_in">get</span>());<br>        &#125;<br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ClientBaseData&gt;(<br>          ClientBaseData::<span class="hljs-built_in">ResultResponseData</span>(<br>            ret, response_header, result_response));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> EntityType::CancelClient:<br>      &#123;<br>        <span class="hljs-type">rmw_request_id_t</span> response_header;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; cancel_response;<br>        &#123;<br>          <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_client_mutex_)</span></span>;<br>          cancel_response = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_cancel_response</span>();<br>          ret = <span class="hljs-built_in">rcl_action_take_cancel_response</span>(<br>            pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), &amp;response_header, cancel_response.<span class="hljs-built_in">get</span>());<br>        &#125;<br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ClientBaseData&gt;(<br>          ClientBaseData::<span class="hljs-built_in">CancelResponseData</span>(<br>            ret, response_header, cancel_response));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> EntityType::FeedbackSubscription:<br>      &#123;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; feedback_message;<br>        &#123;<br>          <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_client_mutex_)</span></span>;<br>          feedback_message = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_feedback_message</span>();<br>          ret = <span class="hljs-built_in">rcl_action_take_feedback</span>(<br>            pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), feedback_message.<span class="hljs-built_in">get</span>());<br>        &#125;<br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ClientBaseData&gt;(<br>          ClientBaseData::<span class="hljs-built_in">FeedbackReadyData</span>(<br>            ret, feedback_message));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> EntityType::StatusSubscription:<br>      &#123;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; status_message;<br>        &#123;<br>          <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_client_mutex_)</span></span>;<br>          status_message = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_status_message</span>();<br>          ret = <span class="hljs-built_in">rcl_action_take_status</span>(<br>            pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), status_message.<span class="hljs-built_in">get</span>());<br>        &#125;<br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ClientBaseData&gt;(<br>          ClientBaseData::<span class="hljs-built_in">StatusReadyData</span>(<br>            ret, status_message));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(data_ptr);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ClientBase::execute</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data_in)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!data_in) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Executing action client but &#x27;data&#x27; is empty&quot;</span>);<br>  &#125;<br><br>  std::shared_ptr&lt;ClientBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ClientBaseData&gt;(data_in);<br><br>  std::<span class="hljs-built_in">visit</span>(<br>    [&amp;](<span class="hljs-keyword">auto</span> &amp;&amp; data) -&gt; <span class="hljs-type">void</span> &#123;<br>      <span class="hljs-keyword">using</span> T = std::<span class="hljs-type">decay_t</span>&lt;<span class="hljs-keyword">decltype</span>(data)&gt;;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::FeedbackReadyData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_feedback_message</span>(data.feedback_message);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking feedback&quot;</span>);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::StatusReadyData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_status_message</span>(data.status_message);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking status&quot;</span>);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::GoalResponseData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_goal_response</span>(data.response_header, data.goal_response);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking goal response&quot;</span>);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::ResultResponseData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_result_response</span>(data.response_header, data.result_response);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking result response&quot;</span>);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::CancelResponseData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_cancel_response</span>(data.response_header, data.cancel_response);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking cancel response&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;, data_ptr-&gt;data);<br>&#125;<br></code></pre></td></tr></table></figure><p>整个过程类似于服务端，构建ClientBaseData，并在execute()执行handle_goal_response函数，该函数知道了Goal被服务端正确处理。此时客户端调用之前send_goal_request()注册回调函数，然后将请求从pending列表中删除：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ClientBase::handle_goal_response</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rmw_request_id_t</span> &amp; response_header,</span></span><br><span class="hljs-params"><span class="hljs-function">  std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(pimpl_-&gt;goal_requests_mutex)</span></span>;<br>  <span class="hljs-type">const</span> <span class="hljs-type">int64_t</span> &amp; sequence_number = response_header.sequence_number;<br>  <span class="hljs-keyword">if</span> (pimpl_-&gt;pending_goal_responses.<span class="hljs-built_in">count</span>(sequence_number) == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">RCLCPP_ERROR</span>(pimpl_-&gt;logger, <span class="hljs-string">&quot;unknown goal response, ignoring...&quot;</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-comment">// 这里回调send_goal_request() 注册回调函数</span><br>  pimpl_-&gt;pending_goal_responses[sequence_number](response);<br>  pimpl_-&gt;pending_goal_responses.<span class="hljs-built_in">erase</span>(sequence_number);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>我们回顾下send_goal_request()回调函数：</p><ul><li>如果Goal被拒绝了，就用nullptr调用options.goal_response_callback()</li><li>如果Goal被接受了，就用Goal 反馈调用options.goal_response_callback()</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">std::shared_future&lt;<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr&gt;</span><br><span class="hljs-function"><span class="hljs-title">async_send_goal</span><span class="hljs-params">(<span class="hljs-type">const</span> Goal &amp; goal, <span class="hljs-type">const</span> SendGoalOptions &amp; options = SendGoalOptions())</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// Put promise in the heap to move it around.</span><br>  <span class="hljs-keyword">auto</span> promise = std::make_shared&lt;std::promise&lt;<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr&gt;&gt;();<br>  <span class="hljs-function">std::shared_future&lt;<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr&gt; <span class="hljs-title">future</span><span class="hljs-params">(promise-&gt;get_future())</span></span>;<br>  <span class="hljs-keyword">using</span> GoalRequest = <span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Request;<br>  <span class="hljs-keyword">auto</span> goal_request = std::<span class="hljs-built_in">make_shared</span>&lt;GoalRequest&gt;();<br>  goal_request-&gt;goal_id.uuid = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">generate_goal_id</span>();<br>  goal_request-&gt;goal = goal;<br>  <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">send_goal_request</span>(<br>    std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(goal_request),<br>    [<span class="hljs-keyword">this</span>, goal_request, options, promise](std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response) <span class="hljs-keyword">mutable</span><br>    &#123;<br>      <span class="hljs-keyword">using</span> GoalResponse = <span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Response;<br>      <span class="hljs-keyword">auto</span> goal_response = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;GoalResponse&gt;(response);<br>      <span class="hljs-keyword">if</span> (!goal_response-&gt;accepted) &#123;<br>        promise-&gt;<span class="hljs-built_in">set_value</span>(<span class="hljs-literal">nullptr</span>);<br>        <span class="hljs-keyword">if</span> (options.goal_response_callback) &#123;<br>          options.<span class="hljs-built_in">goal_response_callback</span>(<span class="hljs-literal">nullptr</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>      GoalInfo goal_info;<br>      goal_info.goal_id.uuid = goal_request-&gt;goal_id.uuid;<br>      goal_info.stamp = goal_response-&gt;stamp;<br>      <span class="hljs-comment">// Do not use std::make_shared as friendship cannot be forwarded.</span><br>      std::shared_ptr&lt;GoalHandle&gt; <span class="hljs-built_in">goal_handle</span>(<br>        <span class="hljs-keyword">new</span> <span class="hljs-built_in">GoalHandle</span>(goal_info, options.feedback_callback, options.result_callback));<br>      &#123;<br>        std::lock_guard&lt;std::mutex&gt; <span class="hljs-built_in">guard</span>(goal_handles_mutex_);<br>        goal_handles_[goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>()] = goal_handle;<br>      &#125;<br>      promise-&gt;<span class="hljs-built_in">set_value</span>(goal_handle);<br>      <span class="hljs-keyword">if</span> (options.goal_response_callback) &#123;<br>        options.<span class="hljs-built_in">goal_response_callback</span>(goal_handle);<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (options.result_callback) &#123;<br>        <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">make_result_aware</span>(goal_handle);<br>      &#125;<br>    &#125;);<br><br>  ....<span class="hljs-comment">//其他代码逻辑</span><br><br>  <span class="hljs-keyword">return</span> future;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="动作服务器客户端发送Result请求"><a href="#动作服务器客户端发送Result请求" class="headerlink" title="动作服务器客户端发送Result请求"></a>动作服务器客户端发送Result请求</h2><p>在调用options.goal_response_callback()响应回调后，make_result_aware()会发送Result请求，并注册Result响应回调：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/client.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> : <span class="hljs-keyword">public</span> ClientBase<br>&#123;<br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">make_result_aware</span><span class="hljs-params">(<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr goal_handle)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">    <span class="hljs-title">ClientBase::send_result_request</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; request, ResponseCallback callback)</span></span><br><span class="hljs-function">    </span>&#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(pimpl_-&gt;result_requests_mutex)</span></span>;<br>      <span class="hljs-type">int64_t</span> sequence_number;<br>      <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_send_result_request</span>(<br>        pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), request.<span class="hljs-built_in">get</span>(), &amp;sequence_number);<br>      <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>        rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret, <span class="hljs-string">&quot;failed to send result request&quot;</span>);<br>      &#125;<br>      <span class="hljs-built_in">assert</span>(pimpl_-&gt;pending_result_responses.<span class="hljs-built_in">count</span>(sequence_number) == <span class="hljs-number">0</span>);<br>      pimpl_-&gt;pending_result_responses[sequence_number] = callback;<br>    &#125;<br><br>    <span class="hljs-comment">// Avoid making more than one request</span><br>    <span class="hljs-keyword">if</span> (goal_handle-&gt;<span class="hljs-built_in">set_result_awareness</span>(<span class="hljs-literal">true</span>)) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">using</span> GoalResultRequest = <span class="hljs-keyword">typename</span> ActionT::Impl::GetResultService::Request;<br>    <span class="hljs-keyword">auto</span> goal_result_request = std::<span class="hljs-built_in">make_shared</span>&lt;GoalResultRequest&gt;();<br>    goal_result_request-&gt;goal_id.uuid = goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 异步发送Result请求</span><br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">send_result_request</span>(<br>        std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(goal_result_request),<br>        [goal_handle, <span class="hljs-keyword">this</span>](std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response) <span class="hljs-keyword">mutable</span><br>        &#123;<br>          <span class="hljs-comment">// Wrap the response in a struct with the fields a user cares about</span><br>          WrappedResult wrapped_result;<br>          <span class="hljs-keyword">using</span> GoalResultResponse = <span class="hljs-keyword">typename</span> ActionT::Impl::GetResultService::Response;<br>          <span class="hljs-keyword">auto</span> result_response = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;GoalResultResponse&gt;(response);<br>          wrapped_result.result = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-keyword">typename</span> ActionT::Result&gt;();<br>          *wrapped_result.result = result_response-&gt;result;<br>          wrapped_result.goal_id = goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>();<br>          wrapped_result.code = <span class="hljs-built_in">static_cast</span>&lt;ResultCode&gt;(result_response-&gt;status);<br>          goal_handle-&gt;<span class="hljs-built_in">set_result</span>(wrapped_result);<br>          std::lock_guard&lt;std::mutex&gt; <span class="hljs-built_in">lock</span>(goal_handles_mutex_);<br>          goal_handles_.<span class="hljs-built_in">erase</span>(goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>());<br>        &#125;);<br>    &#125; <span class="hljs-built_in">catch</span> (rclcpp::exceptions::RCLError &amp; ex) &#123;<br>      <span class="hljs-comment">// This will cause an exception when the user tries to access the result</span><br>      goal_handle-&gt;<span class="hljs-built_in">invalidate</span>(exceptions::<span class="hljs-built_in">UnawareGoalHandleError</span>(ex.message));<br>    &#125;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>整个过程和Goal请求类似，这里就不在赘述了，回调函数保存在pimpl_-&gt;pending_result_responses。</p><h2 id="动作服务器服务端接收Result请求"><a href="#动作服务器服务端接收Result请求" class="headerlink" title="动作服务器服务端接收Result请求"></a>动作服务器服务端接收Result请求</h2><p>当动作服务器服务端接收到来自客户端请求，同样会触发execute()执行，进而调用到execute_result_request_received()：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;</span><br><span class="hljs-function"><span class="hljs-title">ServerBase::take_data_by_entity_id</span><span class="hljs-params">(<span class="hljs-type">size_t</span> id)</span></span><br><span class="hljs-function"></span>&#123;<br>    .......<span class="hljs-comment">//其他代码逻辑</span><br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr;<br>  <span class="hljs-comment">// Mark as ready the entity from which we want to take data</span><br>  <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">static_cast</span>&lt;ActionEventType&gt;(id)) &#123;<br>    .......<span class="hljs-comment">//其他代码逻辑</span><br>    <span class="hljs-keyword">case</span> ActionEventType::ResultService:<br>      &#123;<br>        <span class="hljs-type">rcl_ret_t</span> ret;<br>        <span class="hljs-comment">// Get the result request message</span><br>        <span class="hljs-type">rmw_request_id_t</span> request_header;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_request = <span class="hljs-built_in">create_result_request</span>();<br>        <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>        ret = <span class="hljs-built_in">rcl_action_take_result_request</span>(<br>          pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;request_header, result_request.<span class="hljs-built_in">get</span>());<br><br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ServerBaseData&gt;(<br>          ServerBaseData::<span class="hljs-built_in">ResultRequestData</span>(ret, result_request, request_header));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    .......<span class="hljs-comment">//其他代码逻辑</span><br>  &#125;<br><br>  <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(data_ptr);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::execute</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data_in)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!data_in) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Executing action server but &#x27;data&#x27; is empty&quot;</span>);<br>  &#125;<br><br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ServerBaseData&gt;(data_in);<br><br>  std::<span class="hljs-built_in">visit</span>(<br>    [&amp;](<span class="hljs-keyword">auto</span> &amp;&amp; data) -&gt; <span class="hljs-type">void</span> &#123;<br>      <span class="hljs-keyword">using</span> T = std::<span class="hljs-type">decay_t</span>&lt;<span class="hljs-keyword">decltype</span>(data)&gt;;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::GoalRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_goal_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::CancelRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_cancel_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::ResultRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_result_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::GoalExpiredData&gt;) &#123;<br>        <span class="hljs-built_in">execute_check_expired_goals</span>();<br>      &#125;<br>    &#125;,<br>    data_ptr-&gt;data);<br>&#125;<br></code></pre></td></tr></table></figure><p>execute_result_request_received()处理请求数据，注意当对应的Goal没有找到或者结果已经存在，就直接反馈，否则需要等到结果计算出来，才能回复。这里先把request存起来，因为接下来要发送Feedback。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::execute_result_request_received</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data)</span></span><br><span class="hljs-function"></span>&#123;<br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ServerBaseData&gt;(data);<br>  <span class="hljs-function"><span class="hljs-type">const</span> ServerBaseData::ResultRequestData &amp; <span class="hljs-title">gData</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    std::get&lt;ServerBaseData::ResultRequestData&gt;(data_ptr-&gt;data))</span></span>;<br><br>  <span class="hljs-type">rcl_ret_t</span> ret = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">0</span>&gt;(gData);<br>  std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_request = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">1</span>&gt;(gData);<br>  <span class="hljs-type">rmw_request_id_t</span> request_header = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">2</span>&gt;(gData);<br><br>  <span class="hljs-keyword">if</span> (RCL_RET_ACTION_SERVER_TAKE_FAILED == ret) &#123;<br>    <span class="hljs-comment">// Ignore take failure because connext fails if it receives a sample without valid data.</span><br>    <span class="hljs-comment">// This happens when a client shuts down and connext receives a sample saying the client is</span><br>    <span class="hljs-comment">// no longer alive.</span><br>    <span class="hljs-keyword">return</span>;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br><br>  std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_response;<br><br>  <span class="hljs-comment">// 根据uuid检查Goal是否存在</span><br>  GoalUUID uuid = <span class="hljs-built_in">get_goal_id_from_result_request</span>(result_request.<span class="hljs-built_in">get</span>());<br>  <span class="hljs-type">rcl_action_goal_info_t</span> goal_info;<br>  <span class="hljs-built_in">convert</span>(uuid, &amp;goal_info);<br>  <span class="hljs-type">bool</span> goal_exists;<br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>    goal_exists = <span class="hljs-built_in">rcl_action_server_goal_exists</span>(pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;goal_info);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (!goal_exists) &#123;<br>    <span class="hljs-comment">// 如果goal不存在，则返回STATUS_UNKNOWN表示错误</span><br>    result_response = <span class="hljs-built_in">create_result_response</span>(action_msgs::msg::GoalStatus::STATUS_UNKNOWN);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 如果Goal存在，并且结果也存在（多次请求?)，也立刻返回结果</span><br>    std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-built_in">lock</span>(pimpl_-&gt;unordered_map_mutex_);<br>    <span class="hljs-keyword">auto</span> iter = pimpl_-&gt;goal_results_.<span class="hljs-built_in">find</span>(uuid);<br>    <span class="hljs-keyword">if</span> (iter != pimpl_-&gt;goal_results_.<span class="hljs-built_in">end</span>()) &#123;<br>      result_response = iter-&gt;second;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 如果Goal存在，且没有结果，等待结果计算</span><br>      pimpl_-&gt;result_requests_[uuid].<span class="hljs-built_in">push_back</span>(request_header);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 如果Goal不存在或者Result已存在，立刻发送响应返回</span><br>  <span class="hljs-keyword">if</span> (result_response) &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>    <span class="hljs-type">rcl_ret_t</span> rcl_ret = <span class="hljs-built_in">rcl_action_send_result_response</span>(<br>      pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;request_header, result_response.<span class="hljs-built_in">get</span>());<br>    <span class="hljs-keyword">if</span> (rcl_ret == RCL_RET_TIMEOUT) &#123;<br>      <span class="hljs-built_in">RCLCPP_WARN</span>(<br>        pimpl_-&gt;logger_,<br>        <span class="hljs-string">&quot;Failed to send result response %s (timeout): %s&quot;</span>,<br>        <span class="hljs-built_in">to_string</span>(uuid).<span class="hljs-built_in">c_str</span>(), <span class="hljs-built_in">rcl_get_error_string</span>().str);<br>      <span class="hljs-built_in">rcl_reset_error</span>();<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (RCL_RET_OK != rcl_ret) &#123;<br>      rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(rcl_ret);<br>    &#125;<br>  &#125;<br>  data.<span class="hljs-built_in">reset</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="动作服务器服务端计算并Feedback"><a href="#动作服务器服务端计算并Feedback" class="headerlink" title="动作服务器服务端计算并Feedback"></a>动作服务器服务端计算并Feedback</h2><p>在动作服务器正在计算时，可以通过publish_feedback()发送中间结果反馈，可以通过succeed()告知计算结果已经完成：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// 反馈中间结果</span><br>goal_handle-&gt;<span class="hljs-built_in">publish_feedback</span>(feedback);<br><br><span class="hljs-comment">// 发送最后计算结果</span><br>goal_handle-&gt;<span class="hljs-built_in">succeed</span>(result);<br></code></pre></td></tr></table></figure><p>其中feedback反馈是通过话题发送回客户端：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ServerGoalHandle</span> : <span class="hljs-keyword">public</span> ServerGoalHandleBase<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">/// Send an update about the progress of a goal.</span><br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">publish_feedback</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-keyword">typename</span> ActionT::Feedback&gt; feedback_msg)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">auto</span> feedback_message = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-keyword">typename</span> ActionT::Impl::FeedbackMessage&gt;();<br>    feedback_message-&gt;goal_id.uuid = uuid_;<br>    feedback_message-&gt;feedback = *feedback_msg;<br>    <span class="hljs-comment">// 这里publish_feedback_对应于ServerBase::publish_feedback</span><br>    <span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/server.hpp:call_goal_accepted_callback()</span><br>    <span class="hljs-built_in">publish_feedback_</span>(feedback_message);<br>  &#125;<br>  ......<span class="hljs-comment">//其他代码逻辑</span><br>&#125;;<br><br><span class="hljs-comment">//src/ros2/rclcpp/rclcpp_action/src/server.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::publish_feedback</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; feedback_msg)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>  <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_publish_feedback</span>(pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), feedback_msg.<span class="hljs-built_in">get</span>());<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret, <span class="hljs-string">&quot;Failed to publish feedback&quot;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// src/ros2/rcl/rcl_action/src/rcl_action/action_server.c</span><br><span class="hljs-function"><span class="hljs-type">rcl_ret_t</span></span><br><span class="hljs-function"><span class="hljs-title">rcl_action_publish_feedback</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_server_t</span> * action_server,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">void</span> * ros_feedback)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">rcl_action_server_is_valid</span>(action_server)) &#123;<br>    <span class="hljs-keyword">return</span> RCL_RET_ACTION_SERVER_INVALID;  <span class="hljs-comment">// error already set</span><br>  &#125;<br>  <span class="hljs-built_in">RCL_CHECK_ARGUMENT_FOR_NULL</span>(ros_feedback, RCL_RET_INVALID_ARGUMENT);<br>  <span class="hljs-comment">// 这里调用rcl层直接发送话题到客户端</span><br>  <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_publish</span>(&amp;action_server-&gt;impl-&gt;feedback_publisher, ros_feedback, <span class="hljs-literal">NULL</span>);<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    <span class="hljs-keyword">return</span> RCL_RET_ERROR;  <span class="hljs-comment">// error already set</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> RCL_RET_OK;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="动作服务器客户端接收Feedback"><a href="#动作服务器客户端接收Feedback" class="headerlink" title="动作服务器客户端接收Feedback"></a>动作服务器客户端接收Feedback</h2><p>在接收到Feedback的时候，处理过程类似于Goal响应过程：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/src/client.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ClientBase::execute</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data_in)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!data_in) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Executing action client but &#x27;data&#x27; is empty&quot;</span>);<br>  &#125;<br><br>  std::shared_ptr&lt;ClientBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ClientBaseData&gt;(data_in);<br><br>  std::<span class="hljs-built_in">visit</span>(<br>    [&amp;](<span class="hljs-keyword">auto</span> &amp;&amp; data) -&gt; <span class="hljs-type">void</span> &#123;<br>      <span class="hljs-keyword">using</span> T = std::<span class="hljs-type">decay_t</span>&lt;<span class="hljs-keyword">decltype</span>(data)&gt;;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::FeedbackReadyData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_feedback_message</span>(data.feedback_message);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking feedback&quot;</span>);<br>        &#125;<br>      &#125;<br>      ......<span class="hljs-comment">//其他代码逻辑</span><br>    &#125;, data_ptr-&gt;data);<br>&#125;<br><br><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/client.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> : <span class="hljs-keyword">public</span> ClientBase<br>&#123;<br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">handle_feedback_message</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; message)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(goal_handles_mutex_)</span></span>;<br>    <span class="hljs-keyword">using</span> FeedbackMessage = <span class="hljs-keyword">typename</span> ActionT::Impl::FeedbackMessage;<br>    <span class="hljs-keyword">typename</span> FeedbackMessage::SharedPtr feedback_message =<br>      std::<span class="hljs-built_in">static_pointer_cast</span>&lt;FeedbackMessage&gt;(message);<br>    <span class="hljs-type">const</span> GoalUUID &amp; goal_id = feedback_message-&gt;goal_id.uuid;<br>    <span class="hljs-keyword">if</span> (goal_handles_.<span class="hljs-built_in">count</span>(goal_id) == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">RCLCPP_DEBUG</span>(<br>        <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(),<br>        <span class="hljs-string">&quot;Received feedback for unknown goal. Ignoring...&quot;</span>);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">typename</span> GoalHandle::SharedPtr goal_handle = goal_handles_[goal_id].<span class="hljs-built_in">lock</span>();<br>    <span class="hljs-comment">// Forget about the goal if there are no more user references</span><br>    <span class="hljs-keyword">if</span> (!goal_handle) &#123;<br>      <span class="hljs-built_in">RCLCPP_DEBUG</span>(<br>        <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(),<br>        <span class="hljs-string">&quot;Dropping weak reference to goal handle during feedback callback&quot;</span>);<br>      goal_handles_.<span class="hljs-built_in">erase</span>(goal_id);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 调用用户自定义feedback回调函数</span><br>    <span class="hljs-keyword">auto</span> feedback = std::<span class="hljs-built_in">make_shared</span>&lt;Feedback&gt;();<br>    *feedback = feedback_message-&gt;feedback;<br>    goal_handle-&gt;<span class="hljs-built_in">call_feedback_callback</span>(goal_handle, feedback);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>接收到feedback，客户端会调用用户自定义feedback回调，也就是MinimalActionClient::feedback_callback()。</p><h2 id="动作服务器服务端发送Result回应"><a href="#动作服务器服务端发送Result回应" class="headerlink" title="动作服务器服务端发送Result回应"></a>动作服务器服务端发送Result回应</h2><p>当最终的结果计算成后，succeed()负责将结果传递给服务端，并反馈给客户端：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// </span><br><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/src/server_goal_handle.cpp</span><br><span class="hljs-type">void</span><br>ServerGoalHandleBase::_succeed()<br>&#123;<br>  <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(rcl_handle_mutex_)</span></span>;<br>  <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_update_goal_state</span>(rcl_handle_.<span class="hljs-built_in">get</span>(), GOAL_EVENT_SUCCEED);<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/server_goal_handle.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ServerGoalHandle</span> : <span class="hljs-keyword">public</span> ServerGoalHandleBase<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">succeed</span><span class="hljs-params">(<span class="hljs-keyword">typename</span> ActionT::Result::SharedPtr result_msg)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-comment">// 更新rcl内部goal状态</span><br>    _succeed();<br>    <span class="hljs-keyword">auto</span> response = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-keyword">typename</span> ActionT::Impl::GetResultService::Response&gt;();<br>    response-&gt;status = action_msgs::msg::GoalStatus::STATUS_SUCCEEDED;<br>    response-&gt;result = *result_msg;<br><br>    <span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/server.hpp:call_goal_accepted_callback()</span><br>    <span class="hljs-built_in">on_terminal_state_</span>(uuid_, response);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>on_terminal_state_是在ServerGoalHandle构建的时候填充的，回调函数在call_goal_accepted_callback()定义：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> : <span class="hljs-keyword">public</span> ServerBase, <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;Server&lt;ActionT&gt;&gt;<br>&#123;<br><span class="hljs-keyword">public</span>:<br> <span class="hljs-comment">/// \internal</span><br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">call_goal_accepted_callback</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    std::shared_ptr&lt;<span class="hljs-type">rcl_action_goal_handle_t</span>&gt; rcl_goal_handle,</span></span><br><span class="hljs-params"><span class="hljs-function">    GoalUUID uuid, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; goal_request_message)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function">  </span>&#123;<br>    std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt; goal_handle;<br>    std::weak_ptr&lt;Server&lt;ActionT&gt;&gt; weak_this = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">shared_from_this</span>();<br><br>    std::function&lt;<span class="hljs-type">void</span>(<span class="hljs-type">const</span> GoalUUID &amp;, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;)&gt; on_terminal_state =<br>      [weak_this](<span class="hljs-type">const</span> GoalUUID &amp; goal_uuid, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_message)<br>      &#123;<br>        std::shared_ptr&lt;Server&lt;ActionT&gt;&gt; shared_this = weak_this.<span class="hljs-built_in">lock</span>();<br>        <span class="hljs-keyword">if</span> (!shared_this) &#123;<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// Send result message to anyone that asked</span><br>        shared_this-&gt;<span class="hljs-built_in">publish_result</span>(goal_uuid, result_message);<br>        <span class="hljs-comment">// Publish a status message any time a goal handle changes state</span><br>        shared_this-&gt;<span class="hljs-built_in">publish_status</span>();<br>        <span class="hljs-comment">// notify base so it can recalculate the expired goal timer</span><br>        shared_this-&gt;<span class="hljs-built_in">notify_goal_terminal_state</span>();<br>        <span class="hljs-comment">// Delete data now (ServerBase and rcl_action_server_t keep data until goal handle expires)</span><br>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(shared_this-&gt;goal_handles_mutex_)</span></span>;<br>        shared_this-&gt;goal_handles_.<span class="hljs-built_in">erase</span>(goal_uuid);<br>      &#125;;<br>  ......<span class="hljs-comment">// 其他代码逻辑</span><br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>回调函数中将结果反馈给客户端，并且从goal_handles_移除当前goal，因为已经计算完毕了：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::publish_result</span><span class="hljs-params">(<span class="hljs-type">const</span> GoalUUID &amp; uuid, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_msg)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// 由于要发送结果给客户端，首先检查服务端Goal是否存在</span><br>  <span class="hljs-type">rcl_action_goal_info_t</span> goal_info;<br>  <span class="hljs-built_in">convert</span>(uuid, &amp;goal_info);<br>  <span class="hljs-type">bool</span> goal_exists;<br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>    goal_exists = <span class="hljs-built_in">rcl_action_server_goal_exists</span>(pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;goal_info);<br>  &#125;<br><br>  <span class="hljs-comment">// 不存在就抛出异常（不应该发生）</span><br>  <span class="hljs-keyword">if</span> (!goal_exists) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Asked to publish result for goal that does not exist&quot;</span>);<br>  &#125;<br><br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">unordered_map_lock</span><span class="hljs-params">(pimpl_-&gt;unordered_map_mutex_)</span></span>;<br>    pimpl_-&gt;goal_results_[uuid] = result_msg;<br><br>    <span class="hljs-comment">// if there are clients who already asked for the result, send it to them</span><br>    <span class="hljs-keyword">auto</span> iter = pimpl_-&gt;result_requests_.<span class="hljs-built_in">find</span>(uuid);<br>    <span class="hljs-keyword">if</span> (iter != pimpl_-&gt;result_requests_.<span class="hljs-built_in">end</span>()) &#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> &amp; request_header : iter-&gt;second) &#123;<br><br>        <span class="hljs-comment">// 给客户端发送结果响应</span><br>        <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_send_result_response</span>(<br>          pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;request_header, result_msg.<span class="hljs-built_in">get</span>());<br>        <span class="hljs-keyword">if</span> (ret == RCL_RET_TIMEOUT) &#123;<br>          <span class="hljs-built_in">RCLCPP_WARN</span>(<br>            pimpl_-&gt;logger_,<br>            <span class="hljs-string">&quot;Failed to send result response %s (timeout): %s&quot;</span>,<br>            <span class="hljs-built_in">to_string</span>(uuid).<span class="hljs-built_in">c_str</span>(), <span class="hljs-built_in">rcl_get_error_string</span>().str);<br>          <span class="hljs-built_in">rcl_reset_error</span>();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="动作服务器客户端接收到Result回应"><a href="#动作服务器客户端接收到Result回应" class="headerlink" title="动作服务器客户端接收到Result回应"></a>动作服务器客户端接收到Result回应</h2><p>类似的动作服务器Goal处理回应过程，结果回应的处理如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/src/client.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ClientBase::handle_result_response</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rmw_request_id_t</span> &amp; response_header,</span></span><br><span class="hljs-params"><span class="hljs-function">  std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response)</span></span><br><span class="hljs-function"></span>&#123;<br>  ResponseCallback response_callback;<br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(pimpl_-&gt;result_requests_mutex)</span></span>;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int64_t</span> &amp; sequence_number = response_header.sequence_number;<br>    <span class="hljs-keyword">if</span> (pimpl_-&gt;pending_result_responses.<span class="hljs-built_in">count</span>(sequence_number) == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">RCLCPP_ERROR</span>(pimpl_-&gt;logger, <span class="hljs-string">&quot;unknown result response, ignoring...&quot;</span>);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    response_callback = std::<span class="hljs-built_in">move</span>(pimpl_-&gt;pending_result_responses[sequence_number]);<br>    pimpl_-&gt;pending_result_responses.<span class="hljs-built_in">erase</span>(sequence_number);<br>  &#125;<br>  <span class="hljs-built_in">response_callback</span>(response);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ClientBase::execute</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data_in)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!data_in) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Executing action client but &#x27;data&#x27; is empty&quot;</span>);<br>  &#125;<br><br>  std::shared_ptr&lt;ClientBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ClientBaseData&gt;(data_in);<br><br>  std::<span class="hljs-built_in">visit</span>(<br>    [&amp;](<span class="hljs-keyword">auto</span> &amp;&amp; data) -&gt; <span class="hljs-type">void</span> &#123;<br>      <span class="hljs-keyword">using</span> T = std::<span class="hljs-type">decay_t</span>&lt;<span class="hljs-keyword">decltype</span>(data)&gt;;<br>      ......<span class="hljs-comment">//其他代码逻辑</span><br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::ResultResponseData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_result_response</span>(data.response_header, data.result_response);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking result response&quot;</span>);<br>        &#125;<br>      &#125;<br>      ......<span class="hljs-comment">//其他代码逻辑</span><br>    &#125;, data_ptr-&gt;data);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>客户端首先擦除了pimpl_-&gt;pending_result_responses对应结果响应，然后调用response_callback()，该函数就是客户端注册的回调MinimalActionClient::result_callback()，即用户可以针对结果的回调函数。</p><h2 id="动作服务器客户端发送Cancel请求"><a href="#动作服务器客户端发送Cancel请求" class="headerlink" title="动作服务器客户端发送Cancel请求"></a>动作服务器客户端发送Cancel请求</h2><p>从之前代码可以看到，除了Goal Service和Result Service，还有一个Cancel Service，由于Cancel对于服务端影响较大，所以这里我们重点关注服务端行为：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::execute</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data_in)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!data_in) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Executing action server but &#x27;data&#x27; is empty&quot;</span>);<br>  &#125;<br><br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ServerBaseData&gt;(data_in);<br><br>  std::<span class="hljs-built_in">visit</span>(<br>    [&amp;](<span class="hljs-keyword">auto</span> &amp;&amp; data) -&gt; <span class="hljs-type">void</span> &#123;<br>      <span class="hljs-keyword">using</span> T = std::<span class="hljs-type">decay_t</span>&lt;<span class="hljs-keyword">decltype</span>(data)&gt;;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::GoalRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_goal_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::CancelRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_cancel_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::ResultRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_result_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::GoalExpiredData&gt;) &#123;<br>        <span class="hljs-built_in">execute_check_expired_goals</span>();<br>      &#125;<br>    &#125;,<br>    data_ptr-&gt;data);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>当接收到Cancel消息后，动作服务器客户端则执行execute_result_request_received()，尝试取消当前正在进行的goal：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::execute_cancel_request_received</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data)</span></span><br><span class="hljs-function"></span>&#123;<br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ServerBaseData&gt;(data);<br>  <span class="hljs-function"><span class="hljs-type">const</span> ServerBaseData::CancelRequestData &amp; <span class="hljs-title">gData</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    std::get&lt;ServerBaseData::CancelRequestData&gt;(data_ptr-&gt;data))</span></span>;<br><br>  <span class="hljs-type">rcl_ret_t</span> ret = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">0</span>&gt;(gData);<br>  std::shared_ptr&lt;action_msgs::srv::CancelGoal::Request&gt; request = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">1</span>&gt;(gData);<br>  <span class="hljs-type">rmw_request_id_t</span> request_header = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">2</span>&gt;(gData);<br><br><br>  <span class="hljs-keyword">if</span> (RCL_RET_ACTION_SERVER_TAKE_FAILED == ret) &#123;<br>    <span class="hljs-comment">// Ignore take failure because connext fails if it receives a sample without valid data.</span><br>    <span class="hljs-comment">// This happens when a client shuts down and connext receives a sample saying the client is</span><br>    <span class="hljs-comment">// no longer alive.</span><br>    <span class="hljs-keyword">return</span>;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br><br>  <span class="hljs-comment">// Convert c++ message to C message</span><br>  <span class="hljs-type">rcl_action_cancel_request_t</span> cancel_request = <span class="hljs-built_in">rcl_action_get_zero_initialized_cancel_request</span>();<br>  <span class="hljs-built_in">convert</span>(request-&gt;goal_info.goal_id.uuid, &amp;cancel_request.goal_info);<br>  cancel_request.goal_info.stamp.sec = request-&gt;goal_info.stamp.sec;<br>  cancel_request.goal_info.stamp.nanosec = request-&gt;goal_info.stamp.nanosec;<br><br>  <span class="hljs-comment">// Get a list of goal info that should be attempted to be cancelled</span><br>  <span class="hljs-type">rcl_action_cancel_response_t</span> cancel_response = <span class="hljs-built_in">rcl_action_get_zero_initialized_cancel_response</span>();<br><br>  <span class="hljs-comment">// 首先底层判断是否可以取消当前Goal，并且初始化cancel_response</span><br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>    ret = <span class="hljs-built_in">rcl_action_process_cancel_request</span>(<br>      pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(),<br>      &amp;cancel_request,<br>      &amp;cancel_response);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br>  <span class="hljs-comment">// 这段代码在退出的时候执行，销毁cancel_response</span><br>  <span class="hljs-built_in">RCPPUTILS_SCOPE_EXIT</span>(<br>  &#123;<br>    ret = <span class="hljs-built_in">rcl_action_cancel_response_fini</span>(&amp;cancel_response);<br>    <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>      <span class="hljs-built_in">RCLCPP_ERROR</span>(pimpl_-&gt;logger_, <span class="hljs-string">&quot;Failed to fini cancel response&quot;</span>);<br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-keyword">auto</span> response = std::<span class="hljs-built_in">make_shared</span>&lt;action_msgs::srv::CancelGoal::Response&gt;();<br><br>  response-&gt;return_code = cancel_response.msg.return_code;<br>  <span class="hljs-keyword">auto</span> &amp; goals = cancel_response.msg.goals_canceling;<br>  <span class="hljs-comment">// 对于每一个Goal，调用用户自定义的取消函数：MinimalActionServer::handle_cancel</span><br>  <span class="hljs-comment">// 这里有个疑问，会有多个Goal同时存在？</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; goals.size; ++i) &#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_goal_info_t</span> &amp; goal_info = goals.data[i];<br>    GoalUUID uuid;<br>    <span class="hljs-built_in">convert</span>(goal_info, &amp;uuid);<br>    <span class="hljs-keyword">auto</span> response_code = <span class="hljs-built_in">call_handle_cancel_callback</span>(uuid);<br>    <span class="hljs-keyword">if</span> (CancelResponse::ACCEPT == response_code) &#123;<br>      action_msgs::msg::GoalInfo cpp_info;<br>      cpp_info.goal_id.uuid = uuid;<br>      cpp_info.stamp.sec = goal_info.stamp.sec;<br>      cpp_info.stamp.nanosec = goal_info.stamp.nanosec;<br>      response-&gt;goals_canceling.<span class="hljs-built_in">push_back</span>(cpp_info);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// If the user rejects all individual requests to cancel goals,</span><br>  <span class="hljs-comment">// then we consider the top-level cancel request as rejected.</span><br>  <span class="hljs-keyword">if</span> (goals.size &gt;= <span class="hljs-number">1u</span> &amp;&amp; <span class="hljs-number">0u</span> == response-&gt;goals_canceling.<span class="hljs-built_in">size</span>()) &#123;<br>    response-&gt;return_code = action_msgs::srv::CancelGoal::Response::ERROR_REJECTED;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (!response-&gt;goals_canceling.<span class="hljs-built_in">empty</span>()) &#123;<br>    <span class="hljs-comment">// 有Goal状态改变了，这里通知变更</span><br>    <span class="hljs-built_in">publish_status</span>();<br>  &#125;<br><br>  <span class="hljs-comment">// 发送取消反馈给客户端，告知客户端取消已经完成</span><br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>    ret = <span class="hljs-built_in">rcl_action_send_cancel_response</span>(<br>      pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;request_header, response.<span class="hljs-built_in">get</span>());<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (ret == RCL_RET_TIMEOUT) &#123;<br>    GoalUUID uuid = request-&gt;goal_info.goal_id.uuid;<br>    <span class="hljs-built_in">RCLCPP_WARN</span>(<br>      pimpl_-&gt;logger_,<br>      <span class="hljs-string">&quot;Failed to send cancel response %s (timeout): %s&quot;</span>,<br>      <span class="hljs-built_in">to_string</span>(uuid).<span class="hljs-built_in">c_str</span>(), <span class="hljs-built_in">rcl_get_error_string</span>().str);<br>    <span class="hljs-built_in">rcl_reset_error</span>();<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br>  data.<span class="hljs-built_in">reset</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>其中call_handle_cancel_callback()，调用用户自定义的回调函数handle_cancel_()，即用户注册的MinimalActionServer::handle_cancel()</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> : <span class="hljs-keyword">public</span> ServerBase, <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;Server&lt;ActionT&gt;&gt;<br>&#123;<br><span class="hljs-comment">/// \internal</span><br>  <span class="hljs-function">CancelResponse</span><br><span class="hljs-function">  <span class="hljs-title">call_handle_cancel_callback</span><span class="hljs-params">(<span class="hljs-type">const</span> GoalUUID &amp; uuid)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function">  </span>&#123;<br>    std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt; goal_handle;<br>    &#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(goal_handles_mutex_)</span></span>;<br>      <span class="hljs-keyword">auto</span> element = goal_handles_.<span class="hljs-built_in">find</span>(uuid);<br>      <span class="hljs-keyword">if</span> (element != goal_handles_.<span class="hljs-built_in">end</span>()) &#123;<br>        goal_handle = element-&gt;second.<span class="hljs-built_in">lock</span>();<br>      &#125;<br>    &#125;<br><br>    CancelResponse resp = CancelResponse::REJECT;<br>    <span class="hljs-keyword">if</span> (goal_handle) &#123;<br>      resp = <span class="hljs-built_in">handle_cancel_</span>(goal_handle);<br>      <span class="hljs-keyword">if</span> (CancelResponse::ACCEPT == resp) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          goal_handle-&gt;_cancel_goal();<br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> rclcpp::exceptions::RCLError &amp; ex) &#123;<br>          <span class="hljs-built_in">RCLCPP_DEBUG</span>(<br>            rclcpp::<span class="hljs-built_in">get_logger</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>),<br>            <span class="hljs-string">&quot;Failed to cancel goal in call_handle_cancel_callback: %s&quot;</span>, ex.<span class="hljs-built_in">what</span>());<br>          <span class="hljs-keyword">return</span> CancelResponse::REJECT;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> resp;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>至此动作服务器整体行为已经了解清楚，在细节上还有一些疑问，如Cancel如果发生在边界之类位置，会导致什么后果等，留待以后分析。</p>]]></content>
    
    
    <categories>
      
      <category>ROS2</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ROS2</tag>
      
      <tag>Humble</tag>
      
      <tag>Action</tag>
      
      <tag>ROS2-Action</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ROS2 Service详解</title>
    <link href="/2025/04/14/-1-%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%80%E6%9C%AF%E6%A0%88/-1-ROS2%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/-1-ROS2-Humble%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/%E3%80%902%E3%80%91ROS2%20Service%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/04/14/-1-%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%80%E6%9C%AF%E6%A0%88/-1-ROS2%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/-1-ROS2-Humble%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/%E3%80%902%E3%80%91ROS2%20Service%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<div class="note note-success">            <p>本文由 ZiQingDream 编写，未经允许禁止转载。</p><p>本文作者：工程课代表[B站] &#x2F; ZiQingDream[Github]</p>          </div><p>在之前的《ROS2 Executor详解》文章中，我们解释了调度器怎么处理回调和回调组。对于ROS2客户端-服务端架构，服务端符合之前所说的回调机制，这里不再赘述。该文将重心放到客户端的上，ROS2的客户端包含两种写法，同步客户端和异步客户端。</p><div class="note note-success">            <p>阅读本文需要你有一定ROS2基本理解，至少要有关于客户端-服务端基础知识。</p>          </div><h2 id="ROS2-服务机制"><a href="#ROS2-服务机制" class="headerlink" title="ROS2 服务机制"></a>ROS2 服务机制</h2><p>ROS2官网中关于Service的可视化图，整个处理流程如下（<a href="https://docs.ros.org/en/humble/Tutorials/Beginner-CLI-Tools/Understanding-ROS2-Services/Understanding-ROS2-Services.html">Understanding services — ROS 2 Documentation: Humble documentation</a>）：。</p><p><img src="/img/ros2-service/service.gif"></p><p>ROS2 Service类似于网络通信中“服务端-客户端”架构，客户端发送请求给服务端，服务端（Server）接收到请求，会执行预先注册回调函数。ROS2 Service服务端符合《ROS2 Executor详解》中的回调机制，这里不在赘述。Service模式属于”N-1”模式，多个客户端（Client）发送请求给服务端，服务端每次处理一个请求，并返回相应。（这也同样受回调组的影响）</p><p>客户端代码流程一般如下图。在客户端代码中，等待结果返回方式有两种模式：同步模式和异步回调模式。无论哪一种模式，请求的发送都是异步发送的。也就是说在发送完请求后，可以不必等待，去做其他工作，在之后合适的时机去等待、检查结果返回，并对结果做进一步处理。</p><p><img src="/img/ros2-service/service_flow.png"></p><h1 id="同步Service-Client模式"><a href="#同步Service-Client模式" class="headerlink" title="同步Service-Client模式"></a>同步Service-Client模式</h1><h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cinttypes&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;example_interfaces/srv/add_two_ints.hpp&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp/rclcpp.hpp&quot;</span></span><br><br><span class="hljs-keyword">using</span> AddTwoInts = example_interfaces::srv::AddTwoInts;<br>rclcpp::Node::SharedPtr g_node = <span class="hljs-literal">nullptr</span>;<br><br><span class="hljs-comment">// 服务端回调，用于处理客户端请求</span><br><span class="hljs-comment">// 由于只有一个线程运行，整个服务处理一定要尽快完成</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_service</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> std::shared_ptr&lt;<span class="hljs-type">rmw_request_id_t</span>&gt; request_header,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> std::shared_ptr&lt;AddTwoInts::Request&gt; request,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> std::shared_ptr&lt;AddTwoInts::Response&gt; response)</span></span><br><span class="hljs-function"></span>&#123;<br>  (<span class="hljs-type">void</span>)request_header;<br>  <span class="hljs-built_in">RCLCPP_INFO</span>(<br>    g_node-&gt;<span class="hljs-built_in">get_logger</span>(),<br>    <span class="hljs-string">&quot;request: %&quot;</span> PRId64 <span class="hljs-string">&quot; + %&quot;</span> PRId64, request-&gt;a, request-&gt;b);<br>  response-&gt;sum = request-&gt;a + request-&gt;b;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">init</span>(argc, argv);<br>  g_node = rclcpp::Node::<span class="hljs-built_in">make_shared</span>(<span class="hljs-string">&quot;minimal_service&quot;</span>);<br>  <span class="hljs-keyword">auto</span> server = g_node-&gt;<span class="hljs-built_in">create_service</span>&lt;AddTwoInts&gt;(<span class="hljs-string">&quot;add_two_ints&quot;</span>, handle_service);<br>  rclcpp::<span class="hljs-built_in">spin</span>(g_node);<br>  rclcpp::<span class="hljs-built_in">shutdown</span>();<br>  g_node = <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="同步客户端"><a href="#同步客户端" class="headerlink" title="同步客户端"></a>同步客户端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cinttypes&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;example_interfaces/srv/add_two_ints.hpp&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp/rclcpp.hpp&quot;</span></span><br><br><span class="hljs-keyword">using</span> AddTwoInts = example_interfaces::srv::AddTwoInts;<br><br><span class="hljs-comment">// 注意这里并没有建立一个新的类</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">init</span>(argc, argv);<br><br>  <span class="hljs-comment">// 首先建立一个node节点</span><br>  <span class="hljs-keyword">auto</span> node = rclcpp::Node::<span class="hljs-built_in">make_shared</span>(<span class="hljs-string">&quot;minimal_client&quot;</span>);<br><br>  <span class="hljs-comment">// 调用节点API创建一个客户端</span><br>  <span class="hljs-keyword">auto</span> client = node-&gt;<span class="hljs-built_in">create_client</span>&lt;AddTwoInts&gt;(<span class="hljs-string">&quot;add_two_ints&quot;</span>);<br><br>  <span class="hljs-comment">// 等待服务端服务可用</span><br>  <span class="hljs-keyword">while</span> (!client-&gt;<span class="hljs-built_in">wait_for_service</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>))) &#123;<br>    <span class="hljs-keyword">if</span> (!rclcpp::<span class="hljs-built_in">ok</span>()) &#123;<br>      <span class="hljs-built_in">RCLCPP_ERROR</span>(node-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;client interrupted while waiting for service to appear.&quot;</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-built_in">RCLCPP_INFO</span>(node-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;waiting for service to appear...&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// 新建请求，填充数据</span><br>  <span class="hljs-keyword">auto</span> request = std::<span class="hljs-built_in">make_shared</span>&lt;AddTwoInts::Request&gt;();<br>  request-&gt;a = <span class="hljs-number">41</span>;<br>  request-&gt;b = <span class="hljs-number">1</span>;<br><br>  <span class="hljs-comment">// 异步发送到服务端</span><br>  <span class="hljs-keyword">auto</span> result_future = client-&gt;<span class="hljs-built_in">async_send_request</span>(request);<br><br>  <span class="hljs-comment">// 等待服务端处理完成</span><br>  <span class="hljs-comment">// 注意这里的node不能被加入到executor，否则程序会报错崩溃</span><br>  <span class="hljs-keyword">if</span> (rclcpp::<span class="hljs-built_in">spin_until_future_complete</span>(node, result_future) != rclcpp::FutureReturnCode::SUCCESS)<br>  &#123;<br>    <span class="hljs-comment">// 失败的话，要移除挂起的请求</span><br>    <span class="hljs-built_in">RCLCPP_ERROR</span>(node-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;service call failed :(&quot;</span>);<br>    client-&gt;<span class="hljs-built_in">remove_pending_request</span>(result_future);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// 获取客户端结果</span><br>  <span class="hljs-keyword">auto</span> result = result_future.<span class="hljs-built_in">get</span>();<br>  <span class="hljs-built_in">RCLCPP_INFO</span>(<br>    node-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;result of %&quot;</span> PRId64 <span class="hljs-string">&quot; + %&quot;</span> PRId64 <span class="hljs-string">&quot; = %&quot;</span> PRId64,<br>    request-&gt;a, request-&gt;b, result-&gt;sum);<br>    <br>  rclcpp::<span class="hljs-built_in">shutdown</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="同步客户端分析"><a href="#同步客户端分析" class="headerlink" title="同步客户端分析"></a>同步客户端分析</h2><p>如之前所述，请求发送是异步的，通过调用async_send_request()函数，请求被通过DDS发送给服务端：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">auto</span> result_future = client-&gt;<span class="hljs-built_in">async_send_request</span>(request);<br></code></pre></td></tr></table></figure><p>async_send_request()异步发送的代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/include/rclcpp/client.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ServiceT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> : <span class="hljs-keyword">public</span> ClientBase<br>&#123;<br>  <span class="hljs-comment">// 请求和回复是在服务消息中定义的</span><br>  <span class="hljs-keyword">using</span> Request = <span class="hljs-keyword">typename</span> ServiceT::Request;<br>  <span class="hljs-keyword">using</span> Response = <span class="hljs-keyword">typename</span> ServiceT::Response;<br><br>  <span class="hljs-keyword">using</span> SharedRequest = <span class="hljs-keyword">typename</span> ServiceT::Request::SharedPtr;<br>  <span class="hljs-keyword">using</span> SharedResponse = <span class="hljs-keyword">typename</span> ServiceT::Response::SharedPtr;<br><br>  <span class="hljs-comment">// 服务的Promise，其实相当于std::promise</span><br>  <span class="hljs-keyword">using</span> Promise = std::promise&lt;SharedResponse&gt;;<br>  <span class="hljs-keyword">using</span> PromiseWithRequest = std::promise&lt;std::pair&lt;SharedRequest, SharedResponse&gt;&gt;;<br><br>  <span class="hljs-keyword">using</span> SharedPromise = std::shared_ptr&lt;Promise&gt;;<br>  <span class="hljs-keyword">using</span> SharedPromiseWithRequest = std::shared_ptr&lt;PromiseWithRequest&gt;;<br><br>  <span class="hljs-comment">// 服务的Future，其实相当于std::future</span><br>  <span class="hljs-keyword">using</span> Future = std::future&lt;SharedResponse&gt;;<br>  <span class="hljs-keyword">using</span> SharedFuture = std::shared_future&lt;SharedResponse&gt;;<br>  <span class="hljs-keyword">using</span> SharedFutureWithRequest = std::shared_future&lt;std::pair&lt;SharedRequest, SharedResponse&gt;&gt;;<br><br>  <span class="hljs-comment">// 回调类型</span><br>  <span class="hljs-keyword">using</span> CallbackType = std::function&lt;<span class="hljs-built_in">void</span> (SharedFuture)&gt;;<br>  <span class="hljs-keyword">using</span> CallbackWithRequestType = std::function&lt;<span class="hljs-built_in">void</span> (SharedFutureWithRequest)&gt;;<br><br>  <span class="hljs-comment">// detail::FutureAndRequestId 其实是 future和ID的封装</span><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">FutureAndRequestId</span><br>    : detail::FutureAndRequestId&lt;std::future&lt;SharedResponse&gt;&gt;<br>  &#123;<br>    <span class="hljs-keyword">using</span> detail::FutureAndRequestId&lt;std::future&lt;SharedResponse&gt;&gt;::FutureAndRequestId;<br>    <span class="hljs-comment">/// See std::future::share().</span><br>    <span class="hljs-function">SharedFuture <span class="hljs-title">share</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>-&gt;future.<span class="hljs-built_in">share</span>();&#125;<br>  &#125;;<br><br>  <span class="hljs-function">FutureAndRequestId <span class="hljs-title">async_send_request</span><span class="hljs-params">(SharedRequest request)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-comment">// 建立promise，并且获取对应future，以便异步操作</span><br>    Promise promise;<br>    <span class="hljs-keyword">auto</span> future = promise.<span class="hljs-built_in">get_future</span>();<br><br>    <span class="hljs-comment">// 执行异步发送，并且这里promise，通过std::move将控制权交出去了</span><br>    <span class="hljs-keyword">auto</span> req_id = <span class="hljs-built_in">async_send_request_impl</span>(<br>      *request,<br>      std::<span class="hljs-built_in">move</span>(promise));<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">FutureAndRequestId</span>(std::<span class="hljs-built_in">move</span>(future), req_id);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>async_send_request()首先建立promise并获取future（注意这里的future带有一个请求ID），以便未来能够通过promise通知结果已经准备好。（如果对这部分不清楚，可以参考std::promise）。消息发送的流程，交给了async_send_request_impl()函数。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ServiceT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> : <span class="hljs-keyword">public</span> ClientBase<br>&#123;<br>  <span class="hljs-keyword">using</span> CallbackTypeValueVariant = std::tuple&lt;CallbackType, SharedFuture, Promise&gt;;<br>  <span class="hljs-keyword">using</span> CallbackWithRequestTypeValueVariant = std::tuple&lt;<br>    CallbackWithRequestType, SharedRequest, SharedFutureWithRequest, PromiseWithRequest&gt;;<br><br>  <span class="hljs-keyword">using</span> CallbackInfoVariant = std::variant&lt;<br>    std::promise&lt;SharedResponse&gt;,<br>    CallbackTypeValueVariant,<br>    CallbackWithRequestTypeValueVariant&gt;;<br>  <span class="hljs-comment">// </span><br>  <span class="hljs-function"><span class="hljs-type">int64_t</span> <span class="hljs-title">async_send_request_impl</span><span class="hljs-params">(<span class="hljs-type">const</span> Request &amp; request, CallbackInfoVariant value)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-type">int64_t</span> sequence_number;<br>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pending_requests_mutex_)</span></span>;<br>    <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_send_request</span>(<span class="hljs-built_in">get_client_handle</span>().<span class="hljs-built_in">get</span>(), &amp;request, &amp;sequence_number);<br>    <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>      rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret, <span class="hljs-string">&quot;failed to send request&quot;</span>);<br>    &#125;<br>    pending_requests_.<span class="hljs-built_in">try_emplace</span>(<br>      sequence_number,<br>      std::<span class="hljs-built_in">make_pair</span>(std::chrono::system_clock::<span class="hljs-built_in">now</span>(), std::<span class="hljs-built_in">move</span>(value)));<br>    <span class="hljs-keyword">return</span> sequence_number;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>async_send_request_impl()通过调用RCL层rcl_send_request()发送请求，并返回请求ID。然后以这个ID为键，将请求保留到pending_requests_，表明该请求在处理，之后收到服务端的反馈后，程序会pending_requests_中找到对应的请求Promise，然后通知客户端，结果已经返回。另外如果客户端不想接受反馈（例如出错了），则需要将请求从pending_requests_移除，防止回调被调用，这也很重要。<br>RCL底层细节暂不关注，请求发出后，返回的future就是等待任务完成的手段，程序通过spin_until_future_complete()等待结果返回：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">auto</span> request = std::<span class="hljs-built_in">make_shared</span>&lt;AddTwoInts::Request&gt;();<br>request-&gt;a = <span class="hljs-number">41</span>;<br>request-&gt;b = <span class="hljs-number">1</span>;<br><span class="hljs-keyword">auto</span> result_future = client-&gt;<span class="hljs-built_in">async_send_request</span>(request);<br><span class="hljs-keyword">if</span> (rclcpp::<span class="hljs-built_in">spin_until_future_complete</span>(node, result_future) != rclcpp::FutureReturnCode::SUCCESS)<br>&#123;<br>  <span class="hljs-built_in">RCLCPP_ERROR</span>(node-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;service call failed :(&quot;</span>);<br>  client-&gt;<span class="hljs-built_in">remove_pending_request</span>(result_future);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p>这里有一个问题：为什么不能直接调用future.get()？</p>          </div><p>要回答这个问题，我们需要深入spin_until_future_complete()函数，看下有什么额外的操作：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/include/rclcpp/executors.hpp</span><br><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> FutureT, <span class="hljs-keyword">typename</span> TimeRepT </span>= <span class="hljs-type">int64_t</span>, <span class="hljs-keyword">typename</span> TimeT = std::milli&gt;<br>rclcpp::FutureReturnCode<br><span class="hljs-built_in">spin_until_future_complete</span>(<br>  rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_ptr,<br>  <span class="hljs-type">const</span> FutureT &amp; future,<br>  std::chrono::duration&lt;TimeRepT, TimeT&gt; timeout = std::chrono::<span class="hljs-built_in">duration</span>&lt;TimeRepT, TimeT&gt;(<span class="hljs-number">-1</span>))<br>&#123;<br>  rclcpp::ExecutorOptions options;<br>  options.context = node_ptr-&gt;<span class="hljs-built_in">get_context</span>();<br>  rclcpp::<span class="hljs-function">executors::SingleThreadedExecutor <span class="hljs-title">executor</span><span class="hljs-params">(options)</span></span>;<br>  <span class="hljs-keyword">return</span> executors::<span class="hljs-built_in">spin_node_until_future_complete</span>&lt;FutureT&gt;(executor, node_ptr, future, timeout);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> NodeT </span>= rclcpp::Node, <span class="hljs-keyword">typename</span> FutureT, <span class="hljs-keyword">typename</span> TimeRepT = <span class="hljs-type">int64_t</span>,<br>  <span class="hljs-keyword">typename</span> TimeT = std::milli&gt;<br>rclcpp::FutureReturnCode<br><span class="hljs-built_in">spin_until_future_complete</span>(<br>  std::shared_ptr&lt;NodeT&gt; node_ptr,<br>  <span class="hljs-type">const</span> FutureT &amp; future,<br>  std::chrono::duration&lt;TimeRepT, TimeT&gt; timeout = std::chrono::<span class="hljs-built_in">duration</span>&lt;TimeRepT, TimeT&gt;(<span class="hljs-number">-1</span>))<br>&#123;<br>  <span class="hljs-keyword">return</span> rclcpp::<span class="hljs-built_in">spin_until_future_complete</span>(node_ptr-&gt;<span class="hljs-built_in">get_node_base_interface</span>(), future, timeout);<br>&#125;<br></code></pre></td></tr></table></figure><p>在spin_until_future_complete()中建立一个单线程执行器，然后将传入的节点加入到单线程执行器，从而提供了与ROS2底层通信交互的能力，该执行器负责驱动底层获取由服务端反馈的消息。具体细节如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/include/rclcpp/executors.hpp</span><br><span class="hljs-keyword">namespace</span> executors<br>&#123;<br><span class="hljs-keyword">using</span> rclcpp::executors::MultiThreadedExecutor;<br><span class="hljs-keyword">using</span> rclcpp::executors::SingleThreadedExecutor;<br><br><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> FutureT, <span class="hljs-keyword">typename</span> TimeRepT </span>= <span class="hljs-type">int64_t</span>, <span class="hljs-keyword">typename</span> TimeT = std::milli&gt;<br>rclcpp::FutureReturnCode<br><span class="hljs-built_in">spin_node_until_future_complete</span>(<br>  rclcpp::Executor &amp; executor,<br>  rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_ptr,<br>  <span class="hljs-type">const</span> FutureT &amp; future,<br>  std::chrono::duration&lt;TimeRepT, TimeT&gt; timeout = std::chrono::<span class="hljs-built_in">duration</span>&lt;TimeRepT, TimeT&gt;(<span class="hljs-number">-1</span>))<br>&#123;<br>  <span class="hljs-comment">// TODO(wjwwood): does not work recursively; can&#x27;t call spin_node_until_future_complete</span><br>  <span class="hljs-comment">// inside a callback executed by an executor.</span><br>  executor.<span class="hljs-built_in">add_node</span>(node_ptr);<br>  <span class="hljs-keyword">auto</span> retcode = executor.<span class="hljs-built_in">spin_until_future_complete</span>(future, timeout);<br>  executor.<span class="hljs-built_in">remove_node</span>(node_ptr);<br>  <span class="hljs-keyword">return</span> retcode;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> NodeT </span>= rclcpp::Node, <span class="hljs-keyword">typename</span> FutureT, <span class="hljs-keyword">typename</span> TimeRepT = <span class="hljs-type">int64_t</span>,<br>  <span class="hljs-keyword">typename</span> TimeT = std::milli&gt;<br>rclcpp::FutureReturnCode<br><span class="hljs-built_in">spin_node_until_future_complete</span>(<br>  rclcpp::Executor &amp; executor,<br>  std::shared_ptr&lt;NodeT&gt; node_ptr,<br>  <span class="hljs-type">const</span> FutureT &amp; future,<br>  std::chrono::duration&lt;TimeRepT, TimeT&gt; timeout = std::chrono::<span class="hljs-built_in">duration</span>&lt;TimeRepT, TimeT&gt;(<span class="hljs-number">-1</span>))<br>&#123;<br>  <span class="hljs-keyword">return</span> rclcpp::executors::<span class="hljs-built_in">spin_node_until_future_complete</span>(<br>    executor,<br>    node_ptr-&gt;<span class="hljs-built_in">get_node_base_interface</span>(),<br>    future,<br>    timeout);<br>&#125;<br><br>&#125;  <span class="hljs-comment">// namespace executors</span><br></code></pre></td></tr></table></figure><p>由于节点被加入到临时的单线程执行器中，并且执行器通过节点与ROS2底层进行交互，所以对节点有以下要求：</p><ol><li>该节点必须是创建客户端的节点，否则会阻塞但不会返回；</li><li>该节点在调用前不能加入到其他执行器中，否则就会抛出异常，导致程序终止。<br>紧接着控制权就交给了SingleThreadedExecutor的spin_until_future_complete()函数，该函数代码如下：</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> FutureT, <span class="hljs-keyword">typename</span> TimeRepT </span>= <span class="hljs-type">int64_t</span>, <span class="hljs-keyword">typename</span> TimeT = std::milli&gt;<br>FutureReturnCode<br><span class="hljs-built_in">spin_until_future_complete</span>(<br>  <span class="hljs-type">const</span> FutureT &amp; future,<br>  std::chrono::duration&lt;TimeRepT, TimeT&gt; timeout = std::chrono::<span class="hljs-built_in">duration</span>&lt;TimeRepT, TimeT&gt;(<span class="hljs-number">-1</span>))<br>&#123;<br>  <span class="hljs-comment">// TODO(wjwwood): does not work recursively; can&#x27;t call spin_node_until_future_complete</span><br>  <span class="hljs-comment">// inside a callback executed by an executor.</span><br>  <span class="hljs-comment">// 这一段警告写的很清晰，不要在一个callback中，调用spin_node_until_future_complete，否则会引起死锁</span><br><br>  <span class="hljs-comment">// 再进入spin循环之前，先检查一遍，看结果是不是已经反馈了</span><br>  std::future_status status = future.<span class="hljs-built_in">wait_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">0</span>));<br>  <span class="hljs-keyword">if</span> (status == std::future_status::ready) &#123;<br>    <span class="hljs-keyword">return</span> FutureReturnCode::SUCCESS;<br>  &#125;<br><br>  <span class="hljs-comment">// 等待时间处理，计算结束时间</span><br>  <span class="hljs-keyword">auto</span> end_time = std::chrono::steady_clock::<span class="hljs-built_in">now</span>();<br>  std::chrono::nanoseconds timeout_ns = std::chrono::<span class="hljs-built_in">duration_cast</span>&lt;std::chrono::nanoseconds&gt;(<br>    timeout);<br>  <span class="hljs-keyword">if</span> (timeout_ns &gt; std::chrono::nanoseconds::<span class="hljs-built_in">zero</span>()) &#123;<br>    end_time += timeout_ns;<br>  &#125;<br>  std::chrono::nanoseconds timeout_left = timeout_ns;<br><br>  <span class="hljs-comment">// 进入spin循环中，这段代码我们之前在讲执行器的时候已经很熟悉了</span><br>  <span class="hljs-keyword">if</span> (spinning.<span class="hljs-built_in">exchange</span>(<span class="hljs-literal">true</span>)) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;spin_until_future_complete() called while already spinning&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-built_in">RCPPUTILS_SCOPE_EXIT</span>(<span class="hljs-keyword">this</span>-&gt;spinning.<span class="hljs-built_in">store</span>(<span class="hljs-literal">false</span>); );<br>  <span class="hljs-keyword">while</span> (rclcpp::<span class="hljs-built_in">ok</span>(<span class="hljs-keyword">this</span>-&gt;context_) &amp;&amp; spinning.<span class="hljs-built_in">load</span>()) &#123;<br>    <span class="hljs-comment">// 执行回调检查，看看有没有服务端消息反馈，这里其实就是调用了get_next_executable、execute_any_executable</span><br>    <span class="hljs-built_in">spin_once_impl</span>(timeout_left);<br><br>    <span class="hljs-comment">// 询问是否promise通知我已经消息返回了</span><br>    status = future.<span class="hljs-built_in">wait_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">0</span>));<br>    <span class="hljs-keyword">if</span> (status == std::future_status::ready) &#123;<br>      <span class="hljs-comment">// 这里返回了成功，表示有结果正常返回</span><br>      <span class="hljs-keyword">return</span> FutureReturnCode::SUCCESS;<br>    &#125;<br>    <span class="hljs-comment">// 如果timeout&lt;0，阻塞式等待，没有超时要求</span><br>    <span class="hljs-keyword">if</span> (timeout_ns &lt; std::chrono::nanoseconds::<span class="hljs-built_in">zero</span>()) &#123;<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 判断是否完成了超时</span><br>    <span class="hljs-keyword">auto</span> now = std::chrono::steady_clock::<span class="hljs-built_in">now</span>();<br>    <span class="hljs-keyword">if</span> (now &gt;= end_time) &#123;<br>      <span class="hljs-keyword">return</span> FutureReturnCode::TIMEOUT;<br>    &#125;<br>    <span class="hljs-comment">// Subtract the elapsed time from the original timeout.</span><br>    timeout_left = std::chrono::<span class="hljs-built_in">duration_cast</span>&lt;std::chrono::nanoseconds&gt;(end_time - now);<br>  &#125;<br><br>  <span class="hljs-comment">// The future did not complete before ok() returned false, return INTERRUPTED.</span><br>  <span class="hljs-keyword">return</span> FutureReturnCode::INTERRUPTED;<br>&#125;<br></code></pre></td></tr></table></figure><p>等待包含三种状态：</p><ol><li>FutureReturnCode::SUCCESS：一切正常，拿到了从服务端反馈的消息</li><li>FutureReturnCode::TIMEOUT：超时了，需要继续等待或做错误处理</li><li>FutureReturnCode::INTERRUPTED：操作被终端，有可能是ROS2底层出了问题<br>在返回不为FutureReturnCode::SUCCESS，要处理好pending_requests_中滞留的请求（移除或继续等待）</li></ol><p>有了之前文章中调度器概念后，整个过程并不复杂，就是通过执行器处理底层消息，当服务结果有反馈时，spin_once_impl()的execute_any_executable()触发客户端回调，future对应promise就会被设置，从而future.wait_for就会获取到”有结果到来”的通知：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/include/rclcpp/client.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ServiceT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> : <span class="hljs-keyword">public</span> ClientBase<br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">handle_response</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    std::shared_ptr&lt;<span class="hljs-type">rmw_request_id_t</span>&gt; request_header,</span></span><br><span class="hljs-params"><span class="hljs-function">    std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function">  </span>&#123;<br>    std::optional&lt;CallbackInfoVariant&gt;<br>    optional_pending_request = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_and_erase_pending_request</span>(request_header-&gt;sequence_number);<br>    <span class="hljs-keyword">if</span> (!optional_pending_request) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">auto</span> &amp; value = *optional_pending_request;<br>    <span class="hljs-keyword">auto</span> typed_response = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-keyword">typename</span> ServiceT::Response&gt;(<br>      std::<span class="hljs-built_in">move</span>(response));<br>    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">holds_alternative</span>&lt;Promise&gt;(value)) &#123;<br>      <span class="hljs-comment">// 这里promise执行了触发</span><br>      <span class="hljs-keyword">auto</span> &amp; promise = std::<span class="hljs-built_in">get</span>&lt;Promise&gt;(value);<br>      promise.<span class="hljs-built_in">set_value</span>(std::<span class="hljs-built_in">move</span>(typed_response));<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">holds_alternative</span>&lt;CallbackTypeValueVariant&gt;(value)) &#123;<br>      <span class="hljs-keyword">auto</span> &amp; inner = std::<span class="hljs-built_in">get</span>&lt;CallbackTypeValueVariant&gt;(value);<br>      <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp; callback = std::<span class="hljs-built_in">get</span>&lt;CallbackType&gt;(inner);<br>      <span class="hljs-keyword">auto</span> &amp; promise = std::<span class="hljs-built_in">get</span>&lt;Promise&gt;(inner);<br>      <span class="hljs-keyword">auto</span> &amp; future = std::<span class="hljs-built_in">get</span>&lt;SharedFuture&gt;(inner);<br>      promise.<span class="hljs-built_in">set_value</span>(std::<span class="hljs-built_in">move</span>(typed_response));<br>      <span class="hljs-built_in">callback</span>(std::<span class="hljs-built_in">move</span>(future));<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">holds_alternative</span>&lt;CallbackWithRequestTypeValueVariant&gt;(value)) &#123;<br>      <span class="hljs-keyword">auto</span> &amp; inner = std::<span class="hljs-built_in">get</span>&lt;CallbackWithRequestTypeValueVariant&gt;(value);<br>      <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp; callback = std::<span class="hljs-built_in">get</span>&lt;CallbackWithRequestType&gt;(inner);<br>      <span class="hljs-keyword">auto</span> &amp; promise = std::<span class="hljs-built_in">get</span>&lt;PromiseWithRequest&gt;(inner);<br>      <span class="hljs-keyword">auto</span> &amp; future = std::<span class="hljs-built_in">get</span>&lt;SharedFutureWithRequest&gt;(inner);<br>      <span class="hljs-keyword">auto</span> &amp; request = std::<span class="hljs-built_in">get</span>&lt;SharedRequest&gt;(inner);<br>      promise.<span class="hljs-built_in">set_value</span>(std::<span class="hljs-built_in">make_pair</span>(std::<span class="hljs-built_in">move</span>(request), std::<span class="hljs-built_in">move</span>(typed_response)));<br>      <span class="hljs-built_in">callback</span>(std::<span class="hljs-built_in">move</span>(future));<br>    &#125;<br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/src/rclcpp/executor.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">Executor::execute_client</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::ClientBase::SharedPtr client)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">auto</span> request_header = client-&gt;<span class="hljs-built_in">create_request_header</span>();<br>  std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response = client-&gt;<span class="hljs-built_in">create_response</span>();<br>  <span class="hljs-built_in">take_and_do_error_handling</span>(<br>    <span class="hljs-string">&quot;taking a service client response from service&quot;</span>,<br>    client-&gt;<span class="hljs-built_in">get_service_name</span>(),<br>    [&amp;]() &#123;<span class="hljs-keyword">return</span> client-&gt;<span class="hljs-built_in">take_type_erased_response</span>(response.<span class="hljs-built_in">get</span>(), *request_header);&#125;,<br>    [&amp;]() &#123;client-&gt;<span class="hljs-built_in">handle_response</span>(request_header, response);&#125;);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">Executor::execute_any_executable</span><span class="hljs-params">(AnyExecutable &amp; any_exec)</span></span><br><span class="hljs-function"></span>&#123;<br>  ......<br>  <span class="hljs-comment">// 当接收到服务端的反馈消息时，就会执行回调</span><br>  <span class="hljs-keyword">if</span> (any_exec.client) &#123;<br>    <span class="hljs-built_in">execute_client</span>(any_exec.client);<br>  &#125;<br>  <span class="hljs-comment">// Reset the callback_group, regardless of type</span><br>  any_exec.callback_group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">store</span>(<span class="hljs-literal">true</span>);<br>  ......<br>&#125;<br></code></pre></td></tr></table></figure><p>从上方代码基本可以回答之前的问题了：</p><div class="note note-success">            <p>由于等待过程涉及到底层服务反馈到来后，才会触发promise.set_value，必须使用spin获取底层的消息，不能直接通过future.get()类函数完成等待，否则就会卡死。</p>          </div><h1 id="异步Service-Client模式"><a href="#异步Service-Client模式" class="headerlink" title="异步Service-Client模式"></a>异步Service-Client模式</h1><h2 id="实验-1"><a href="#实验-1" class="headerlink" title="实验"></a>实验</h2><h3 id="异步客户端"><a href="#异步客户端" class="headerlink" title="异步客户端"></a>异步客户端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cinttypes&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;limits&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utility&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;example_interfaces/srv/add_two_ints.hpp&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp/rclcpp.hpp&quot;</span></span><br><br><span class="hljs-keyword">using</span> AddTwoInts = example_interfaces::srv::AddTwoInts;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std::chrono_literals;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientNode</span> : <span class="hljs-keyword">public</span> rclcpp::Node<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">ClientNode</span><span class="hljs-params">(<span class="hljs-type">const</span> rclcpp::NodeOptions &amp; options = rclcpp::NodeOptions&#123;&#125;)</span></span><br><span class="hljs-function">  : Node(<span class="hljs-string">&quot;add_two_ints_async_client&quot;</span>, options)</span><br><span class="hljs-function">  &#123;</span><br>    <span class="hljs-built_in">setvbuf</span>(stdout, <span class="hljs-literal">NULL</span>, _IONBF, BUFSIZ);<br>    <span class="hljs-comment">// 创建client</span><br>    client_ = <span class="hljs-built_in">create_client</span>&lt;AddTwoInts&gt;(<span class="hljs-string">&quot;add_two_ints&quot;</span>);<br>    <span class="hljs-comment">// 启动定时器，每隔5s裁剪掉之前请求</span><br>    timer_ = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_wall_timer</span>(<br>      <span class="hljs-number">5</span>s,<br>      [<span class="hljs-keyword">this</span>]() &#123;<br>        std::vector&lt;<span class="hljs-type">int64_t</span>&gt; pruned_requests;<br>        <span class="hljs-comment">// Prune all requests older than 5s.</span><br>        <span class="hljs-type">size_t</span> n_pruned = <span class="hljs-keyword">this</span>-&gt;client_-&gt;<span class="hljs-built_in">prune_requests_older_than</span>(<br>          std::chrono::system_clock::<span class="hljs-built_in">now</span>() - <span class="hljs-number">5</span>s, &amp;pruned_requests);<br>        <span class="hljs-keyword">if</span> (n_pruned) &#123;<br>          <span class="hljs-built_in">RCLCPP_INFO</span>(<br>            <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(),<br>            <span class="hljs-string">&quot;The server hasn&#x27;t replied for more than 5s, %zu requests were discarded, &quot;</span><br>            <span class="hljs-string">&quot;the discarded requests numbers are:&quot;</span>,<br>            n_pruned);<br>          <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp; req_num : pruned_requests) &#123;<br>            <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;\t%&quot;</span> PRId64, req_num);<br>          &#125;<br>        &#125;<br>      &#125;);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">bool</span></span><br><span class="hljs-function">  <span class="hljs-title">wait_for_service_server</span><span class="hljs-params">()</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">while</span> (!client_-&gt;<span class="hljs-built_in">wait_for_service</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>))) &#123;<br>      <span class="hljs-keyword">if</span> (!rclcpp::<span class="hljs-built_in">ok</span>()) &#123;<br>        <span class="hljs-built_in">RCLCPP_ERROR</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;client interrupted while waiting for service to appear.&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>      <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;waiting for service to appear...&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">queue_async_request</span><span class="hljs-params">(<span class="hljs-type">int64_t</span> a, <span class="hljs-type">int64_t</span> b)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">auto</span> request = std::<span class="hljs-built_in">make_shared</span>&lt;AddTwoInts::Request&gt;();<br>    request-&gt;a = a;<br>    request-&gt;b = b;<br><br>    <span class="hljs-comment">// We give the async_send_request() method a callback that will get executed once the response</span><br>    <span class="hljs-comment">// is received.</span><br>    <span class="hljs-comment">// This way we can return immediately from this method and allow other work to be done by the</span><br>    <span class="hljs-comment">// executor in `spin` while waiting for the response.</span><br>    <span class="hljs-keyword">using</span> ServiceResponseFuture =<br>      rclcpp::Client&lt;example_interfaces::srv::AddTwoInts&gt;::SharedFutureWithRequest;<br>    <span class="hljs-keyword">auto</span> response_received_callback =<br>      [logger = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>()](ServiceResponseFuture future) &#123;<br>        <span class="hljs-keyword">auto</span> request_response_pair = future.<span class="hljs-built_in">get</span>();<br>        <span class="hljs-built_in">RCLCPP_INFO</span>(<br>          logger,<br>          <span class="hljs-string">&quot;Result of %&quot;</span> PRId64 <span class="hljs-string">&quot; + %&quot;</span> PRId64 <span class="hljs-string">&quot; is: %&quot;</span> PRId64,<br>          request_response_pair.first-&gt;a,<br>          request_response_pair.first-&gt;b,<br>          request_response_pair.second-&gt;sum);<br>      &#125;;<br>    <span class="hljs-keyword">auto</span> result = client_-&gt;<span class="hljs-built_in">async_send_request</span>(<br>      request, std::<span class="hljs-built_in">move</span>(response_received_callback));<br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(),<br>      <span class="hljs-string">&quot;Sending a request to the server (request_id =%&quot;</span> PRId64<br>      <span class="hljs-string">&quot;), we&#x27;re going to let you know the result when ready!&quot;</span>,<br>      result.request_id);<br>  &#125;<br><br><span class="hljs-keyword">private</span>:<br>  rclcpp::Client&lt;AddTwoInts&gt;::SharedPtr client_;<br>  rclcpp::TimerBase::SharedPtr timer_;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">bool</span></span><br><span class="hljs-function"><span class="hljs-title">read_more</span><span class="hljs-params">(std::string &amp; buffer, <span class="hljs-type">const</span> rclcpp::Logger &amp; logger)</span></span><br><span class="hljs-function"></span>&#123;<br>  buffer.<span class="hljs-built_in">clear</span>();<br>  std::<span class="hljs-built_in">getline</span>(std::cin, buffer);<br>  <span class="hljs-keyword">if</span> (std::cin.<span class="hljs-built_in">fail</span>() || std::cin.<span class="hljs-built_in">eof</span>()) &#123;<br>    <span class="hljs-built_in">RCLCPP_INFO</span>(logger, <span class="hljs-string">&quot;\nProgram was interrupted, bye!&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function">std::optional&lt;<span class="hljs-type">int64_t</span>&gt;</span><br><span class="hljs-function"><span class="hljs-title">read_number</span><span class="hljs-params">(std::string &amp; buffer, <span class="hljs-type">const</span> rclcpp::Logger &amp; logger)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-type">size_t</span> pos;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">read_more</span>(buffer, logger)) &#123;<br>      <span class="hljs-keyword">return</span> std::<span class="hljs-literal">nullopt</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (buffer == <span class="hljs-string">&quot;q&quot;</span>) &#123;<br>      <span class="hljs-keyword">return</span> std::<span class="hljs-literal">nullopt</span>;<br>    &#125;<br>    <span class="hljs-keyword">auto</span> ret = std::<span class="hljs-built_in">stoll</span>(buffer, &amp;pos);<br>    <span class="hljs-keyword">if</span> (ret &gt; std::<span class="hljs-built_in">numeric_limits</span>&lt;<span class="hljs-type">int64_t</span>&gt;().<span class="hljs-built_in">max</span>()) &#123;<br>      <span class="hljs-built_in">RCLCPP_INFO</span>(<br>        logger,<br>        <span class="hljs-string">&quot;The input number should be less or equal than %&quot;</span> PRId64<br>        <span class="hljs-string">&quot;\n Please try again: &quot;</span>,<br>        std::<span class="hljs-built_in">numeric_limits</span>&lt;<span class="hljs-type">int64_t</span>&gt;().<span class="hljs-built_in">max</span>());<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (pos != buffer.<span class="hljs-built_in">size</span>()) &#123;<br>      <span class="hljs-built_in">RCLCPP_INFO</span>(<br>        logger,<br>        <span class="hljs-string">&quot;The input should be a number not: %s\n Please try again: &quot;</span>, buffer.<span class="hljs-built_in">c_str</span>());<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ret;<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">init</span>(argc, argv);<br>  <br>  <span class="hljs-keyword">auto</span> node = std::<span class="hljs-built_in">make_shared</span>&lt;ClientNode&gt;();<br>  <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp; logger = node-&gt;<span class="hljs-built_in">get_logger</span>();<br>  <br>  <span class="hljs-comment">// 等待服务端启动建立服务</span><br>  <span class="hljs-built_in">RCLCPP_INFO</span>(logger, <span class="hljs-string">&quot;waiting for service to appear...&quot;</span>);<br>  <span class="hljs-keyword">if</span> (!node-&gt;<span class="hljs-built_in">wait_for_service_server</span>()) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-built_in">RCLCPP_INFO</span>(logger, <span class="hljs-string">&quot;Server is available!!!&quot;</span>);<br>  <span class="hljs-built_in">RCLCPP_INFO</span>(logger, <span class="hljs-string">&quot;We are going to add two numbers, insert the first one (or &#x27;q&#x27; to exit): &quot;</span>);<br>  <br>  <span class="hljs-type">int64_t</span> a;<br>  <span class="hljs-type">int64_t</span> b;<br><br>  <span class="hljs-comment">// 启动线程用于spin，注意这里写法，例子里提供了一种停止spin()的方法</span><br>  <span class="hljs-comment">// 至此，有两个线程在并行执行：主线程和执行器spin线程</span><br>  std::promise&lt;<span class="hljs-type">void</span>&gt; stop_async_spinner;<br>  <span class="hljs-function">std::thread <span class="hljs-title">async_spinner_thread</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    [stop_token = stop_async_spinner.get_future(), node]() &#123;</span></span><br><span class="hljs-params"><span class="hljs-function">      rclcpp::executors::SingleThreadedExecutor executor;</span></span><br><span class="hljs-params"><span class="hljs-function">      executor.add_node(node);</span></span><br><span class="hljs-params"><span class="hljs-function">      executor.spin_until_future_complete(stop_token);</span></span><br><span class="hljs-params"><span class="hljs-function">    &#125;)</span></span>;<br><br><br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-comment">// 获取数字，不重要</span><br>    std::string buffer;<br>    <span class="hljs-keyword">auto</span> optional_number = <span class="hljs-built_in">read_number</span>(buffer, logger);<br>    <span class="hljs-keyword">if</span> (!optional_number) &#123;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    a = *optional_number;<br>    <span class="hljs-built_in">RCLCPP_INFO</span>(logger, <span class="hljs-string">&quot;Insert the second number (or &#x27;q&#x27; to exit): &quot;</span>);<br>    optional_number = <span class="hljs-built_in">read_number</span>(buffer, logger);<br>    <span class="hljs-keyword">if</span> (!optional_number) &#123;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    b = *optional_number;<br><br>    <span class="hljs-comment">// 异步发送请求</span><br>    node-&gt;<span class="hljs-built_in">queue_async_request</span>(a, b);<br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<br>      logger,<br>      <span class="hljs-string">&quot;You can prepare another request to add two numbers, insert the first one (or &#x27;q&#x27; to exit):&quot;</span><br>    );<br>  &#125;<br><br>  <span class="hljs-comment">// 停止spin线程</span><br>  stop_async_spinner.<span class="hljs-built_in">set_value</span>();<br>  async_spinner_thread.<span class="hljs-built_in">join</span>();<br>  rclcpp::<span class="hljs-built_in">shutdown</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="异步客户端分析"><a href="#异步客户端分析" class="headerlink" title="异步客户端分析"></a>异步客户端分析</h2><p>以上代码仍然是ros2 example中异步客户端样例，核心在于：</p><ol><li>主线程（其他线程）负责注册callback并发送请求</li><li>启动独立线程负责执行器spin()，以便在主线程执行其他操作，spin线程完成ROS2消息处理<br>异步发送请求代码如下（注意这部分在主线程中完成）：</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">queue_async_request</span><span class="hljs-params">(<span class="hljs-type">int64_t</span> a, <span class="hljs-type">int64_t</span> b)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// 首先建立一个请求，填充必要数据</span><br>  <span class="hljs-keyword">auto</span> request = std::<span class="hljs-built_in">make_shared</span>&lt;AddTwoInts::Request&gt;();<br>  request-&gt;a = a;<br>  request-&gt;b = b;<br><br>  <span class="hljs-comment">// 异步发送请求的callback（lambda），当接收到服务器消息反馈时，就会执行该callback</span><br>  <span class="hljs-keyword">using</span> ServiceResponseFuture =<br>    rclcpp::Client&lt;example_interfaces::srv::AddTwoInts&gt;::SharedFutureWithRequest;<br>  <span class="hljs-keyword">auto</span> response_received_callback =<br>    [logger = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>()](ServiceResponseFuture future) &#123;<br>      <span class="hljs-keyword">auto</span> request_response_pair = future.<span class="hljs-built_in">get</span>();<br>      <span class="hljs-built_in">RCLCPP_INFO</span>(<br>        logger,<br>        <span class="hljs-string">&quot;Result of %&quot;</span> PRId64 <span class="hljs-string">&quot; + %&quot;</span> PRId64 <span class="hljs-string">&quot; is: %&quot;</span> PRId64,<br>        request_response_pair.first-&gt;a,<br>        request_response_pair.first-&gt;b,<br>        request_response_pair.second-&gt;sum);<br>    &#125;;<br><br>  <span class="hljs-comment">// 异步发送请求，只不过这里多了一个callback函数</span><br>  <span class="hljs-keyword">auto</span> result = client_-&gt;<span class="hljs-built_in">async_send_request</span>(<br>    request, std::<span class="hljs-built_in">move</span>(response_received_callback));<br>  <span class="hljs-built_in">RCLCPP_INFO</span>(<br>    <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(),<br>    <span class="hljs-string">&quot;Sending a request to the server (request_id =%&quot;</span> PRId64<br>    <span class="hljs-string">&quot;), we&#x27;re going to let you know the result when ready!&quot;</span>,<br>    result.request_id);<br>&#125;<br></code></pre></td></tr></table></figure><p>在发送请求代码中async_send_request()提供回调函数response_received_callback()，用于在接收到服务消息反馈时，触发回调函数调用。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ServiceT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> : <span class="hljs-keyword">public</span> ClientBase<br>  <span class="hljs-keyword">template</span>&lt;<br>    <span class="hljs-keyword">typename</span> CallbackT,<br>    <span class="hljs-keyword">typename</span> std::enable_if&lt;<br>      rclcpp::function_traits::same_arguments&lt;<br>        CallbackT,<br>        CallbackWithRequestType<br>      &gt;::value<br>    &gt;::type * = <span class="hljs-literal">nullptr</span><br>  &gt;<br>  SharedFutureWithRequestAndRequestId<br>  <span class="hljs-built_in">async_send_request</span>(SharedRequest request, CallbackT &amp;&amp; cb)<br>  &#123;<br>    PromiseWithRequest promise;<br>    <span class="hljs-keyword">auto</span> shared_future = promise.<span class="hljs-built_in">get_future</span>().<span class="hljs-built_in">share</span>();<br>    <span class="hljs-keyword">auto</span> req_id = <span class="hljs-built_in">async_send_request_impl</span>(<br>      *request,<br>      <span class="hljs-comment">// 这里将回调、请求、future、promise打包在一起</span><br>      std::<span class="hljs-built_in">make_tuple</span>(<br>        CallbackWithRequestType&#123;std::forward&lt;CallbackT&gt;(cb)&#125;,<br>        request,<br>        shared_future,<br>        std::<span class="hljs-built_in">move</span>(promise)));<br>    <span class="hljs-keyword">return</span> SharedFutureWithRequestAndRequestId&#123;std::<span class="hljs-built_in">move</span>(shared_future), req_id&#125;;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>具体触发回调的位置，我们之前在同步客户端中已经说明了，具体细节：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/include/rclcpp/client.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ServiceT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> : <span class="hljs-keyword">public</span> ClientBase<br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">handle_response</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    std::shared_ptr&lt;<span class="hljs-type">rmw_request_id_t</span>&gt; request_header,</span></span><br><span class="hljs-params"><span class="hljs-function">    std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function">  </span>&#123;<br>    std::optional&lt;CallbackInfoVariant&gt;<br>    optional_pending_request = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_and_erase_pending_request</span>(request_header-&gt;sequence_number);<br>    <span class="hljs-keyword">if</span> (!optional_pending_request) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">auto</span> &amp; value = *optional_pending_request;<br>    <span class="hljs-keyword">auto</span> typed_response = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-keyword">typename</span> ServiceT::Response&gt;(<br>      std::<span class="hljs-built_in">move</span>(response));<br>    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">holds_alternative</span>&lt;Promise&gt;(value)) &#123;<br>      <span class="hljs-keyword">auto</span> &amp; promise = std::<span class="hljs-built_in">get</span>&lt;Promise&gt;(value);<br>      promise.<span class="hljs-built_in">set_value</span>(std::<span class="hljs-built_in">move</span>(typed_response));<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">holds_alternative</span>&lt;CallbackTypeValueVariant&gt;(value)) &#123;<br>      <span class="hljs-keyword">auto</span> &amp; inner = std::<span class="hljs-built_in">get</span>&lt;CallbackTypeValueVariant&gt;(value);<br>      <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp; callback = std::<span class="hljs-built_in">get</span>&lt;CallbackType&gt;(inner);<br>      <span class="hljs-keyword">auto</span> &amp; promise = std::<span class="hljs-built_in">get</span>&lt;Promise&gt;(inner);<br>      <span class="hljs-keyword">auto</span> &amp; future = std::<span class="hljs-built_in">get</span>&lt;SharedFuture&gt;(inner);<br>      promise.<span class="hljs-built_in">set_value</span>(std::<span class="hljs-built_in">move</span>(typed_response));<br>      <span class="hljs-built_in">callback</span>(std::<span class="hljs-built_in">move</span>(future));<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">holds_alternative</span>&lt;CallbackWithRequestTypeValueVariant&gt;(value)) &#123;<br>      <span class="hljs-comment">// 会在这个分支</span><br>      <span class="hljs-keyword">auto</span> &amp; inner = std::<span class="hljs-built_in">get</span>&lt;CallbackWithRequestTypeValueVariant&gt;(value);<br>      <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp; callback = std::<span class="hljs-built_in">get</span>&lt;CallbackWithRequestType&gt;(inner);<br>      <span class="hljs-keyword">auto</span> &amp; promise = std::<span class="hljs-built_in">get</span>&lt;PromiseWithRequest&gt;(inner);<br>      <span class="hljs-keyword">auto</span> &amp; future = std::<span class="hljs-built_in">get</span>&lt;SharedFutureWithRequest&gt;(inner);<br>      <span class="hljs-keyword">auto</span> &amp; request = std::<span class="hljs-built_in">get</span>&lt;SharedRequest&gt;(inner);<br><br>      <span class="hljs-comment">// 注意这里，先让promise设置值，然后调用callback</span><br>      promise.<span class="hljs-built_in">set_value</span>(std::<span class="hljs-built_in">make_pair</span>(std::<span class="hljs-built_in">move</span>(request), std::<span class="hljs-built_in">move</span>(typed_response)));<br>      <span class="hljs-built_in">callback</span>(std::<span class="hljs-built_in">move</span>(future));<br>    &#125;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>当从服务端接收到回应时，handle_response()被调用，代码通过promise.set_value通知客户端，消息已经被回应了。之后调用callback()，这就是用户注册回调函数，可对结果进一步地处理。另外值得注意的是，用户的回调是在执行器线程中被调用的，自定义的功能代码要做好共享变量的数据同步和保护。</p>]]></content>
    
    
    <categories>
      
      <category>ROS2</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ROS2</tag>
      
      <tag>Humble</tag>
      
      <tag>Service</tag>
      
      <tag>ROS2-Service</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ROS2 Executor详解</title>
    <link href="/2025/04/13/-1-%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%80%E6%9C%AF%E6%A0%88/-1-ROS2%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/-1-ROS2-Humble%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/%E3%80%901%E3%80%91ROS2%20Executor%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/04/13/-1-%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%80%E6%9C%AF%E6%A0%88/-1-ROS2%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/-1-ROS2-Humble%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/%E3%80%901%E3%80%91ROS2%20Executor%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<div class="note note-success">            <p>本文由 ZiQingDream 编写，未经允许禁止转载。</p><p>本文作者：工程课代表[B站] &#x2F; ZiQingDream[Github]</p>          </div><h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>为什么有这篇文章：</p><ol><li>在使用ROS2编排话题、服务等，很少有人能够清楚、明确地说明ROS2调度逻辑；</li><li>ROS2官网对于执行器和回调组的说明偏简单，可能产生理解偏差，本文尝试补充官网的细节；</li><li>多线程执行器误用是造成ROS2死锁、崩溃、通信效率低下问题根源。<br>这篇文章从代码层面说明多种执行器差异，让阅读者对于执行器内部调度逻辑有比较清楚的认识，从而减少在机器人程序中出现的并发问题。</li></ol><div class="note note-warning">            <p>阅读本文需要你有一定ROS2基本理解，至少要有关于话题发布、订阅基础知识。</p>          </div><h1 id="单线程执行器（SingleThreadedExecutor）"><a href="#单线程执行器（SingleThreadedExecutor）" class="headerlink" title="单线程执行器（SingleThreadedExecutor）"></a>单线程执行器（SingleThreadedExecutor）</h1><h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><h3 id="发布程序"><a href="#发布程序" class="headerlink" title="发布程序"></a>发布程序</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//src/ros2/examples/rclcpp/topics/minimal_publisher/member_function.cpp</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp/rclcpp.hpp&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;std_msgs/msg/string.hpp&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std::chrono_literals;<br><br><span class="hljs-comment">// 从使用上来说，继承仅仅是为了简化代码操作，在ROS2整个设计体系下，</span><br><span class="hljs-comment">// 节点抽象更加独立和具体，作为类成员也很方便，不必非要写成继承</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MinimalPublisher</span> : <span class="hljs-keyword">public</span> rclcpp::Node<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">MinimalPublisher</span>()<br>  : <span class="hljs-built_in">Node</span>(<span class="hljs-string">&quot;minimal_publisher&quot;</span>), <span class="hljs-built_in">count_</span>(<span class="hljs-number">0</span>)<br>  &#123;<br>    <span class="hljs-comment">// 建立一个定时器，不断发送消息给订阅端</span><br>    publisher_ = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_publisher</span>&lt;std_msgs::msg::String&gt;(<span class="hljs-string">&quot;topic&quot;</span>, <span class="hljs-number">10</span>);<br>    timer_ = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_wall_timer</span>(<br>      <span class="hljs-number">500</span>ms, std::<span class="hljs-built_in">bind</span>(&amp;MinimalPublisher::timer_callback, <span class="hljs-keyword">this</span>));<br>  &#125;<br><br><span class="hljs-keyword">private</span>:<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">timer_callback</span><span class="hljs-params">()</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">auto</span> message = std_msgs::msg::<span class="hljs-built_in">String</span>();<br>    message.data = <span class="hljs-string">&quot;Hello, world! &quot;</span> + std::<span class="hljs-built_in">to_string</span>(count_++);<br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Publishing: &#x27;%s&#x27;&quot;</span>, message.data.<span class="hljs-built_in">c_str</span>());<br>    publisher_-&gt;<span class="hljs-built_in">publish</span>(message);<br>  &#125;<br>  <br>  rclcpp::TimerBase::SharedPtr timer_;<br>  rclcpp::Publisher&lt;std_msgs::msg::String&gt;::SharedPtr publisher_;<br>  <span class="hljs-type">size_t</span> count_;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">init</span>(argc, argv);<br>  rclcpp::<span class="hljs-built_in">spin</span>(std::<span class="hljs-built_in">make_shared</span>&lt;MinimalPublisher&gt;());<br>  rclcpp::<span class="hljs-built_in">shutdown</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="订阅程序"><a href="#订阅程序" class="headerlink" title="订阅程序"></a>订阅程序</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//src/ros2/examples/rclcpp/topics/minimal_subscriber/member_function.cpp</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp/rclcpp.hpp&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;std_msgs/msg/string.hpp&quot;</span></span><br><br><span class="hljs-keyword">using</span> std::placeholders::_1;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MinimalSubscriber</span> : <span class="hljs-keyword">public</span> rclcpp::Node<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">MinimalSubscriber</span>()<br>  : <span class="hljs-built_in">Node</span>(<span class="hljs-string">&quot;minimal_subscriber&quot;</span>)<br>  &#123;<br>    subscription_ = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_subscription</span>&lt;std_msgs::msg::String&gt;(<br>      <span class="hljs-string">&quot;topic&quot;</span>, <span class="hljs-number">10</span>, std::<span class="hljs-built_in">bind</span>(&amp;MinimalSubscriber::topic_callback, <span class="hljs-keyword">this</span>, _1));<br>  &#125;<br><br><span class="hljs-keyword">private</span>:<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">topic_callback</span><span class="hljs-params">(<span class="hljs-type">const</span> std_msgs::msg::String &amp; msg)</span> <span class="hljs-type">const</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;I heard: &#x27;%s&#x27;&quot;</span>, msg.data.<span class="hljs-built_in">c_str</span>());<br>  &#125;<br>  rclcpp::Subscription&lt;std_msgs::msg::String&gt;::SharedPtr subscription_;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">init</span>(argc, argv);<br>  rclcpp::<span class="hljs-built_in">spin</span>(std::<span class="hljs-built_in">make_shared</span>&lt;MinimalSubscriber&gt;());<br>  rclcpp::<span class="hljs-built_in">shutdown</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这两个程序是ros2官方提供example。我们现忽略对于话题和节点细节，后面逐步展开，重点关注消息调度，也就是这里的rclcpp::spin()函数。</p><h2 id="全局spin"><a href="#全局spin" class="headerlink" title="全局spin()"></a>全局spin()</h2><p>如官网所述rclcpp::spin()函数其实就是SingleThreadedExecutor全局包装而已：</p><p><img src="/img/ros2-executor/spin%E5%AE%98%E7%BD%91%E4%BB%8B%E7%BB%8D.png"></p><p>也就是说，上述的Publisher和Subscriber例子，都包含一个单线程执行器(rclcpp::executors::SingleThreadedExecutor)，由该执行器调度ROS2消息：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">init</span>(argc, argv);<br>  rclcpp::<span class="hljs-built_in">spin</span>(std::<span class="hljs-built_in">make_shared</span>&lt;MinimalPublisher&gt;());<br>  rclcpp::<span class="hljs-built_in">shutdown</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>代码基本等价于下方代码：新建一个单线程执行器，并把节点加入执行器。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">init</span>(argc, argv);<br><br>  <span class="hljs-keyword">auto</span> node = std::<span class="hljs-built_in">make_shared</span>&lt;MinimalPublisher&gt;();<br><br>  rclcpp::executors::SingleThreadedExecutor executor;<br>  executor.<span class="hljs-built_in">add_node</span>(node);<br>  executor.<span class="hljs-built_in">spin</span>();<br>  <br>  rclcpp::<span class="hljs-built_in">shutdown</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>以上的结论，我们从humble代码中，可以清晰的了解到：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/src/rclcpp/executors.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">rclcpp::spin</span><span class="hljs-params">(rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_ptr)</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::ExecutorOptions options;<br>  options.context = node_ptr-&gt;<span class="hljs-built_in">get_context</span>();<br>  <span class="hljs-comment">// 建立一个单线程执行器</span><br>  rclcpp::<span class="hljs-function">executors::SingleThreadedExecutor <span class="hljs-title">exec</span><span class="hljs-params">(options)</span></span>;<br>  <span class="hljs-comment">// 把节点加入到其中</span><br>  exec.<span class="hljs-built_in">add_node</span>(node_ptr);<br>  <span class="hljs-comment">// 进入调度线程</span><br>  exec.<span class="hljs-built_in">spin</span>();<br>  exec.<span class="hljs-built_in">remove_node</span>(node_ptr);<br>&#125;<br><br><span class="hljs-comment">// 首先调用这个函数(非类成员)，然后执行重载的rclcpp::spin()</span><br><span class="hljs-comment">// 参数rclcpp::Node::SharedPtr指针的版本</span><br><span class="hljs-comment">// 直接转发到rclcpp::node_interfaces::NodeBaseInterface::SharedPtr版本</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">rclcpp::spin</span><span class="hljs-params">(rclcpp::Node::SharedPtr node_ptr)</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">spin</span>(node_ptr-&gt;<span class="hljs-built_in">get_node_base_interface</span>());<br>&#125;<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p>要非常注意，代码不能写成以下的形式，否则你会莫名其妙找不掉节点或话题。</p>          </div><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">init</span>(argc, argv);<br><br>  rclcpp::executors::SingleThreadedExecutor executor;<br>  <br>  <span class="hljs-comment">// 注意这一行代码</span><br>  <span class="hljs-comment">// 在函数调用完成后，std::make_shared&lt;MinimalPublisher&gt;()返回的</span><br>  <span class="hljs-comment">// 临时变量就会被销毁</span><br>  <span class="hljs-comment">// ！！！ 不要这样写 ！！！</span><br>  executor.<span class="hljs-built_in">add_node</span>(std::<span class="hljs-built_in">make_shared</span>&lt;MinimalPublisher&gt;()); <br>  <br>  executor.<span class="hljs-built_in">spin</span>(); <span class="hljs-comment">// 直到这里才会阻塞</span><br>  <br>  rclcpp::<span class="hljs-built_in">shutdown</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>解释起来不复杂，std::make_shared&lt; MinimalPublisher &gt;()创建的节点共享指针，executor.add_node()并没有保存，函数执行返回后，共享指针被销毁，导致节点和话题失效。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/src/rclcpp/executor.cpp</span><br><span class="hljs-comment">// Executor是SingleThreadedExecutor父类</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Executor::add_node</span><span class="hljs-params">(std::shared_ptr&lt;rclcpp::Node&gt; node_ptr, <span class="hljs-type">bool</span> notify)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">add_node</span>(node_ptr-&gt;<span class="hljs-built_in">get_node_base_interface</span>(), notify);<br>&#125;<br></code></pre></td></tr></table></figure><p>那为什么rclcpp::spin()不会出现问题？原因是rclcpp::spin()会执行调度循环，一般不会退出来，共享指针也就被保留下来（我认为这是ros2代码缺陷，造成开发者有点精神分裂）。</p><h2 id="单线程执行器spin"><a href="#单线程执行器spin" class="headerlink" title="单线程执行器spin()"></a>单线程执行器spin()</h2><p>让我们的关注点再回到单线程执行器上来，进入SingleThreadedExecutor::spin()看一看到底发生了什么：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SingleThreadedExecutor::spin</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// std::atomic_bool spinning;</span><br>  <span class="hljs-comment">// 原子变量，表示是否当前已经有人spin()，这部分防止多次spin()：</span><br>  <span class="hljs-comment">// 1. 如果没调用过spin(): spinning = true，并返回false</span><br>  <span class="hljs-comment">// 2. 如果已经spin()：spinning=true，并返回true，此时会抛出异常，程序退出</span><br>  <span class="hljs-keyword">if</span> (spinning.<span class="hljs-built_in">exchange</span>(<span class="hljs-literal">true</span>)) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;spin() called while already spinning&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// 这个不细说，这行代码在异常/函数退出时，将spinning=false，</span><br>  <span class="hljs-comment">// 主要让多线程内部正常退出，防止资源泄露</span><br>  <span class="hljs-built_in">RCPPUTILS_SCOPE_EXIT</span>(<span class="hljs-keyword">this</span>-&gt;spinning.<span class="hljs-built_in">store</span>(<span class="hljs-literal">false</span>); );<br>  <br>  <span class="hljs-keyword">while</span> (rclcpp::<span class="hljs-built_in">ok</span>(<span class="hljs-keyword">this</span>-&gt;context_) &amp;&amp; spinning.<span class="hljs-built_in">load</span>()) &#123;<br>  <span class="hljs-comment">/*struct AnyExecutable</span><br><span class="hljs-comment">    &#123;</span><br><span class="hljs-comment">      RCLCPP_PUBLIC</span><br><span class="hljs-comment">      AnyExecutable();</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">      RCLCPP_PUBLIC</span><br><span class="hljs-comment">      virtual ~AnyExecutable();</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">      // Only one of the following pointers will be set.</span><br><span class="hljs-comment">      rclcpp::SubscriptionBase::SharedPtr subscription; // 话题订阅</span><br><span class="hljs-comment">      rclcpp::TimerBase::SharedPtr timer; // 定时器</span><br><span class="hljs-comment">      rclcpp::ServiceBase::SharedPtr service; // 服务端</span><br><span class="hljs-comment">      rclcpp::ClientBase::SharedPtr client; // 客户端</span><br><span class="hljs-comment">      rclcpp::Waitable::SharedPtr waitable;</span><br><span class="hljs-comment">      // These are used to keep the scope on the containing items</span><br><span class="hljs-comment">      rclcpp::CallbackGroup::SharedPtr callback_group;</span><br><span class="hljs-comment">      rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base;</span><br><span class="hljs-comment">      std::shared_ptr&lt;void&gt; data;</span><br><span class="hljs-comment">    &#125;; */</span><br>    rclcpp::AnyExecutable any_executable;<br><br>    <span class="hljs-comment">// 获取一个可调用的对象：话题订阅、定时器、服务回调、客户端回调、waitable</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">get_next_executable</span>(any_executable)) &#123;<br>      <span class="hljs-comment">// 如果获取成功，执行回调函数</span><br>      <span class="hljs-built_in">execute_any_executable</span>(any_executable);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>整个过程就一个线程（也就是调用spin()的线程），循环尝试获取可调用对象，如果成功，就执行回调函数。这样加入到单线程执行器中节点的内部回调串行执行，流程图如下：</p><p><img src="/img/ros2-executor/%E5%8D%95%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%99%A8spin()%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png"></p><p>以上代码并没有说明底层发生了什么，只是强调了单线程执行器的串行执行。在ROS2 Humble官网文档中，有一张图简单说明了调度过程，这里补充下调度细节，以便大家更好理解后续多线程执行器的流程。<a href="https://docs.ros.org/en/humble/Concepts/Intermediate/About-Executors.html">Executors — ROS 2 Documentation: Humble documentation</a></p><p><img src="/img/ros2-executor/executor%E5%BD%A2%E8%B1%A1%E6%B5%81%E7%A8%8B.png"></p><ul><li>左图上方圆形表示回调函数，例如processOdom()是&#x2F;odom话题的回调</li><li>左图下方信封形状代表接收到数据，例如&#x2F;goal有两个数据，&#x2F;odom有三个数据，&#x2F;cmd没有数据</li><li>左图中间说明了调度的三个过程：<ol><li>wait：尝试等待底层(Middleware)数据到来。初始化wait_set，并根据底层数据情况，设置wait_set（wait_set可以简单理解成数组，每个数组元素表示队列里是否有可处理的数据，1表示有可处理数据，0表示没有数据）。图中&#x2F;goal和&#x2F;odom有消息，对应的掩码就是1，&#x2F;cmd没有消息，对应的掩码就是0。所以wait_set就是101。这个过程在get_next_executable()函数中。</li><li>take：会获取一个可执行对象，这个过程在get_next_executable()函数中。</li><li>execute：执行回调函数，拿到可调用对象的线程，会直接调用回调函数。这个过程在execute_any_executable()函数中。</li></ol></li></ul><h1 id="多线程执行器（MultiThreadedExecutor）"><a href="#多线程执行器（MultiThreadedExecutor）" class="headerlink" title="多线程执行器（MultiThreadedExecutor）"></a>多线程执行器（MultiThreadedExecutor）</h1><p>在进入多线程执行器前，先说明下为什么要用多线程执行器，要回答这个问题，先来看看单线程执行器有什么问题：</p><ol><li>单线程执行器，所有回调都是串行执行，如果其中回调执行的工作比较多，其他回调必须等待，造成调度后延</li><li>即使回调执行很短，但如果你有很多回调需要服务，甚至需要他们同时执行，单线程执行器很难满足</li><li>如果你想在topic&#x2F;service回调中，执行一个阻塞的操作（如发送另一个service请求并同步等待响应），你就会遇到程序卡死问题<br>多线程执行器的引入，直接通过启动多个线程，带来回调执行上的并发，可以有效接触调用阻塞，提高节点的响应。当然，编程世界里没有银弹，多线程执行器同样带来很多隐含的特性，而且这些特性并不是很容易理解。我在这里先抛出几个问题，如果你不能清晰地回答，或许接下来分析会对你有所帮助：</li></ol><ul><li>问题1：多线程执行器与单线程执行器有关系？执行器会启动多少线程？</li><li>问题2：多线程执行器spin()和单线程spin()差异在哪里？</li><li>问题3：什么是回调组？”Mutually Exclusive Callback Group”和”Reentrant Callback Group”区别是什么？</li><li>问题4：多线程执行器并行调度的单元是什么，是节点吗？怎么做到回调并发执行？</li><li>问题5：”Reentrant Callback Group”能否导致同一个节点的同一个话题的回调，被多个线程并发调用？</li></ul><h2 id="实验-1"><a href="#实验-1" class="headerlink" title="实验"></a>实验</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/examples/rclcpp/executors/multithreaded_executor/multithreaded_executor.cpp</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp/rclcpp.hpp&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;std_msgs/msg/string.hpp&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std::chrono_literals;<br><br><span class="hljs-function">std::string <span class="hljs-title">string_thread_id</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">auto</span> hashed = std::<span class="hljs-built_in">hash</span>&lt;std::thread::id&gt;()(std::this_thread::<span class="hljs-built_in">get_id</span>());<br>  <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">to_string</span>(hashed);<br>&#125;<br><br><span class="hljs-comment">// 发送话题节点</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PublisherNode</span> : <span class="hljs-keyword">public</span> rclcpp::Node<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">PublisherNode</span>()<br>  : <span class="hljs-built_in">Node</span>(<span class="hljs-string">&quot;PublisherNode&quot;</span>), <span class="hljs-built_in">count_</span>(<span class="hljs-number">0</span>)<br>  &#123;<br>    publisher_ = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_publisher</span>&lt;std_msgs::msg::String&gt;(<span class="hljs-string">&quot;topic&quot;</span>, <span class="hljs-number">10</span>);<br>    <span class="hljs-keyword">auto</span> timer_callback =<br>      [<span class="hljs-keyword">this</span>]() -&gt; <span class="hljs-type">void</span> &#123;<br>        <span class="hljs-keyword">auto</span> message = std_msgs::msg::<span class="hljs-built_in">String</span>();<br>        message.data = <span class="hljs-string">&quot;Hello World! &quot;</span> + std::<span class="hljs-built_in">to_string</span>(<span class="hljs-keyword">this</span>-&gt;count_++);<br><br>        <span class="hljs-comment">// Extract current thread</span><br>        <span class="hljs-keyword">auto</span> curr_thread = <span class="hljs-built_in">string_thread_id</span>();<br><br>        <span class="hljs-comment">// 定时器每隔一段时间会发送自己线程ID</span><br>        <span class="hljs-built_in">RCLCPP_INFO</span>(<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;\n&lt;&lt;THREAD %s&gt;&gt; Publishing &#x27;%s&#x27;&quot;</span>,<br>          curr_thread.<span class="hljs-built_in">c_str</span>(), message.data.<span class="hljs-built_in">c_str</span>());<br>        <span class="hljs-keyword">this</span>-&gt;publisher_-&gt;<span class="hljs-built_in">publish</span>(message);<br>      &#125;;<br>    timer_ = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_wall_timer</span>(<span class="hljs-number">500</span>ms, timer_callback);<br>  &#125;<br><br><span class="hljs-keyword">private</span>:<br>  rclcpp::TimerBase::SharedPtr timer_;<br>  rclcpp::Publisher&lt;std_msgs::msg::String&gt;::SharedPtr publisher_;<br>  <span class="hljs-type">size_t</span> count_;<br>&#125;;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DualThreadedNode</span> : <span class="hljs-keyword">public</span> rclcpp::Node<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">DualThreadedNode</span>()<br>  : <span class="hljs-built_in">Node</span>(<span class="hljs-string">&quot;DualThreadedNode&quot;</span>)<br>  &#123;<br>    <span class="hljs-comment">/* These define the callback groups</span><br><span class="hljs-comment">     * They don&#x27;t really do much on their own, but they have to exist in order to</span><br><span class="hljs-comment">     * assign callbacks to them. They&#x27;re also what the executor looks for when trying to run multiple threads</span><br><span class="hljs-comment">     */</span><br>    callback_group_subscriber1_ = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_callback_group</span>(<br>      rclcpp::CallbackGroupType::MutuallyExclusive);<br>    callback_group_subscriber2_ = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_callback_group</span>(<br>      rclcpp::CallbackGroupType::MutuallyExclusive);<br><br>    <span class="hljs-comment">// Each of these callback groups is basically a thread</span><br>    <span class="hljs-comment">// Everything assigned to one of them gets bundled into the same thread</span><br>    <span class="hljs-keyword">auto</span> sub1_opt = rclcpp::<span class="hljs-built_in">SubscriptionOptions</span>();<br>    sub1_opt.callback_group = callback_group_subscriber1_;<br>    <span class="hljs-keyword">auto</span> sub2_opt = rclcpp::<span class="hljs-built_in">SubscriptionOptions</span>();<br>    sub2_opt.callback_group = callback_group_subscriber2_;<br><br>    subscription1_ = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_subscription</span>&lt;std_msgs::msg::String&gt;(<br>      <span class="hljs-string">&quot;topic&quot;</span>,<br>      rclcpp::<span class="hljs-built_in">QoS</span>(<span class="hljs-number">10</span>),<br>      <span class="hljs-comment">// std::bind is sort of C++&#x27;s way of passing a function</span><br>      <span class="hljs-comment">// If you&#x27;re used to function-passing, skip these comments</span><br>      std::<span class="hljs-built_in">bind</span>(<br>        &amp;DualThreadedNode::subscriber1_cb,  <span class="hljs-comment">// First parameter is a reference to the function</span><br>        <span class="hljs-keyword">this</span>,                               <span class="hljs-comment">// What the function should be bound to</span><br>        std::placeholders::_1),             <span class="hljs-comment">// At this point we&#x27;re not positive of all the</span><br>                                            <span class="hljs-comment">// parameters being passed</span><br>                                            <span class="hljs-comment">// So we just put a generic placeholder</span><br>                                            <span class="hljs-comment">// into the binder</span><br>                                            <span class="hljs-comment">// (since we know we need ONE parameter)</span><br>      sub1_opt);                  <span class="hljs-comment">// This is where we set the callback group.</span><br>                                  <span class="hljs-comment">// This subscription will run with callback group subscriber1</span><br><br>    subscription2_ = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_subscription</span>&lt;std_msgs::msg::String&gt;(<br>      <span class="hljs-string">&quot;topic&quot;</span>,<br>      rclcpp::<span class="hljs-built_in">QoS</span>(<span class="hljs-number">10</span>),<br>      std::<span class="hljs-built_in">bind</span>(<br>        &amp;DualThreadedNode::subscriber2_cb,<br>        <span class="hljs-keyword">this</span>,<br>        std::placeholders::_1),<br>      sub2_opt);<br>  &#125;<br><br><span class="hljs-keyword">private</span>:<br>  <span class="hljs-function">std::string <span class="hljs-title">timing_string</span><span class="hljs-params">()</span></span><br><span class="hljs-function">  </span>&#123;<br>    rclcpp::Time time = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">now</span>();<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">to_string</span>(time.<span class="hljs-built_in">nanoseconds</span>());<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Every time the Publisher publishes something, all subscribers to the topic get poked</span><br><span class="hljs-comment">   * This function gets called when Subscriber1 is poked (due to the std::bind we used when defining it)</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">subscriber1_cb</span><span class="hljs-params">(<span class="hljs-type">const</span> std_msgs::msg::String::ConstSharedPtr msg)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">auto</span> message_received_at = <span class="hljs-built_in">timing_string</span>();<br><br>    <span class="hljs-comment">// Extract current thread</span><br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;THREAD %s =&gt; Heard &#x27;%s&#x27; at %s&quot;</span>,<br>      <span class="hljs-built_in">string_thread_id</span>().<span class="hljs-built_in">c_str</span>(), msg-&gt;data.<span class="hljs-built_in">c_str</span>(), message_received_at.<span class="hljs-built_in">c_str</span>());<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * This function gets called when Subscriber2 is poked</span><br><span class="hljs-comment">   * Since it&#x27;s running on a separate thread than Subscriber 1, it will run at (more-or-less) the same time!</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">subscriber2_cb</span><span class="hljs-params">(<span class="hljs-type">const</span> std_msgs::msg::String::ConstSharedPtr msg)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">auto</span> message_received_at = <span class="hljs-built_in">timing_string</span>();<br><br>    <span class="hljs-comment">// Prep display message</span><br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;THREAD %s =&gt; Heard &#x27;%s&#x27; at %s&quot;</span>,<br>      <span class="hljs-built_in">string_thread_id</span>().<span class="hljs-built_in">c_str</span>(), msg-&gt;data.<span class="hljs-built_in">c_str</span>(), message_received_at.<span class="hljs-built_in">c_str</span>());<br>  &#125;<br><br>  rclcpp::CallbackGroup::SharedPtr callback_group_subscriber1_;<br>  rclcpp::CallbackGroup::SharedPtr callback_group_subscriber2_;<br>  rclcpp::Subscription&lt;std_msgs::msg::String&gt;::SharedPtr subscription1_;<br>  rclcpp::Subscription&lt;std_msgs::msg::String&gt;::SharedPtr subscription2_;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">init</span>(argc, argv);<br><br>  <span class="hljs-comment">// You MUST use the MultiThreadedExecutor to use, well, multiple threads</span><br>  rclcpp::executors::MultiThreadedExecutor executor;<br>  <span class="hljs-keyword">auto</span> pubnode = std::<span class="hljs-built_in">make_shared</span>&lt;PublisherNode&gt;();<br>  <span class="hljs-keyword">auto</span> subnode = std::<span class="hljs-built_in">make_shared</span>&lt;DualThreadedNode&gt;();                                          <br>  <br>  executor.<span class="hljs-built_in">add_node</span>(pubnode);<br>  executor.<span class="hljs-built_in">add_node</span>(subnode);<br>  executor.<span class="hljs-built_in">spin</span>();<br>  rclcpp::<span class="hljs-built_in">shutdown</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>以上仍然是ROS2官方example。我们分析仍然从主函数开始，主函数定义了多线程调度器，并且同时加入了发布节点和接收节点，executor.spin()进入了调度循环，我们暂时忽略类内回调组，下面会分析。</p><h2 id="执行器关系"><a href="#执行器关系" class="headerlink" title="执行器关系"></a>执行器关系</h2><p>从代码结构上看，多线程执行器和单线程执行器相似度很高，你甚至可以把这段代码中多线程调度器替换成单线程调度器，同样可以编译。这两种执行器都是继承同一父类，代码结构类似。</p><p><img src="/img/ros2-executor/executor%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.png"></p><p>多线程执行器对象创建时，构造函数可以调整启动线程数目，而线程创建和执行在spin()中完成，多线程的引入，给并发地执行回调提供了可能：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++">MultiThreadedExecutor::<span class="hljs-built_in">MultiThreadedExecutor</span>(<br>  <span class="hljs-type">const</span> rclcpp::ExecutorOptions &amp; options,<br>  <span class="hljs-type">size_t</span> number_of_threads,<br>  <span class="hljs-type">bool</span> yield_before_execute,<br>  std::chrono::nanoseconds next_exec_timeout)<br>: rclcpp::<span class="hljs-built_in">Executor</span>(options),<br>  <span class="hljs-built_in">yield_before_execute_</span>(yield_before_execute),<br>  <span class="hljs-built_in">next_exec_timeout_</span>(next_exec_timeout)<br>&#123;<br>  number_of_threads_ = number_of_threads ? number_of_threads : std::thread::<span class="hljs-built_in">hardware_concurrency</span>();<br>  <span class="hljs-keyword">if</span> (number_of_threads_ == <span class="hljs-number">0</span>) &#123;<br>    number_of_threads_ = <span class="hljs-number">1</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><div class="note note-success">            <p>问题1：多线程执行器，与单线程执行器有关系？执行器会启动多少线程？<br>(1)单线程执行器和多线程执行器继承自同一个父类，具有相似的编码结构。<br>(2)在多线程执行器构造时，可以指定大于0的线程数目，或者默认线程数目”std::thread::hardware_concurrency()”，一般为机器CPU核心数。</p>          </div><h2 id="多线程执行器spin"><a href="#多线程执行器spin" class="headerlink" title="多线程执行器spin()"></a>多线程执行器spin()</h2><p>虽然代码结构相似，但spin()行为却差异很大，多线程执行器启动多个线程，以便未来并发地执行回调：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//src/ros2/rclcpp/rclcpp/src/rclcpp/executors/multi_threaded_executor.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MultiThreadedExecutor::spin</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// 这部分与单线程执行器一致，都是为了防止多次spin()</span><br>  <span class="hljs-keyword">if</span> (spinning.<span class="hljs-built_in">exchange</span>(<span class="hljs-literal">true</span>)) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;spin() called while already spinning&quot;</span>);<br>  &#125;<br>  <span class="hljs-built_in">RCPPUTILS_SCOPE_EXIT</span>(<span class="hljs-keyword">this</span>-&gt;spinning.<span class="hljs-built_in">store</span>(<span class="hljs-literal">false</span>); );<br>  std::vector&lt;std::thread&gt; threads;<br>  <span class="hljs-type">size_t</span> thread_id = <span class="hljs-number">0</span>;<br>  <br>  <span class="hljs-comment">// 启动多个线程，值得注意的是：</span><br>  <span class="hljs-comment">// 1. 所有线程启动都在锁内保护，这个锁在run函数里也会用到</span><br>  <span class="hljs-comment">// 2. 注意这里少了一个线程，因为调用spin()函数的那个线程也要被使用，例如执行器开启8个线程：7个新线程+1个启动线程（启动7个线程的线程）</span><br>  <span class="hljs-comment">// 注：这里我也感觉是一个编程缺陷，作者可能想着同步所有线程，却把启动线程放在外边，可以考虑使用其他同步机制</span><br>  &#123;<br>    std::lock_guard wait_lock&#123;wait_mutex_&#125;;<br>    <span class="hljs-keyword">for</span> (; thread_id &lt; number_of_threads_ - <span class="hljs-number">1</span>; ++thread_id) &#123;<br>      <span class="hljs-keyword">auto</span> func = std::<span class="hljs-built_in">bind</span>(&amp;MultiThreadedExecutor::run, <span class="hljs-keyword">this</span>, thread_id);<br>      threads.<span class="hljs-built_in">emplace_back</span>(func);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 启动线程也运行run()</span><br>  <span class="hljs-built_in">run</span>(thread_id);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> &amp; thread : threads) &#123;<br>    thread.<span class="hljs-built_in">join</span>();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>也就是说，多线程执行器在spin()中启动了MultiThreadedExecutor::number_of_threads_个线程，并发运行MultiThreadedExecutor::run()函数。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//src/ros2/rclcpp/rclcpp/src/rclcpp/executors/multi_threaded_executor.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MultiThreadedExecutor::run</span><span class="hljs-params">(<span class="hljs-type">size_t</span> this_thread_number)</span></span><br><span class="hljs-function"></span>&#123;<br>  (<span class="hljs-type">void</span>)this_thread_number;<br>  <span class="hljs-keyword">while</span> (rclcpp::<span class="hljs-built_in">ok</span>(<span class="hljs-keyword">this</span>-&gt;context_) &amp;&amp; spinning.<span class="hljs-built_in">load</span>()) &#123;<br>    rclcpp::AnyExecutable any_exec;<br>    <span class="hljs-comment">// !!! 注意这里，代码这里也加了wait_mutex_锁</span><br>    &#123;<br>      std::lock_guard wait_lock&#123;wait_mutex_&#125;;<br>      <span class="hljs-keyword">if</span> (!rclcpp::<span class="hljs-built_in">ok</span>(<span class="hljs-keyword">this</span>-&gt;context_) || !spinning.<span class="hljs-built_in">load</span>()) &#123;<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>      <br>      <span class="hljs-comment">// 尝试获取一个可调用对象</span><br>      <span class="hljs-comment">// 这部分在wait_mutex_锁内，所以同时只有一个线程能进入</span><br>      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">get_next_executable</span>(any_exec, next_exec_timeout_)) &#123;<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (yield_before_execute_) &#123;<br>      std::this_thread::<span class="hljs-built_in">yield</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// 执行可调用对象</span><br>    <span class="hljs-comment">// 这部分在wait_mutex_锁外部，所以可以并发地执行</span><br>    <span class="hljs-built_in">execute_any_executable</span>(any_exec);<br>    <br>    <span class="hljs-comment">// 可调用对象已经无用了，删除</span><br>    any_exec.callback_group.<span class="hljs-built_in">reset</span>();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>和单线程执行器类似，这里同样通过是get_next_executable()-&gt;execute_any_executable()。<br>注意代码包含wait_mutex_锁位置，查询并获取下一个可调用对象的函数get_next_executable()，不是并行执行，而且<strong>多线程间互斥执行</strong>的。执行可回调的函数execute_any_executable()，并没有wait_mutex_锁的保护，所以是<strong>可以</strong>并行执行的。</p><p><img src="/img/ros2-executor/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%99%A8spin()%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png"></p><div class="note note-success">            <p>问题2：多线程执行器spin()和单线程spin()差异在哪里？<br>(1)多线程执行器的spin()启动多个线程，如果用户只启动一个线程，就退化到单线程执行器<br>(2)spin()互斥执行get_next_executable()，并发执行execute_any_executable()，给予回调并发执行能力</p>          </div><h1 id="回调组"><a href="#回调组" class="headerlink" title="回调组"></a>回调组</h1><p>到这里你可能以为：所有的回调函数在多线程执行器调度下都是并发执行的，这个结论仍然是不充分的。<br>以上论述仅仅能说明：多线程执行器提供并行执行能力，但并没有说明并发执行的单元是谁？并发会不会由于某些限制，退化到串行执行？回调函数是不是会发生重入？等。要解释清楚这些，就要从回调组说起，先直接给出问题3-问题5的答案，然后再分析代码。<br>以下是官方的回调组定义（<a href="https://docs.ros.org/en/humble/How-To-Guides/Using-callback-groups.html">Using Callback Groups — ROS 2 Documentation: Humble documentation</a>）：</p><p><img src="/img/ros2-executor/callback_group%E5%AE%9A%E4%B9%89.png"></p><p>比较简单明了，这里总结一下回调组的差异：</p><div class="note note-success">            <p>问题3：什么是回调组？”Mutually Exclusive Callback Group”和”Reentrant Callback Group”区别是什么？<br>回调组是用来控制回调并发执行的回调集合（在多线程执行器有实际意义，因为单线程执行器本身就是串行的），从调度角度看，ROS2 Node可以理解为回调组的集合，节点包含多个回调组（节点默认会创建一个互斥回调组），回调组分为两种：<br>(1)互斥回调组（Mutually Exclusive Callback Group）：不同回调组回调可并发地执行，同一个回调组的回调串行地执行；<br>(2)可重入回调组（Reentrant Callback Group）：没有限制，不同回调组的回调可并发地执行，同一个回调组的回调也可并发地执行。</p>          </div><div class="note note-success">            <p>问题4：多线程执行器并行调度的单元是什么，是节点吗？怎么做到回调并行执行？<br>多线程执行器调度基本单元是回调函数。节点是回调组的集合，每个回调组可以包含多个回调，回调组通过设置不同的属性（互斥或重入）控制回调并发执行的行为。</p>          </div><p>在官网的说明，对于Reentrant Callback Group中有一句话：This means that, in addition to different callbacks being run parallel to each other, different instances of the same callback may also be executed concurrently.</p><div class="note note-success">            <p>问题5：”Reentrant Callback Group”能否导致同一个节点的同一个话题的回调，被多个线程并发调用？<br>可以，也就是说在多线程执行器中，如果消息或请求持续到来，并且有空闲线程，那么同一个回调会被并行执行。这是一个“危险的”特性，这要求函数可重入，个人推测这也是Reentrant Callback Group名字中Reentrant的由来。</p>          </div><p>大家对于以上的特性有了概念后，我们就能继续分析代码，并且说明ros2 humble怎么通过代码实现以上的特性。再次祭出官网的调度图（以下简称：<strong>调度图</strong>），只不过这一次调度被并行执行。</p><p><img src="/img/ros2-executor/executor%E5%BD%A2%E8%B1%A1%E6%B5%81%E7%A8%8B.png"></p><p>如之前单线程执行器中所述，整个过程核心就是：</p><ul><li>等待并获取可调用对象在Executor::get_next_executable()中，分别对应1)wait和2)take；</li><li>执行可调用对象回调函数在Executor::execute_any_executable()中，对应3)execute。<br>具体代码和注释如下：</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/src/rclcpp/executor.cpp</span><br><span class="hljs-comment">// 获取下一个可调用对象，我们暂时不考虑这里timeout，任务这里会持续等待</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Executor::get_next_executable</span><span class="hljs-params">(AnyExecutable &amp; any_executable, std::chrono::nanoseconds timeout)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">bool</span> success = <span class="hljs-literal">false</span>;<br>  <span class="hljs-comment">// 检查是否有可调用的对象：话题、服务、定时器等</span><br>  <span class="hljs-comment">// 作者也在这里加入了TODO，因为这里是循环对比所有请求对象是否有效，所以在底层请求对象（如话题）超级多的情况下，会给CPU形成明显的负担</span><br>  <span class="hljs-comment">// TODO(wjwwood): improve run to run efficiency of this function</span><br>  success = <span class="hljs-built_in">get_next_ready_executable</span>(any_executable);<br>  <span class="hljs-keyword">if</span> (!success) &#123;<br>    <span class="hljs-comment">// 如果没有获取成功，就尝试从底层等待消息的到来</span><br>    <span class="hljs-built_in">wait_for_work</span>(timeout);<br>    <br>    <span class="hljs-comment">// 确保spining持续进行，外部没有退出</span><br>    <span class="hljs-keyword">if</span> (!spinning.<span class="hljs-built_in">load</span>()) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 忽略timeout的话，消息或请求应该是等到了，再次尝试是否能够拿到可调用对象</span><br>    success = <span class="hljs-built_in">get_next_ready_executable</span>(any_executable);<br>  &#125;<br>  <span class="hljs-keyword">return</span> success;<br>&#125;<br></code></pre></td></tr></table></figure><p>之前说过，get_next_executable()在多线程执行器中，是互斥执行的。也就是说同时只有一个线程会执行该函数，暂时不必担心该函数的线程安全问题。<br>wait_for_work()就是调度图中的1)wait，而get_next_ready_executable()函数就是调度图中的2)take。举个例子，假设这次没有拿到可调用对象，执行了wait_for_work()尝试更新wait_set，具体代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/src/rclcpp/executor.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Executor::wait_for_work</span><span class="hljs-params">(std::chrono::nanoseconds timeout)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">TRACEPOINT</span>(rclcpp_executor_wait_for_work, timeout.<span class="hljs-built_in">count</span>());<br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(mutex_)</span></span>;<br><br>    <span class="hljs-comment">// 将执行器下的所有回调组，加入到Executor的map数据结构里，方便索引</span><br>    <span class="hljs-built_in">add_callback_groups_from_nodes_associated_to_executor</span>();<br><br>    <span class="hljs-comment">// 收集所有的准备消息订阅、服务、客户端、定时器、waitable，这些都以handles形式存储到memory_strategy_</span><br>    <span class="hljs-comment">// ！！collect_entities中包含有一个group-&gt;can_be_taken_from().load()，可以防止正在执行的互斥回调组二次加入，后面细说</span><br>    memory_strategy_-&gt;<span class="hljs-built_in">clear_handles</span>();<br>    <span class="hljs-type">bool</span> has_invalid_weak_groups_or_nodes =<br>      memory_strategy_-&gt;<span class="hljs-built_in">collect_entities</span>(weak_groups_to_nodes_);<br><br>    <span class="hljs-keyword">if</span> (has_invalid_weak_groups_or_nodes) &#123;<br>      <span class="hljs-comment">// 无效的group和node处理，不关心</span><br>      <span class="hljs-comment">//.....</span><br>    &#125;<br><br>    <span class="hljs-comment">// 清空wait_set，注意这里调用的是rcl(ROS Client Support Library)库，具体底层暂时不关心</span><br>    <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_wait_set_clear</span>(&amp;wait_set_);<br>    <span class="hljs-keyword">if</span> (ret != RCL_RET_OK) &#123;<br>      <span class="hljs-built_in">throw_from_rcl_error</span>(ret, <span class="hljs-string">&quot;Couldn&#x27;t clear wait set&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 根据收集的订阅、定时器等，重新申请wait_set内部数据结构内存</span><br>    <span class="hljs-comment">// 奇怪的是：这里传递的size参数都没用，直接从底层确定订阅、定时器等数量</span><br>    ret = <span class="hljs-built_in">rcl_wait_set_resize</span>(<br>      &amp;wait_set_, memory_strategy_-&gt;<span class="hljs-built_in">number_of_ready_subscriptions</span>(),<br>      memory_strategy_-&gt;<span class="hljs-built_in">number_of_guard_conditions</span>(), memory_strategy_-&gt;<span class="hljs-built_in">number_of_ready_timers</span>(),<br>      memory_strategy_-&gt;<span class="hljs-built_in">number_of_ready_clients</span>(), memory_strategy_-&gt;<span class="hljs-built_in">number_of_ready_services</span>(),<br>      memory_strategy_-&gt;<span class="hljs-built_in">number_of_ready_events</span>());<br>    <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>      <span class="hljs-built_in">throw_from_rcl_error</span>(ret, <span class="hljs-string">&quot;Couldn&#x27;t resize the wait set&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 把需要等待的订阅、定时器、客户端、服务端对象加入到待等待集合，并设置好rmw底层数据结构</span><br>    <span class="hljs-comment">// 函数会填充类似wait_set-&gt;impl-&gt;rmw_type.type[i]数据结构（一堆宏函数）</span><br>    <span class="hljs-keyword">if</span> (!memory_strategy_-&gt;<span class="hljs-built_in">add_handles_to_wait_set</span>(&amp;wait_set_)) &#123;<br>      <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Couldn&#x27;t fill wait set&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 等待，内部调用了rmw_wait等待</span><br>  <span class="hljs-comment">// 函数会根据消息有无、定时器是否到期等，填充类似wait_set-&gt;impl-&gt;rmw_type.types[i]设置</span><br>  <span class="hljs-type">rcl_ret_t</span> status =<br>    <span class="hljs-built_in">rcl_wait</span>(&amp;wait_set_, std::chrono::<span class="hljs-built_in">duration_cast</span>&lt;std::chrono::nanoseconds&gt;(timeout).<span class="hljs-built_in">count</span>());<br>  <span class="hljs-keyword">if</span> (status == RCL_RET_WAIT_SET_EMPTY) &#123;<br>    <span class="hljs-built_in">RCUTILS_LOG_WARN_NAMED</span>(<br>      <span class="hljs-string">&quot;rclcpp&quot;</span>,<br>      <span class="hljs-string">&quot;empty wait set received in rcl_wait(). This should never happen.&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status != RCL_RET_OK &amp;&amp; status != RCL_RET_TIMEOUT) &#123;<br>    <span class="hljs-keyword">using</span> rclcpp::exceptions::throw_from_rcl_error;<br>    <span class="hljs-built_in">throw_from_rcl_error</span>(status, <span class="hljs-string">&quot;rcl_wait() failed&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// check the null handles in the wait set and remove them from the handles in memory strategy</span><br>  <span class="hljs-comment">// for callback-based entities</span><br>  <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(mutex_)</span></span>;<br>  <span class="hljs-comment">// wait_set_没有准备好的订阅、定时器等对象会是NULL，会在这里被从Executor的Handles数组清除，没有被清除的元素都是有效的请求</span><br>  <span class="hljs-comment">// 在后面做2)take的时候，直接对比的是Executor的Handles数据结构和节点中的订阅、定时器等，确定对象是否有效</span><br>  memory_strategy_-&gt;<span class="hljs-built_in">remove_null_handles</span>(&amp;wait_set_);<br>&#125;<br></code></pre></td></tr></table></figure><p>上面代码大致：在收集完订阅、定时器、服务端、客户端、waitable对象后，初始化rmw底层数据结构，并调用rcl_wait()尝试等待(注意这里wait_set_具有复杂数据结构，并非简单数组)。<br>在rcl_wait()内部调用rmw_wait()，确定消息订阅有没有数据、定时器是否就绪等，并基于此更新wait_set_数据结构(调度图中wait_set&#x3D;101，就是指&#x2F;goal、&#x2F;odom有数据，&#x2F;cmd无数据)。然后拿到wait_set_后，Executor根据wait_set_更新自己的内部数据结构memory_strategy_，简单说就是从订阅、定时器等Handles数组中，抹去无数据的订阅、没有就绪定时器等（对应位置设置为NULL），方便之后2)take循环检查。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rcl/rcl/src/rcl/wait.c</span><br><span class="hljs-function"><span class="hljs-type">rcl_ret_t</span> <span class="hljs-title">rcl_wait</span><span class="hljs-params">(<span class="hljs-type">rcl_wait_set_t</span> * wait_set, <span class="hljs-type">int64_t</span> timeout)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// ... timeout等处理，跳过</span><br><br>  <span class="hljs-comment">// 尝试等待 </span><br>  <span class="hljs-type">rmw_ret_t</span> ret = <span class="hljs-built_in">rmw_wait</span>(<br>    &amp;wait_set-&gt;impl-&gt;rmw_subscriptions,<br>    &amp;wait_set-&gt;impl-&gt;rmw_guard_conditions,<br>    &amp;wait_set-&gt;impl-&gt;rmw_services,<br>    &amp;wait_set-&gt;impl-&gt;rmw_clients,<br>    &amp;wait_set-&gt;impl-&gt;rmw_events,<br>    wait_set-&gt;impl-&gt;rmw_wait_set,<br>    timeout_argument);<br>    <br>  <span class="hljs-comment">// 对于还没准备好的定时器、订阅，更新对应的handles数组，设置为NULL</span><br>  <br>  <span class="hljs-type">size_t</span> i;<br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; wait_set-&gt;impl-&gt;timer_index; ++i) &#123;<br>    <span class="hljs-keyword">if</span> (!wait_set-&gt;timers[i]) &#123;<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    <span class="hljs-type">bool</span> is_ready = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_timer_is_ready</span>(wait_set-&gt;timers[i], &amp;is_ready);<br>    <span class="hljs-keyword">if</span> (ret != RCL_RET_OK) &#123;<br>      <span class="hljs-keyword">return</span> ret;  <span class="hljs-comment">// The rcl error state should already be set.</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> (!is_ready) &#123;<br>      wait_set-&gt;timers[i] = <span class="hljs-literal">NULL</span>;<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-comment">//.....</span><br>  <br>  <span class="hljs-comment">// Set corresponding rcl subscription handles NULL.</span><br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; wait_set-&gt;size_of_subscriptions; ++i) &#123;<br>    <span class="hljs-type">bool</span> is_ready = wait_set-&gt;impl-&gt;rmw_subscriptions.subscribers[i] != <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">if</span> (!is_ready) &#123;<br>      wait_set-&gt;subscriptions[i] = <span class="hljs-literal">NULL</span>;<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-comment">//....其他类似处理</span><br>  <br>  <span class="hljs-keyword">return</span> RCL_RET_OK;<br>&#125;<br></code></pre></td></tr></table></figure><p>memory_strategy_-&gt;remove_null_handles(&amp;wait_set_);移除Handles元素过程如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/include/rclcpp/strategies/allocator_memory_strategy.hpp</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">remove_null_handles</span><span class="hljs-params">(<span class="hljs-type">rcl_wait_set_t</span> * wait_set)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function">  </span>&#123;<br>     <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; subscription_handles_.<span class="hljs-built_in">size</span>(); ++i) &#123;<br>      <span class="hljs-keyword">if</span> (!wait_set-&gt;subscriptions[i]) &#123;<br>        subscription_handles_[i].<span class="hljs-built_in">reset</span>();<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">// ......</span><br><br>    subscription_handles_.<span class="hljs-built_in">erase</span>(<br>      std::<span class="hljs-built_in">remove</span>(subscription_handles_.<span class="hljs-built_in">begin</span>(), subscription_handles_.<span class="hljs-built_in">end</span>(), <span class="hljs-literal">nullptr</span>),<br>      subscription_handles_.<span class="hljs-built_in">end</span>()<br>    );<br><br>    <span class="hljs-comment">// ......</span><br>  &#125;<br></code></pre></td></tr></table></figure><p>我们已经获取了所有的准备好的消息、定时器等，紧接着就是2)take阶段，从其中选择一个可调用对象，官网上流程图展示了这个过程<a href="https://docs.ros.org/en/humble/Concepts/Intermediate/About-Executors.html">Executors — ROS 2 Documentation: Humble documentation</a>：</p><p><img src="/img/ros2-executor/take%E7%9A%84%E6%B5%81%E7%A8%8B.png"></p><p>对应的具体代码如下，你可以在图和代码一一对应上。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/src/rclcpp/executor.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Executor::get_next_ready_executable</span><span class="hljs-params">(AnyExecutable &amp; any_executable)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// 直接转发到get_next_ready_executable_from_map</span><br>  <span class="hljs-type">bool</span> success = <span class="hljs-built_in">get_next_ready_executable_from_map</span>(any_executable, weak_groups_to_nodes_);<br>  <span class="hljs-keyword">return</span> success;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Executor::get_next_ready_executable_from_map</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  AnyExecutable &amp; any_executable,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> rclcpp::memory_strategy::MemoryStrategy::WeakCallbackGroupsToNodesMap &amp;</span></span><br><span class="hljs-params"><span class="hljs-function">  weak_groups_to_nodes)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">TRACEPOINT</span>(rclcpp_executor_get_next_ready);<br>  <span class="hljs-type">bool</span> success = <span class="hljs-literal">false</span>;<br>  std::lock_guard&lt;std::mutex&gt; guard&#123;mutex_&#125;;<br>  <span class="hljs-comment">// Check the timers to see if there are any that are ready</span><br>  memory_strategy_-&gt;<span class="hljs-built_in">get_next_timer</span>(any_executable, weak_groups_to_nodes);<br>  <span class="hljs-keyword">if</span> (any_executable.timer) &#123;<br>    success = <span class="hljs-literal">true</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (!success) &#123;<br>    <span class="hljs-comment">// Check the subscriptions to see if there are any that are ready</span><br>    memory_strategy_-&gt;<span class="hljs-built_in">get_next_subscription</span>(any_executable, weak_groups_to_nodes);<br>    <span class="hljs-keyword">if</span> (any_executable.subscription) &#123;<br>      success = <span class="hljs-literal">true</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (!success) &#123;<br>    <span class="hljs-comment">// Check the services to see if there are any that are ready</span><br>    memory_strategy_-&gt;<span class="hljs-built_in">get_next_service</span>(any_executable, weak_groups_to_nodes);<br>    <span class="hljs-keyword">if</span> (any_executable.service) &#123;<br>      success = <span class="hljs-literal">true</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (!success) &#123;<br>    <span class="hljs-comment">// Check the clients to see if there are any that are ready</span><br>    memory_strategy_-&gt;<span class="hljs-built_in">get_next_client</span>(any_executable, weak_groups_to_nodes);<br>    <span class="hljs-keyword">if</span> (any_executable.client) &#123;<br>      success = <span class="hljs-literal">true</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (!success) &#123;<br>    <span class="hljs-comment">// Check the waitables to see if there are any that are ready</span><br>    memory_strategy_-&gt;<span class="hljs-built_in">get_next_waitable</span>(any_executable, weak_groups_to_nodes);<br>    <span class="hljs-keyword">if</span> (any_executable.waitable) &#123;<br>      any_executable.data = any_executable.waitable-&gt;<span class="hljs-built_in">take_data</span>();<br>      success = <span class="hljs-literal">true</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// At this point any_executable should be valid with either a valid subscription</span><br>  <span class="hljs-comment">// or a valid timer, or it should be a null shared_ptr</span><br>  <span class="hljs-keyword">if</span> (success) &#123;<br>    rclcpp::CallbackGroup::WeakPtr weak_group_ptr = any_executable.callback_group;<br>    <span class="hljs-keyword">auto</span> iter = weak_groups_to_nodes.<span class="hljs-built_in">find</span>(weak_group_ptr);<br>    <span class="hljs-keyword">if</span> (iter == weak_groups_to_nodes.<span class="hljs-built_in">end</span>()) &#123;<br>      success = <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (success) &#123;<br>    <span class="hljs-comment">// If it is valid, check to see if the group is mutually exclusive or</span><br>    <span class="hljs-comment">// not, then mark it accordingly ..Check if the callback_group belongs to this executor</span><br>    <span class="hljs-keyword">if</span> (any_executable.callback_group &amp;&amp; any_executable.callback_group-&gt;<span class="hljs-built_in">type</span>() == CallbackGroupType::MutuallyExclusive)<br>    &#123;<br>      <span class="hljs-comment">// It should not have been taken otherwise</span><br>      <span class="hljs-built_in">assert</span>(any_executable.callback_group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">load</span>());<br>      <span class="hljs-comment">// Set to false to indicate something is being run from this group</span><br>      <span class="hljs-comment">// This is reset to true either when the any_executable is executed or when the</span><br>      <span class="hljs-comment">// any_executable is destructued</span><br>      any_executable.callback_group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">store</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// If there is no ready executable, return false</span><br>  <span class="hljs-keyword">return</span> success;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里我想说明三点：</p><ol><li>显然这里的处理是有优先级的，优先定时器-&gt;订阅-&gt;服务-&gt;客户端-&gt;其他可调用对象，个人认为这种优先级可能在不当编程下造成部分请求回调的饥饿；</li><li>这里get_next_xxxx函数，为了解决有效性的问题，这里采用循环和当前回调组内部的话题对比，个人认为在大量话题的系统下，会显著增加CPU负担；</li><li>在take可调用对象的时候，也做了group-&gt;can_be_taken_from().load()判断，确定是否允许访问已经在执行回调组。<br>以下是take一个订阅的过程：</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/src/rclcpp/executor.cpp</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">get_next_subscription</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    rclcpp::AnyExecutable &amp; any_exec,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> WeakCallbackGroupsToNodesMap &amp; weak_groups_to_nodes)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">auto</span> it = subscription_handles_.<span class="hljs-built_in">begin</span>();<br>    <span class="hljs-keyword">while</span> (it != subscription_handles_.<span class="hljs-built_in">end</span>()) &#123;<br>      <span class="hljs-keyword">auto</span> subscription = <span class="hljs-built_in">get_subscription_by_handle</span>(*it, weak_groups_to_nodes);<br>      <span class="hljs-keyword">if</span> (subscription) &#123;<br>        <span class="hljs-comment">// Find the group for this handle and see if it can be serviced</span><br>        <span class="hljs-keyword">auto</span> group = <span class="hljs-built_in">get_group_by_subscription</span>(subscription, weak_groups_to_nodes);<br>        <span class="hljs-keyword">if</span> (!group) &#123;<br>          <span class="hljs-comment">// Group was not found, meaning the subscription is not valid...</span><br>          <span class="hljs-comment">// Remove it from the ready list and continue looking</span><br>          it = subscription_handles_.<span class="hljs-built_in">erase</span>(it);<br>          <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-comment">// ！！这里很重要，回调组的属性由这里体现</span><br>        <span class="hljs-keyword">if</span> (!group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">load</span>()) &#123;<br>          <span class="hljs-comment">// Group is mutually exclusive and is being used, so skip it for now</span><br>          <span class="hljs-comment">// Leave it to be checked next time, but continue searching</span><br>          ++it;<br>          <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-comment">// Otherwise it is safe to set and return the any_exec</span><br>        any_exec.subscription = subscription;<br>        any_exec.callback_group = group;<br>        any_exec.node_base = <span class="hljs-built_in">get_node_by_group</span>(group, weak_groups_to_nodes);<br>        subscription_handles_.<span class="hljs-built_in">erase</span>(it);<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>      <span class="hljs-comment">// Else, the subscription is no longer valid, remove it and continue</span><br>      it = subscription_handles_.<span class="hljs-built_in">erase</span>(it);<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>当我们拿到可调用的对象，剩下的就是执行可调用对象了。我们以execute_subscription()为例，如果有消息到来，则execute_subscription()会处理好序列化，并直接调用已经存储好的callback函数，细节不在这里赘述。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/src/rclcpp/executor.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Executor::execute_any_executable</span><span class="hljs-params">(AnyExecutable &amp; any_exec)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!spinning.<span class="hljs-built_in">load</span>()) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (any_exec.timer) &#123;<br>    <span class="hljs-built_in">TRACEPOINT</span>(<br>      rclcpp_executor_execute,<br>      <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">void</span> *&gt;(any_exec.timer-&gt;<span class="hljs-built_in">get_timer_handle</span>().<span class="hljs-built_in">get</span>()));<br>    <span class="hljs-built_in">execute_timer</span>(any_exec.timer);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (any_exec.subscription) &#123;<br>    <span class="hljs-built_in">TRACEPOINT</span>(<br>      rclcpp_executor_execute,<br>      <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">void</span> *&gt;(any_exec.subscription-&gt;<span class="hljs-built_in">get_subscription_handle</span>().<span class="hljs-built_in">get</span>()));<br>    <span class="hljs-built_in">execute_subscription</span>(any_exec.subscription);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (any_exec.service) &#123;<br>    <span class="hljs-built_in">execute_service</span>(any_exec.service);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (any_exec.client) &#123;<br>    <span class="hljs-built_in">execute_client</span>(any_exec.client);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (any_exec.waitable) &#123;<br>    any_exec.waitable-&gt;<span class="hljs-built_in">execute</span>(any_exec.data);<br>  &#125;<br><br>  <span class="hljs-comment">// !!! 这里很重要</span><br>  any_exec.callback_group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">store</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-comment">// Wake the wait, because it may need to be recalculated or work that</span><br>  <span class="hljs-comment">// was previously blocked is now available.</span><br>  <span class="hljs-keyword">try</span> &#123;<br>    interrupt_guard_condition_.<span class="hljs-built_in">trigger</span>();<br>  &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> rclcpp::exceptions::RCLError &amp; ex) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<br>            std::<span class="hljs-built_in">string</span>(<br>              <span class="hljs-string">&quot;Failed to trigger guard condition from execute_any_executable: &quot;</span>) + ex.<span class="hljs-built_in">what</span>());<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>到这里问题4基本明白。问题3和问题5还没有被理清楚，因为代码跨度太大，为了弄清楚调度逻辑，我们需要跟踪can_be_taken_from()，才能说明并发的流程。为了方便说明，暂时把其他不重要的代码省略掉。仍然从run开始：</p><ul><li>整个调用流程是互斥的执行get_next_executable()；</li><li>并发的执行execute_any_executable()。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/src/rclcpp/executors/multi_threaded_executor.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MultiThreadedExecutor::run</span><span class="hljs-params">(<span class="hljs-type">size_t</span> this_thread_number)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">while</span> (rclcpp::<span class="hljs-built_in">ok</span>(<span class="hljs-keyword">this</span>-&gt;context_) &amp;&amp; spinning.<span class="hljs-built_in">load</span>()) &#123;<br>    rclcpp::AnyExecutable any_exec;<br>    &#123;<br>      std::lock_guard wait_lock&#123;wait_mutex_&#125;;<br>      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">get_next_executable</span>(any_exec, next_exec_timeout_)) &#123;<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br>    &#125;<br>    <br>    <span class="hljs-built_in">execute_any_executable</span>(any_exec);<br>    any_exec.callback_group.<span class="hljs-built_in">reset</span>();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>get_next_executable()是互斥执行的，当满足两个条件，那么can_be_taken_from_会设置为false，表示不允许再执行该回调组里的回调：</p><ul><li>成功take了一个可调用对象；</li><li>可调用对象所属的回调组类型为CallbackGroupType::MutuallyExclusive。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/src/rclcpp/executor.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Executor::get_next_executable</span><span class="hljs-params">(AnyExecutable &amp; any_executable, std::chrono::nanoseconds timeout)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">bool</span> success = <span class="hljs-built_in">get_next_ready_executable</span>(any_executable);<br>  <span class="hljs-keyword">if</span> (!success) &#123;<br>    <span class="hljs-built_in">wait_for_work</span>(timeout);<br>    success = <span class="hljs-built_in">get_next_ready_executable</span>(any_executable);<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> success;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Executor::get_next_ready_executable</span><span class="hljs-params">(AnyExecutable &amp; any_executable)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">bool</span> success = <span class="hljs-built_in">get_next_ready_executable_from_map</span>(any_executable, weak_groups_to_nodes_);<br>  <span class="hljs-keyword">return</span> success;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Executor::get_next_ready_executable_from_map</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  AnyExecutable &amp; any_executable,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> rclcpp::memory_strategy::MemoryStrategy::WeakCallbackGroupsToNodesMap &amp;weak_groups_to_nodes)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">TRACEPOINT</span>(rclcpp_executor_get_next_ready);<br>  <span class="hljs-type">bool</span> success = <span class="hljs-literal">false</span>;<br>  std::lock_guard&lt;std::mutex&gt; guard&#123;mutex_&#125;;<br><br>  <span class="hljs-comment">//.......</span><br><br>  <span class="hljs-keyword">if</span> (success) &#123;<br>    <span class="hljs-keyword">if</span> (any_executable.callback_group &amp;&amp; any_executable.callback_group-&gt;<span class="hljs-built_in">type</span>() \<br>        == CallbackGroupType::MutuallyExclusive)<br>    &#123;<br>      <span class="hljs-built_in">assert</span>(any_executable.callback_group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">load</span>());<br>      any_executable.callback_group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">store</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> success;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>并发的执行execute_any_executable()的最后，会将可调用对象所在回调组的can_be_taken_from_设置为true，表示该回调组的回调已经执行完毕，可以再次执行该回调了。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Executor::execute_any_executable</span><span class="hljs-params">(AnyExecutable &amp; any_exec)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (any_exec.subscription) &#123;<br>    <span class="hljs-built_in">execute_subscription</span>(any_exec.subscription);<br>  &#125;<br>  <br>  any_exec.callback_group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">store</span>(<span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>根据can_be_taken_from_的值，确定回调是否能被执行的代码如下，程序在收集对象Handles、take的时候都有判断：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">collect_entities</span><span class="hljs-params">(<span class="hljs-type">const</span> WeakCallbackGroupsToNodesMap &amp; weak_groups_to_nodes)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">//......</span><br>    <span class="hljs-keyword">if</span> (!group || !group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">load</span>()) &#123;<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br>  <span class="hljs-comment">//......</span><br>  <span class="hljs-keyword">return</span> has_invalid_weak_groups_or_nodes;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">get_next_subscription</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::AnyExecutable &amp; any_exec,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> WeakCallbackGroupsToNodesMap &amp; weak_groups_to_nodes)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">auto</span> it = subscription_handles_.<span class="hljs-built_in">begin</span>();<br>  <span class="hljs-keyword">while</span> (it != subscription_handles_.<span class="hljs-built_in">end</span>()) &#123;<br>    <span class="hljs-keyword">auto</span> subscription = <span class="hljs-built_in">get_subscription_by_handle</span>(*it, weak_groups_to_nodes);<br>    <span class="hljs-keyword">if</span> (subscription) &#123;<br>      <span class="hljs-keyword">auto</span> group = <span class="hljs-built_in">get_group_by_subscription</span>(subscription, weak_groups_to_nodes);<br>      <span class="hljs-keyword">if</span> (!group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">load</span>()) &#123;<br>        ++it;<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br><br>      any_exec.subscription = subscription;<br>      any_exec.callback_group = group;<br>      any_exec.node_base = <span class="hljs-built_in">get_node_by_group</span>(group, weak_groups_to_nodes);<br>      subscription_handles_.<span class="hljs-built_in">erase</span>(it);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    it = subscription_handles_.<span class="hljs-built_in">erase</span>(it);<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>如果回调组类型为CallbackGroupType::Reentrant，那么就不会将can_be_taken_from_设置为false，回调组可以被持续调用。也就是说，如果有消息持续到来，并且有足够多线程，即使是同一个节点、同一个回调组的同一个函数，可能被多线程并行调用，这就要求在编程中，注意函数要支持可重入。（实验方法很简单，只需要改大QoS，假设发送端按照5Hz发送，订阅回调只需要sleep(1s)，那么就会造成消息处理不过来，其他线程就会进入同一个订阅回调，处理消息）。</p>]]></content>
    
    
    <categories>
      
      <category>ROS2</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Executor</tag>
      
      <tag>ROS2-Executor</tag>
      
      <tag>ROS2</tag>
      
      <tag>Humble</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ROS2 源码环境说明</title>
    <link href="/2025/04/12/-1-%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%80%E6%9C%AF%E6%A0%88/-1-ROS2%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/-1-ROS2-Humble%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/%E3%80%90%E9%99%84%E3%80%91ROS2%20%E6%BA%90%E7%A0%81%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E/"/>
    <url>/2025/04/12/-1-%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%80%E6%9C%AF%E6%A0%88/-1-ROS2%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/-1-ROS2-Humble%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/%E3%80%90%E9%99%84%E3%80%91ROS2%20%E6%BA%90%E7%A0%81%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E/</url>
    
    <content type="html"><![CDATA[<div class="note note-success">            <p>本文由 ZiQingDream 编写，未经允许禁止转载。</p><p>本文作者：工程课代表[B站] &#x2F; ZiQingDream[Github]</p>          </div><h1 id="Docker环境说明"><a href="#Docker环境说明" class="headerlink" title="Docker环境说明"></a>Docker环境说明</h1><h2 id="Docker构建"><a href="#Docker构建" class="headerlink" title="Docker构建"></a>Docker构建</h2><p>为了简化大家的构建过程，解决令人烦恼的国外的仓库依赖问题。我在这里使用Docker打包的humble编译构建环境，参见官网：<a href="https://docs.ros.org/en/humble/Installation/Alternatives/Ubuntu-Development-Setup.html">https://docs.ros.org/en/humble/Installation/Alternatives/Ubuntu-Development-Setup.html</a><br>生成docker为：ros&#x2F;ros2-lab-humble，当前更新到3.0版本，运行指令为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Bash">docker run -it --name humble ros/ros2-lab-humble:3.0 bash<br></code></pre></td></tr></table></figure><p>然后通过vscode的“Remote Development”插件，即可很方便阅读代码。<br>另外，Docker镜像中，为了解决编译某个测试单元链接错误，强制关闭了humble的测试：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Bash">colcon build --symlink-install --cmake-args=-DBUILD_TESTING=OFF<br></code></pre></td></tr></table></figure><p>如果你想修改代码，可以通过docker内的build.sh完成代码编译更新。</p><h1 id="为什么使用Humble"><a href="#为什么使用Humble" class="headerlink" title="为什么使用Humble"></a>为什么使用Humble</h1><p>为什么选择Humble：随着时代的发展ROS1官方不再更新维护，逐步退出历史舞台，而ROS2主流版本以Foxy和Humble为主，其中Foxy也不再支持维护。当前工程中稳定版本就是Humble，所以代码阅读以Humble为主。2025年，最新ROS2为Fazzy，在多个方面优化了ROS2，有机会再聊。</p>]]></content>
    
    
    <categories>
      
      <category>ROS2</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Executor</tag>
      
      <tag>ROS2-Executor</tag>
      
      <tag>ROS2</tag>
      
      <tag>Humble</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>宇树RL代码分析</title>
    <link href="/2025/03/10/-1-%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%80%E6%9C%AF%E6%A0%88/-2-%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/%E3%80%900%E3%80%91%E5%AE%87%E6%A0%91RL%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <url>/2025/03/10/-1-%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%80%E6%9C%AF%E6%A0%88/-2-%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/%E3%80%900%E3%80%91%E5%AE%87%E6%A0%91RL%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="项目说明"><a href="#项目说明" class="headerlink" title="项目说明"></a>项目说明</h1><p>整个项目目录结构如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#unitree_rl_gym</span><br><span class="hljs-comment">#----isaacgym         # NV Isaac Gym，老版本，已经被Isaac Lab取代</span><br><span class="hljs-comment">#----rsl_rl           # 基于GPU的强化学习库</span><br><span class="hljs-comment">#----unitree_rl_gym   # 宇树强化学习环境</span><br><span class="hljs-comment">#--------deploy</span><br><span class="hljs-comment">#--------doc</span><br><span class="hljs-comment">#----legged_gym       # 宇树强化学习包</span><br><span class="hljs-comment">#--------envs         # 强化学习环境定义：g1</span><br><span class="hljs-comment">#--------scripts      # 训练及推理脚本</span><br><span class="hljs-comment">#--------utils        # 其他辅助包</span><br><span class="hljs-comment">#----resources</span><br><span class="hljs-comment">#----setup.py</span><br></code></pre></td></tr></table></figure><h1 id="训练分析"><a href="#训练分析" class="headerlink" title="训练分析"></a>训练分析</h1><p>启动训练命令为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># `--task`: 必选参数，值可选(go2, g1, h1, h1_2)</span><br><span class="hljs-comment"># `--headless`: 默认启动图形界面，设为 true 时不渲染图形界面（效率更高）</span><br><span class="hljs-comment"># `--resume`: 从日志中选择 checkpoint 继续训练</span><br><span class="hljs-comment"># `--experiment_name`: 运行/加载的 experiment 名称</span><br><span class="hljs-comment"># `--run_name`: 运行/加载的 run 名称</span><br><span class="hljs-comment"># `--load_run`: 加载运行的名称，默认加载最后一次运行</span><br><span class="hljs-comment"># `--checkpoint`: checkpoint 编号，默认加载最新一次文件</span><br><span class="hljs-comment"># `--num_envs`: 并行训练的环境个数</span><br><span class="hljs-comment"># `--seed`: 随机种子</span><br><span class="hljs-comment"># `--max_iterations`: 训练的最大迭代次数</span><br><span class="hljs-comment"># `--sim_device`: 仿真计算设备，指定 CPU 为 `--sim_device=cpu`</span><br><span class="hljs-comment"># `--rl_device`: 强化学习计算设备，指定 CPU 为 `--rl_device=cpu`</span><br>python legged_gym/scripts/play.py --task=g1<br></code></pre></td></tr></table></figure><p>此时传递的参数会被get_args()解析，并传递下去：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">import</span> isaacgym<br><span class="hljs-keyword">from</span> legged_gym.envs <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> legged_gym.utils <span class="hljs-keyword">import</span> get_args, task_registry<br><span class="hljs-keyword">import</span> torch<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">args</span>):<br>    <span class="hljs-comment"># 构建强化学习环境</span><br>    env, env_cfg = task_registry.make_env(name=args.task, args=args)<br><br>    <span class="hljs-comment"># 构建强化学习算法</span><br>    ppo_runner, train_cfg = task_registry.make_alg_runner(env=env, name=args.task, args=args)<br><br>    <span class="hljs-comment"># 调用算法learn</span><br>    ppo_runner.learn(num_learning_iterations=train_cfg.runner.max_iterations, init_at_random_ep_len=<span class="hljs-literal">True</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    args = get_args()<br>    train(args)<br></code></pre></td></tr></table></figure><p>我们的任务如”g1”，是在legged_gym包初始化脚本中注册的：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> legged_gym <span class="hljs-keyword">import</span> LEGGED_GYM_ROOT_DIR, LEGGED_GYM_ENVS_DIR<br><br><span class="hljs-keyword">from</span> legged_gym.envs.go2.go2_config <span class="hljs-keyword">import</span> GO2RoughCfg, GO2RoughCfgPPO<br><span class="hljs-keyword">from</span> legged_gym.envs.h1.h1_config <span class="hljs-keyword">import</span> H1RoughCfg, H1RoughCfgPPO<br><span class="hljs-keyword">from</span> legged_gym.envs.h1.h1_env <span class="hljs-keyword">import</span> H1Robot<br><span class="hljs-keyword">from</span> legged_gym.envs.h1_2.h1_2_config <span class="hljs-keyword">import</span> H1_2RoughCfg, H1_2RoughCfgPPO<br><span class="hljs-keyword">from</span> legged_gym.envs.h1_2.h1_2_env <span class="hljs-keyword">import</span> H1_2Robot<br><span class="hljs-keyword">from</span> legged_gym.envs.g1.g1_config <span class="hljs-keyword">import</span> G1RoughCfg, G1RoughCfgPPO<br><span class="hljs-keyword">from</span> legged_gym.envs.g1.g1_env <span class="hljs-keyword">import</span> G1Robot<br><span class="hljs-keyword">from</span> .base.legged_robot <span class="hljs-keyword">import</span> LeggedRobot<br><br><span class="hljs-keyword">from</span> legged_gym.utils.task_registry <span class="hljs-keyword">import</span> task_registry<br><br>task_registry.register( <span class="hljs-string">&quot;go2&quot;</span>, LeggedRobot, GO2RoughCfg(), GO2RoughCfgPPO())<br>task_registry.register( <span class="hljs-string">&quot;h1&quot;</span>, H1Robot, H1RoughCfg(), H1RoughCfgPPO())<br>task_registry.register( <span class="hljs-string">&quot;h1_2&quot;</span>, H1_2Robot, H1_2RoughCfg(), H1_2RoughCfgPPO())<br><br><span class="hljs-comment"># 我们关注class G1Robot(LeggedRobot): unitree_rl_gym/legged_gym/envs/g1/g1_env.py</span><br><span class="hljs-comment"># 机器人关节配置class G1RoughCfg( LeggedRobotCfg ): unitree_rl_gym/legged_gym/envs/g1/g1_config.py</span><br><span class="hljs-comment"># 训练算法为class G1RoughCfgPPO( LeggedRobotCfgPPO ): unitree_rl_gym/legged_gym/envs/g1/g1_config.py</span><br>task_registry.register( <span class="hljs-string">&quot;g1&quot;</span>, G1Robot, G1RoughCfg(), G1RoughCfgPPO())<br></code></pre></td></tr></table></figure><p>这里的注册函数，调用了任务注册模块，同时env创建、算法创建也在该模块中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># unitree_rl_gym/legged_gym/utils/task_registry.py</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskRegistry</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.task_classes = &#123;&#125;<br>        <span class="hljs-variable language_">self</span>.env_cfgs = &#123;&#125;<br>        <span class="hljs-variable language_">self</span>.train_cfgs = &#123;&#125;<br><br>    <span class="hljs-comment"># 这里注册任务：传入任务名、任务类型、环境配置、PPO配置</span><br>    <span class="hljs-comment"># task_registry.register( &quot;g1&quot;, G1Robot, G1RoughCfg(), G1RoughCfgPPO())</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, task_class: VecEnv, env_cfg: LeggedRobotCfg, train_cfg: LeggedRobotCfgPPO</span>):<br>        <span class="hljs-variable language_">self</span>.task_classes[name] = task_class<br>        <span class="hljs-variable language_">self</span>.env_cfgs[name] = env_cfg<br>        <span class="hljs-variable language_">self</span>.train_cfgs[name] = train_cfg<br></code></pre></td></tr></table></figure><p>在make_env()和make_alg_runner()分别创建训练环境，并且构建算法执行器：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># unitree_rl_gym/legged_gym/utils/task_registry.py</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskRegistry</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_task_class</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span></span>) -&gt; VecEnv:<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.task_classes[name]<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_cfgs</span>(<span class="hljs-params">self, name</span>) -&gt; <span class="hljs-type">Tuple</span>[LeggedRobotCfg, LeggedRobotCfgPPO]:<br>        train_cfg = <span class="hljs-variable language_">self</span>.train_cfgs[name]<br>        env_cfg = <span class="hljs-variable language_">self</span>.env_cfgs[name]<br>        <span class="hljs-comment"># copy seed</span><br>        env_cfg.seed = train_cfg.seed<br>        <span class="hljs-keyword">return</span> env_cfg, train_cfg<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">make_env</span>(<span class="hljs-params">self, name, args=<span class="hljs-literal">None</span>, env_cfg=<span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">Tuple</span>[VecEnv, LeggedRobotCfg]:<br>        <span class="hljs-comment"># if no args passed get command line arguments</span><br>        <span class="hljs-keyword">if</span> args <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            args = get_args()<br>        <span class="hljs-comment"># check if there is a registered env with that name</span><br>        <span class="hljs-keyword">if</span> name <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.task_classes:<br>            task_class = <span class="hljs-variable language_">self</span>.get_task_class(name)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Task with name: <span class="hljs-subst">&#123;name&#125;</span> was not registered&quot;</span>)<br>        <span class="hljs-keyword">if</span> env_cfg <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-comment"># load config files</span><br>            env_cfg, _ = <span class="hljs-variable language_">self</span>.get_cfgs(name)<br>        <span class="hljs-comment"># override cfg from args (if specified)</span><br>        env_cfg, _ = update_cfg_from_args(env_cfg, <span class="hljs-literal">None</span>, args)<br>        set_seed(env_cfg.seed)<br>        <span class="hljs-comment"># parse sim params (convert to dict first)</span><br>        sim_params = &#123;<span class="hljs-string">&quot;sim&quot;</span>: class_to_dict(env_cfg.sim)&#125;<br>        sim_params = parse_sim_params(args, sim_params)<br>        <span class="hljs-comment"># 这里相当于创建了G1Robot</span><br>        env = task_class(   cfg=env_cfg,<br>                            sim_params=sim_params,<br>                            physics_engine=args.physics_engine,<br>                            sim_device=args.sim_device,<br>                            headless=args.headless)<br>        <span class="hljs-keyword">return</span> env, env_cfg<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">make_alg_runner</span>(<span class="hljs-params">self, env, name=<span class="hljs-literal">None</span>, args=<span class="hljs-literal">None</span>, train_cfg=<span class="hljs-literal">None</span>, log_root=<span class="hljs-string">&quot;default&quot;</span></span>) -&gt; <span class="hljs-type">Tuple</span>[OnPolicyRunner, LeggedRobotCfgPPO]:<br>        <span class="hljs-comment"># if no args passed get command line arguments</span><br>        <span class="hljs-keyword">if</span> args <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            args = get_args()<br>        <span class="hljs-comment"># if config files are passed use them, otherwise load from the name</span><br>        <span class="hljs-keyword">if</span> train_cfg <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">if</span> name <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;Either &#x27;name&#x27; or &#x27;train_cfg&#x27; must be not None&quot;</span>)<br>            <span class="hljs-comment"># load config files</span><br>            _, train_cfg = <span class="hljs-variable language_">self</span>.get_cfgs(name)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> name <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;&#x27;train_cfg&#x27; provided -&gt; Ignoring &#x27;name=<span class="hljs-subst">&#123;name&#125;</span>&#x27;&quot;</span>)<br>        <span class="hljs-comment"># override cfg from args (if specified)</span><br>        _, train_cfg = update_cfg_from_args(<span class="hljs-literal">None</span>, train_cfg, args)<br><br>        <span class="hljs-keyword">if</span> log_root==<span class="hljs-string">&quot;default&quot;</span>:<br>            log_root = os.path.join(LEGGED_GYM_ROOT_DIR, <span class="hljs-string">&#x27;logs&#x27;</span>, train_cfg.runner.experiment_name)<br>            log_dir = os.path.join(log_root, datetime.now().strftime(<span class="hljs-string">&#x27;%b%d_%H-%M-%S&#x27;</span>) + <span class="hljs-string">&#x27;_&#x27;</span> + train_cfg.runner.run_name)<br>        <span class="hljs-keyword">elif</span> log_root <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            log_dir = <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">else</span>:<br>            log_dir = os.path.join(log_root, datetime.now().strftime(<span class="hljs-string">&#x27;%b%d_%H-%M-%S&#x27;</span>) + <span class="hljs-string">&#x27;_&#x27;</span> + train_cfg.runner.run_name)<br><br>        <span class="hljs-comment"># 这里相当于创建了OnPolicyRunner，配置为G1RoughCfgPPO</span><br>        train_cfg_dict = class_to_dict(train_cfg)<br>        runner = OnPolicyRunner(env, train_cfg_dict, log_dir, device=args.rl_device)<br>        <span class="hljs-comment">#save resume path before creating a new log_dir</span><br>        resume = train_cfg.runner.resume<br>        <span class="hljs-keyword">if</span> resume:<br>            <span class="hljs-comment"># load previously trained model</span><br>            resume_path = get_load_path(log_root, load_run=train_cfg.runner.load_run, checkpoint=train_cfg.runner.checkpoint)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Loading model from: <span class="hljs-subst">&#123;resume_path&#125;</span>&quot;</span>)<br>            runner.load(resume_path)<br>        <span class="hljs-keyword">return</span> runner, train_cfg<br><br><span class="hljs-comment"># make global task registry</span><br>task_registry = TaskRegistry()<br><br></code></pre></td></tr></table></figure><p>这样我们关注重点就来到了以下几个类：</p><ul><li>VecEnv：我们向量化并行环境</li><li>OnPolicyRunner：在线强化学习算法类</li><li>LeggedRobotCfg：强化学习环境配置</li><li>LeggedRobotCfgPPO：PPO配置</li></ul><h1 id="强化学习环境"><a href="#强化学习环境" class="headerlink" title="强化学习环境"></a>强化学习环境</h1><p>rsl-rl的VecEnv是并行化环境的抽象接口：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VecEnv</span>(<span class="hljs-title class_ inherited__">ABC</span>):<br>    num_envs: <span class="hljs-built_in">int</span><br>    num_obs: <span class="hljs-built_in">int</span><br>    num_privileged_obs: <span class="hljs-built_in">int</span><br>    num_actions: <span class="hljs-built_in">int</span><br>    max_episode_length: <span class="hljs-built_in">int</span><br>    privileged_obs_buf: torch.Tensor<br>    obs_buf: torch.Tensor <br>    rew_buf: torch.Tensor<br>    reset_buf: torch.Tensor<br>    episode_length_buf: torch.Tensor <span class="hljs-comment"># current episode duration</span><br>    extras: <span class="hljs-built_in">dict</span><br>    device: torch.device<br><span class="hljs-meta">    @abstractmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">self, actions: torch.Tensor</span>) -&gt; <span class="hljs-type">Tuple</span>[torch.Tensor, <span class="hljs-type">Union</span>[torch.Tensor, <span class="hljs-literal">None</span>], torch.Tensor, torch.Tensor, <span class="hljs-built_in">dict</span>]:<br>        <span class="hljs-keyword">pass</span><br><span class="hljs-meta">    @abstractmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reset</span>(<span class="hljs-params">self, env_ids: <span class="hljs-type">Union</span>[<span class="hljs-built_in">list</span>, torch.Tensor]</span>):<br>        <span class="hljs-keyword">pass</span><br><span class="hljs-meta">    @abstractmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_observations</span>(<span class="hljs-params">self</span>) -&gt; torch.Tensor:<br>        <span class="hljs-keyword">pass</span><br><span class="hljs-meta">    @abstractmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_privileged_observations</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Union</span>[torch.Tensor, <span class="hljs-literal">None</span>]:<br>        <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure><p>我们的机器人任务，就是一个VecEnv（根据python鸭子类型）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">G1Robot</span>(<span class="hljs-title class_ inherited__">LeggedRobot</span>):<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LeggedRobot</span>(<span class="hljs-title class_ inherited__">BaseTask</span>):<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseTask</span>(): 该类实现了VecEnv部分接口<br></code></pre></td></tr></table></figure><p>TaskRegistry的make_env会创建G1Robot对象，其中G1Robot是一种VecEnv对象：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">env, env_cfg = task_registry.make_env(name=args.task, args=args)<br></code></pre></td></tr></table></figure><p>G1Robot没有定义自己构造函数，转接到LeggedRobot和BaseTask初始化训练环境：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LeggedRobot</span>(<span class="hljs-title class_ inherited__">BaseTask</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, cfg: LeggedRobotCfg, sim_params, physics_engine, sim_device, headless</span>):<br>        <span class="hljs-comment"># 1. 配置解析</span><br>        <span class="hljs-variable language_">self</span>.cfg = cfg<br>        <span class="hljs-variable language_">self</span>.sim_params = sim_params<br>        <span class="hljs-variable language_">self</span>.height_samples = <span class="hljs-literal">None</span><br>        <span class="hljs-variable language_">self</span>.debug_viz = <span class="hljs-literal">False</span><br>        <span class="hljs-variable language_">self</span>.init_done = <span class="hljs-literal">False</span><br>        <span class="hljs-variable language_">self</span>._parse_cfg(<span class="hljs-variable language_">self</span>.cfg)<br><br>        <span class="hljs-comment"># 调用BaseTask.__init__，初始化仿真环境</span><br>        <span class="hljs-built_in">super</span>().__init__(<span class="hljs-variable language_">self</span>.cfg, sim_params, physics_engine, sim_device, headless)<br><br>        <span class="hljs-comment"># 如果需要渲染，这里设置观测</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.headless:<br>            <span class="hljs-variable language_">self</span>.set_camera(<span class="hljs-variable language_">self</span>.cfg.viewer.pos, <span class="hljs-variable language_">self</span>.cfg.viewer.lookat)<br>        <span class="hljs-comment"># 初始化状态等缓存</span><br>        <span class="hljs-variable language_">self</span>._init_buffers()<br>        <span class="hljs-variable language_">self</span>._prepare_reward_function()<br>        <span class="hljs-variable language_">self</span>.init_done = <span class="hljs-literal">True</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseTask</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, cfg, sim_params, physics_engine, sim_device, headless</span>):<br>        <span class="hljs-comment"># isaac gym获取一个交互环境</span><br>        <span class="hljs-variable language_">self</span>.gym = gymapi.acquire_gym()<br><br>        <span class="hljs-variable language_">self</span>.sim_params = sim_params<br>        <span class="hljs-variable language_">self</span>.physics_engine = physics_engine<br>        <span class="hljs-variable language_">self</span>.sim_device = sim_device<br>        sim_device_type, <span class="hljs-variable language_">self</span>.sim_device_id = gymutil.parse_device_str(<span class="hljs-variable language_">self</span>.sim_device)<br>        <span class="hljs-variable language_">self</span>.headless = headless<br><br>        <span class="hljs-comment"># env device is GPU only if sim is on GPU and use_gpu_pipeline=True, otherwise returned tensors are copied to CPU by physX.</span><br>        <span class="hljs-keyword">if</span> sim_device_type==<span class="hljs-string">&#x27;cuda&#x27;</span> <span class="hljs-keyword">and</span> sim_params.use_gpu_pipeline:<br>            <span class="hljs-variable language_">self</span>.device = <span class="hljs-variable language_">self</span>.sim_device<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>.device = <span class="hljs-string">&#x27;cpu&#x27;</span><br><br>        <span class="hljs-comment"># graphics device for rendering, -1 for no rendering</span><br>        <span class="hljs-variable language_">self</span>.graphics_device_id = <span class="hljs-variable language_">self</span>.sim_device_id<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.headless == <span class="hljs-literal">True</span>:<br>            <span class="hljs-variable language_">self</span>.graphics_device_id = -<span class="hljs-number">1</span><br><br>        <span class="hljs-variable language_">self</span>.num_envs = cfg.env.num_envs<br>        <span class="hljs-variable language_">self</span>.num_obs = cfg.env.num_observations<br>        <span class="hljs-variable language_">self</span>.num_privileged_obs = cfg.env.num_privileged_obs<br>        <span class="hljs-variable language_">self</span>.num_actions = cfg.env.num_actions<br><br>        <span class="hljs-comment"># optimization flags for pytorch JIT</span><br>        torch._C._jit_set_profiling_mode(<span class="hljs-literal">False</span>)<br>        torch._C._jit_set_profiling_executor(<span class="hljs-literal">False</span>)<br><br>        <span class="hljs-comment"># allocate buffers</span><br>        <span class="hljs-variable language_">self</span>.obs_buf = torch.zeros(<span class="hljs-variable language_">self</span>.num_envs, <span class="hljs-variable language_">self</span>.num_obs, device=<span class="hljs-variable language_">self</span>.device, dtype=torch.<span class="hljs-built_in">float</span>)<br>        <span class="hljs-variable language_">self</span>.rew_buf = torch.zeros(<span class="hljs-variable language_">self</span>.num_envs, device=<span class="hljs-variable language_">self</span>.device, dtype=torch.<span class="hljs-built_in">float</span>)<br>        <span class="hljs-variable language_">self</span>.reset_buf = torch.ones(<span class="hljs-variable language_">self</span>.num_envs, device=<span class="hljs-variable language_">self</span>.device, dtype=torch.long)<br>        <span class="hljs-variable language_">self</span>.episode_length_buf = torch.zeros(<span class="hljs-variable language_">self</span>.num_envs, device=<span class="hljs-variable language_">self</span>.device, dtype=torch.long)<br>        <span class="hljs-variable language_">self</span>.time_out_buf = torch.zeros(<span class="hljs-variable language_">self</span>.num_envs, device=<span class="hljs-variable language_">self</span>.device, dtype=torch.<span class="hljs-built_in">bool</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.num_privileged_obs <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-variable language_">self</span>.privileged_obs_buf = torch.zeros(<span class="hljs-variable language_">self</span>.num_envs, <span class="hljs-variable language_">self</span>.num_privileged_obs, device=<span class="hljs-variable language_">self</span>.device, dtype=torch.<span class="hljs-built_in">float</span>)<br>        <span class="hljs-keyword">else</span>: <br>            <span class="hljs-variable language_">self</span>.privileged_obs_buf = <span class="hljs-literal">None</span><br>            <span class="hljs-comment"># self.num_privileged_obs = self.num_obs</span><br><br>        <span class="hljs-variable language_">self</span>.extras = &#123;&#125;<br><br>        <span class="hljs-comment"># 调用LeggedRobot创建仿真环境，这里不列出来代码，具体包括：</span><br>        <span class="hljs-comment"># 1. 定义z轴索引为2</span><br>        <span class="hljs-comment"># 2. self.gym.create_sim创建仿真环境</span><br>        <span class="hljs-comment"># 3. self.gym.add_ground创建地面</span><br>        <span class="hljs-comment"># 4. 创建训练环境</span><br>        <span class="hljs-comment"># 4.1. 加载机器人资源（设置机器人参数）</span><br>        <span class="hljs-comment"># 4.2. self.gym.load_asset加载机器人资源</span><br>        <span class="hljs-comment"># 4.3. 通过self.gym获取机器人机环境属性</span><br>        <span class="hljs-comment"># 4.4. self.gym.create_env根据预定数量创建isaacgym强化学习</span><br>        <span class="hljs-comment"># 4.5. self.gym.create_actor创建智能体</span><br>        <span class="hljs-comment"># 4.6. 设置智能体关节自由度</span><br>        <span class="hljs-comment"># 4.7. 设置智能体刚体属性</span><br>        <span class="hljs-comment"># 4.8. 保存环境和智能体</span><br>        <span class="hljs-variable language_">self</span>.create_sim()<br>        <span class="hljs-comment"># 准备仿真</span><br>        <span class="hljs-variable language_">self</span>.gym.prepare_sim(<span class="hljs-variable language_">self</span>.sim)<br><br>        <span class="hljs-comment"># todo: read from config</span><br>        <span class="hljs-variable language_">self</span>.enable_viewer_sync = <span class="hljs-literal">True</span><br>        <span class="hljs-variable language_">self</span>.viewer = <span class="hljs-literal">None</span><br><br>        <span class="hljs-comment"># if running with a viewer, set up keyboard shortcuts and camera</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.headless == <span class="hljs-literal">False</span>:<br>            <span class="hljs-comment"># subscribe to keyboard shortcuts</span><br>            <span class="hljs-variable language_">self</span>.viewer = <span class="hljs-variable language_">self</span>.gym.create_viewer(<br>                <span class="hljs-variable language_">self</span>.sim, gymapi.CameraProperties())<br>            <span class="hljs-variable language_">self</span>.gym.subscribe_viewer_keyboard_event(<br>                <span class="hljs-variable language_">self</span>.viewer, gymapi.KEY_ESCAPE, <span class="hljs-string">&quot;QUIT&quot;</span>)<br>            <span class="hljs-variable language_">self</span>.gym.subscribe_viewer_keyboard_event(<br>                <span class="hljs-variable language_">self</span>.viewer, gymapi.KEY_V, <span class="hljs-string">&quot;toggle_viewer_sync&quot;</span>)<br></code></pre></td></tr></table></figure><p>在创建完成环境后，代码紧接着创建了OnPolicyRunner，该类是PPO算法封装：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">ppo_runner, train_cfg = task_registry.make_alg_runner(env=env, name=args.task, args=args)<br></code></pre></td></tr></table></figure><p>OnPolicyRunner在构造时，会创建ActorCritic并基于此，创建PPO算法类，该类定义于rsl_rl中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 注意这里引入了PPO算法，下面会根据名称创建这个类（有点多此一举）</span><br><span class="hljs-keyword">from</span> rsl_rl.algorithms <span class="hljs-keyword">import</span> PPO<br><span class="hljs-keyword">from</span> rsl_rl.modules <span class="hljs-keyword">import</span> ActorCritic, ActorCriticRecurrent<br><span class="hljs-keyword">from</span> rsl_rl.env <span class="hljs-keyword">import</span> VecEnv<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OnPolicyRunner</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,</span><br><span class="hljs-params">                 env: VecEnv,</span><br><span class="hljs-params">                 train_cfg,</span><br><span class="hljs-params">                 log_dir=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">                 device=<span class="hljs-string">&#x27;cpu&#x27;</span></span>):<br>        <span class="hljs-comment"># 从配置中拿到训练配置</span><br>        <span class="hljs-variable language_">self</span>.cfg=train_cfg[<span class="hljs-string">&quot;runner&quot;</span>]<br>        <span class="hljs-variable language_">self</span>.alg_cfg = train_cfg[<span class="hljs-string">&quot;algorithm&quot;</span>]<br>        <span class="hljs-variable language_">self</span>.policy_cfg = train_cfg[<span class="hljs-string">&quot;policy&quot;</span>]<br>        <span class="hljs-variable language_">self</span>.device = device<br>        <span class="hljs-variable language_">self</span>.env = env<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.env.num_privileged_obs <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            num_critic_obs = <span class="hljs-variable language_">self</span>.env.num_privileged_obs <br>        <span class="hljs-keyword">else</span>:<br>            num_critic_obs = <span class="hljs-variable language_">self</span>.env.num_obs<br><br>        <span class="hljs-comment"># 策略类：ActorCritic创建</span><br>        actor_critic_class = <span class="hljs-built_in">eval</span>(<span class="hljs-variable language_">self</span>.cfg[<span class="hljs-string">&quot;policy_class_name&quot;</span>]) <span class="hljs-comment"># ActorCritic</span><br>        actor_critic: ActorCritic = actor_critic_class( <span class="hljs-variable language_">self</span>.env.num_obs,<br>                                                        num_critic_obs,<br>                                                        <span class="hljs-variable language_">self</span>.env.num_actions,<br>                                                        **<span class="hljs-variable language_">self</span>.policy_cfg).to(<span class="hljs-variable language_">self</span>.device)<br>        <span class="hljs-comment"># 算法类：PPO创建</span><br>        alg_class = <span class="hljs-built_in">eval</span>(<span class="hljs-variable language_">self</span>.cfg[<span class="hljs-string">&quot;algorithm_class_name&quot;</span>]) <span class="hljs-comment"># PPO</span><br>        <span class="hljs-variable language_">self</span>.alg: PPO = alg_class(actor_critic, device=<span class="hljs-variable language_">self</span>.device, **<span class="hljs-variable language_">self</span>.alg_cfg)<br>        <span class="hljs-variable language_">self</span>.num_steps_per_env = <span class="hljs-variable language_">self</span>.cfg[<span class="hljs-string">&quot;num_steps_per_env&quot;</span>]<br>        <span class="hljs-variable language_">self</span>.save_interval = <span class="hljs-variable language_">self</span>.cfg[<span class="hljs-string">&quot;save_interval&quot;</span>]<br><br>        <span class="hljs-comment"># 这一这里，创建的环境数量由这个函数初始化</span><br>        <span class="hljs-variable language_">self</span>.alg.init_storage(<span class="hljs-variable language_">self</span>.env.num_envs, <span class="hljs-variable language_">self</span>.num_steps_per_env, [<span class="hljs-variable language_">self</span>.env.num_obs], [<span class="hljs-variable language_">self</span>.env.num_privileged_obs], [<span class="hljs-variable language_">self</span>.env.num_actions])<br><br>        <span class="hljs-comment"># Log</span><br>        <span class="hljs-variable language_">self</span>.log_dir = log_dir<br>        <span class="hljs-variable language_">self</span>.writer = <span class="hljs-literal">None</span><br>        <span class="hljs-variable language_">self</span>.tot_timesteps = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.tot_time = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.current_learning_iteration = <span class="hljs-number">0</span><br>        <span class="hljs-comment"># 环境复位</span><br>        _, _ = <span class="hljs-variable language_">self</span>.env.reset()<br></code></pre></td></tr></table></figure><p>初始化PPO算法所需要的配置定义在g1_config.py中，Actor和Critic都使用LSTM神经网络，策略类为ActorCriticRecurrent（调用torch定义LSTM）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">G1RoughCfgPPO</span>( <span class="hljs-title class_ inherited__">LeggedRobotCfgPPO</span> ):<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">policy</span>:<br>        init_noise_std = <span class="hljs-number">0.8</span> <span class="hljs-comment"># 噪声</span><br>        actor_hidden_dims = [<span class="hljs-number">32</span>]  <span class="hljs-comment"># 好像并没有用</span><br>        critic_hidden_dims = [<span class="hljs-number">32</span>] <span class="hljs-comment"># 好像并没有用</span><br>        activation = <span class="hljs-string">&#x27;elu&#x27;</span> <span class="hljs-comment"># can be elu, relu, selu, crelu, lrelu, tanh, sigmoid</span><br>        <span class="hljs-comment"># only for &#x27;ActorCriticRecurrent&#x27;:</span><br>        rnn_type = <span class="hljs-string">&#x27;lstm&#x27;</span> <span class="hljs-comment"># 使用LSTM</span><br>        rnn_hidden_size = <span class="hljs-number">64</span> <span class="hljs-comment"># 隐藏层大小64</span><br>        rnn_num_layers = <span class="hljs-number">1</span> <span class="hljs-comment"># 只有一层</span><br>        <br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">algorithm</span>( LeggedRobotCfgPPO.algorithm ):<br>        entropy_coef = <span class="hljs-number">0.01</span><br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">runner</span>( LeggedRobotCfgPPO.runner ):<br>        policy_class_name = <span class="hljs-string">&quot;ActorCriticRecurrent&quot;</span><br>        max_iterations = <span class="hljs-number">10000</span> <span class="hljs-comment"># 训练最大迭代10000</span><br>        run_name = <span class="hljs-string">&#x27;&#x27;</span><br>        experiment_name = <span class="hljs-string">&#x27;g1&#x27;</span>  <br></code></pre></td></tr></table></figure><p>在环境和算法都构造完毕后，程序可以开始训练过程：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">ppo_runner.learn(<span class="hljs-attribute">num_learning_iterations</span>=train_cfg.runner.max_iterations, <span class="hljs-attribute">init_at_random_ep_len</span>=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>以下是强化学习训练代码，这里我直接在代码中解释（&#x3D;&#x3D;TODO：actions观测不明确&#x3D;&#x3D;）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">learn</span>(<span class="hljs-params">self, num_learning_iterations, init_at_random_ep_len=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-comment"># 创建logger记录器</span><br>        <span class="hljs-comment"># 在训练过程中输出训练实时loss等</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.log_dir <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.writer <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-variable language_">self</span>.writer = SummaryWriter(log_dir=<span class="hljs-variable language_">self</span>.log_dir, flush_secs=<span class="hljs-number">10</span>)<br><br>        <span class="hljs-comment"># 外部传递参数init_at_random_ep_len=True，则回合缓存长度会随机</span><br>        <span class="hljs-keyword">if</span> init_at_random_ep_len:<br>            <span class="hljs-variable language_">self</span>.env.episode_length_buf = torch.randint_like(<span class="hljs-variable language_">self</span>.env.episode_length_buf, high=<span class="hljs-built_in">int</span>(<span class="hljs-variable language_">self</span>.env.max_episode_length))<br>        <span class="hljs-comment"># 注意这里获取观测，观测是在 LeggedRobot.compute_observations()计算返回一个torch.Tensor</span><br>        <span class="hljs-comment"># 1. Base的线速度（缩放）</span><br>        <span class="hljs-comment"># 2. Base的角速度（缩放）</span><br>        <span class="hljs-comment"># 3. 投射到Base的重力</span><br>        <span class="hljs-comment"># 4. 外部速度</span><br>        <span class="hljs-comment"># 5. 关节角度（缩放）</span><br>        <span class="hljs-comment"># 6. 关节角速度（缩放）</span><br>        <span class="hljs-comment"># 7. actions</span><br>        <span class="hljs-comment"># 可以通过配置给观测加噪声</span><br>        obs = <span class="hljs-variable language_">self</span>.env.get_observations()<br>        privileged_obs = <span class="hljs-variable language_">self</span>.env.get_privileged_observations()<br>        critic_obs = privileged_obs <span class="hljs-keyword">if</span> privileged_obs <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> obs<br><br>        <span class="hljs-comment"># 把观测向量迁移到指定设备，并切换到训练模式（pytorch需要）</span><br>        obs, critic_obs = obs.to(<span class="hljs-variable language_">self</span>.device), critic_obs.to(<span class="hljs-variable language_">self</span>.device)<br>        <span class="hljs-variable language_">self</span>.alg.actor_critic.train() <span class="hljs-comment"># switch to train mode (for dropout for example)</span><br><br>        ep_infos = []<br>        rewbuffer = deque(maxlen=<span class="hljs-number">100</span>)<br>        lenbuffer = deque(maxlen=<span class="hljs-number">100</span>)<br>        cur_reward_sum = torch.zeros(<span class="hljs-variable language_">self</span>.env.num_envs, dtype=torch.<span class="hljs-built_in">float</span>, device=<span class="hljs-variable language_">self</span>.device)<br>        cur_episode_length = torch.zeros(<span class="hljs-variable language_">self</span>.env.num_envs, dtype=torch.<span class="hljs-built_in">float</span>, device=<span class="hljs-variable language_">self</span>.device)<br><br>        tot_iter = <span class="hljs-variable language_">self</span>.current_learning_iteration + num_learning_iterations<br>        <span class="hljs-keyword">for</span> it <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.current_learning_iteration, tot_iter):<br>            start = time.time()<br>            <span class="hljs-comment"># 与环境进行交互，获取奖励和下一个状态</span><br>            <span class="hljs-keyword">with</span> torch.inference_mode():<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.num_steps_per_env): <span class="hljs-comment"># num_steps_per_env = 24</span><br>                    <span class="hljs-comment"># 从算法中获取一个动作，内部根据策略网络获取动作，根据价值网络获取评估动作价值</span><br>                    actions = <span class="hljs-variable language_">self</span>.alg.act(obs, critic_obs)<br>                    <span class="hljs-comment"># 与环境交互，产生下一步观测、奖励、是否结束</span><br>                    <span class="hljs-comment"># LeggedRobot.step()：</span><br>                    <span class="hljs-comment"># 1. 调用self.render()，利用gym渲染场景</span><br>                    <span class="hljs-comment"># 2. 执行仿真，每个policy dt=4*sim dt</span><br>                    <span class="hljs-comment"># 2.1. 调用self._compute_torques()，如果是位置控制，则使用PD计算关节力矩，并clip</span><br>                    <span class="hljs-comment"># 2.2. 调用self.gym.set_dof_actuation_force_tensor设置到机器人仿真环境</span><br>                    <span class="hljs-comment"># 2.3. 调用self.gym.simulate(self.sim)执行仿真</span><br>                    <span class="hljs-comment"># 2.4. 调用self.gym.refresh_dof_state_tensor刷新状态</span><br>                    <span class="hljs-comment"># 3. 仿真后，执行后处理操作</span><br>                    <span class="hljs-comment"># 3.1. 调用self.gym.refresh_actor_root_state_tensor和self.gym.refresh_net_contact_force_tensor刷新状态</span><br>                    <span class="hljs-comment"># 3.2. 将内部状态，转换为位置、线速度、rpy等可读状态</span><br>                    <span class="hljs-comment"># 3.3. 在计算奖励之前，随机生成vel_x，vel_y,ang_vel_yaw</span><br>                    <span class="hljs-comment"># 3.4. self.check_termination()检查是不是需要停止，例如角度过大快要摔倒等</span><br>                    <span class="hljs-comment"># 3.5. self.compute_reward()计算奖励：应用奖励函数，并追加终止奖励。</span><br>                    <span class="hljs-comment"># 3.5. self._push_robots()如果需要，可以随机推移机器人</span><br>                    <span class="hljs-comment"># 3.6. self.compute_observations()观测更新</span><br>                    obs, privileged_obs, rewards, dones, infos = <span class="hljs-variable language_">self</span>.env.step(actions)<br>                    critic_obs = privileged_obs <span class="hljs-keyword">if</span> privileged_obs <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> obs<br>                    <span class="hljs-comment"># self.storage.add_transitions获取奖励，并存储transition </span><br>                    obs, critic_obs, rewards, dones = obs.to(<span class="hljs-variable language_">self</span>.device), critic_obs.to(<span class="hljs-variable language_">self</span>.device), rewards.to(<span class="hljs-variable language_">self</span>.device), dones.to(<span class="hljs-variable language_">self</span>.device)<br>                    <span class="hljs-variable language_">self</span>.alg.process_env_step(rewards, dones, infos)<br>                    <br>                    <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.log_dir <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                        <span class="hljs-comment"># Book keeping</span><br>                        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;episode&#x27;</span> <span class="hljs-keyword">in</span> infos:<br>                            ep_infos.append(infos[<span class="hljs-string">&#x27;episode&#x27;</span>])<br>                        cur_reward_sum += rewards<br>                        cur_episode_length += <span class="hljs-number">1</span><br>                        new_ids = (dones &gt; <span class="hljs-number">0</span>).nonzero(as_tuple=<span class="hljs-literal">False</span>)<br>                        rewbuffer.extend(cur_reward_sum[new_ids][:, <span class="hljs-number">0</span>].cpu().numpy().tolist())<br>                        lenbuffer.extend(cur_episode_length[new_ids][:, <span class="hljs-number">0</span>].cpu().numpy().tolist())<br>                        cur_reward_sum[new_ids] = <span class="hljs-number">0</span><br>                        cur_episode_length[new_ids] = <span class="hljs-number">0</span><br><br>                stop = time.time()<br>                collection_time = stop - start<br><br>                <span class="hljs-comment"># 计算折扣回报</span><br>                start = stop<br>                <span class="hljs-variable language_">self</span>.alg.compute_returns(critic_obs)<br><br>            <span class="hljs-comment"># 执行PPO算法更新</span><br>            mean_value_loss, mean_surrogate_loss = <span class="hljs-variable language_">self</span>.alg.update()<br>            stop = time.time()<br>            learn_time = stop - start<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.log_dir <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-variable language_">self</span>.log(<span class="hljs-built_in">locals</span>())<br>            <span class="hljs-keyword">if</span> it % <span class="hljs-variable language_">self</span>.save_interval == <span class="hljs-number">0</span>:<br>                <span class="hljs-variable language_">self</span>.save(os.path.join(<span class="hljs-variable language_">self</span>.log_dir, <span class="hljs-string">&#x27;model_&#123;&#125;.pt&#x27;</span>.<span class="hljs-built_in">format</span>(it)))<br>            ep_infos.clear()<br>        <br>        <span class="hljs-variable language_">self</span>.current_learning_iteration += num_learning_iterations<br>        <span class="hljs-variable language_">self</span>.save(os.path.join(<span class="hljs-variable language_">self</span>.log_dir, <span class="hljs-string">&#x27;model_&#123;&#125;.pt&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-variable language_">self</span>.current_learning_iteration)))<br></code></pre></td></tr></table></figure><p>环境提供的奖励，定义于LeggedRobot，代码通过python技巧，获取了该类中所有_reward_xxx的奖励函数，这些奖励函数通过鼓励或者惩罚特定的属性，指导机器人能够按照预期运动：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#------------ reward functions----------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_lin_vel_z</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Penalize z axis base linear velocity</span><br>    <span class="hljs-keyword">return</span> torch.square(<span class="hljs-variable language_">self</span>.base_lin_vel[:, <span class="hljs-number">2</span>])<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_ang_vel_xy</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Penalize xy axes base angular velocity</span><br>    <span class="hljs-keyword">return</span> torch.<span class="hljs-built_in">sum</span>(torch.square(<span class="hljs-variable language_">self</span>.base_ang_vel[:, :<span class="hljs-number">2</span>]), dim=<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_orientation</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Penalize non flat base orientation</span><br>    <span class="hljs-keyword">return</span> torch.<span class="hljs-built_in">sum</span>(torch.square(<span class="hljs-variable language_">self</span>.projected_gravity[:, :<span class="hljs-number">2</span>]), dim=<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_base_height</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Penalize base height away from target</span><br>    base_height = <span class="hljs-variable language_">self</span>.root_states[:, <span class="hljs-number">2</span>]<br>    <span class="hljs-keyword">return</span> torch.square(base_height - <span class="hljs-variable language_">self</span>.cfg.rewards.base_height_target)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_torques</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Penalize torques</span><br>    <span class="hljs-keyword">return</span> torch.<span class="hljs-built_in">sum</span>(torch.square(<span class="hljs-variable language_">self</span>.torques), dim=<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_dof_vel</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Penalize dof velocities</span><br>    <span class="hljs-keyword">return</span> torch.<span class="hljs-built_in">sum</span>(torch.square(<span class="hljs-variable language_">self</span>.dof_vel), dim=<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_dof_acc</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Penalize dof accelerations</span><br>    <span class="hljs-keyword">return</span> torch.<span class="hljs-built_in">sum</span>(torch.square((<span class="hljs-variable language_">self</span>.last_dof_vel - <span class="hljs-variable language_">self</span>.dof_vel) / <span class="hljs-variable language_">self</span>.dt), dim=<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_action_rate</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Penalize changes in actions</span><br>    <span class="hljs-keyword">return</span> torch.<span class="hljs-built_in">sum</span>(torch.square(<span class="hljs-variable language_">self</span>.last_actions - <span class="hljs-variable language_">self</span>.actions), dim=<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_collision</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Penalize collisions on selected bodies</span><br>    <span class="hljs-keyword">return</span> torch.<span class="hljs-built_in">sum</span>(<span class="hljs-number">1.</span>*(torch.norm(<span class="hljs-variable language_">self</span>.contact_forces[:, <span class="hljs-variable language_">self</span>.penalised_contact_indices, :], dim=-<span class="hljs-number">1</span>) &gt; <span class="hljs-number">0.1</span>), dim=<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_termination</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Terminal reward / penalty</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.reset_buf * ~<span class="hljs-variable language_">self</span>.time_out_buf<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_dof_pos_limits</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Penalize dof positions too close to the limit</span><br>    out_of_limits = -(<span class="hljs-variable language_">self</span>.dof_pos - <span class="hljs-variable language_">self</span>.dof_pos_limits[:, <span class="hljs-number">0</span>]).clip(<span class="hljs-built_in">max</span>=<span class="hljs-number">0.</span>) <span class="hljs-comment"># lower limit</span><br>    out_of_limits += (<span class="hljs-variable language_">self</span>.dof_pos - <span class="hljs-variable language_">self</span>.dof_pos_limits[:, <span class="hljs-number">1</span>]).clip(<span class="hljs-built_in">min</span>=<span class="hljs-number">0.</span>)<br>    <span class="hljs-keyword">return</span> torch.<span class="hljs-built_in">sum</span>(out_of_limits, dim=<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_dof_vel_limits</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Penalize dof velocities too close to the limit</span><br>    <span class="hljs-comment"># clip to max error = 1 rad/s per joint to avoid huge penalties</span><br>    <span class="hljs-keyword">return</span> torch.<span class="hljs-built_in">sum</span>((torch.<span class="hljs-built_in">abs</span>(<span class="hljs-variable language_">self</span>.dof_vel) - <span class="hljs-variable language_">self</span>.dof_vel_limits*<span class="hljs-variable language_">self</span>.cfg.rewards.soft_dof_vel_limit).clip(<span class="hljs-built_in">min</span>=<span class="hljs-number">0.</span>, <span class="hljs-built_in">max</span>=<span class="hljs-number">1.</span>), dim=<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_torque_limits</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># penalize torques too close to the limit</span><br>    <span class="hljs-keyword">return</span> torch.<span class="hljs-built_in">sum</span>((torch.<span class="hljs-built_in">abs</span>(<span class="hljs-variable language_">self</span>.torques) - <span class="hljs-variable language_">self</span>.torque_limits*<span class="hljs-variable language_">self</span>.cfg.rewards.soft_torque_limit).clip(<span class="hljs-built_in">min</span>=<span class="hljs-number">0.</span>), dim=<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_tracking_lin_vel</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Tracking of linear velocity commands (xy axes)</span><br>    lin_vel_error = torch.<span class="hljs-built_in">sum</span>(torch.square(<span class="hljs-variable language_">self</span>.commands[:, :<span class="hljs-number">2</span>] - <span class="hljs-variable language_">self</span>.base_lin_vel[:, :<span class="hljs-number">2</span>]), dim=<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span> torch.exp(-lin_vel_error/<span class="hljs-variable language_">self</span>.cfg.rewards.tracking_sigma)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_tracking_ang_vel</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Tracking of angular velocity commands (yaw) </span><br>    ang_vel_error = torch.square(<span class="hljs-variable language_">self</span>.commands[:, <span class="hljs-number">2</span>] - <span class="hljs-variable language_">self</span>.base_ang_vel[:, <span class="hljs-number">2</span>])<br>    <span class="hljs-keyword">return</span> torch.exp(-ang_vel_error/<span class="hljs-variable language_">self</span>.cfg.rewards.tracking_sigma)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_feet_air_time</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Reward long steps</span><br>    <span class="hljs-comment"># Need to filter the contacts because the contact reporting of PhysX is unreliable on meshes</span><br>    contact = <span class="hljs-variable language_">self</span>.contact_forces[:, <span class="hljs-variable language_">self</span>.feet_indices, <span class="hljs-number">2</span>] &gt; <span class="hljs-number">1.</span><br>    contact_filt = torch.logical_or(contact, <span class="hljs-variable language_">self</span>.last_contacts) <br>    <span class="hljs-variable language_">self</span>.last_contacts = contact<br>    first_contact = (<span class="hljs-variable language_">self</span>.feet_air_time &gt; <span class="hljs-number">0.</span>) * contact_filt<br>    <span class="hljs-variable language_">self</span>.feet_air_time += <span class="hljs-variable language_">self</span>.dt<br>    rew_airTime = torch.<span class="hljs-built_in">sum</span>((<span class="hljs-variable language_">self</span>.feet_air_time - <span class="hljs-number">0.5</span>) * first_contact, dim=<span class="hljs-number">1</span>) <span class="hljs-comment"># reward only on first contact with the ground</span><br>    rew_airTime *= torch.norm(<span class="hljs-variable language_">self</span>.commands[:, :<span class="hljs-number">2</span>], dim=<span class="hljs-number">1</span>) &gt; <span class="hljs-number">0.1</span> <span class="hljs-comment">#no reward for zero command</span><br>    <span class="hljs-variable language_">self</span>.feet_air_time *= ~contact_filt<br>    <span class="hljs-keyword">return</span> rew_airTime<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_stumble</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Penalize feet hitting vertical surfaces</span><br>    <span class="hljs-keyword">return</span> torch.<span class="hljs-built_in">any</span>(torch.norm(<span class="hljs-variable language_">self</span>.contact_forces[:, <span class="hljs-variable language_">self</span>.feet_indices, :<span class="hljs-number">2</span>], dim=<span class="hljs-number">2</span>) &gt;\<br>         <span class="hljs-number">5</span> *torch.<span class="hljs-built_in">abs</span>(<span class="hljs-variable language_">self</span>.contact_forces[:, <span class="hljs-variable language_">self</span>.feet_indices, <span class="hljs-number">2</span>]), dim=<span class="hljs-number">1</span>)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_stand_still</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># Penalize motion at zero commands</span><br>    <span class="hljs-keyword">return</span> torch.<span class="hljs-built_in">sum</span>(torch.<span class="hljs-built_in">abs</span>(<span class="hljs-variable language_">self</span>.dof_pos - <span class="hljs-variable language_">self</span>.default_dof_pos), dim=<span class="hljs-number">1</span>) * (torch.norm(<span class="hljs-variable language_">self</span>.commands[:, :<span class="hljs-number">2</span>], dim=<span class="hljs-number">1</span>) &lt; <span class="hljs-number">0.1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_reward_feet_contact_forces</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># penalize high contact forces</span><br>    <span class="hljs-keyword">return</span> torch.<span class="hljs-built_in">sum</span>((torch.norm(<span class="hljs-variable language_">self</span>.contact_forces[:, <span class="hljs-variable language_">self</span>.feet_indices, :], dim=-<span class="hljs-number">1</span>) -  <span class="hljs-variable language_">self</span>.cfg.rewards.max_contact_force).clip(<span class="hljs-built_in">min</span>=<span class="hljs-number">0.</span>), dim=<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><p>以上大费周章就是为了和环境进行交互，从而获取奖励、计算回报，并更新机器人状态。与环境交互的数据，可以更新到机器人PPO算法，接下来我们直接看下PPO算法更新实现：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim<br><br><span class="hljs-keyword">from</span> rsl_rl.modules <span class="hljs-keyword">import</span> ActorCritic<br><span class="hljs-keyword">from</span> rsl_rl.storage <span class="hljs-keyword">import</span> RolloutStorage<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PPO</span>:<br>    actor_critic: ActorCritic<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,</span><br><span class="hljs-params">                 actor_critic,</span><br><span class="hljs-params">                 num_learning_epochs=<span class="hljs-number">1</span>,</span><br><span class="hljs-params">                 num_mini_batches=<span class="hljs-number">1</span>,</span><br><span class="hljs-params">                 clip_param=<span class="hljs-number">0.2</span>,</span><br><span class="hljs-params">                 gamma=<span class="hljs-number">0.998</span>,</span><br><span class="hljs-params">                 lam=<span class="hljs-number">0.95</span>,</span><br><span class="hljs-params">                 value_loss_coef=<span class="hljs-number">1.0</span>,</span><br><span class="hljs-params">                 entropy_coef=<span class="hljs-number">0.0</span>,</span><br><span class="hljs-params">                 learning_rate=<span class="hljs-number">1e-3</span>,</span><br><span class="hljs-params">                 max_grad_norm=<span class="hljs-number">1.0</span>,</span><br><span class="hljs-params">                 use_clipped_value_loss=<span class="hljs-literal">True</span>,</span><br><span class="hljs-params">                 schedule=<span class="hljs-string">&quot;fixed&quot;</span>,</span><br><span class="hljs-params">                 desired_kl=<span class="hljs-number">0.01</span>,</span><br><span class="hljs-params">                 device=<span class="hljs-string">&#x27;cpu&#x27;</span>,</span><br><span class="hljs-params">                 </span>):<br><br>        <span class="hljs-variable language_">self</span>.device = device<br><br>        <span class="hljs-variable language_">self</span>.desired_kl = desired_kl<br>        <span class="hljs-variable language_">self</span>.schedule = schedule<br>        <span class="hljs-variable language_">self</span>.learning_rate = learning_rate<br><br>        <span class="hljs-comment"># PPO components</span><br>        <span class="hljs-variable language_">self</span>.actor_critic = actor_critic<br>        <span class="hljs-variable language_">self</span>.actor_critic.to(<span class="hljs-variable language_">self</span>.device)<br>        <span class="hljs-variable language_">self</span>.storage = <span class="hljs-literal">None</span> <span class="hljs-comment"># initialized later</span><br>        <span class="hljs-variable language_">self</span>.optimizer = optim.Adam(<span class="hljs-variable language_">self</span>.actor_critic.parameters(), lr=learning_rate)<br>        <span class="hljs-variable language_">self</span>.transition = RolloutStorage.Transition()<br><br>        <span class="hljs-comment"># PPO parameters</span><br>        <span class="hljs-variable language_">self</span>.clip_param = clip_param<br>        <span class="hljs-variable language_">self</span>.num_learning_epochs = num_learning_epochs<br>        <span class="hljs-variable language_">self</span>.num_mini_batches = num_mini_batches<br>        <span class="hljs-variable language_">self</span>.value_loss_coef = value_loss_coef<br>        <span class="hljs-variable language_">self</span>.entropy_coef = entropy_coef<br>        <span class="hljs-variable language_">self</span>.gamma = gamma<br>        <span class="hljs-variable language_">self</span>.lam = lam<br>        <span class="hljs-variable language_">self</span>.max_grad_norm = max_grad_norm<br>        <span class="hljs-variable language_">self</span>.use_clipped_value_loss = use_clipped_value_loss<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self</span>):<br>        mean_value_loss = <span class="hljs-number">0</span><br>        mean_surrogate_loss = <span class="hljs-number">0</span><br><br>        <span class="hljs-comment"># 根据是否RNN，选择不同的mini-batch生成器</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.actor_critic.is_recurrent:<br>            generator = <span class="hljs-variable language_">self</span>.storage.reccurent_mini_batch_generator(<span class="hljs-variable language_">self</span>.num_mini_batches, <span class="hljs-variable language_">self</span>.num_learning_epochs)<br>        <span class="hljs-keyword">else</span>:<br>            generator = <span class="hljs-variable language_">self</span>.storage.mini_batch_generator(<span class="hljs-variable language_">self</span>.num_mini_batches, <span class="hljs-variable language_">self</span>.num_learning_epochs)<br><br>        <span class="hljs-comment"># 对每一个mini-batch</span><br>        <span class="hljs-keyword">for</span> obs_batch, critic_obs_batch, actions_batch, target_values_batch, advantages_batch, returns_batch, old_actions_log_prob_batch, \<br>            old_mu_batch, old_sigma_batch, hid_states_batch, masks_batch <span class="hljs-keyword">in</span> generator:<br><br>                <span class="hljs-comment"># 从策略网络采样获取动作Action，并评估State-Value</span><br>                <span class="hljs-variable language_">self</span>.actor_critic.act(obs_batch, masks=masks_batch, hidden_states=hid_states_batch[<span class="hljs-number">0</span>])<br>                actions_log_prob_batch = <span class="hljs-variable language_">self</span>.actor_critic.get_actions_log_prob(actions_batch)<br>                value_batch = <span class="hljs-variable language_">self</span>.actor_critic.evaluate(critic_obs_batch, masks=masks_batch, hidden_states=hid_states_batch[<span class="hljs-number">1</span>])<br>                mu_batch = <span class="hljs-variable language_">self</span>.actor_critic.action_mean<br>                sigma_batch = <span class="hljs-variable language_">self</span>.actor_critic.action_std<br>                entropy_batch = <span class="hljs-variable language_">self</span>.actor_critic.entropy<br><br>                <span class="hljs-comment"># 自适应KL</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.desired_kl != <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.schedule == <span class="hljs-string">&#x27;adaptive&#x27;</span>:<br>                    <span class="hljs-keyword">with</span> torch.inference_mode():<br>                        kl = torch.<span class="hljs-built_in">sum</span>(<br>                            torch.log(sigma_batch / old_sigma_batch + <span class="hljs-number">1.e-5</span>) + (torch.square(old_sigma_batch) + torch.square(old_mu_batch - mu_batch)) <br>                            / (<span class="hljs-number">2.0</span> * torch.square(sigma_batch)) - <span class="hljs-number">0.5</span>, axis=-<span class="hljs-number">1</span>)<br>                        kl_mean = torch.mean(kl)<br>                        <span class="hljs-comment"># 根据KL调整学习率</span><br>                        <span class="hljs-keyword">if</span> kl_mean &gt; <span class="hljs-variable language_">self</span>.desired_kl * <span class="hljs-number">2.0</span>:<br>                            <span class="hljs-variable language_">self</span>.learning_rate = <span class="hljs-built_in">max</span>(<span class="hljs-number">1e-5</span>, <span class="hljs-variable language_">self</span>.learning_rate / <span class="hljs-number">1.5</span>)<br>                        <span class="hljs-keyword">elif</span> kl_mean &lt; <span class="hljs-variable language_">self</span>.desired_kl / <span class="hljs-number">2.0</span> <span class="hljs-keyword">and</span> kl_mean &gt; <span class="hljs-number">0.0</span>:<br>                            <span class="hljs-variable language_">self</span>.learning_rate = <span class="hljs-built_in">min</span>(<span class="hljs-number">1e-2</span>, <span class="hljs-variable language_">self</span>.learning_rate * <span class="hljs-number">1.5</span>)<br>                        <br>                        <span class="hljs-keyword">for</span> param_group <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.optimizer.param_groups:<br>                            param_group[<span class="hljs-string">&#x27;lr&#x27;</span>] = <span class="hljs-variable language_">self</span>.learning_rate<br><br><br>                <span class="hljs-comment"># Surrogate loss</span><br>                <span class="hljs-comment"># 重要性采样比例</span><br>                ratio = torch.exp(actions_log_prob_batch - torch.squeeze(old_actions_log_prob_batch))<br>                <span class="hljs-comment"># 计算截断和非截断下重要性采样*优势函数</span><br>                surrogate = -torch.squeeze(advantages_batch) * ratio<br>                surrogate_clipped = -torch.squeeze(advantages_batch) * torch.clamp(ratio, <span class="hljs-number">1.0</span> - <span class="hljs-variable language_">self</span>.clip_param,<br>                                                                                <span class="hljs-number">1.0</span> + <span class="hljs-variable language_">self</span>.clip_param)<br>                <span class="hljs-comment"># 由于添加了符号，所以这里找到的是最大</span><br>                surrogate_loss = torch.<span class="hljs-built_in">max</span>(surrogate, surrogate_clipped).mean()<br><br>                <span class="hljs-comment"># Value function loss</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.use_clipped_value_loss:<br>                    value_clipped = target_values_batch + (value_batch - target_values_batch).clamp(-<span class="hljs-variable language_">self</span>.clip_param,<br>                                                                                                    <span class="hljs-variable language_">self</span>.clip_param)<br>                    value_losses = (value_batch - returns_batch).<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>)<br>                    value_losses_clipped = (value_clipped - returns_batch).<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>)<br>                    value_loss = torch.<span class="hljs-built_in">max</span>(value_losses, value_losses_clipped).mean()<br>                <span class="hljs-keyword">else</span>:<br>                    value_loss = (returns_batch - value_batch).<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>).mean()<br>                <span class="hljs-comment"># 计算策略梯度的loss</span><br>                loss = surrogate_loss + <span class="hljs-variable language_">self</span>.value_loss_coef * value_loss - <span class="hljs-variable language_">self</span>.entropy_coef * entropy_batch.mean()<br><br>                <span class="hljs-comment"># 梯度更新反向传播，注意torch是梯度下降，所以前面去了负号</span><br>                <span class="hljs-variable language_">self</span>.optimizer.zero_grad()<br>                loss.backward()<br>                nn.utils.clip_grad_norm_(<span class="hljs-variable language_">self</span>.actor_critic.parameters(), <span class="hljs-variable language_">self</span>.max_grad_norm)<br>                <span class="hljs-variable language_">self</span>.optimizer.step()<br><br>                mean_value_loss += value_loss.item()<br>                mean_surrogate_loss += surrogate_loss.item()<br><br>        num_updates = <span class="hljs-variable language_">self</span>.num_learning_epochs * <span class="hljs-variable language_">self</span>.num_mini_batches<br>        mean_value_loss /= num_updates<br>        mean_surrogate_loss /= num_updates<br>        <span class="hljs-variable language_">self</span>.storage.clear()<br><br>        <span class="hljs-keyword">return</span> mean_value_loss, mean_surrogate_loss<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ReinforceLearning</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Unitree-RL</tag>
      
      <tag>Locomotion</tag>
      
      <tag>PPO</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用 ECharts 插件绘制炫酷图表</title>
    <link href="/2020/06/20/-9-hexo%E6%A0%B7%E4%BE%8B%E6%96%87%E4%BB%B6/hexo-echarts/"/>
    <url>/2020/06/20/-9-hexo%E6%A0%B7%E4%BE%8B%E6%96%87%E4%BB%B6/hexo-echarts/</url>
    
    <content type="html"><![CDATA[<div class="note note-success">            <p>本文由 Fluid 用户授权转载，版权归原作者所有。</p><p>本文作者：pxxyyz</p><p>原文地址：<a href="https://pxxyyz.com/posts/15698/">https://pxxyyz.com/posts/15698/</a></p>          </div><h2 id="ECharts使用"><a href="#ECharts使用" class="headerlink" title="ECharts使用"></a>ECharts使用</h2><ul><li>安装<code>hexo-tag-echarts</code>插件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ npm install hexo-tag-echarts --save<br></code></pre></td></tr></table></figure><ul><li><p>注意：ECharts官网教程-<a href="%5Bhttps://echarts.apache.org/zh/tutorial.html#5%20%E5%88%86%E9%92%9F%E4%B8%8A%E6%89%8B%20ECharts%5D" title="https:&#x2F;&#x2F;echarts.apache.org&#x2F;zh&#x2F;tutorial.html#5 分钟上手 ECharts">5 分钟上手 ECharts</a>里的<code>npm install echarts --save</code>并不适合hexo博客，这种安装方式无效，请安装<code>hexo-tag-echarts</code>插件。</p></li><li><p>添加如下js文件</p></li></ul><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs markdown">// 通过jsDelivr的CDN引入echarts<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.jsdelivr.net/npm/echarts@4.8.0/dist/echarts.min.js&quot;</span>&gt;</span></span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br>// 使用GL里的各种组件时需要添加，否则可不需要<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.jsdelivr.net/npm/echarts-gl@1.1.1/dist/echarts-gl.min.js&quot;</span>&gt;</span></span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></code></pre></td></tr></table></figure><ul><li>在markdown文件下添加echarts，格式如下</li></ul><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br>...<br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><br>&#123;% echarts 400 &#x27;85%&#x27; %&#125;<br>...<br>&#123;% endecharts %&#125;<br></code></pre></td></tr></table></figure><ul><li><code>&lt;script&gt;</code>中添加定义的变量和函数，若无设定则可删掉<code>&lt;script&gt;&lt;/script&gt;</code></li><li><code>{% echarts 400 '85%' %}</code>和<code>{% endecharts %}</code>之间添加echarts的<code>option</code> 。<ul><li>参数400指定图表展示的高度为400px，85%则指定图表展示的宽度为85%，如不写明这两项参数则默认值为高度400px，宽度81%。</li><li>title：标题组件，包含主标题和副标题。</li><li>legend：图例组件。</li><li>tooltip：提示框组件。</li><li>toolbox：工具栏。内置有导出图片，数据视图，动态类型切换，数据区域缩放，重置五个工具。</li><li>xAxis、yAxis：直角坐标系 grid 中的 x 轴、y轴。</li><li>series：系列列表。每个系列通过<code>type</code>决定自己的图表类型。<ul><li>series-line：折线&#x2F;面积图</li><li>series-bar：柱状&#x2F;条形图</li><li>series-pie：饼图</li><li>series-scatter：散点图</li><li>series-radar：雷达图</li><li>series-tree：树图</li><li>series-boxplot：箱形图</li><li>series-candlestick：K线图</li><li>series-heatmap：热力图</li><li>series-graph：关系图</li></ul></li></ul></li><li>多个图表的数据和函数可能会冲突，请注意！</li><li>直接在html中直接绘制，然后用<code>&lt;iframe&gt;&lt;/iframe&gt;</code>展示效果更佳。关于hexo的html文件渲染问题，可以参考<a href="https://pxxyyz.com/posts/13656/">Fluid+自定义html</a>，主要是去掉<code>head</code>部分的说明。</li><li>在html绘图ECharts的格式如下：</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.jsdelivr.net/npm/echarts@4.8.0/dist/echarts.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 为 ECharts 准备一个具备大小（宽高）的 DOM --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;main&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;width: 600px;height:400px;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-comment">// 基于准备好的dom，初始化echarts实例</span></span><br><span class="language-javascript">  <span class="hljs-keyword">var</span> myChart = echarts.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;main&#x27;</span>));</span><br><span class="language-javascript">  <span class="hljs-comment">// 指定图表的配置项和数据</span></span><br><span class="language-javascript">  <span class="hljs-keyword">var</span> option = &#123;</span><br><span class="language-javascript">    ...</span><br><span class="language-javascript">  &#125;;</span><br><span class="language-javascript">  <span class="hljs-comment">// 使用刚指定的配置项和数据显示图表。</span></span><br><span class="language-javascript">  myChart.<span class="hljs-title function_">setOption</span>(option);</span><br><span class="language-javascript">  <span class="hljs-comment">// 刷新调整</span></span><br><span class="language-javascript">  <span class="hljs-variable language_">window</span>.<span class="hljs-property">onresize</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">    myChart.<span class="hljs-title function_">resize</span>();</span><br><span class="language-javascript">  &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>部分echart需要引入其他js，如<code>bmap</code>、<code>jquery</code>等，请自行添加。</li><li>使用百度地图的api需要<a href="http://lbsyun.baidu.com/apiconsole/key?application=key">申请密钥(ak)</a>，使用格式如下，注意替换<code>FAKE_AK</code>。</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://api.map.baidu.com/api?v=2.0&amp;ak=FAKE_AK&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://api.map.baidu.com/getscript?v=2.0&amp;ak=FAKE_AK&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><script src="https://cdn.jsdelivr.net/npm/echarts@4.8.0/dist/echarts.min.js"></script><script src="https://api.map.baidu.com/getscript?v=2.0&ak=84y4lPUPCHIrwRUQPc61uBewdYZ1pHM2"></script><script src="https://cdn.jsdelivr.net/npm/echarts-gl@1.1.1/dist/echarts-gl.min.js"></script><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><div class="note note-success">            <p>下面给出一些<a href="https://echarts.apache.org/examples/zh/index.html">echarts官方实例</a>，大多数都可以<span class="label label-primary"><strong>交互</strong></span>。</p>          </div><h3 id="折线图Line"><a href="#折线图Line" class="headerlink" title="折线图Line"></a>折线图Line</h3><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=area-stack">Stacked area chart</a></li></ul><div id="echarts5217" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts5217'));        // 指定图表的配置项和数据        var option = option = {    title: {        text: '堆叠区域图'    },    tooltip: {        trigger: 'axis',        axisPointer: {            type: 'cross',            label: {                backgroundColor: '#6a7985'            }        }    },    legend: {        data: ['邮件营销', '联盟广告', '视频广告', '直接访问', '搜索引擎']    },    toolbox: {        feature: {            saveAsImage: {}        }    },    grid: {        left: '3%',        right: '4%',        bottom: '3%',        containLabel: true    },    xAxis: [        {            type: 'category',            boundaryGap: false,            data: ['周一', '周二', '周三', '周四', '周五', '周六', '周日']        }    ],    yAxis: [        {            type: 'value'        }    ],    series: [        {            name: '邮件营销',            type: 'line',            stack: '总量',            areaStyle: {},            data: [120, 132, 101, 134, 90, 230, 210]        },        {            name: '联盟广告',            type: 'line',            stack: '总量',            areaStyle: {},            data: [220, 182, 191, 234, 290, 330, 310]        },        {            name: '视频广告',            type: 'line',            stack: '总量',            areaStyle: {},            data: [150, 232, 201, 154, 190, 330, 410]        },        {            name: '直接访问',            type: 'line',            stack: '总量',            areaStyle: {},            data: [320, 332, 301, 334, 390, 330, 320]        },        {            name: '搜索引擎',            type: 'line',            stack: '总量',            label: {                normal: {                    show: true,                    position: 'top'                }            },            areaStyle: {},            data: [820, 932, 901, 934, 1290, 1330, 1320]        }    ]};        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=area-pieces">Area Pieces</a></li></ul><div id="echarts7437" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts7437'));        // 指定图表的配置项和数据        var option = option = {    xAxis: {        type: 'category',        boundaryGap: false    },    yAxis: {        type: 'value',        boundaryGap: [0, '30%']    },    visualMap: {        type: 'piecewise',        show: false,        dimension: 0,        seriesIndex: 0,        pieces: [{            gt: 1,            lt: 3,            color: 'rgba(0, 180, 0, 0.5)'        }, {            gt: 5,            lt: 7,            color: 'rgba(0, 180, 0, 0.5)'        }]    },    series: [        {            type: 'line',            smooth: 0.6,            symbol: 'none',            lineStyle: {                color: 'green',                width: 5            },            markLine: {                symbol: ['none', 'none'],                label: {show: false},                data: [                    {xAxis: 1},                    {xAxis: 3},                    {xAxis: 5},                    {xAxis: 7}                ]            },            areaStyle: {},            data: [                ['2019-10-10', 200],                ['2019-10-11', 400],                ['2019-10-12', 650],                ['2019-10-13', 500],                ['2019-10-14', 250],                ['2019-10-15', 300],                ['2019-10-16', 450],                ['2019-10-17', 300],                ['2019-10-18', 100]            ]        }    ]};        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=area-rainfall">Rainfall</a></li></ul><div id="echarts548" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts548'));        // 指定图表的配置项和数据        var option = option = {    title: {        text: '雨量流量关系图',        subtext: '数据来自西安兰特水电测控技术有限公司',        left: 'center',        align: 'right'    },    grid: {        bottom: 80    },    toolbox: {        feature: {            dataZoom: {                yAxisIndex: 'none'            },            restore: {},            saveAsImage: {}        }    },    tooltip: {        trigger: 'axis',        axisPointer: {            type: 'cross',            animation: false,            label: {                backgroundColor: '#505765'            }        }    },    legend: {        data: ['流量', '降雨量'],        left: 10    },    dataZoom: [        {            show: true,            realtime: true,            start: 65,            end: 85        },        {            type: 'inside',            realtime: true,            start: 65,            end: 85        }    ],    xAxis: [        {            type: 'category',            boundaryGap: false,            axisLine: {onZero: false},            data: [                '2009/6/12 2:00', '2009/6/12 3:00', '2009/6/12 4:00', '2009/6/12 5:00', '2009/6/12 6:00', '2009/6/12 7:00', '2009/6/12 8:00', '2009/6/12 9:00', '2009/6/12 10:00', '2009/6/12 11:00', '2009/6/12 12:00', '2009/6/12 13:00', '2009/6/12 14:00', '2009/6/12 15:00', '2009/6/12 16:00', '2009/6/12 17:00', '2009/6/12 18:00', '2009/6/12 19:00', '2009/6/12 20:00', '2009/6/12 21:00', '2009/6/12 22:00', '2009/6/12 23:00',                '2009/6/13 0:00', '2009/6/13 1:00', '2009/6/13 2:00', '2009/6/13 3:00', '2009/6/13 4:00', '2009/6/13 5:00', '2009/6/13 6:00', '2009/6/13 7:00', '2009/6/13 8:00', '2009/6/13 9:00', '2009/6/13 10:00', '2009/6/13 11:00', '2009/6/13 12:00', '2009/6/13 13:00', '2009/6/13 14:00', '2009/6/13 15:00', '2009/6/13 16:00', '2009/6/13 17:00', '2009/6/13 18:00', '2009/6/13 19:00', '2009/6/13 20:00', '2009/6/13 21:00', '2009/6/13 22:00', '2009/6/13 23:00',                '2009/6/14 0:00', '2009/6/14 1:00', '2009/6/14 2:00', '2009/6/14 3:00', '2009/6/14 4:00', '2009/6/14 5:00', '2009/6/14 6:00', '2009/6/14 7:00', '2009/6/14 8:00', '2009/6/14 9:00', '2009/6/14 10:00', '2009/6/14 11:00', '2009/6/14 12:00', '2009/6/14 13:00', '2009/6/14 14:00', '2009/6/14 15:00', '2009/6/14 16:00', '2009/6/14 17:00', '2009/6/14 18:00', '2009/6/14 19:00', '2009/6/14 20:00', '2009/6/14 21:00', '2009/6/14 22:00', '2009/6/14 23:00',                '2009/6/15 0:00', '2009/6/15 1:00', '2009/6/15 2:00', '2009/6/15 3:00', '2009/6/15 4:00', '2009/6/15 5:00', '2009/6/15 6:00', '2009/6/15 7:00', '2009/6/15 8:00', '2009/6/15 9:00', '2009/6/15 10:00', '2009/6/15 11:00', '2009/6/15 12:00', '2009/6/15 13:00', '2009/6/15 14:00', '2009/6/15 15:00', '2009/6/15 16:00', '2009/6/15 17:00', '2009/6/15 18:00', '2009/6/15 19:00', '2009/6/15 20:00', '2009/6/15 21:00', '2009/6/15 22:00', '2009/6/15 23:00',                '2009/6/15 0:00', '2009/6/16 1:00', '2009/6/16 2:00', '2009/6/16 3:00', '2009/6/16 4:00', '2009/6/16 5:00', '2009/6/16 6:00', '2009/6/16 7:00', '2009/6/16 8:00', '2009/6/16 9:00', '2009/6/16 10:00', '2009/6/16 11:00', '2009/6/16 12:00', '2009/6/16 13:00', '2009/6/16 14:00', '2009/6/16 15:00', '2009/6/16 16:00', '2009/6/16 17:00', '2009/6/16 18:00', '2009/6/16 19:00', '2009/6/16 20:00', '2009/6/16 21:00', '2009/6/16 22:00', '2009/6/16 23:00',                '2009/6/15 0:00', '2009/6/17 1:00', '2009/6/17 2:00', '2009/6/17 3:00', '2009/6/17 4:00', '2009/6/17 5:00', '2009/6/17 6:00', '2009/6/17 7:00', '2009/6/17 8:00', '2009/6/17 9:00', '2009/6/17 10:00', '2009/6/17 11:00', '2009/6/17 12:00', '2009/6/17 13:00', '2009/6/17 14:00', '2009/6/17 15:00', '2009/6/17 16:00', '2009/6/17 17:00', '2009/6/17 18:00', '2009/6/17 19:00', '2009/6/17 20:00', '2009/6/17 21:00', '2009/6/17 22:00', '2009/6/17 23:00',                '2009/6/18 0:00', '2009/6/18 1:00', '2009/6/18 2:00', '2009/6/18 3:00', '2009/6/18 4:00', '2009/6/18 5:00', '2009/6/18 6:00', '2009/6/18 7:00', '2009/6/18 8:00', '2009/6/18 9:00', '2009/6/18 10:00', '2009/6/18 11:00', '2009/6/18 12:00', '2009/6/18 13:00', '2009/6/18 14:00', '2009/6/18 15:00', '2009/6/18 16:00', '2009/6/18 17:00', '2009/6/18 18:00', '2009/6/18 19:00', '2009/6/18 20:00', '2009/6/18 21:00', '2009/6/18 22:00', '2009/6/18 23:00',                '2009/6/15 0:00', '2009/6/19 1:00', '2009/6/19 2:00', '2009/6/19 3:00', '2009/6/19 4:00', '2009/6/19 5:00', '2009/6/19 6:00', '2009/6/19 7:00', '2009/6/19 8:00', '2009/6/19 9:00', '2009/6/19 10:00', '2009/6/19 11:00', '2009/6/19 12:00', '2009/6/19 13:00', '2009/6/19 14:00', '2009/6/19 15:00', '2009/6/19 16:00', '2009/6/19 17:00', '2009/6/19 18:00', '2009/6/19 19:00', '2009/6/19 20:00', '2009/6/19 21:00', '2009/6/19 22:00', '2009/6/19 23:00',                '2009/6/20 0:00', '2009/6/20 1:00', '2009/6/20 2:00', '2009/6/20 3:00', '2009/6/20 4:00', '2009/6/20 5:00', '2009/6/20 6:00', '2009/6/20 7:00', '2009/6/20 8:00', '2009/6/20 9:00', '2009/6/20 10:00', '2009/6/20 11:00', '2009/6/20 12:00', '2009/6/20 13:00', '2009/6/20 14:00', '2009/6/20 15:00', '2009/6/20 16:00', '2009/6/20 17:00', '2009/6/20 18:00', '2009/6/20 19:00', '2009/6/20 20:00', '2009/6/20 21:00', '2009/6/20 22:00', '2009/6/20 23:00',                '2009/6/21 0:00', '2009/6/21 1:00', '2009/6/21 2:00', '2009/6/21 3:00', '2009/6/21 4:00', '2009/6/21 5:00', '2009/6/21 6:00', '2009/6/21 7:00', '2009/6/21 8:00', '2009/6/21 9:00', '2009/6/21 10:00', '2009/6/21 11:00', '2009/6/21 12:00', '2009/6/21 13:00', '2009/6/21 14:00', '2009/6/21 15:00', '2009/6/21 16:00', '2009/6/21 17:00', '2009/6/21 18:00', '2009/6/21 19:00', '2009/6/21 20:00', '2009/6/21 21:00', '2009/6/21 22:00', '2009/6/21 23:00',                '2009/6/22 0:00', '2009/6/22 1:00', '2009/6/22 2:00', '2009/6/22 3:00', '2009/6/22 4:00', '2009/6/22 5:00', '2009/6/22 6:00', '2009/6/22 7:00', '2009/6/22 8:00', '2009/6/22 9:00', '2009/6/22 10:00', '2009/6/22 11:00', '2009/6/22 12:00', '2009/6/22 13:00', '2009/6/22 14:00', '2009/6/22 15:00', '2009/6/22 16:00', '2009/6/22 17:00', '2009/6/22 18:00', '2009/6/22 19:00', '2009/6/22 20:00', '2009/6/22 21:00', '2009/6/22 22:00', '2009/6/22 23:00',                '2009/6/23 0:00', '2009/6/23 1:00', '2009/6/23 2:00', '2009/6/23 3:00', '2009/6/23 4:00', '2009/6/23 5:00', '2009/6/23 6:00', '2009/6/23 7:00', '2009/6/23 8:00', '2009/6/23 9:00', '2009/6/23 10:00', '2009/6/23 11:00', '2009/6/23 12:00', '2009/6/23 13:00', '2009/6/23 14:00', '2009/6/23 15:00', '2009/6/23 16:00', '2009/6/23 17:00', '2009/6/23 18:00', '2009/6/23 19:00', '2009/6/23 20:00', '2009/6/23 21:00', '2009/6/23 22:00', '2009/6/23 23:00',                '2009/6/24 0:00', '2009/6/24 1:00', '2009/6/24 2:00', '2009/6/24 3:00', '2009/6/24 4:00', '2009/6/24 5:00', '2009/6/24 6:00', '2009/6/24 7:00', '2009/6/24 8:00', '2009/6/24 9:00', '2009/6/24 10:00', '2009/6/24 11:00', '2009/6/24 12:00', '2009/6/24 13:00', '2009/6/24 14:00', '2009/6/24 15:00', '2009/6/24 16:00', '2009/6/24 17:00', '2009/6/24 18:00', '2009/6/24 19:00', '2009/6/24 20:00', '2009/6/24 21:00', '2009/6/24 22:00', '2009/6/24 23:00',                '2009/6/25 0:00', '2009/6/25 1:00', '2009/6/25 2:00', '2009/6/25 3:00', '2009/6/25 4:00', '2009/6/25 5:00', '2009/6/25 6:00', '2009/6/25 7:00', '2009/6/25 8:00', '2009/6/25 9:00', '2009/6/25 10:00', '2009/6/25 11:00', '2009/6/25 12:00', '2009/6/25 13:00', '2009/6/25 14:00', '2009/6/25 15:00', '2009/6/25 16:00', '2009/6/25 17:00', '2009/6/25 18:00', '2009/6/25 19:00', '2009/6/25 20:00', '2009/6/25 21:00', '2009/6/25 22:00', '2009/6/25 23:00',                '2009/6/26 0:00', '2009/6/26 1:00', '2009/6/26 2:00', '2009/6/26 3:00', '2009/6/26 4:00', '2009/6/26 5:00', '2009/6/26 6:00', '2009/6/26 7:00', '2009/6/26 8:00', '2009/6/26 9:00', '2009/6/26 10:00', '2009/6/26 11:00', '2009/6/26 12:00', '2009/6/26 13:00', '2009/6/26 14:00', '2009/6/26 15:00', '2009/6/26 16:00', '2009/6/26 17:00', '2009/6/26 18:00', '2009/6/26 19:00', '2009/6/26 20:00', '2009/6/26 21:00', '2009/6/26 22:00', '2009/6/26 23:00',                '2009/6/27 0:00', '2009/6/27 1:00', '2009/6/27 2:00', '2009/6/27 3:00', '2009/6/27 4:00', '2009/6/27 5:00', '2009/6/27 6:00', '2009/6/27 7:00', '2009/6/27 8:00', '2009/6/27 9:00', '2009/6/27 10:00', '2009/6/27 11:00', '2009/6/27 12:00', '2009/6/27 13:00', '2009/6/27 14:00', '2009/6/27 15:00', '2009/6/27 16:00', '2009/6/27 17:00', '2009/6/27 18:00', '2009/6/27 19:00', '2009/6/27 20:00', '2009/6/27 21:00', '2009/6/27 22:00', '2009/6/27 23:00',                '2009/6/28 0:00', '2009/6/28 1:00', '2009/6/28 2:00', '2009/6/28 3:00', '2009/6/28 4:00', '2009/6/28 5:00', '2009/6/28 6:00', '2009/6/28 7:00', '2009/6/28 8:00', '2009/6/28 9:00', '2009/6/28 10:00', '2009/6/28 11:00', '2009/6/28 12:00', '2009/6/28 13:00', '2009/6/28 14:00', '2009/6/28 15:00', '2009/6/28 16:00', '2009/6/28 17:00', '2009/6/28 18:00', '2009/6/28 19:00', '2009/6/28 20:00', '2009/6/28 21:00', '2009/6/28 22:00', '2009/6/28 23:00',                '2009/6/29 0:00', '2009/6/29 1:00', '2009/6/29 2:00', '2009/6/29 3:00', '2009/6/29 4:00', '2009/6/29 5:00', '2009/6/29 6:00', '2009/6/29 7:00', '2009/6/29 8:00', '2009/6/29 9:00', '2009/6/29 10:00', '2009/6/29 11:00', '2009/6/29 12:00', '2009/6/29 13:00', '2009/6/29 14:00', '2009/6/29 15:00', '2009/6/29 16:00', '2009/6/29 17:00', '2009/6/29 18:00', '2009/6/29 19:00', '2009/6/29 20:00', '2009/6/29 21:00', '2009/6/29 22:00', '2009/6/29 23:00',                '2009/6/30 0:00', '2009/6/30 1:00', '2009/6/30 2:00', '2009/6/30 3:00', '2009/6/30 4:00', '2009/6/30 5:00', '2009/6/30 6:00', '2009/6/30 7:00', '2009/6/30 8:00', '2009/6/30 9:00', '2009/6/30 10:00', '2009/6/30 11:00', '2009/6/30 12:00', '2009/6/30 13:00', '2009/6/30 14:00', '2009/6/30 15:00', '2009/6/30 16:00', '2009/6/30 17:00', '2009/6/30 18:00', '2009/6/30 19:00', '2009/6/30 20:00', '2009/6/30 21:00', '2009/6/30 22:00', '2009/6/30 23:00',                '2009/7/1 0:00', '2009/7/1 1:00', '2009/7/1 2:00', '2009/7/1 3:00', '2009/7/1 4:00', '2009/7/1 5:00', '2009/7/1 6:00', '2009/7/1 7:00', '2009/7/1 8:00', '2009/7/1 9:00', '2009/7/1 10:00', '2009/7/1 11:00', '2009/7/1 12:00', '2009/7/1 13:00', '2009/7/1 14:00', '2009/7/1 15:00', '2009/7/1 16:00', '2009/7/1 17:00', '2009/7/1 18:00', '2009/7/1 19:00', '2009/7/1 20:00', '2009/7/1 21:00', '2009/7/1 22:00', '2009/7/1 23:00',                '2009/7/2 0:00', '2009/7/2 1:00', '2009/7/2 2:00', '2009/7/2 3:00', '2009/7/2 4:00', '2009/7/2 5:00', '2009/7/2 6:00', '2009/7/2 7:00', '2009/7/2 8:00', '2009/7/2 9:00', '2009/7/2 10:00', '2009/7/2 11:00', '2009/7/2 12:00', '2009/7/2 13:00', '2009/7/2 14:00', '2009/7/2 15:00', '2009/7/2 16:00', '2009/7/2 17:00', '2009/7/2 18:00', '2009/7/2 19:00', '2009/7/2 20:00', '2009/7/2 21:00', '2009/7/2 22:00', '2009/7/2 23:00',                '2009/7/3 0:00', '2009/7/3 1:00', '2009/7/3 2:00', '2009/7/3 3:00', '2009/7/3 4:00', '2009/7/3 5:00', '2009/7/3 6:00', '2009/7/3 7:00', '2009/7/3 8:00', '2009/7/3 9:00', '2009/7/3 10:00', '2009/7/3 11:00', '2009/7/3 12:00', '2009/7/3 13:00', '2009/7/3 14:00', '2009/7/3 15:00', '2009/7/3 16:00', '2009/7/3 17:00', '2009/7/3 18:00', '2009/7/3 19:00', '2009/7/3 20:00', '2009/7/3 21:00', '2009/7/3 22:00', '2009/7/3 23:00',                '2009/7/4 0:00', '2009/7/4 1:00', '2009/7/4 2:00', '2009/7/4 3:00', '2009/7/4 4:00', '2009/7/4 5:00', '2009/7/4 6:00', '2009/7/4 7:00', '2009/7/4 8:00', '2009/7/4 9:00', '2009/7/4 10:00', '2009/7/4 11:00', '2009/7/4 12:00', '2009/7/4 13:00', '2009/7/4 14:00', '2009/7/4 15:00', '2009/7/4 16:00', '2009/7/4 17:00', '2009/7/4 18:00', '2009/7/4 19:00', '2009/7/4 20:00', '2009/7/4 21:00', '2009/7/4 22:00', '2009/7/4 23:00',                '2009/7/5 0:00', '2009/7/5 1:00', '2009/7/5 2:00', '2009/7/5 3:00', '2009/7/5 4:00', '2009/7/5 5:00', '2009/7/5 6:00', '2009/7/5 7:00', '2009/7/5 8:00', '2009/7/5 9:00', '2009/7/5 10:00', '2009/7/5 11:00', '2009/7/5 12:00', '2009/7/5 13:00', '2009/7/5 14:00', '2009/7/5 15:00', '2009/7/5 16:00', '2009/7/5 17:00', '2009/7/5 18:00', '2009/7/5 19:00', '2009/7/5 20:00', '2009/7/5 21:00', '2009/7/5 22:00', '2009/7/5 23:00',                '2009/7/6 0:00', '2009/7/6 1:00', '2009/7/6 2:00', '2009/7/6 3:00', '2009/7/6 4:00', '2009/7/6 5:00', '2009/7/6 6:00', '2009/7/6 7:00', '2009/7/6 8:00', '2009/7/6 9:00', '2009/7/6 10:00', '2009/7/6 11:00', '2009/7/6 12:00', '2009/7/6 13:00', '2009/7/6 14:00', '2009/7/6 15:00', '2009/7/6 16:00', '2009/7/6 17:00', '2009/7/6 18:00', '2009/7/6 19:00', '2009/7/6 20:00', '2009/7/6 21:00', '2009/7/6 22:00', '2009/7/6 23:00',                '2009/7/7 0:00', '2009/7/7 1:00', '2009/7/7 2:00', '2009/7/7 3:00', '2009/7/7 4:00', '2009/7/7 5:00', '2009/7/7 6:00', '2009/7/7 7:00', '2009/7/7 8:00', '2009/7/7 9:00', '2009/7/7 10:00', '2009/7/7 11:00', '2009/7/7 12:00', '2009/7/7 13:00', '2009/7/7 14:00', '2009/7/7 15:00', '2009/7/7 16:00', '2009/7/7 17:00', '2009/7/7 18:00', '2009/7/7 19:00', '2009/7/7 20:00', '2009/7/7 21:00', '2009/7/7 22:00', '2009/7/7 23:00',                '2009/7/8 0:00', '2009/7/8 1:00', '2009/7/8 2:00', '2009/7/8 3:00', '2009/7/8 4:00', '2009/7/8 5:00', '2009/7/8 6:00', '2009/7/8 7:00', '2009/7/8 8:00', '2009/7/8 9:00', '2009/7/8 10:00', '2009/7/8 11:00', '2009/7/8 12:00', '2009/7/8 13:00', '2009/7/8 14:00', '2009/7/8 15:00', '2009/7/8 16:00', '2009/7/8 17:00', '2009/7/8 18:00', '2009/7/8 19:00', '2009/7/8 20:00', '2009/7/8 21:00', '2009/7/8 22:00', '2009/7/8 23:00',                '2009/7/9 0:00', '2009/7/9 1:00', '2009/7/9 2:00', '2009/7/9 3:00', '2009/7/9 4:00', '2009/7/9 5:00', '2009/7/9 6:00', '2009/7/9 7:00', '2009/7/9 8:00', '2009/7/9 9:00', '2009/7/9 10:00', '2009/7/9 11:00', '2009/7/9 12:00', '2009/7/9 13:00', '2009/7/9 14:00', '2009/7/9 15:00', '2009/7/9 16:00', '2009/7/9 17:00', '2009/7/9 18:00', '2009/7/9 19:00', '2009/7/9 20:00', '2009/7/9 21:00', '2009/7/9 22:00', '2009/7/9 23:00',                '2009/7/10 0:00', '2009/7/10 1:00', '2009/7/10 2:00', '2009/7/10 3:00', '2009/7/10 4:00', '2009/7/10 5:00', '2009/7/10 6:00', '2009/7/10 7:00', '2009/7/10 8:00', '2009/7/10 9:00', '2009/7/10 10:00', '2009/7/10 11:00', '2009/7/10 12:00', '2009/7/10 13:00', '2009/7/10 14:00', '2009/7/10 15:00', '2009/7/10 16:00', '2009/7/10 17:00', '2009/7/10 18:00', '2009/7/10 19:00', '2009/7/10 20:00', '2009/7/10 21:00', '2009/7/10 22:00', '2009/7/10 23:00',                '2009/7/11 0:00', '2009/7/11 1:00', '2009/7/11 2:00', '2009/7/11 3:00', '2009/7/11 4:00', '2009/7/11 5:00', '2009/7/11 6:00', '2009/7/11 7:00', '2009/7/11 8:00', '2009/7/11 9:00', '2009/7/11 10:00', '2009/7/11 11:00', '2009/7/11 12:00', '2009/7/11 13:00', '2009/7/11 14:00', '2009/7/11 15:00', '2009/7/11 16:00', '2009/7/11 17:00', '2009/7/11 18:00', '2009/7/11 19:00', '2009/7/11 20:00', '2009/7/11 21:00', '2009/7/11 22:00', '2009/7/11 23:00',                '2009/7/12 0:00', '2009/7/12 1:00', '2009/7/12 2:00', '2009/7/12 3:00', '2009/7/12 4:00', '2009/7/12 5:00', '2009/7/12 6:00', '2009/7/12 7:00', '2009/7/12 8:00', '2009/7/12 9:00', '2009/7/12 10:00', '2009/7/12 11:00', '2009/7/12 12:00', '2009/7/12 13:00', '2009/7/12 14:00', '2009/7/12 15:00', '2009/7/12 16:00', '2009/7/12 17:00', '2009/7/12 18:00', '2009/7/12 19:00', '2009/7/12 20:00', '2009/7/12 21:00', '2009/7/12 22:00', '2009/7/12 23:00',                '2009/7/13 0:00', '2009/7/13 1:00', '2009/7/13 2:00', '2009/7/13 3:00', '2009/7/13 4:00', '2009/7/13 5:00', '2009/7/13 6:00', '2009/7/13 7:00', '2009/7/13 8:00', '2009/7/13 9:00', '2009/7/13 10:00', '2009/7/13 11:00', '2009/7/13 12:00', '2009/7/13 13:00', '2009/7/13 14:00', '2009/7/13 15:00', '2009/7/13 16:00', '2009/7/13 17:00', '2009/7/13 18:00', '2009/7/13 19:00', '2009/7/13 20:00', '2009/7/13 21:00', '2009/7/13 22:00', '2009/7/13 23:00',                '2009/7/14 0:00', '2009/7/14 1:00', '2009/7/14 2:00', '2009/7/14 3:00', '2009/7/14 4:00', '2009/7/14 5:00', '2009/7/14 6:00', '2009/7/14 7:00', '2009/7/14 8:00', '2009/7/14 9:00', '2009/7/14 10:00', '2009/7/14 11:00', '2009/7/14 12:00', '2009/7/14 13:00', '2009/7/14 14:00', '2009/7/14 15:00', '2009/7/14 16:00', '2009/7/14 17:00', '2009/7/14 18:00', '2009/7/14 19:00', '2009/7/14 20:00', '2009/7/14 21:00', '2009/7/14 22:00', '2009/7/14 23:00',                '2009/7/15 0:00', '2009/7/15 1:00', '2009/7/15 2:00', '2009/7/15 3:00', '2009/7/15 4:00', '2009/7/15 5:00', '2009/7/15 6:00', '2009/7/15 7:00', '2009/7/15 8:00', '2009/7/15 9:00', '2009/7/15 10:00', '2009/7/15 11:00', '2009/7/15 12:00', '2009/7/15 13:00', '2009/7/15 14:00', '2009/7/15 15:00', '2009/7/15 16:00', '2009/7/15 17:00', '2009/7/15 18:00', '2009/7/15 19:00', '2009/7/15 20:00', '2009/7/15 21:00', '2009/7/15 22:00', '2009/7/15 23:00',                '2009/7/16 0:00', '2009/7/16 1:00', '2009/7/16 2:00', '2009/7/16 3:00', '2009/7/16 4:00', '2009/7/16 5:00', '2009/7/16 6:00', '2009/7/16 7:00', '2009/7/16 8:00', '2009/7/16 9:00', '2009/7/16 10:00', '2009/7/16 11:00', '2009/7/16 12:00', '2009/7/16 13:00', '2009/7/16 14:00', '2009/7/16 15:00', '2009/7/16 16:00', '2009/7/16 17:00', '2009/7/16 18:00', '2009/7/16 19:00', '2009/7/16 20:00', '2009/7/16 21:00', '2009/7/16 22:00', '2009/7/16 23:00',                '2009/7/17 0:00', '2009/7/17 1:00', '2009/7/17 2:00', '2009/7/17 3:00', '2009/7/17 4:00', '2009/7/17 5:00', '2009/7/17 6:00', '2009/7/17 7:00', '2009/7/17 8:00', '2009/7/17 9:00', '2009/7/17 10:00', '2009/7/17 11:00', '2009/7/17 12:00', '2009/7/17 13:00', '2009/7/17 14:00', '2009/7/17 15:00', '2009/7/17 16:00', '2009/7/17 17:00', '2009/7/17 18:00', '2009/7/17 19:00', '2009/7/17 20:00', '2009/7/17 21:00', '2009/7/17 22:00', '2009/7/17 23:00',                '2009/7/18 0:00', '2009/7/18 1:00', '2009/7/18 2:00', '2009/7/18 3:00', '2009/7/18 4:00', '2009/7/18 5:00', '2009/7/18 6:00', '2009/7/18 7:00', '2009/7/18 8:00', '2009/7/18 9:00', '2009/7/18 10:00', '2009/7/18 11:00', '2009/7/18 12:00', '2009/7/18 13:00', '2009/7/18 14:00', '2009/7/18 15:00', '2009/7/18 16:00', '2009/7/18 17:00', '2009/7/18 18:00', '2009/7/18 19:00', '2009/7/18 20:00', '2009/7/18 21:00', '2009/7/18 22:00', '2009/7/18 23:00',                '2009/7/19 0:00', '2009/7/19 1:00', '2009/7/19 2:00', '2009/7/19 3:00', '2009/7/19 4:00', '2009/7/19 5:00', '2009/7/19 6:00', '2009/7/19 7:00', '2009/7/19 8:00', '2009/7/19 9:00', '2009/7/19 10:00', '2009/7/19 11:00', '2009/7/19 12:00', '2009/7/19 13:00', '2009/7/19 14:00', '2009/7/19 15:00', '2009/7/19 16:00', '2009/7/19 17:00', '2009/7/19 18:00', '2009/7/19 19:00', '2009/7/19 20:00', '2009/7/19 21:00', '2009/7/19 22:00', '2009/7/19 23:00',                '2009/7/20 0:00', '2009/7/20 1:00', '2009/7/20 2:00', '2009/7/20 3:00', '2009/7/20 4:00', '2009/7/20 5:00', '2009/7/20 6:00', '2009/7/20 7:00', '2009/7/20 8:00', '2009/7/20 9:00', '2009/7/20 10:00', '2009/7/20 11:00', '2009/7/20 12:00', '2009/7/20 13:00', '2009/7/20 14:00', '2009/7/20 15:00', '2009/7/20 16:00', '2009/7/20 17:00', '2009/7/20 18:00', '2009/7/20 19:00', '2009/7/20 20:00', '2009/7/20 21:00', '2009/7/20 22:00', '2009/7/20 23:00',                '2009/7/21 0:00', '2009/7/21 1:00', '2009/7/21 2:00', '2009/7/21 3:00', '2009/7/21 4:00', '2009/7/21 5:00', '2009/7/21 6:00', '2009/7/21 7:00', '2009/7/21 8:00', '2009/7/21 9:00', '2009/7/21 10:00', '2009/7/21 11:00', '2009/7/21 12:00', '2009/7/21 13:00', '2009/7/21 14:00', '2009/7/21 15:00', '2009/7/21 16:00', '2009/7/21 17:00', '2009/7/21 18:00', '2009/7/21 19:00', '2009/7/21 20:00', '2009/7/21 21:00', '2009/7/21 22:00', '2009/7/21 23:00',                '2009/7/22 0:00', '2009/7/22 1:00', '2009/7/22 2:00', '2009/7/22 3:00', '2009/7/22 4:00', '2009/7/22 5:00', '2009/7/22 6:00', '2009/7/22 7:00', '2009/7/22 8:00', '2009/7/22 9:00', '2009/7/22 10:00', '2009/7/22 11:00', '2009/7/22 12:00', '2009/7/22 13:00', '2009/7/22 14:00', '2009/7/22 15:00', '2009/7/22 16:00', '2009/7/22 17:00', '2009/7/22 18:00', '2009/7/22 19:00', '2009/7/22 20:00', '2009/7/22 21:00', '2009/7/22 22:00', '2009/7/22 23:00',                '2009/7/23 0:00', '2009/7/23 1:00', '2009/7/23 2:00', '2009/7/23 3:00', '2009/7/23 4:00', '2009/7/23 5:00', '2009/7/23 6:00', '2009/7/23 7:00', '2009/7/23 8:00', '2009/7/23 9:00', '2009/7/23 10:00', '2009/7/23 11:00', '2009/7/23 12:00', '2009/7/23 13:00', '2009/7/23 14:00', '2009/7/23 15:00', '2009/7/23 16:00', '2009/7/23 17:00', '2009/7/23 18:00', '2009/7/23 19:00', '2009/7/23 20:00', '2009/7/23 21:00', '2009/7/23 22:00', '2009/7/23 23:00',                '2009/7/24 0:00', '2009/7/24 1:00', '2009/7/24 2:00', '2009/7/24 3:00', '2009/7/24 4:00', '2009/7/24 5:00', '2009/7/24 6:00', '2009/7/24 7:00', '2009/7/24 8:00', '2009/7/24 9:00', '2009/7/24 10:00', '2009/7/24 11:00', '2009/7/24 12:00', '2009/7/24 13:00', '2009/7/24 14:00', '2009/7/24 15:00', '2009/7/24 16:00', '2009/7/24 17:00', '2009/7/24 18:00', '2009/7/24 19:00', '2009/7/24 20:00', '2009/7/24 21:00', '2009/7/24 22:00', '2009/7/24 23:00',                '2009/7/25 0:00', '2009/7/25 1:00', '2009/7/25 2:00', '2009/7/25 3:00', '2009/7/25 4:00', '2009/7/25 5:00', '2009/7/25 6:00', '2009/7/25 7:00', '2009/7/25 8:00', '2009/7/25 9:00', '2009/7/25 10:00', '2009/7/25 11:00', '2009/7/25 12:00', '2009/7/25 13:00', '2009/7/25 14:00', '2009/7/25 15:00', '2009/7/25 16:00', '2009/7/25 17:00', '2009/7/25 18:00', '2009/7/25 19:00', '2009/7/25 20:00', '2009/7/25 21:00', '2009/7/25 22:00', '2009/7/25 23:00',                '2009/7/26 0:00', '2009/7/26 1:00', '2009/7/26 2:00', '2009/7/26 3:00', '2009/7/26 4:00', '2009/7/26 5:00', '2009/7/26 6:00', '2009/7/26 7:00', '2009/7/26 8:00', '2009/7/26 9:00', '2009/7/26 10:00', '2009/7/26 11:00', '2009/7/26 12:00', '2009/7/26 13:00', '2009/7/26 14:00', '2009/7/26 15:00', '2009/7/26 16:00', '2009/7/26 17:00', '2009/7/26 18:00', '2009/7/26 19:00', '2009/7/26 20:00', '2009/7/26 21:00', '2009/7/26 22:00', '2009/7/26 23:00',                '2009/7/27 0:00', '2009/7/27 1:00', '2009/7/27 2:00', '2009/7/27 3:00', '2009/7/27 4:00', '2009/7/27 5:00', '2009/7/27 6:00', '2009/7/27 7:00', '2009/7/27 8:00', '2009/7/27 9:00', '2009/7/27 10:00', '2009/7/27 11:00', '2009/7/27 12:00', '2009/7/27 13:00', '2009/7/27 14:00', '2009/7/27 15:00', '2009/7/27 16:00', '2009/7/27 17:00', '2009/7/27 18:00', '2009/7/27 19:00', '2009/7/27 20:00', '2009/7/27 21:00', '2009/7/27 22:00', '2009/7/27 23:00',                '2009/7/28 0:00', '2009/7/28 1:00', '2009/7/28 2:00', '2009/7/28 3:00', '2009/7/28 4:00', '2009/7/28 5:00', '2009/7/28 6:00', '2009/7/28 7:00', '2009/7/28 8:00', '2009/7/28 9:00', '2009/7/28 10:00', '2009/7/28 11:00', '2009/7/28 12:00', '2009/7/28 13:00', '2009/7/28 14:00', '2009/7/28 15:00', '2009/7/28 16:00', '2009/7/28 17:00', '2009/7/28 18:00', '2009/7/28 19:00', '2009/7/28 20:00', '2009/7/28 21:00', '2009/7/28 22:00', '2009/7/28 23:00',                '2009/7/29 0:00', '2009/7/29 1:00', '2009/7/29 2:00', '2009/7/29 3:00', '2009/7/29 4:00', '2009/7/29 5:00', '2009/7/29 6:00', '2009/7/29 7:00', '2009/7/29 8:00', '2009/7/29 9:00', '2009/7/29 10:00', '2009/7/29 11:00', '2009/7/29 12:00', '2009/7/29 13:00', '2009/7/29 14:00', '2009/7/29 15:00', '2009/7/29 16:00', '2009/7/29 17:00', '2009/7/29 18:00', '2009/7/29 19:00', '2009/7/29 20:00', '2009/7/29 21:00', '2009/7/29 22:00', '2009/7/29 23:00',                '2009/7/30 0:00', '2009/7/30 1:00', '2009/7/30 2:00', '2009/7/30 3:00', '2009/7/30 4:00', '2009/7/30 5:00', '2009/7/30 6:00', '2009/7/30 7:00', '2009/7/30 8:00', '2009/7/30 9:00', '2009/7/30 10:00', '2009/7/30 11:00', '2009/7/30 12:00', '2009/7/30 13:00', '2009/7/30 14:00', '2009/7/30 15:00', '2009/7/30 16:00', '2009/7/30 17:00', '2009/7/30 18:00', '2009/7/30 19:00', '2009/7/30 20:00', '2009/7/30 21:00', '2009/7/30 22:00', '2009/7/30 23:00',                '2009/7/31 0:00', '2009/7/31 1:00', '2009/7/31 2:00', '2009/7/31 3:00', '2009/7/31 4:00', '2009/7/31 5:00', '2009/7/31 6:00', '2009/7/31 7:00', '2009/7/31 8:00', '2009/7/31 9:00', '2009/7/31 10:00', '2009/7/31 11:00', '2009/7/31 12:00', '2009/7/31 13:00', '2009/7/31 14:00', '2009/7/31 15:00', '2009/7/31 16:00', '2009/7/31 17:00', '2009/7/31 18:00', '2009/7/31 19:00', '2009/7/31 20:00', '2009/7/31 21:00', '2009/7/31 22:00', '2009/7/31 23:00',                '2009/8/1 0:00', '2009/8/1 1:00', '2009/8/1 2:00', '2009/8/1 3:00', '2009/8/1 4:00', '2009/8/1 5:00', '2009/8/1 6:00', '2009/8/1 7:00', '2009/8/1 8:00', '2009/8/1 9:00', '2009/8/1 10:00', '2009/8/1 11:00', '2009/8/1 12:00', '2009/8/1 13:00', '2009/8/1 14:00', '2009/8/1 15:00', '2009/8/1 16:00', '2009/8/1 17:00', '2009/8/1 18:00', '2009/8/1 19:00', '2009/8/1 20:00', '2009/8/1 21:00', '2009/8/1 22:00', '2009/8/1 23:00', '2009/8/2 0:00', '2009/8/2 1:00', '2009/8/2 2:00', '2009/8/2 3:00', '2009/8/2 4:00', '2009/8/2 5:00', '2009/8/2 6:00', '2009/8/2 7:00', '2009/8/2 8:00', '2009/8/2 9:00', '2009/8/2 10:00', '2009/8/2 11:00', '2009/8/2 12:00', '2009/8/2 13:00', '2009/8/2 14:00', '2009/8/2 15:00', '2009/8/2 16:00', '2009/8/2 17:00', '2009/8/2 18:00', '2009/8/2 19:00', '2009/8/2 20:00', '2009/8/2 21:00', '2009/8/2 22:00', '2009/8/2 23:00', '2009/8/3 0:00', '2009/8/3 1:00', '2009/8/3 2:00', '2009/8/3 3:00', '2009/8/3 4:00', '2009/8/3 5:00', '2009/8/3 6:00', '2009/8/3 7:00', '2009/8/3 8:00', '2009/8/3 9:00', '2009/8/3 10:00', '2009/8/3 11:00', '2009/8/3 12:00', '2009/8/3 13:00', '2009/8/3 14:00', '2009/8/3 15:00', '2009/8/3 16:00', '2009/8/3 17:00', '2009/8/3 18:00', '2009/8/3 19:00', '2009/8/3 20:00', '2009/8/3 21:00', '2009/8/3 22:00', '2009/8/3 23:00', '2009/8/4 0:00', '2009/8/4 1:00', '2009/8/4 2:00', '2009/8/4 3:00', '2009/8/4 4:00', '2009/8/4 5:00', '2009/8/4 6:00', '2009/8/4 7:00', '2009/8/4 8:00', '2009/8/4 9:00', '2009/8/4 10:00', '2009/8/4 11:00', '2009/8/4 12:00', '2009/8/4 13:00', '2009/8/4 14:00', '2009/8/4 15:00', '2009/8/4 16:00', '2009/8/4 17:00', '2009/8/4 18:00', '2009/8/4 19:00', '2009/8/4 20:00', '2009/8/4 21:00', '2009/8/4 22:00', '2009/8/4 23:00', '2009/8/5 0:00', '2009/8/5 1:00', '2009/8/5 2:00', '2009/8/5 3:00', '2009/8/5 4:00', '2009/8/5 5:00', '2009/8/5 6:00', '2009/8/5 7:00', '2009/8/5 8:00', '2009/8/5 9:00', '2009/8/5 10:00', '2009/8/5 11:00', '2009/8/5 12:00', '2009/8/5 13:00', '2009/8/5 14:00', '2009/8/5 15:00', '2009/8/5 16:00', '2009/8/5 17:00', '2009/8/5 18:00', '2009/8/5 19:00', '2009/8/5 20:00', '2009/8/5 21:00', '2009/8/5 22:00', '2009/8/5 23:00', '2009/8/6 0:00', '2009/8/6 1:00', '2009/8/6 2:00', '2009/8/6 3:00', '2009/8/6 4:00', '2009/8/6 5:00', '2009/8/6 6:00', '2009/8/6 7:00', '2009/8/6 8:00', '2009/8/6 9:00', '2009/8/6 10:00', '2009/8/6 11:00', '2009/8/6 12:00', '2009/8/6 13:00', '2009/8/6 14:00', '2009/8/6 15:00', '2009/8/6 16:00', '2009/8/6 17:00', '2009/8/6 18:00', '2009/8/6 19:00', '2009/8/6 20:00', '2009/8/6 21:00', '2009/8/6 22:00', '2009/8/6 23:00', '2009/8/7 0:00', '2009/8/7 1:00', '2009/8/7 2:00', '2009/8/7 3:00', '2009/8/7 4:00', '2009/8/7 5:00', '2009/8/7 6:00', '2009/8/7 7:00', '2009/8/7 8:00', '2009/8/7 9:00', '2009/8/7 10:00', '2009/8/7 11:00', '2009/8/7 12:00', '2009/8/7 13:00', '2009/8/7 14:00', '2009/8/7 15:00', '2009/8/7 16:00', '2009/8/7 17:00', '2009/8/7 18:00', '2009/8/7 19:00', '2009/8/7 20:00', '2009/8/7 21:00', '2009/8/7 22:00', '2009/8/7 23:00', '2009/8/8 0:00', '2009/8/8 1:00', '2009/8/8 2:00', '2009/8/8 3:00', '2009/8/8 4:00', '2009/8/8 5:00', '2009/8/8 6:00', '2009/8/8 7:00', '2009/8/8 8:00', '2009/8/8 9:00', '2009/8/8 10:00', '2009/8/8 11:00', '2009/8/8 12:00', '2009/8/8 13:00', '2009/8/8 14:00', '2009/8/8 15:00', '2009/8/8 16:00', '2009/8/8 17:00', '2009/8/8 18:00', '2009/8/8 19:00', '2009/8/8 20:00', '2009/8/8 21:00', '2009/8/8 22:00', '2009/8/8 23:00', '2009/8/9 0:00', '2009/8/9 1:00', '2009/8/9 2:00', '2009/8/9 3:00', '2009/8/9 4:00', '2009/8/9 5:00', '2009/8/9 6:00', '2009/8/9 7:00', '2009/8/9 8:00', '2009/8/9 9:00', '2009/8/9 10:00', '2009/8/9 11:00', '2009/8/9 12:00', '2009/8/9 13:00', '2009/8/9 14:00', '2009/8/9 15:00', '2009/8/9 16:00', '2009/8/9 17:00', '2009/8/9 18:00', '2009/8/9 19:00', '2009/8/9 20:00', '2009/8/9 21:00', '2009/8/9 22:00', '2009/8/9 23:00', '2009/8/10 0:00', '2009/8/10 1:00', '2009/8/10 2:00', '2009/8/10 3:00', '2009/8/10 4:00', '2009/8/10 5:00', '2009/8/10 6:00', '2009/8/10 7:00', '2009/8/10 8:00', '2009/8/10 9:00', '2009/8/10 10:00', '2009/8/10 11:00', '2009/8/10 12:00', '2009/8/10 13:00', '2009/8/10 14:00', '2009/8/10 15:00', '2009/8/10 16:00', '2009/8/10 17:00', '2009/8/10 18:00', '2009/8/10 19:00', '2009/8/10 20:00', '2009/8/10 21:00', '2009/8/10 22:00', '2009/8/10 23:00', '2009/8/11 0:00', '2009/8/11 1:00', '2009/8/11 2:00', '2009/8/11 3:00', '2009/8/11 4:00', '2009/8/11 5:00', '2009/8/11 6:00', '2009/8/11 7:00', '2009/8/11 8:00', '2009/8/11 9:00', '2009/8/11 10:00', '2009/8/11 11:00', '2009/8/11 12:00', '2009/8/11 13:00', '2009/8/11 14:00', '2009/8/11 15:00', '2009/8/11 16:00', '2009/8/11 17:00', '2009/8/11 18:00', '2009/8/11 19:00', '2009/8/11 20:00', '2009/8/11 21:00', '2009/8/11 22:00', '2009/8/11 23:00', '2009/8/12 0:00', '2009/8/12 1:00', '2009/8/12 2:00', '2009/8/12 3:00', '2009/8/12 4:00', '2009/8/12 5:00', '2009/8/12 6:00', '2009/8/12 7:00', '2009/8/12 8:00', '2009/8/12 9:00', '2009/8/12 10:00', '2009/8/12 11:00', '2009/8/12 12:00', '2009/8/12 13:00', '2009/8/12 14:00', '2009/8/12 15:00', '2009/8/12 16:00', '2009/8/12 17:00', '2009/8/12 18:00', '2009/8/12 19:00', '2009/8/12 20:00', '2009/8/12 21:00', '2009/8/12 22:00', '2009/8/12 23:00', '2009/8/13 0:00', '2009/8/13 1:00', '2009/8/13 2:00', '2009/8/13 3:00', '2009/8/13 4:00', '2009/8/13 5:00', '2009/8/13 6:00', '2009/8/13 7:00', '2009/8/13 8:00', '2009/8/13 9:00', '2009/8/13 10:00', '2009/8/13 11:00', '2009/8/13 12:00', '2009/8/13 13:00', '2009/8/13 14:00', '2009/8/13 15:00', '2009/8/13 16:00', '2009/8/13 17:00', '2009/8/13 18:00', '2009/8/13 19:00', '2009/8/13 20:00', '2009/8/13 21:00', '2009/8/13 22:00', '2009/8/13 23:00', '2009/8/14 0:00', '2009/8/14 1:00', '2009/8/14 2:00', '2009/8/14 3:00', '2009/8/14 4:00', '2009/8/14 5:00', '2009/8/14 6:00', '2009/8/14 7:00', '2009/8/14 8:00', '2009/8/14 9:00', '2009/8/14 10:00', '2009/8/14 11:00', '2009/8/14 12:00', '2009/8/14 13:00', '2009/8/14 14:00', '2009/8/14 15:00', '2009/8/14 16:00', '2009/8/14 17:00', '2009/8/14 18:00', '2009/8/14 19:00', '2009/8/14 20:00', '2009/8/14 21:00', '2009/8/14 22:00', '2009/8/14 23:00', '2009/8/15 0:00', '2009/8/15 1:00', '2009/8/15 2:00', '2009/8/15 3:00', '2009/8/15 4:00', '2009/8/15 5:00', '2009/8/15 6:00', '2009/8/15 7:00', '2009/8/15 8:00', '2009/8/15 9:00', '2009/8/15 10:00', '2009/8/15 11:00', '2009/8/15 12:00', '2009/8/15 13:00', '2009/8/15 14:00', '2009/8/15 15:00', '2009/8/15 16:00', '2009/8/15 17:00', '2009/8/15 18:00', '2009/8/15 19:00', '2009/8/15 20:00', '2009/8/15 21:00', '2009/8/15 22:00', '2009/8/15 23:00', '2009/8/16 0:00', '2009/8/16 1:00', '2009/8/16 2:00', '2009/8/16 3:00', '2009/8/16 4:00', '2009/8/16 5:00', '2009/8/16 6:00', '2009/8/16 7:00', '2009/8/16 8:00', '2009/8/16 9:00', '2009/8/16 10:00', '2009/8/16 11:00', '2009/8/16 12:00', '2009/8/16 13:00', '2009/8/16 14:00', '2009/8/16 15:00', '2009/8/16 16:00', '2009/8/16 17:00', '2009/8/16 18:00', '2009/8/16 19:00', '2009/8/16 20:00', '2009/8/16 21:00', '2009/8/16 22:00', '2009/8/16 23:00', '2009/8/17 0:00', '2009/8/17 1:00', '2009/8/17 2:00', '2009/8/17 3:00', '2009/8/17 4:00', '2009/8/17 5:00', '2009/8/17 6:00', '2009/8/17 7:00', '2009/8/17 8:00', '2009/8/17 9:00', '2009/8/17 10:00', '2009/8/17 11:00', '2009/8/17 12:00', '2009/8/17 13:00', '2009/8/17 14:00', '2009/8/17 15:00', '2009/8/17 16:00', '2009/8/17 17:00', '2009/8/17 18:00', '2009/8/17 19:00', '2009/8/17 20:00', '2009/8/17 21:00', '2009/8/17 22:00', '2009/8/17 23:00', '2009/8/18 0:00', '2009/8/18 1:00', '2009/8/18 2:00', '2009/8/18 3:00', '2009/8/18 4:00', '2009/8/18 5:00', '2009/8/18 6:00', '2009/8/18 7:00', '2009/8/18 8:00', '2009/8/18 9:00', '2009/8/18 10:00', '2009/8/18 11:00', '2009/8/18 12:00', '2009/8/18 13:00', '2009/8/18 14:00', '2009/8/18 15:00', '2009/8/18 16:00', '2009/8/18 17:00', '2009/8/18 18:00', '2009/8/18 19:00', '2009/8/18 20:00', '2009/8/18 21:00', '2009/8/18 22:00', '2009/8/18 23:00', '2009/8/19 0:00', '2009/8/19 1:00', '2009/8/19 2:00', '2009/8/19 3:00', '2009/8/19 4:00', '2009/8/19 5:00', '2009/8/19 6:00', '2009/8/19 7:00', '2009/8/19 8:00', '2009/8/19 9:00', '2009/8/19 10:00', '2009/8/19 11:00', '2009/8/19 12:00', '2009/8/19 13:00', '2009/8/19 14:00', '2009/8/19 15:00', '2009/8/19 16:00', '2009/8/19 17:00', '2009/8/19 18:00', '2009/8/19 19:00', '2009/8/19 20:00', '2009/8/19 21:00', '2009/8/19 22:00', '2009/8/19 23:00', '2009/8/20 0:00', '2009/8/20 1:00', '2009/8/20 2:00', '2009/8/20 3:00', '2009/8/20 4:00', '2009/8/20 5:00', '2009/8/20 6:00', '2009/8/20 7:00', '2009/8/20 8:00', '2009/8/20 9:00', '2009/8/20 10:00', '2009/8/20 11:00', '2009/8/20 12:00', '2009/8/20 13:00', '2009/8/20 14:00', '2009/8/20 15:00', '2009/8/20 16:00', '2009/8/20 17:00', '2009/8/20 18:00', '2009/8/20 19:00', '2009/8/20 20:00', '2009/8/20 21:00', '2009/8/20 22:00', '2009/8/20 23:00', '2009/8/21 0:00', '2009/8/21 1:00', '2009/8/21 2:00', '2009/8/21 3:00', '2009/8/21 4:00', '2009/8/21 5:00', '2009/8/21 6:00', '2009/8/21 7:00', '2009/8/21 8:00', '2009/8/21 9:00', '2009/8/21 10:00', '2009/8/21 11:00', '2009/8/21 12:00', '2009/8/21 13:00', '2009/8/21 14:00', '2009/8/21 15:00', '2009/8/21 16:00', '2009/8/21 17:00', '2009/8/21 18:00', '2009/8/21 19:00', '2009/8/21 20:00', '2009/8/21 21:00', '2009/8/21 22:00', '2009/8/21 23:00', '2009/8/22 0:00', '2009/8/22 1:00', '2009/8/22 2:00', '2009/8/22 3:00', '2009/8/22 4:00', '2009/8/22 5:00', '2009/8/22 6:00', '2009/8/22 7:00', '2009/8/22 8:00', '2009/8/22 9:00', '2009/8/22 10:00', '2009/8/22 11:00', '2009/8/22 12:00', '2009/8/22 13:00', '2009/8/22 14:00', '2009/8/22 15:00', '2009/8/22 16:00', '2009/8/22 17:00', '2009/8/22 18:00', '2009/8/22 19:00', '2009/8/22 20:00', '2009/8/22 21:00', '2009/8/22 22:00', '2009/8/22 23:00', '2009/8/23 0:00', '2009/8/23 1:00', '2009/8/23 2:00', '2009/8/23 3:00', '2009/8/23 4:00', '2009/8/23 5:00', '2009/8/23 6:00', '2009/8/23 7:00', '2009/8/23 8:00', '2009/8/23 9:00', '2009/8/23 10:00', '2009/8/23 11:00', '2009/8/23 12:00', '2009/8/23 13:00', '2009/8/23 14:00', '2009/8/23 15:00', '2009/8/23 16:00', '2009/8/23 17:00', '2009/8/23 18:00', '2009/8/23 19:00', '2009/8/23 20:00', '2009/8/23 21:00', '2009/8/23 22:00', '2009/8/23 23:00', '2009/8/24 0:00', '2009/8/24 1:00', '2009/8/24 2:00', '2009/8/24 3:00', '2009/8/24 4:00', '2009/8/24 5:00', '2009/8/24 6:00', '2009/8/24 7:00', '2009/8/24 8:00', '2009/8/24 9:00', '2009/8/24 10:00', '2009/8/24 11:00', '2009/8/24 12:00', '2009/8/24 13:00', '2009/8/24 14:00', '2009/8/24 15:00', '2009/8/24 16:00', '2009/8/24 17:00', '2009/8/24 18:00', '2009/8/24 19:00', '2009/8/24 20:00', '2009/8/24 21:00', '2009/8/24 22:00', '2009/8/24 23:00', '2009/8/25 0:00', '2009/8/25 1:00', '2009/8/25 2:00', '2009/8/25 3:00', '2009/8/25 4:00', '2009/8/25 5:00', '2009/8/25 6:00', '2009/8/25 7:00', '2009/8/25 8:00', '2009/8/25 9:00', '2009/8/25 10:00', '2009/8/25 11:00', '2009/8/25 12:00', '2009/8/25 13:00', '2009/8/25 14:00', '2009/8/25 15:00', '2009/8/25 16:00', '2009/8/25 17:00', '2009/8/25 18:00', '2009/8/25 19:00', '2009/8/25 20:00', '2009/8/25 21:00', '2009/8/25 22:00', '2009/8/25 23:00', '2009/8/26 0:00', '2009/8/26 1:00', '2009/8/26 2:00', '2009/8/26 3:00', '2009/8/26 4:00', '2009/8/26 5:00', '2009/8/26 6:00', '2009/8/26 7:00', '2009/8/26 8:00', '2009/8/26 9:00', '2009/8/26 10:00', '2009/8/26 11:00', '2009/8/26 12:00', '2009/8/26 13:00', '2009/8/26 14:00', '2009/8/26 15:00', '2009/8/26 16:00', '2009/8/26 17:00', '2009/8/26 18:00', '2009/8/26 19:00', '2009/8/26 20:00', '2009/8/26 21:00', '2009/8/26 22:00', '2009/8/26 23:00', '2009/8/27 0:00', '2009/8/27 1:00', '2009/8/27 2:00', '2009/8/27 3:00', '2009/8/27 4:00', '2009/8/27 5:00', '2009/8/27 6:00', '2009/8/27 7:00', '2009/8/27 8:00', '2009/8/27 9:00', '2009/8/27 10:00', '2009/8/27 11:00', '2009/8/27 12:00', '2009/8/27 13:00', '2009/8/27 14:00', '2009/8/27 15:00', '2009/8/27 16:00', '2009/8/27 17:00', '2009/8/27 18:00', '2009/8/27 19:00', '2009/8/27 20:00', '2009/8/27 21:00', '2009/8/27 22:00', '2009/8/27 23:00', '2009/8/28 0:00', '2009/8/28 1:00', '2009/8/28 2:00', '2009/8/28 3:00', '2009/8/28 4:00', '2009/8/28 5:00', '2009/8/28 6:00', '2009/8/28 7:00', '2009/8/28 8:00', '2009/8/28 9:00', '2009/8/28 10:00', '2009/8/28 11:00', '2009/8/28 12:00', '2009/8/28 13:00', '2009/8/28 14:00', '2009/8/28 15:00', '2009/8/28 16:00', '2009/8/28 17:00', '2009/8/28 18:00', '2009/8/28 19:00', '2009/8/28 20:00', '2009/8/28 21:00', '2009/8/28 22:00', '2009/8/28 23:00', '2009/8/29 0:00', '2009/8/29 1:00', '2009/8/29 2:00', '2009/8/29 3:00', '2009/8/29 4:00', '2009/8/29 5:00', '2009/8/29 6:00', '2009/8/29 7:00', '2009/8/29 8:00', '2009/8/29 9:00', '2009/8/29 10:00', '2009/8/29 11:00', '2009/8/29 12:00', '2009/8/29 13:00', '2009/8/29 14:00', '2009/8/29 15:00', '2009/8/29 16:00', '2009/8/29 17:00', '2009/8/29 18:00', '2009/8/29 19:00', '2009/8/29 20:00', '2009/8/29 21:00', '2009/8/29 22:00', '2009/8/29 23:00', '2009/8/30 0:00', '2009/8/30 1:00', '2009/8/30 2:00', '2009/8/30 3:00', '2009/8/30 4:00', '2009/8/30 5:00', '2009/8/30 6:00', '2009/8/30 7:00', '2009/8/30 8:00', '2009/8/30 9:00', '2009/8/30 10:00', '2009/8/30 11:00', '2009/8/30 12:00', '2009/8/30 13:00', '2009/8/30 14:00', '2009/8/30 15:00', '2009/8/30 16:00', '2009/8/30 17:00', '2009/8/30 18:00', '2009/8/30 19:00', '2009/8/30 20:00', '2009/8/30 21:00', '2009/8/30 22:00', '2009/8/30 23:00', '2009/8/31 0:00', '2009/8/31 1:00', '2009/8/31 2:00', '2009/8/31 3:00', '2009/8/31 4:00', '2009/8/31 5:00', '2009/8/31 6:00', '2009/8/31 7:00', '2009/8/31 8:00', '2009/8/31 9:00', '2009/8/31 10:00', '2009/8/31 11:00', '2009/8/31 12:00', '2009/8/31 13:00', '2009/8/31 14:00', '2009/8/31 15:00', '2009/8/31 16:00', '2009/8/31 17:00', '2009/8/31 18:00', '2009/8/31 19:00', '2009/8/31 20:00', '2009/8/31 21:00', '2009/8/31 22:00', '2009/8/31 23:00',                '2009/9/1 0:00', '2009/9/1 1:00', '2009/9/1 2:00', '2009/9/1 3:00', '2009/9/1 4:00', '2009/9/1 5:00', '2009/9/1 6:00', '2009/9/1 7:00', '2009/9/1 8:00', '2009/9/1 9:00', '2009/9/1 10:00', '2009/9/1 11:00', '2009/9/1 12:00', '2009/9/1 13:00', '2009/9/1 14:00', '2009/9/1 15:00', '2009/9/1 16:00', '2009/9/1 17:00', '2009/9/1 18:00', '2009/9/1 19:00', '2009/9/1 20:00', '2009/9/1 21:00', '2009/9/1 22:00', '2009/9/1 23:00', '2009/9/2 0:00', '2009/9/2 1:00', '2009/9/2 2:00', '2009/9/2 3:00', '2009/9/2 4:00', '2009/9/2 5:00', '2009/9/2 6:00', '2009/9/2 7:00', '2009/9/2 8:00', '2009/9/2 9:00', '2009/9/2 10:00', '2009/9/2 11:00', '2009/9/2 12:00', '2009/9/2 13:00', '2009/9/2 14:00', '2009/9/2 15:00', '2009/9/2 16:00', '2009/9/2 17:00', '2009/9/2 18:00', '2009/9/2 19:00', '2009/9/2 20:00', '2009/9/2 21:00', '2009/9/2 22:00', '2009/9/2 23:00', '2009/9/3 0:00', '2009/9/3 1:00', '2009/9/3 2:00', '2009/9/3 3:00', '2009/9/3 4:00', '2009/9/3 5:00', '2009/9/3 6:00', '2009/9/3 7:00', '2009/9/3 8:00', '2009/9/3 9:00', '2009/9/3 10:00', '2009/9/3 11:00', '2009/9/3 12:00', '2009/9/3 13:00', '2009/9/3 14:00', '2009/9/3 15:00', '2009/9/3 16:00', '2009/9/3 17:00', '2009/9/3 18:00', '2009/9/3 19:00', '2009/9/3 20:00', '2009/9/3 21:00', '2009/9/3 22:00', '2009/9/3 23:00', '2009/9/4 0:00', '2009/9/4 1:00', '2009/9/4 2:00', '2009/9/4 3:00', '2009/9/4 4:00', '2009/9/4 5:00', '2009/9/4 6:00', '2009/9/4 7:00', '2009/9/4 8:00', '2009/9/4 9:00', '2009/9/4 10:00', '2009/9/4 11:00', '2009/9/4 12:00', '2009/9/4 13:00', '2009/9/4 14:00', '2009/9/4 15:00', '2009/9/4 16:00', '2009/9/4 17:00', '2009/9/4 18:00', '2009/9/4 19:00', '2009/9/4 20:00', '2009/9/4 21:00', '2009/9/4 22:00', '2009/9/4 23:00', '2009/9/5 0:00', '2009/9/5 1:00', '2009/9/5 2:00', '2009/9/5 3:00', '2009/9/5 4:00', '2009/9/5 5:00', '2009/9/5 6:00', '2009/9/5 7:00', '2009/9/5 8:00', '2009/9/5 9:00', '2009/9/5 10:00', '2009/9/5 11:00', '2009/9/5 12:00', '2009/9/5 13:00', '2009/9/5 14:00', '2009/9/5 15:00', '2009/9/5 16:00', '2009/9/5 17:00', '2009/9/5 18:00', '2009/9/5 19:00', '2009/9/5 20:00', '2009/9/5 21:00', '2009/9/5 22:00', '2009/9/5 23:00', '2009/9/6 0:00', '2009/9/6 1:00', '2009/9/6 2:00', '2009/9/6 3:00', '2009/9/6 4:00', '2009/9/6 5:00', '2009/9/6 6:00', '2009/9/6 7:00', '2009/9/6 8:00', '2009/9/6 9:00', '2009/9/6 10:00', '2009/9/6 11:00', '2009/9/6 12:00', '2009/9/6 13:00', '2009/9/6 14:00', '2009/9/6 15:00', '2009/9/6 16:00', '2009/9/6 17:00', '2009/9/6 18:00', '2009/9/6 19:00', '2009/9/6 20:00', '2009/9/6 21:00', '2009/9/6 22:00', '2009/9/6 23:00', '2009/9/7 0:00', '2009/9/7 1:00', '2009/9/7 2:00', '2009/9/7 3:00', '2009/9/7 4:00', '2009/9/7 5:00', '2009/9/7 6:00', '2009/9/7 7:00', '2009/9/7 8:00', '2009/9/7 9:00', '2009/9/7 10:00', '2009/9/7 11:00', '2009/9/7 12:00', '2009/9/7 13:00', '2009/9/7 14:00', '2009/9/7 15:00', '2009/9/7 16:00', '2009/9/7 17:00', '2009/9/7 18:00', '2009/9/7 19:00', '2009/9/7 20:00', '2009/9/7 21:00', '2009/9/7 22:00', '2009/9/7 23:00', '2009/9/8 0:00', '2009/9/8 1:00', '2009/9/8 2:00', '2009/9/8 3:00', '2009/9/8 4:00', '2009/9/8 5:00', '2009/9/8 6:00', '2009/9/8 7:00', '2009/9/8 8:00', '2009/9/8 9:00', '2009/9/8 10:00', '2009/9/8 11:00', '2009/9/8 12:00', '2009/9/8 13:00', '2009/9/8 14:00', '2009/9/8 15:00', '2009/9/8 16:00', '2009/9/8 17:00', '2009/9/8 18:00', '2009/9/8 19:00', '2009/9/8 20:00', '2009/9/8 21:00', '2009/9/8 22:00', '2009/9/8 23:00', '2009/9/9 0:00', '2009/9/9 1:00', '2009/9/9 2:00', '2009/9/9 3:00', '2009/9/9 4:00', '2009/9/9 5:00', '2009/9/9 6:00', '2009/9/9 7:00', '2009/9/9 8:00', '2009/9/9 9:00', '2009/9/9 10:00', '2009/9/9 11:00', '2009/9/9 12:00', '2009/9/9 13:00', '2009/9/9 14:00', '2009/9/9 15:00', '2009/9/9 16:00', '2009/9/9 17:00', '2009/9/9 18:00', '2009/9/9 19:00', '2009/9/9 20:00', '2009/9/9 21:00', '2009/9/9 22:00', '2009/9/9 23:00', '2009/9/10 0:00', '2009/9/10 1:00', '2009/9/10 2:00', '2009/9/10 3:00', '2009/9/10 4:00', '2009/9/10 5:00', '2009/9/10 6:00', '2009/9/10 7:00', '2009/9/10 8:00', '2009/9/10 9:00', '2009/9/10 10:00', '2009/9/10 11:00', '2009/9/10 12:00', '2009/9/10 13:00', '2009/9/10 14:00', '2009/9/10 15:00', '2009/9/10 16:00', '2009/9/10 17:00', '2009/9/10 18:00', '2009/9/10 19:00', '2009/9/10 20:00', '2009/9/10 21:00', '2009/9/10 22:00', '2009/9/10 23:00', '2009/9/11 0:00', '2009/9/11 1:00', '2009/9/11 2:00', '2009/9/11 3:00', '2009/9/11 4:00', '2009/9/11 5:00', '2009/9/11 6:00', '2009/9/11 7:00', '2009/9/11 8:00', '2009/9/11 9:00', '2009/9/11 10:00', '2009/9/11 11:00', '2009/9/11 12:00', '2009/9/11 13:00', '2009/9/11 14:00', '2009/9/11 15:00', '2009/9/11 16:00', '2009/9/11 17:00', '2009/9/11 18:00', '2009/9/11 19:00', '2009/9/11 20:00', '2009/9/11 21:00', '2009/9/11 22:00', '2009/9/11 23:00', '2009/9/12 0:00', '2009/9/12 1:00', '2009/9/12 2:00', '2009/9/12 3:00', '2009/9/12 4:00', '2009/9/12 5:00', '2009/9/12 6:00', '2009/9/12 7:00', '2009/9/12 8:00', '2009/9/12 9:00', '2009/9/12 10:00', '2009/9/12 11:00', '2009/9/12 12:00', '2009/9/12 13:00', '2009/9/12 14:00', '2009/9/12 15:00', '2009/9/12 16:00', '2009/9/12 17:00', '2009/9/12 18:00', '2009/9/12 19:00', '2009/9/12 20:00', '2009/9/12 21:00', '2009/9/12 22:00', '2009/9/12 23:00', '2009/9/13 0:00', '2009/9/13 1:00', '2009/9/13 2:00', '2009/9/13 3:00', '2009/9/13 4:00', '2009/9/13 5:00', '2009/9/13 6:00', '2009/9/13 7:00', '2009/9/13 8:00', '2009/9/13 9:00', '2009/9/13 10:00', '2009/9/13 11:00', '2009/9/13 12:00', '2009/9/13 13:00', '2009/9/13 14:00', '2009/9/13 15:00', '2009/9/13 16:00', '2009/9/13 17:00', '2009/9/13 18:00', '2009/9/13 19:00', '2009/9/13 20:00', '2009/9/13 21:00', '2009/9/13 22:00', '2009/9/13 23:00', '2009/9/14 0:00', '2009/9/14 1:00', '2009/9/14 2:00', '2009/9/14 3:00', '2009/9/14 4:00', '2009/9/14 5:00', '2009/9/14 6:00', '2009/9/14 7:00', '2009/9/14 8:00', '2009/9/14 9:00', '2009/9/14 10:00', '2009/9/14 11:00', '2009/9/14 12:00', '2009/9/14 13:00', '2009/9/14 14:00', '2009/9/14 15:00', '2009/9/14 16:00', '2009/9/14 17:00', '2009/9/14 18:00', '2009/9/14 19:00', '2009/9/14 20:00', '2009/9/14 21:00', '2009/9/14 22:00', '2009/9/14 23:00', '2009/9/15 0:00', '2009/9/15 1:00', '2009/9/15 2:00', '2009/9/15 3:00', '2009/9/15 4:00', '2009/9/15 5:00', '2009/9/15 6:00', '2009/9/15 7:00', '2009/9/15 8:00', '2009/9/15 9:00', '2009/9/15 10:00', '2009/9/15 11:00', '2009/9/15 12:00', '2009/9/15 13:00', '2009/9/15 14:00', '2009/9/15 15:00', '2009/9/15 16:00', '2009/9/15 17:00', '2009/9/15 18:00', '2009/9/15 19:00', '2009/9/15 20:00', '2009/9/15 21:00', '2009/9/15 22:00', '2009/9/15 23:00', '2009/9/16 0:00', '2009/9/16 1:00', '2009/9/16 2:00', '2009/9/16 3:00', '2009/9/16 4:00', '2009/9/16 5:00', '2009/9/16 6:00', '2009/9/16 7:00', '2009/9/16 8:00', '2009/9/16 9:00', '2009/9/16 10:00', '2009/9/16 11:00', '2009/9/16 12:00', '2009/9/16 13:00', '2009/9/16 14:00', '2009/9/16 15:00', '2009/9/16 16:00', '2009/9/16 17:00', '2009/9/16 18:00', '2009/9/16 19:00', '2009/9/16 20:00', '2009/9/16 21:00', '2009/9/16 22:00', '2009/9/16 23:00', '2009/9/17 0:00', '2009/9/17 1:00', '2009/9/17 2:00', '2009/9/17 3:00', '2009/9/17 4:00', '2009/9/17 5:00', '2009/9/17 6:00', '2009/9/17 7:00', '2009/9/17 8:00', '2009/9/17 9:00', '2009/9/17 10:00', '2009/9/17 11:00', '2009/9/17 12:00', '2009/9/17 13:00', '2009/9/17 14:00', '2009/9/17 15:00', '2009/9/17 16:00', '2009/9/17 17:00', '2009/9/17 18:00', '2009/9/17 19:00', '2009/9/17 20:00', '2009/9/17 21:00', '2009/9/17 22:00', '2009/9/17 23:00', '2009/9/18 0:00', '2009/9/18 1:00', '2009/9/18 2:00', '2009/9/18 3:00', '2009/9/18 4:00', '2009/9/18 5:00', '2009/9/18 6:00', '2009/9/18 7:00', '2009/9/18 8:00', '2009/9/18 9:00', '2009/9/18 10:00', '2009/9/18 11:00', '2009/9/18 12:00', '2009/9/18 13:00', '2009/9/18 14:00', '2009/9/18 15:00', '2009/9/18 16:00', '2009/9/18 17:00', '2009/9/18 18:00', '2009/9/18 19:00', '2009/9/18 20:00', '2009/9/18 21:00', '2009/9/18 22:00', '2009/9/18 23:00', '2009/9/19 0:00', '2009/9/19 1:00', '2009/9/19 2:00', '2009/9/19 3:00', '2009/9/19 4:00', '2009/9/19 5:00', '2009/9/19 6:00', '2009/9/19 7:00', '2009/9/19 8:00', '2009/9/19 9:00', '2009/9/19 10:00', '2009/9/19 11:00', '2009/9/19 12:00', '2009/9/19 13:00', '2009/9/19 14:00', '2009/9/19 15:00', '2009/9/19 16:00', '2009/9/19 17:00', '2009/9/19 18:00', '2009/9/19 19:00', '2009/9/19 20:00', '2009/9/19 21:00', '2009/9/19 22:00', '2009/9/19 23:00', '2009/9/20 0:00', '2009/9/20 1:00', '2009/9/20 2:00', '2009/9/20 3:00', '2009/9/20 4:00', '2009/9/20 5:00', '2009/9/20 6:00', '2009/9/20 7:00', '2009/9/20 8:00', '2009/9/20 9:00', '2009/9/20 10:00', '2009/9/20 11:00', '2009/9/20 12:00', '2009/9/20 13:00', '2009/9/20 14:00', '2009/9/20 15:00', '2009/9/20 16:00', '2009/9/20 17:00', '2009/9/20 18:00', '2009/9/20 19:00', '2009/9/20 20:00', '2009/9/20 21:00', '2009/9/20 22:00', '2009/9/20 23:00', '2009/9/21 0:00', '2009/9/21 1:00', '2009/9/21 2:00', '2009/9/21 3:00', '2009/9/21 4:00', '2009/9/21 5:00', '2009/9/21 6:00', '2009/9/21 7:00', '2009/9/21 8:00', '2009/9/21 9:00', '2009/9/21 10:00', '2009/9/21 11:00', '2009/9/21 12:00', '2009/9/21 13:00', '2009/9/21 14:00', '2009/9/21 15:00', '2009/9/21 16:00', '2009/9/21 17:00', '2009/9/21 18:00', '2009/9/21 19:00', '2009/9/21 20:00', '2009/9/21 21:00', '2009/9/21 22:00', '2009/9/21 23:00', '2009/9/22 0:00', '2009/9/22 1:00', '2009/9/22 2:00', '2009/9/22 3:00', '2009/9/22 4:00', '2009/9/22 5:00', '2009/9/22 6:00', '2009/9/22 7:00', '2009/9/22 8:00', '2009/9/22 9:00', '2009/9/22 10:00', '2009/9/22 11:00', '2009/9/22 12:00', '2009/9/22 13:00', '2009/9/22 14:00', '2009/9/22 15:00', '2009/9/22 16:00', '2009/9/22 17:00', '2009/9/22 18:00', '2009/9/22 19:00', '2009/9/22 20:00', '2009/9/22 21:00', '2009/9/22 22:00', '2009/9/22 23:00', '2009/9/23 0:00', '2009/9/23 1:00', '2009/9/23 2:00', '2009/9/23 3:00', '2009/9/23 4:00', '2009/9/23 5:00', '2009/9/23 6:00', '2009/9/23 7:00', '2009/9/23 8:00', '2009/9/23 9:00', '2009/9/23 10:00', '2009/9/23 11:00', '2009/9/23 12:00', '2009/9/23 13:00', '2009/9/23 14:00', '2009/9/23 15:00', '2009/9/23 16:00', '2009/9/23 17:00', '2009/9/23 18:00', '2009/9/23 19:00', '2009/9/23 20:00', '2009/9/23 21:00', '2009/9/23 22:00', '2009/9/23 23:00', '2009/9/24 0:00', '2009/9/24 1:00', '2009/9/24 2:00', '2009/9/24 3:00', '2009/9/24 4:00', '2009/9/24 5:00', '2009/9/24 6:00', '2009/9/24 7:00', '2009/9/24 8:00', '2009/9/24 9:00', '2009/9/24 10:00', '2009/9/24 11:00', '2009/9/24 12:00', '2009/9/24 13:00', '2009/9/24 14:00', '2009/9/24 15:00', '2009/9/24 16:00', '2009/9/24 17:00', '2009/9/24 18:00', '2009/9/24 19:00', '2009/9/24 20:00', '2009/9/24 21:00', '2009/9/24 22:00', '2009/9/24 23:00', '2009/9/25 0:00', '2009/9/25 1:00', '2009/9/25 2:00', '2009/9/25 3:00', '2009/9/25 4:00', '2009/9/25 5:00', '2009/9/25 6:00', '2009/9/25 7:00', '2009/9/25 8:00', '2009/9/25 9:00', '2009/9/25 10:00', '2009/9/25 11:00', '2009/9/25 12:00', '2009/9/25 13:00', '2009/9/25 14:00', '2009/9/25 15:00', '2009/9/25 16:00', '2009/9/25 17:00', '2009/9/25 18:00', '2009/9/25 19:00', '2009/9/25 20:00', '2009/9/25 21:00', '2009/9/25 22:00', '2009/9/25 23:00', '2009/9/26 0:00', '2009/9/26 1:00', '2009/9/26 2:00', '2009/9/26 3:00', '2009/9/26 4:00', '2009/9/26 5:00', '2009/9/26 6:00', '2009/9/26 7:00', '2009/9/26 8:00', '2009/9/26 9:00', '2009/9/26 10:00', '2009/9/26 11:00', '2009/9/26 12:00', '2009/9/26 13:00', '2009/9/26 14:00', '2009/9/26 15:00', '2009/9/26 16:00', '2009/9/26 17:00', '2009/9/26 18:00', '2009/9/26 19:00', '2009/9/26 20:00', '2009/9/26 21:00', '2009/9/26 22:00', '2009/9/26 23:00', '2009/9/27 0:00', '2009/9/27 1:00', '2009/9/27 2:00', '2009/9/27 3:00', '2009/9/27 4:00', '2009/9/27 5:00', '2009/9/27 6:00', '2009/9/27 7:00', '2009/9/27 8:00', '2009/9/27 9:00', '2009/9/27 10:00', '2009/9/27 11:00', '2009/9/27 12:00', '2009/9/27 13:00', '2009/9/27 14:00', '2009/9/27 15:00', '2009/9/27 16:00', '2009/9/27 17:00', '2009/9/27 18:00', '2009/9/27 19:00', '2009/9/27 20:00', '2009/9/27 21:00', '2009/9/27 22:00', '2009/9/27 23:00', '2009/9/28 0:00', '2009/9/28 1:00', '2009/9/28 2:00', '2009/9/28 3:00', '2009/9/28 4:00', '2009/9/28 5:00', '2009/9/28 6:00', '2009/9/28 7:00', '2009/9/28 8:00', '2009/9/28 9:00', '2009/9/28 10:00', '2009/9/28 11:00', '2009/9/28 12:00', '2009/9/28 13:00', '2009/9/28 14:00', '2009/9/28 15:00', '2009/9/28 16:00', '2009/9/28 17:00', '2009/9/28 18:00', '2009/9/28 19:00', '2009/9/28 20:00', '2009/9/28 21:00', '2009/9/28 22:00', '2009/9/28 23:00', '2009/9/29 0:00', '2009/9/29 1:00', '2009/9/29 2:00', '2009/9/29 3:00', '2009/9/29 4:00', '2009/9/29 5:00', '2009/9/29 6:00', '2009/9/29 7:00', '2009/9/29 8:00', '2009/9/29 9:00', '2009/9/29 10:00', '2009/9/29 11:00', '2009/9/29 12:00', '2009/9/29 13:00', '2009/9/29 14:00', '2009/9/29 15:00', '2009/9/29 16:00', '2009/9/29 17:00', '2009/9/29 18:00', '2009/9/29 19:00', '2009/9/29 20:00', '2009/9/29 21:00', '2009/9/29 22:00', '2009/9/29 23:00', '2009/9/30 0:00', '2009/9/30 1:00', '2009/9/30 2:00', '2009/9/30 3:00', '2009/9/30 4:00', '2009/9/30 5:00', '2009/9/30 6:00', '2009/9/30 7:00', '2009/9/30 8:00', '2009/9/30 9:00', '2009/9/30 10:00', '2009/9/30 11:00', '2009/9/30 12:00', '2009/9/30 13:00', '2009/9/30 14:00', '2009/9/30 15:00', '2009/9/30 16:00', '2009/9/30 17:00', '2009/9/30 18:00', '2009/9/30 19:00', '2009/9/30 20:00', '2009/9/30 21:00', '2009/9/30 22:00', '2009/9/30 23:00',                '2009/10/1 0:00', '2009/10/1 1:00', '2009/10/1 2:00', '2009/10/1 3:00', '2009/10/1 4:00', '2009/10/1 5:00', '2009/10/1 6:00', '2009/10/1 7:00', '2009/10/1 8:00', '2009/10/1 9:00', '2009/10/1 10:00', '2009/10/1 11:00', '2009/10/1 12:00', '2009/10/1 13:00', '2009/10/1 14:00', '2009/10/1 15:00', '2009/10/1 16:00', '2009/10/1 17:00', '2009/10/1 18:00', '2009/10/1 19:00', '2009/10/1 20:00', '2009/10/1 21:00', '2009/10/1 22:00', '2009/10/1 23:00', '2009/10/2 0:00', '2009/10/2 1:00', '2009/10/2 2:00', '2009/10/2 3:00', '2009/10/2 4:00', '2009/10/2 5:00', '2009/10/2 6:00', '2009/10/2 7:00', '2009/10/2 8:00', '2009/10/2 9:00', '2009/10/2 10:00', '2009/10/2 11:00', '2009/10/2 12:00', '2009/10/2 13:00', '2009/10/2 14:00', '2009/10/2 15:00', '2009/10/2 16:00', '2009/10/2 17:00', '2009/10/2 18:00', '2009/10/2 19:00', '2009/10/2 20:00', '2009/10/2 21:00', '2009/10/2 22:00', '2009/10/2 23:00', '2009/10/3 0:00', '2009/10/3 1:00', '2009/10/3 2:00', '2009/10/3 3:00', '2009/10/3 4:00', '2009/10/3 5:00', '2009/10/3 6:00', '2009/10/3 7:00', '2009/10/3 8:00', '2009/10/3 9:00', '2009/10/3 10:00', '2009/10/3 11:00', '2009/10/3 12:00', '2009/10/3 13:00', '2009/10/3 14:00', '2009/10/3 15:00', '2009/10/3 16:00', '2009/10/3 17:00', '2009/10/3 18:00', '2009/10/3 19:00', '2009/10/3 20:00', '2009/10/3 21:00', '2009/10/3 22:00', '2009/10/3 23:00', '2009/10/4 0:00', '2009/10/4 1:00', '2009/10/4 2:00', '2009/10/4 3:00', '2009/10/4 4:00', '2009/10/4 5:00', '2009/10/4 6:00', '2009/10/4 7:00', '2009/10/4 8:00', '2009/10/4 9:00', '2009/10/4 10:00', '2009/10/4 11:00', '2009/10/4 12:00', '2009/10/4 13:00', '2009/10/4 14:00', '2009/10/4 15:00', '2009/10/4 16:00', '2009/10/4 17:00', '2009/10/4 18:00', '2009/10/4 19:00', '2009/10/4 20:00', '2009/10/4 21:00', '2009/10/4 22:00', '2009/10/4 23:00', '2009/10/5 0:00', '2009/10/5 1:00', '2009/10/5 2:00', '2009/10/5 3:00', '2009/10/5 4:00', '2009/10/5 5:00', '2009/10/5 6:00', '2009/10/5 7:00', '2009/10/5 8:00', '2009/10/5 9:00', '2009/10/5 10:00', '2009/10/5 11:00', '2009/10/5 12:00', '2009/10/5 13:00', '2009/10/5 14:00', '2009/10/5 15:00', '2009/10/5 16:00', '2009/10/5 17:00', '2009/10/5 18:00', '2009/10/5 19:00', '2009/10/5 20:00', '2009/10/5 21:00', '2009/10/5 22:00', '2009/10/5 23:00', '2009/10/6 0:00', '2009/10/6 1:00', '2009/10/6 2:00', '2009/10/6 3:00', '2009/10/6 4:00', '2009/10/6 5:00', '2009/10/6 6:00', '2009/10/6 7:00', '2009/10/6 8:00', '2009/10/6 9:00', '2009/10/6 10:00', '2009/10/6 11:00', '2009/10/6 12:00', '2009/10/6 13:00', '2009/10/6 14:00', '2009/10/6 15:00', '2009/10/6 16:00', '2009/10/6 17:00', '2009/10/6 18:00', '2009/10/6 19:00', '2009/10/6 20:00', '2009/10/6 21:00', '2009/10/6 22:00', '2009/10/6 23:00', '2009/10/7 0:00', '2009/10/7 1:00', '2009/10/7 2:00', '2009/10/7 3:00', '2009/10/7 4:00', '2009/10/7 5:00', '2009/10/7 6:00', '2009/10/7 7:00', '2009/10/7 8:00', '2009/10/7 9:00', '2009/10/7 10:00', '2009/10/7 11:00', '2009/10/7 12:00', '2009/10/7 13:00', '2009/10/7 14:00', '2009/10/7 15:00', '2009/10/7 16:00', '2009/10/7 17:00', '2009/10/7 18:00', '2009/10/7 19:00', '2009/10/7 20:00', '2009/10/7 21:00', '2009/10/7 22:00', '2009/10/7 23:00', '2009/10/8 0:00', '2009/10/8 1:00', '2009/10/8 2:00', '2009/10/8 3:00', '2009/10/8 4:00', '2009/10/8 5:00', '2009/10/8 6:00', '2009/10/8 7:00', '2009/10/8 8:00', '2009/10/8 9:00', '2009/10/8 10:00', '2009/10/8 11:00', '2009/10/8 12:00', '2009/10/8 13:00', '2009/10/8 14:00', '2009/10/8 15:00', '2009/10/8 16:00', '2009/10/8 17:00', '2009/10/8 18:00', '2009/10/8 19:00', '2009/10/8 20:00', '2009/10/8 21:00', '2009/10/8 22:00', '2009/10/8 23:00', '2009/10/9 0:00', '2009/10/9 1:00', '2009/10/9 2:00', '2009/10/9 3:00', '2009/10/9 4:00', '2009/10/9 5:00', '2009/10/9 6:00', '2009/10/9 7:00', '2009/10/9 8:00', '2009/10/9 9:00', '2009/10/9 10:00', '2009/10/9 11:00', '2009/10/9 12:00', '2009/10/9 13:00', '2009/10/9 14:00', '2009/10/9 15:00', '2009/10/9 16:00', '2009/10/9 17:00', '2009/10/9 18:00', '2009/10/9 19:00', '2009/10/9 20:00', '2009/10/9 21:00', '2009/10/9 22:00', '2009/10/9 23:00', '2009/10/10 0:00', '2009/10/10 1:00', '2009/10/10 2:00', '2009/10/10 3:00', '2009/10/10 4:00', '2009/10/10 5:00', '2009/10/10 6:00', '2009/10/10 7:00', '2009/10/10 8:00', '2009/10/10 9:00', '2009/10/10 10:00', '2009/10/10 11:00', '2009/10/10 12:00', '2009/10/10 13:00', '2009/10/10 14:00', '2009/10/10 15:00', '2009/10/10 16:00', '2009/10/10 17:00', '2009/10/10 18:00', '2009/10/10 19:00', '2009/10/10 20:00', '2009/10/10 21:00', '2009/10/10 22:00', '2009/10/10 23:00', '2009/10/11 0:00', '2009/10/11 1:00', '2009/10/11 2:00', '2009/10/11 3:00', '2009/10/11 4:00', '2009/10/11 5:00', '2009/10/11 6:00', '2009/10/11 7:00', '2009/10/11 8:00', '2009/10/11 9:00', '2009/10/11 10:00', '2009/10/11 11:00', '2009/10/11 12:00', '2009/10/11 13:00', '2009/10/11 14:00', '2009/10/11 15:00', '2009/10/11 16:00', '2009/10/11 17:00', '2009/10/11 18:00', '2009/10/11 19:00', '2009/10/11 20:00', '2009/10/11 21:00', '2009/10/11 22:00', '2009/10/11 23:00', '2009/10/12 0:00', '2009/10/12 1:00', '2009/10/12 2:00', '2009/10/12 3:00', '2009/10/12 4:00', '2009/10/12 5:00', '2009/10/12 6:00', '2009/10/12 7:00', '2009/10/12 8:00', '2009/10/12 9:00', '2009/10/12 10:00', '2009/10/12 11:00', '2009/10/12 12:00', '2009/10/12 13:00', '2009/10/12 14:00', '2009/10/12 15:00', '2009/10/12 16:00', '2009/10/12 17:00', '2009/10/12 18:00', '2009/10/12 19:00', '2009/10/12 20:00', '2009/10/12 21:00', '2009/10/12 22:00', '2009/10/12 23:00', '2009/10/13 0:00', '2009/10/13 1:00', '2009/10/13 2:00', '2009/10/13 3:00', '2009/10/13 4:00', '2009/10/13 5:00', '2009/10/13 6:00', '2009/10/13 7:00', '2009/10/13 8:00', '2009/10/13 9:00', '2009/10/13 10:00', '2009/10/13 11:00', '2009/10/13 12:00', '2009/10/13 13:00', '2009/10/13 14:00', '2009/10/13 15:00', '2009/10/13 16:00', '2009/10/13 17:00', '2009/10/13 18:00', '2009/10/13 19:00', '2009/10/13 20:00', '2009/10/13 21:00', '2009/10/13 22:00', '2009/10/13 23:00', '2009/10/14 0:00', '2009/10/14 1:00', '2009/10/14 2:00', '2009/10/14 3:00', '2009/10/14 4:00', '2009/10/14 5:00', '2009/10/14 6:00', '2009/10/14 7:00', '2009/10/14 8:00', '2009/10/14 9:00', '2009/10/14 10:00', '2009/10/14 11:00', '2009/10/14 12:00', '2009/10/14 13:00', '2009/10/14 14:00', '2009/10/14 15:00', '2009/10/14 16:00', '2009/10/14 17:00', '2009/10/14 18:00', '2009/10/14 19:00', '2009/10/14 20:00', '2009/10/14 21:00', '2009/10/14 22:00', '2009/10/14 23:00', '2009/10/15 0:00', '2009/10/15 1:00', '2009/10/15 2:00', '2009/10/15 3:00', '2009/10/15 4:00', '2009/10/15 5:00', '2009/10/15 6:00', '2009/10/15 7:00', '2009/10/15 8:00', '2009/10/15 9:00', '2009/10/15 10:00', '2009/10/15 11:00', '2009/10/15 12:00', '2009/10/15 13:00', '2009/10/15 14:00', '2009/10/15 15:00', '2009/10/15 16:00', '2009/10/15 17:00', '2009/10/15 18:00', '2009/10/15 19:00', '2009/10/15 20:00', '2009/10/15 21:00', '2009/10/15 22:00', '2009/10/15 23:00', '2009/10/16 0:00', '2009/10/16 1:00', '2009/10/16 2:00', '2009/10/16 3:00', '2009/10/16 4:00', '2009/10/16 5:00', '2009/10/16 6:00', '2009/10/16 7:00', '2009/10/16 8:00', '2009/10/16 9:00', '2009/10/16 10:00', '2009/10/16 11:00', '2009/10/16 12:00', '2009/10/16 13:00', '2009/10/16 14:00', '2009/10/16 15:00', '2009/10/16 16:00', '2009/10/16 17:00', '2009/10/16 18:00', '2009/10/16 19:00', '2009/10/16 20:00', '2009/10/16 21:00', '2009/10/16 22:00', '2009/10/16 23:00', '2009/10/17 0:00', '2009/10/17 1:00', '2009/10/17 2:00', '2009/10/17 3:00', '2009/10/17 4:00', '2009/10/17 5:00', '2009/10/17 6:00', '2009/10/17 7:00', '2009/10/17 8:00', '2009/10/17 9:00', '2009/10/17 10:00', '2009/10/17 11:00', '2009/10/17 12:00', '2009/10/17 13:00', '2009/10/17 14:00', '2009/10/17 15:00', '2009/10/17 16:00', '2009/10/17 17:00', '2009/10/17 18:00', '2009/10/17 19:00', '2009/10/17 20:00', '2009/10/17 21:00', '2009/10/17 22:00', '2009/10/17 23:00', '2009/10/18 0:00', '2009/10/18 1:00', '2009/10/18 2:00', '2009/10/18 3:00', '2009/10/18 4:00', '2009/10/18 5:00', '2009/10/18 6:00', '2009/10/18 7:00', '2009/10/18 8:00'            ].map(function (str) {                return str.replace(' ', '\n');            })        }    ],    yAxis: [        {            name: '流量(m^3/s)',            type: 'value',            max: 500        },        {            name: '降雨量(mm)',            nameLocation: 'start',            max: 5,            type: 'value',            inverse: true        }    ],    series: [        {            name: '流量',            type: 'line',            animation: false,            areaStyle: {},            lineStyle: {                width: 1            },            markArea: {                silent: true,                data: [[{                    xAxis: '2009/9/12\n7:00'                }, {                    xAxis: '2009/9/22\n7:00'                }]]            },            data: [                0.97,0.96,0.96,0.95,0.95,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.93,0.92,0.91,0.9,0.89,0.88,0.87,0.87,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.87,0.88,0.9,0.93,0.96,0.99,1.03,1.06,1.1,1.14,1.17,1.2,1.23,1.26,1.29,1.33,1.36,1.4,1.43,1.45,1.48,1.49,1.51,1.51,1.5,1.49,1.47,1.44,1.41,1.37,1.34,1.3,1.27,1.24,1.22,1.2,1.19,1.18,1.16,1.15,1.14,1.13,1.12,1.11,1.11,1.1,1.1,1.1,1.1,1.1,1.1,1.1,1.1,1.1,1.1,1.1,1.1,1.1,1.1,1.1,1.1,1.1,1.09,1.09,1.08,1.07,1.06,1.05,1.04,1.03,1.03,1.02,1.01,1.01,1,0.99,0.98,0.97,0.96,0.96,0.95,0.95,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.93,0.92,0.91,0.9,0.89,0.88,0.87,0.87,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.85,0.84,0.83,0.82,0.81,0.8,0.8,0.79,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.77,0.75,0.73,0.71,0.68,0.65,0.63,0.61,0.59,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.57,0.57,0.57,0.56,0.55,0.55,0.54,0.54,0.53,0.52,0.52,0.51,0.51,0.5,0.5,0.49,0.48,0.48,0.47,0.47,0.47,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.46,0.52,0.67,0.9,1.19,1.52,1.87,2.22,2.55,2.84,3.07,3.22,3.28,3.28,3.28,3.28,3.28,3.28,3.28,3.28,3.28,3.28,3.28,3.28,3.28,3.24,3.13,2.97,2.77,2.54,2.3,2.05,1.82,1.62,1.46,1.35,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.31,1.3,1.26,1.21,1.14,1.06,0.97,0.89,0.81,0.74,0.69,0.65,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.63,0.63,0.62,0.62,0.61,0.6,0.59,0.59,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.59,0.61,0.63,0.65,0.68,0.71,0.73,0.75,0.77,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.77,0.75,0.73,0.71,0.68,0.65,0.63,0.61,0.59,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.58,0.59,0.59,0.6,0.61,0.62,0.62,0.63,0.63,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.65,0.66,0.68,0.69,0.71,0.73,0.74,0.76,0.77,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.79,0.81,0.82,0.84,0.86,0.88,0.9,0.92,0.93,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.94,0.93,0.92,0.91,0.9,0.89,0.88,0.87,0.87,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.86,0.85,0.84,0.82,0.8,0.78,0.76,0.75,0.73,0.72,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.72,0.73,0.74,0.76,0.78,0.79,0.82,0.84,0.86,0.89,0.91,0.94,0.97,1,1.02,1.05,1.08,1.11,1.14,1.17,1.19,1.22,1.25,1.27,1.29,1.31,1.33,1.35,1.36,1.38,1.39,1.39,1.4,1.4,1.4,1.39,1.37,1.35,1.32,1.29,1.26,1.22,1.18,1.14,1.1,1.05,1.01,0.97,0.93,0.89,0.85,0.82,0.78,0.76,0.74,0.72,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.72,0.73,0.74,0.75,0.77,0.78,0.8,0.82,0.84,0.87,0.89,0.92,0.94,0.97,0.99,1.02,1.05,1.08,1.1,1.13,1.16,1.18,1.21,1.23,1.26,1.28,1.3,1.32,1.34,1.35,1.37,1.38,1.39,1.4,1.41,1.41,1.42,1.42,1.43,1.43,1.43,1.44,1.44,1.44,1.44,1.45,1.45,1.45,1.46,1.46,1.46,1.47,1.47,1.48,1.48,1.49,1.5,1.51,1.54,1.62,1.73,1.88,2.05,2.24,2.45,2.67,2.89,3.11,3.31,3.51,3.69,3.86,4.03,4.18,4.33,4.48,4.62,4.76,4.89,5.02,5.16,5.29,5.43,5.57,5.71,5.86,6.02,6.18,6.36,6.54,6.73,6.93,7.15,7.38,7.62,7.88,8.16,8.46,8.77,9.11,9.46,9.84,10.24,10.67,11.12,11.6,12.3,13.66,16,38.43,82.21,146.6,218.7,226,225.23,223.08,219.78,212,199.82,184.6,168,151.65,137.21,126.31,119.94,115.52,112.06,108.92,105.44,101,94.56,86.36,77.67,69.76,63.9,60.38,57.41,54.84,52.57,50.56,48.71,46.97,45.25,43.48,41.6,39.5,37.19,34.81,32.46,30.27,28.36,26.85,25.86,25.5,25.5,25.5,25.5,25.5,25.5,25.5,25.5,25.5,25.5,25.5,25.5,25.5,25.27,24.65,23.7,22.52,21.17,19.75,18.33,16.98,15.8,14.85,14.23,14,14.02,14.08,14.17,14.29,14.44,14.61,14.8,15.01,15.23,15.47,15.71,15.95,16.19,16.43,16.67,16.89,17.1,17.29,17.46,17.61,17.73,17.82,17.88,17.9,17.63,16.88,15.75,14.33,12.71,10.98,9.23,7.56,6.05,4.81,3.92,3.47,3.28,3.1,2.93,2.76,2.61,2.46,2.32,2.19,2.07,1.96,1.85,1.75,1.66,1.58,1.51,1.44,1.39,1.34,1.29,1.26,1.23,1.22,1.2,1.2,1.2,1.2,1.2,1.2,1.21,1.21,1.21,1.21,1.22,1.22,1.22,1.23,1.23,1.23,1.24,1.24,1.25,1.25,1.25,1.26,1.26,1.27,1.27,1.27,1.28,1.28,1.28,1.29,1.29,1.29,1.29,1.3,1.3,1.3,1.3,1.3,1.3,1.3,1.3,1.3,1.3,1.3,1.29,1.29,1.29,1.29,1.28,1.28,1.28,1.27,1.27,1.26,1.25,1.25,1.24,1.23,1.23,1.22,1.21,1.2,1.16,1.06,0.95,0.83,0.74,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.71,0.7,0.7,0.7,0.7,0.7,0.7,0.7,0.7,0.7,0.7,0.7,0.69,0.69,0.69,0.69,0.69,0.69,0.69,0.69,0.68,0.68,0.68,0.68,0.68,0.68,0.67,0.67,0.67,0.67,0.67,0.67,0.67,0.66,0.66,0.66,0.66,0.66,0.66,0.66,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.65,0.66,0.68,0.69,0.71,0.73,0.74,0.76,0.77,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.78,0.8,0.86,0.95,1.08,1.25,1.46,1.7,1.97,2.28,2.63,3.01,3.42,3.87,4.35,4.86,5.4,5.98,6.59,7.92,10.49,14.04,18.31,23.04,27.98,32.87,37.45,41.46,44.64,46.74,47.5,46.86,45.16,42.77,40.04,37.33,35,32.74,30.21,27.7,25.5,23.9,23.2,23.06,22.94,22.84,22.77,22.72,22.7,22.8,23.23,23.95,24.91,26.04,27.3,28.76,30.7,33.39,37.12,42.15,48.77,65.22,252.1,257,237.32,221.19,212,208.67,206.89,205.2,202.15,189.82,172,165.3,160.49,156.8,153.44,149.62,144.6,138.27,131,123.11,114.9,106.69,98.79,91.5,85.13,80,75.53,71.03,66.65,62.54,58.85,55.73,53.31,51.75,51.2,56.53,68.25,80,91.01,102.03,109,112.37,115.29,117.68,119.48,120.61,121,119.45,115.57,110.52,105.47,101.58,100,99.97,99.94,99.92,99.9,99.88,99.86,99.85,99.84,99.83,99.82,99.81,99.81,99.8,99.8,99.8,122.15,163.65,186,182.96,175.15,164.56,153.18,143,136,131.37,126.98,122.81,118.85,115.09,111.52,108.13,104.9,101.83,98.9,96.11,93.44,90.87,88.41,86.04,83.74,81.51,79.33,77.2,75.1,73.02,70.95,68.88,66.8,64.87,63.14,61.4,59.53,57.67,56,54.6,53.36,52.2,51.05,49.85,48.5,46.87,44.92,42.74,40.42,38.04,35.69,33.46,31.44,29.72,28.38,27.51,27.2,27.2,27.2,27.2,27.2,27.2,27.2,27.2,27.2,27.2,27.2,27.2,27.2,27.14,26.97,26.7,26.35,25.95,25.49,25.02,24.53,24.04,23.58,23.16,22.8,22.46,22.11,21.75,21.39,21.03,20.69,20.36,20.05,19.78,19.54,19.35,19.2,19.09,19,18.92,18.85,18.79,18.74,18.68,18.62,18.56,18.49,18.4,18.3,18.17,18.02,17.83,17.63,17.41,17.18,16.93,16.68,16.43,16.18,15.93,15.7,15.47,15.22,14.97,14.71,14.45,14.18,13.93,13.68,13.44,13.21,13,12.8,12.62,12.46,12.31,12.16,12.03,11.89,11.76,11.62,11.48,11.33,11.17,11,10.81,10.59,10.36,10.12,9.86,9.61,9.36,9.12,8.89,8.68,8.5,8.35,8.21,8.08,7.94,7.81,7.68,7.56,7.46,7.36,7.29,7.23,7.19,7.18,7.51,8.42,9.81,11.58,13.63,15.86,18.16,20.44,22.58,24.49,26.06,27.2,28.08,28.95,29.81,30.65,31.48,32.28,33.07,33.82,34.55,35.25,35.92,36.56,37.15,37.71,38.23,38.7,39.13,39.5,39.83,40.1,40.31,40.47,40.57,40.6,40.49,40.16,39.64,38.94,38.09,37.1,36,34.79,33.51,32.17,30.79,29.39,27.99,26.6,25.25,23.96,22.75,21.63,20.63,19.76,19.04,18.49,18.14,18,17.97,17.95,17.94,17.92,17.91,17.9,17.89,17.88,17.87,17.85,17.83,17.8,17.7,17.46,17.13,16.7,16.21,15.68,15.13,14.57,14.04,13.56,13.14,12.8,12.52,12.27,12.02,11.79,11.57,11.37,11.16,10.97,10.78,10.59,10.39,10.2,10.01,9.81,9.63,9.44,9.26,9.08,8.9,8.73,8.56,8.39,8.22,8.06,7.9,7.73,7.57,7.41,7.25,7.09,6.94,6.79,6.65,6.52,6.4,6.28,6.17,6.08,5.98,5.9,5.81,5.73,5.65,5.57,5.49,5.41,5.32,5.23,5.14,5.04,4.94,4.84,4.74,4.63,4.53,4.43,4.33,4.23,4.13,4.03,3.93,3.81,3.69,3.57,3.45,3.33,3.22,3.12,3.04,2.98,2.93,2.92,2.92,2.92,2.92,2.92,2.92,2.92,2.92,2.92,2.92,2.92,2.92,2.92,2.9,2.86,2.8,2.71,2.62,2.52,2.42,2.33,2.24,2.18,2.14,2.12,2.12,2.12,2.12,2.12,2.12,2.12,2.12,2.12,2.12,2.12,2.12,2.12,2.1,2.06,2,1.91,1.82,1.71,1.61,1.5,1.4,1.32,1.25,1.2,1.16,1.13,1.1,1.06,1.03,1,0.97,0.93,0.9,0.87,0.85,0.82,0.79,0.77,0.74,0.72,0.69,0.67,0.65,0.63,0.61,0.59,0.58,0.56,0.54,0.53,0.52,0.51,0.5,0.49,0.48,0.48,0.47,0.47,0.46,0.46,0.47,0.48,0.5,0.53,0.56,0.59,0.62,0.64,0.67,0.69,0.7,0.71,0.71,0.71,0.71,0.7,0.7,0.7,0.69,0.69,0.69,0.68,0.68,0.67,0.67,0.67,0.66,0.66,0.65,0.65,0.65,0.65,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.64,0.65,0.65,0.65,0.66,0.66,0.67,0.68,0.69,0.69,0.7,0.71,0.73,0.74,0.75,0.76,0.78,0.8,0.81,0.83,0.85,0.87,0.89,0.92,0.94,0.97,0.99,1.02,1.05,1.08,1.11,1.15,1.18,1.32,1.66,2.21,2.97,3.94,5.11,6.5,8.1,9.9,11.92,14.15,16.6,22.3,22.8,24.48,30.38,35.74,42.4,57.14,94.04,112.9,123.4,130.4,130,119.4,120.7,116.8,118.1,119.4,124.8,143.5,204,294,319.2,328.4,365,350.8,347.6,347.6,325,331.6,319.2,308,308,308,308,296.8,300,281,278.4,270.6,271,253.6,233.5,219.2,207.8,205.9,204,189.6,178.8,173.4,160,154.4,146,145,140.5,130.4,126.2,116.8,112.9,106.5,101.6,98.51,82.67,67.3,80.05,76.12,72.3,71.02,69.78,67.3,67.3,68.54,57.6,71.02,66.06,59.12,57.14,55.16,55.16,52.19,52.19,51.2,48.56,44.16,43,45.92,49.44,44.16,36.48,35.74,35,32.36,37.22,32.36,32.36,32.36,33.68,32.36,31.7,35.74,29.72,32.36,30.38,29.72,28.4,28.4,28.4,27.28,25.6,25.04,23.92,22.3,21.8,21.8,21.8,22.8,21.8,25.6,22.8,22.8,17.8,16.04,16.04,16.04,16.04,16.04,16.04,16.04,16.04,16.04,16.04,15.02,14,14.03,14.11,14.25,14.45,14.72,15.06,15.46,15.95,16.51,17.15,17.87,18.69,19.59,20.59,21.69,22.88,24.18,25.59,27.1,28.73,30.48,32.34,34.33,36.44,38.69,41.06,43.57,46.22,49.01,51.95,55.04,58.27,61.66,65.21,68.92,72.8,88.09,104.9,105.7,110.3,111.6,110.3,106.5,105.7,103.3,100,97.02,98.8,91.07,83.98,88.09,81.36,78.74,77.43,77.43,73.5,74.81,72.63,68.58,66.4,68.54,69.78,67.3,64.82,61.1,59.12,56.15,53.18,50.32,49.44,44.16,36.5,42.4,37.96,37.22,33.68,36.48,35.74,35,35,37.22,37.22,39.44,32.6,34.54,36.48,35.74,34.34,33.68,33.02,31.04,29.72,29.72,29.72,26.16,25.6,29.72,18.3,22.3,21.3,21.8,21.8,20.3,20.8,25.04,25.04,25.6,25.6,25.04,25.6,25.04,25.6,23.92,25.04,21.3,21.8,22.3,21.8,20.8,16.1,20.3,18.3,13.22,19.3,19.3,18.3,14.4,13.86,13.36,12.9,12.48,12.1,11.75,11.43,11.15,10.9,10.67,10.48,10.31,10.16,10.04,9.93,9.85,9.78,9.73,9.69,9.67,9.65,9.65,12.08,8.67,11.7,11.38,10.65,9.84,9.32,9.07,8.85,8.66,8.49,8.35,8.22,8.1,7.98,7.86,7.74,7.61,7.47,7.31,7.14,6.96,6.78,6.58,6.39,6.19,5.99,5.78,5.58,5.39,5.2,5.01,4.83,4.67,4.51,4.37,4.24,4.12,4.02,3.95,3.89,3.85,3.84,4.41,5.77,7.39,8.75,9.32,9.18,9,8.94,8.88,8.83,8.78,8.73,8.68,8.64,8.6,8.56,8.53,8.5,8.47,8.45,8.42,8.4,8.39,8.37,8.36,8.35,8.35,8.34,8.34,8.67,9.65,9.62,9.53,9.4,9.21,8.98,8.7,8.4,8.06,7.69,7.3,6.89,6.47,6.03,5.59,5.14,4.7,4.26,3.83,3.42,3.02,2.65,2.3,1.98,1.7,1.45,1.25,1.09,0.99,0.94,0.92,0.91,0.89,0.87,0.85,0.84,0.82,0.81,0.79,0.78,0.77,0.75,0.74,0.73,0.72,0.71,0.7,0.69,0.68,0.67,0.66,0.65,0.64,0.64,0.63,0.63,0.62,0.62,0.61,0.61,0.61,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.61,0.61,0.61,0.61,0.61,0.61,0.62,0.62,0.62,0.62,0.63,0.63,0.63,0.63,0.63,0.64,0.64,0.64,0.64,0.64,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.65,0.64,0.63,0.62,0.6,0.59,0.57,0.55,0.54,0.53,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.51,0.51,0.51,0.5,0.5,0.49,0.48,0.47,0.47,0.46,0.45,0.45,0.44,0.43,0.42,0.42,0.41,0.41,0.41,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.41,0.42,0.43,0.44,0.46,0.48,0.5,0.53,0.55,0.58,0.61,0.64,0.67,0.7,0.73,0.77,0.8,0.83,0.87,0.9,0.93,0.96,0.99,1.02,1.05,1.08,1.1,1.12,1.14,1.16,1.17,1.18,1.19,1.2,1.2,1.2,1.19,1.17,1.15,1.12,1.09,1.06,1.02,0.98,0.94,0.9,0.86,0.82,0.78,0.74,0.7,0.66,0.63,0.6,0.57,0.55,0.53,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.52,0.51,0.51,0.5,0.5,0.49,0.49,0.48,0.47,0.47,0.47,0.46,0.46,0.45,0.45,0.45,0.44,0.44,0.44,0.43,0.43,0.43,0.42,0.42,0.42,0.41,0.41,0.41,0.41,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.41,0.41,0.41,0.41,0.41,0.41,0.41,0.41,0.41,0.41,0.41,0.41,0.41,0.41,0.41,0.42,0.42,0.42,0.42,0.42,0.42,0.42,0.42,0.42,0.43,0.43,0.43,0.43,0.43,0.43,0.44,0.44,0.44,0.44,0.44,0.44,0.45,0.45,0.45            ]        },        {            name: '降雨量',            type: 'line',            yAxisIndex: 1,            animation: false,            areaStyle: {},            lineStyle: {                width: 1            },            markArea: {                silent: true,                data: [                    [{                        xAxis: '2009/9/10\n7:00'                    }, {                        xAxis: '2009/9/20\n7:00'                    }]                ]            },            data: [                0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.005,0.017,0.017,0.017,0.017,0.011,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.021,0.026,0.03,0.036,0.036,0.195,0.221,0.019,0.013,0.017,0.03,0.03,0.03,0.046,0.045,0.038,0.084,0.045,0.045,0.037,0.034,0.035,0.036,0.044,0.052,0.048,0.109,0.033,0.029,0.04,0.042,0.042,0.042,0.073,0.076,0.062,0.066,0.066,0.075,0.096,0.128,0.121,0.128,0.14,0.226,0.143,0.097,0.018,0,0,0,0,0,0.018,0.047,0.054,0.054,0.054,0.036,0.185,0.009,0.038,0.061,0.077,0.091,0.126,0.69,0.182,0.349,0.231,0.146,0.128,0.167,0.1,0.075,0.071,0.071,0.117,0.01,0.002,0.002,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.005,0.026,0.038,0.038,0.038,0.076,0.086,0.109,0.213,0.276,0.288,0.297,0.642,1.799,1.236,2.138,0.921,0.497,0.685,0.828,0.41,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.018,0.024,0.024,0.024,0.024,0.006,0.003,0.046,0.046,0.046,0.046,0.043,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.204,0.303,1.028,1.328,1.524,1.41,1.362,1.292,1.191,0.529,0.501,0.944,1.81,2.899,0.859,0.126,0.087,0.047,0,0,0,0,0.011,0.028,0.028,0.028,0.028,0.017,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.099,0.159,0.297,0.309,0.309,0.614,0.818,1.436,1.195,0.553,0.542,0.955,0.898,0.466,0.386,0.556,0.388,0.221,0.192,0.192,0.187,0.166,0.18,0.302,0.158,0.009,0.009,0.009,0.009,0.009,0.007,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.004,0.032,0.032,0.032,0.032,0.082,0.149,0.204,0.247,0.262,0.49,0.51,0.533,0.746,0.847,2.393,1.188,1.114,0.475,0.043,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.017,0.017,0.021,0.042,0.079,0.111,0.126,0.122,0.133,0.846,0.102,0.077,0.067,0.056,0.005,0,0,0,0,0,0,0,0,0,0,0,0,0,0.011,0.017,0.017,0.017,0.017,0.006,0,0,0,0,0,0.01,0.03,0.054,0.067,0.07,0.25,0.251,0.494,0.065,0.054,0.054,0.064,0.084,0.077,0.101,0.132,0.248,0.069,0.117,0.115,0.087,0.326,0.036,0.009,0.009,0.009,0.009,0.009,0.004,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.02,0.039,0.04,0.04,0.04,0.229,0.079,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.023,0.069,0.082,0.082,0.082,0.503,0.774,0.038,0.012,0.012,0.012,0.016,0.02,0.028,0.051,0.06,0.064,0.19,0.15,0.164,0.139,0.13,0.085,0.031,0.023,0.022,0.007,0.005,0.005,0.001,0,0.02,0.048,0.048,0.053,0.056,0.036,0.008,0.008,0.004,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.013,0.017,0.036,0.068,0.095,0.233,0.272,0.377,0.722,1.494,3.756,0.954,0.439,0.442,0.462,0.373,0.249,0.214,0.1,0.044,0.037,0.023,0.002,0,0,0,0,0,0,0.02,0.024,0.024,0.024,0.024,0.004,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.008,0.017,0.017,0.045,0.186,0.308,0.241,0.241,0.893,4.067,4.494,5.015,3.494,2.057,1.411,0.718,0.407,0.313,0.339,1.537,1.105,0.218,0.136,0.03,0.005,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.037,0.448,1.2,1.309,1.309,1.425,1.223,0.471,0.767,0.423,0.273,0.412,0.646,0.481,0.239,0.131,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.044,0.15,0.223,0.388,0.513,0.883,2.828,4.786,5.959,4.95,6.434,6.319,3.35,2.806,4.204,1.395,1.015,1.015,0.836,0.74,0.72,0.615,0.477,0.192,0.046,0.007,0.007,0.007,0.007,0.007,0.007,0.007,0.008,0.005,0.005,0.005,0.005,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.001,0.012,0.012,0.012,0.012,0.011,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.002,0.012,0.028,0.028,0.028,0.138,0.092,0.082,0.082,0.096,0.719,0.155,0.042,0.047,0.129,0.021,0.021,0.014,0.009,0.029,0.067,0.088,0.095,0.095,0.138,0.091,0.032,0.025,0.025,0.003,0,0,0,0,0,0,0,0,0,0,0,0,0.002,0.045,0.228,0.297,0.325,0.339,0.581,1.244,0.796,0.517,0.227,0.053,0.006,0,0,0,0,0,0,0,0,0,0.003,0.005,0.005,0.005,0.005,0.081,0.129,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.014,0.041,0.041,0.041,0.041,0.027,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.009,0.017,0.017,0.017,0.017,0.355,0.174,0.009,0.009,0.012,0.136,0.208,0.208,0.208,0.215,7.359,1.858,0.458,0.053,0.053,0.047,0.045,0.045,0.059,0.136,0.188,0.206,0.21,0.588,1.517,6.02,4.688,4.42,0.624,0.326,0.359,0.553,0.899,0.94,2.95,9.415,5.752,1.092,0.096,0.035,0.026,0.018,0.015,0.011,0.011,0.011,0,0,0,0,0,0,0,0,0,0,0,0.056,0.27,0.314,0.351,0.354,0.609,0.796,1.857,0.848,0.538,0.214,0.178,0.178,0.201,0.231,0.227,0.272,0.397,0.45,1.014,2.917,1.675,0.081,0.059,0.059,0.148,0.075,0.075,0.078,0.236,0.784,0.784,0.784,0.784,0.741,0.115,0.058,0.058,0.058,0.029,0.015,0.015,0.015,0.015,0.012,0.008,0.604,0.985,1.305,2.273,2.528,2.336,2.496,2.281,1.397,1.713,3.259,1.167,0.745,0.548,1.058,0.684,0.728,0.392,0.179,0.283,0.283,0.46,0.08,0.099,0.099,0.099,0.1,0.143,0.137,0.238,0.317,0.262,0.225,0.792,0.426,0.332,0.261,0.11,0.093,0.102,0.171,0.292,0.504,0.605,1.745,2.485,1.964,0.33,0.171,0.259,0.242,0.215,0.366,0.354,0.205,0.203,0.262,0.153,0.13,0.137,0.362,0.691,0.295,0.433,0.154,0.056,0.053,0.053,0.053,0.051,0.047,0.065,0.078,0.091,0.206,0.813,0.102,0.151,0.05,0.024,0.004,0.001,0,0,0,0.021,0.021,0.021,0.021,0.021,0.013,0.013,0.013,0.013,0.013,0.013,0.013,0.013,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.008,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.018,0.021,0.021,0.021,0.021,0.003,0,0,0,0,0,0,0,0,0,0.024,0.173,0.261,0.267,0.267,0.534,1.354,1.772,0.72,0.218,0.018,0.018,0.028,0.036,0.032,0.194,0.082,0.035,0.286,0.027,0.038,0.038,0.027,0.021,0.014,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.016,0.017,0.017,0.031,0.047,0.043,0.056,0.104,0.149,0.179,0.205,0.328,0.998,0.522,1.851,3.727,3.273,2.204,1.169,1.006,1.179,0.74,0.741,1.065,0.925,0.671,0.497,0.431,0.327,0.277,0.126,0.581,0.207,0.359,2.485,0.038,0.036,0.003,0.003,0.003,0.003,0.004,0.098,0.023,0.021,0.021,0.022,0.041,0.041,0.043,0.045,0.043,0.014,0.014,0.014,0.014,0.014,0.014,0.014,0.031,0.046,0.063,0.119,0.107,0.092,0.085,0.065,0.06,0.054,0.042,0.039,0.046,0.044,0.028,0.028,0.02,0.013,0.013,0.013,0.013,0.016,0.032,0.031,0.031,0.031,0.028,0.011,0.011,0.011,0.011,0.011,0.023,0.024,0.024,0.024,0.019,0.015,0.015,0.015,0.015,0.015,0.015,0.013,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.001,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.011,0.017,0.024,0.026,0.061,0.172,0.206,0.213,0.267,0.511,0.668,0.157,0.017,0.017,0.017,0.046,0.054,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.001,0.017,0.017,0.017,0.017,0.016,0,0,0,0,0,0,0,0,0,0.01,0.017,0.017,0.017,0.017,0.012,0.017,0.017,0.017,0.017,0.012,0,0,0,0,0,0.003,0.031,0.066,0.093,0.112,0.122,0.202,0.068,0.041,0.022,0.011,0,0,0,0,0,0,0,0,0,0,0,0.002,0.005,0.012,0.021,0.021,0.019,0.033,0.03,0.026,0.026,0.034,0.095,0.024,0.024,0.024,0.023,0.019,0.018,0.018,0.018,0.011,0.03,0.045,0.044,0.044,0.044,0.022,0.009,0.024,0.033,0.033,0.033,0.024,0.009,0,0,0,0,0,0,0.003,0.017,0.017,0.017,0.017,0.014,0,0,0,0,0,0.032,0.032,0.032,0.032,0.032,0.005,0.008,0.009,0.014,0.014,0.009,0.005,0.004,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.007,0.009,0.009,0.009,0.009,0.043,0.063,0.084,0.098,0.101,0.213,0.334,0.383,0.43,0.448,0.511,0.801,0.835,1.642,1.614,1.496,1.496,1.476,1.068,0.481,0.22,0.119,0.099,0.07,0.072,0.063,0.076,0.14,0.205,0.28,0.297,0.3,0.479,0.877,1.098,1.611,1.629,1.686,1.686,1.631,1.528,1.862,1.703,1.531,2.196,0.395,0.416,0.453,0.728,0.917,0.986,1.17,2.171,3.011,2.909,3.301,1.377,0.778,0.799,0.947,1.039,0.879,0.76,1.372,1.674,1.674,1.68,1.823,1.793,1.162,0.783,0.216,0.152,0.152,0.152,0.049,0,0,0,0.117,0.127,0.127,0.127,0.127,0.127,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.003,0.005,0.005,0.005,0.005,0.003,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.309,0.364,0.364,0.364,0.364,0.063,0.01,0.01,0.01,0.012,0.015,0.015,0.11,0.55,0.824,0.825,0.829,1.39,1.429,1.342,1.43,1.636,1.717,2.135,2.203,3.191,3.022,1.589,0.86,0.807,0.645,0.595,0.588,0.557,0.552,1.271,0.708,0.677,0.629,0.714,0.203,0.133,0.061,0.062,0.018,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.001,0.072,0.29,0.438,0.53,0.557,0.873,1.039,1.04,0.208,0.049,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.03,0.039,0.039,0.039,0.039,0.098,0.008,0.007,0.007,0.007,0.007,0.007,0.007,0.007,0.007,0.007,0.056,0.062,0.065,0.065,0.065,0.047,0.216,0.256,0.315,0.4,0.502,0.449,0.47,0.571,0.814,1.153,0.774,0.202,0.086,0.075,0.071,0.032,0.019,0.003,0.004,0.004,0.004,0.004,0.004,0.004,0.007,0.072,0.153,0.256,0.306,0.404,0.698,0.733,0.823,0.715,0.563,0.404,0.293,0.217,0.213,0.202,0.202,0.294,0.704,0.797,1.359,1.101,0.72,0.514,0.539,0.434,0.389,0.387,0.386,0.375,0.369,0.319,0.239,0.183,0.136,0.062,0.052,0.096,0.119,0.119,0.114,0.127,0.132,0.139,0.169,0.191,0.278,0.254,0.214,0.237,0.221,0.143,0.129,0.125,0.109,0.1,0.087,0.06,0.038,0.029,0.029,0.028,0.048,0.053,0.053,0.111,0.125,0.102,0.097,0.097,0.039,0.02,0.02,0.02,0.014,0.004,0.031,0.043,0.047,0.052,0.08,0.144,0.182,0.176,0.171,0.149,0.112,0.025,0,0,0,0,0,0,0,0.016,0.031,0.031,0.031,0.031,0.015,0,0,0,0,0,0.005,0.005,0.005,0.005,0.005,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.005,0.005,0.005,0.005,0.005,0.001,0,0,0            ]        }    ]};        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=line-easing">Line Easing Visualizing</a></li></ul><script>var easingFuncs = {    linear: function (k) {        return k;    },    quadraticIn: function (k) {        return k * k;    },    quadraticOut: function (k) {        return k * (2 - k);    },    quadraticInOut: function (k) {        if ((k *= 2) < 1) { return 0.5 * k * k; }        return -0.5 * (--k * (k - 2) - 1);    },    cubicIn: function (k) {        return k * k * k;    },    cubicOut: function (k) {        return --k * k * k + 1;    },    cubicInOut: function (k) {        if ((k *= 2) < 1) { return 0.5 * k * k * k; }        return 0.5 * ((k -= 2) * k * k + 2);    },    quarticIn: function (k) {        return k * k * k * k;    },    quarticOut: function (k) {        return 1 - (--k * k * k * k);    },    quarticInOut: function (k) {        if ((k *= 2) < 1) { return 0.5 * k * k * k * k; }        return -0.5 * ((k -= 2) * k * k * k - 2);    },    quinticIn: function (k) {        return k * k * k * k * k;    },    quinticOut: function (k) {        return --k * k * k * k * k + 1;    },    quinticInOut: function (k) {        if ((k *= 2) < 1) { return 0.5 * k * k * k * k * k; }        return 0.5 * ((k -= 2) * k * k * k * k + 2);    },    sinusoidalIn: function (k) {        return 1 - Math.cos(k * Math.PI / 2);    },    sinusoidalOut: function (k) {        return Math.sin(k * Math.PI / 2);    },    sinusoidalInOut: function (k) {        return 0.5 * (1 - Math.cos(Math.PI * k));    },    exponentialIn: function (k) {        return k === 0 ? 0 : Math.pow(1024, k - 1);    },    exponentialOut: function (k) {        return k === 1 ? 1 : 1 - Math.pow(2, -10 * k);    },    exponentialInOut: function (k) {        if (k === 0) {            return 0;        }        if (k === 1) {            return 1;        }        if ((k *= 2) < 1) {            return 0.5 * Math.pow(1024, k - 1);        }        return 0.5 * (-Math.pow(2, -10 * (k - 1)) + 2);    },    circularIn: function (k) {        return 1 - Math.sqrt(1 - k * k);    },    circularOut: function (k) {        return Math.sqrt(1 - (--k * k));    },    circularInOut: function (k) {        if ((k *= 2) < 1) { return -0.5 * (Math.sqrt(1 - k * k) - 1); }        return 0.5 * (Math.sqrt(1 - (k -= 2) * k) + 1);    },    elasticIn: function (k) {        var s;        var a = 0.1;        var p = 0.4;        if (k === 0) { return 0; }        if (k === 1) { return 1; }        if (!a || a < 1) { a = 1; s = p / 4; }        else { s = p * Math.asin(1 / a) / (2 * Math.PI); }        return -(a * Math.pow(2, 10 * (k -= 1)) * Math.sin((k - s) * (2 * Math.PI) / p));    },    elasticOut: function (k) {        var s;        var a = 0.1;        var p = 0.4;        if (k === 0) { return 0; }        if (k === 1) { return 1; }        if (!a || a < 1) { a = 1; s = p / 4; }        else { s = p * Math.asin(1 / a) / (2 * Math.PI); }        return (a * Math.pow(2, -10 * k) * Math.sin((k - s) * (2 * Math.PI) / p) + 1);    },    elasticInOut: function (k) {        var s;        var a = 0.1;        var p = 0.4;        if (k === 0) { return 0; }        if (k === 1) { return 1; }        if (!a || a < 1) { a = 1; s = p / 4; }        else { s = p * Math.asin(1 / a) / (2 * Math.PI); }        if ((k *= 2) < 1) {            return -0.5 * (a * Math.pow(2, 10 * (k -= 1)) * Math.sin((k - s) * (2 * Math.PI) / p));        }        return a * Math.pow(2, -10 * (k -= 1)) * Math.sin((k - s) * (2 * Math.PI) / p) * 0.5 + 1;    },    backIn: function (k) {        var s = 1.70158;        return k * k * ((s + 1) * k - s);    },    backOut: function (k) {        var s = 1.70158;        return --k * k * ((s + 1) * k + s) + 1;    },    backInOut: function (k) {        var s = 1.70158 * 1.525;        if ((k *= 2) < 1) { return 0.5 * (k * k * ((s + 1) * k - s)); }        return 0.5 * ((k -= 2) * k * ((s + 1) * k + s) + 2);    },    bounceIn: function (k) {        return 1 - easingFuncs.bounceOut(1 - k);    },    bounceOut: function (k) {        if (k < (1 / 2.75)) { return 7.5625 * k * k; }        else if (k < (2 / 2.75)) { return 7.5625 * (k -= (1.5 / 2.75)) * k + 0.75; }        else if (k < (2.5 / 2.75)) { return 7.5625 * (k -= (2.25 / 2.75)) * k + 0.9375; }        else { return 7.5625 * (k -= (2.625 / 2.75)) * k + 0.984375; }    },    bounceInOut: function (k) {        if (k < 0.5) { return easingFuncs.bounceIn(k * 2) * 0.5; }        return easingFuncs.bounceOut(k * 2 - 1) * 0.5 + 0.5;    }};var N_POINT = 30;var grids = [];var xAxes = [];var yAxes = [];var series = [];var titles = [];var count = 0;echarts.util.each(easingFuncs, function (easingFunc, name) {    var data = [];    for (var i = 0; i <= N_POINT; i++) {        var x = i / N_POINT;        var y = easingFunc(x);        data.push([x, y]);    }    grids.push({        show: true,        borderWidth: 0,        backgroundColor: '#fff',        shadowColor: 'rgba(0, 0, 0, 0.3)',        shadowBlur: 2    });    xAxes.push({        type: 'value',        show: false,        min: 0,        max: 1,        gridIndex: count    });    yAxes.push({        type: 'value',        show: false,        min: -0.4,        max: 1.4,        gridIndex: count    });    series.push({        name: name,        type: 'line',        xAxisIndex: count,        yAxisIndex: count,        data: data,        showSymbol: false,        animationEasing: name,        animationDuration: 1000    });    titles.push({        textAlign: 'center',        text: name,        textStyle: {            fontSize: 12,            fontWeight: 'normal'        }    });    count++;});var rowNumber = Math.ceil(Math.sqrt(count));echarts.util.each(grids, function (grid, idx) {    grid.left = ((idx % rowNumber) / rowNumber * 100 + 0.5) + '%';    grid.top = (Math.floor(idx / rowNumber) / rowNumber * 100 + 0.5) + '%';    grid.width = (1 / rowNumber * 100 - 1) + '%';    grid.height = (1 / rowNumber * 100 - 1) + '%';    titles[idx].left = parseFloat(grid.left) + parseFloat(grid.width) / 2 + '%';    titles[idx].top = parseFloat(grid.top) + '%';});</script><div id="echarts8756" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts8756'));        // 指定图表的配置项和数据        var option = option = {    title: titles.concat([{        text: 'Different Easing Functions',        top: 'bottom',        left: 'center'    }]),    grid: grids,    xAxis: xAxes,    yAxis: yAxes,    series: series};        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><h3 id="柱状图Bar"><a href="#柱状图Bar" class="headerlink" title="柱状图Bar"></a>柱状图Bar</h3><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=bar-animation-delay">柱状图动画延迟</a></li></ul><script>var xAxisData = [];var data01 = [];var data02 = [];for (var i = 0; i < 100; i++) {    xAxisData.push('类目' + i);    data01.push((Math.sin(i / 5) * (i / 5 -10) + i / 6) * 5);    data02.push((Math.cos(i / 5) * (i / 5 -10) + i / 6) * 5);}</script><div id="echarts8570" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts8570'));        // 指定图表的配置项和数据        var option = option = {    title: {        text: '柱状图动画延迟'    },    legend: {        data: ['bar01', 'bar02']    },    toolbox: {        // y: 'bottom',        feature: {            magicType: {                type: ['stack', 'tiled']            },            dataView: {},            saveAsImage: {                pixelRatio: 2            }        }    },    tooltip: {},    xAxis: {        data: xAxisData,        splitLine: {            show: false        }    },    yAxis: {    },    series: [{        name: 'bar01',        type: 'bar',        data: data01,        animationDelay: function (idx) {            return idx * 10 + 50;        }    }, {        name: 'bar02',        type: 'bar',        data: data02,        animationDelay: function (idx) {            return idx * 10 + 100;        }    }],    animationEasing: 'elasticOut',    animationDelayUpdate: function (idx) {        return idx * 5;    }};        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=bar-brush">柱状图框选</a></li></ul><script>var xAxisData = [];var data1 = [];var data2 = [];var data3 = [];var data4 = [];for (var i = 0; i < 10; i++) {    xAxisData.push('Class' + i);    data1.push((Math.random() * 2).toFixed(2));    data2.push(-Math.random().toFixed(2));    data3.push((Math.random() * 5).toFixed(2));    data4.push((Math.random() + 0.3).toFixed(2));}var emphasisStyle = {    itemStyle: {        barBorderWidth: 1,        shadowBlur: 10,        shadowOffsetX: 0,        shadowOffsetY: 0,        shadowColor: 'rgba(0,0,0,0.5)'    }};myChart.on('brushSelected', renderBrushed);function renderBrushed(params) {    var brushed = [];    var brushComponent = params.batch[0];    for (var sIdx = 0; sIdx < brushComponent.selected.length; sIdx++) {        var rawIndices = brushComponent.selected[sIdx].dataIndex;        brushed.push('[Series ' + sIdx + '] ' + rawIndices.join(', '));    }        myChart.setOption({        title: {            backgroundColor: '#333',            text: 'SELECTED DATA INDICES: \n' + brushed.join('\n'),            bottom: 0,            right: 0,            width: 100,            textStyle: {                fontSize: 12,                color: '#fff'            }        }    });}</script><div id="echarts8195" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts8195'));        // 指定图表的配置项和数据        var option = option = {    backgroundColor: '#eee',    legend: {        data: ['bar', 'bar2', 'bar3', 'bar4'],        left: 10    },    brush: {        toolbox: ['rect', 'polygon', 'lineX', 'lineY', 'keep', 'clear'],        xAxisIndex: 0    },    toolbox: {        feature: {            magicType: {                type: ['stack', 'tiled']            },            dataView: {}        }    },    tooltip: {},    xAxis: {        data: xAxisData,        name: 'X Axis',        axisLine: {onZero: true},        splitLine: {show: false},        splitArea: {show: false}    },    yAxis: {        inverse: true,        splitArea: {show: false}    },    grid: {        left: 100    },    visualMap: {        type: 'continuous',        dimension: 1,        text: ['High', 'Low'],        inverse: true,        itemHeight: 200,        calculable: true,        min: -2,        max: 6,        top: 60,        left: 10,        inRange: {            colorLightness: [0.4, 0.8]        },        outOfRange: {            color: '#bbb'        },        controller: {            inRange: {                color: '#2f4554'            }        }    },    series: [        {            name: 'bar',            type: 'bar',            stack: 'one',            emphasis: emphasisStyle,            data: data1        },        {            name: 'bar2',            type: 'bar',            stack: 'one',            emphasis: emphasisStyle,            data: data2        },        {            name: 'bar3',            type: 'bar',            stack: 'two',            emphasis: emphasisStyle,            data: data3        },        {            name: 'bar4',            type: 'bar',            stack: 'two',            emphasis: emphasisStyle,            data: data4        }    ]};        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=bar-polar-stack-radial">极坐标系下的堆叠柱状图</a></li></ul><script></script><div id="echarts2584" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts2584'));        // 指定图表的配置项和数据        var option = option = {    angleAxis: {        type: 'category',        data: ['周一', '周二', '周三', '周四', '周五', '周六', '周日']    },    radiusAxis: {    },    polar: {    },    series: [{        type: 'bar',        data: [1, 2, 3, 4, 3, 5, 1],        coordinateSystem: 'polar',        name: 'A',        stack: 'a'    }, {        type: 'bar',        data: [2, 4, 6, 1, 3, 2, 1],        coordinateSystem: 'polar',        name: 'B',        stack: 'a'    }, {        type: 'bar',        data: [1, 2, 3, 4, 1, 2, 5],        coordinateSystem: 'polar',        name: 'C',        stack: 'a'    }],    legend: {        show: true,        data: ['A', 'B', 'C']    }};        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><h3 id="饼图Pie"><a href="#饼图Pie" class="headerlink" title="饼图Pie"></a>饼图Pie</h3><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=pie-pattern">Texture on Pie Chart</a></li></ul><script>var piePatternSrc = 'data:image/jpeg;base64,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';var bgPatternSrc = 'data:image/png;charset=utf-8;base64,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';var piePatternImg = new Image();piePatternImg.src = piePatternSrc;var bgPatternImg = new Image();bgPatternImg.src = bgPatternSrc;var itemStyle = {    normal: {        opacity: 0.7,        color: {            image: piePatternImg,            repeat: 'repeat'        },        borderWidth: 3,        borderColor: '#235894'    }};</script><div id="echarts5019" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts5019'));        // 指定图表的配置项和数据        var option = option = {    backgroundColor: {        image: bgPatternImg,        repeat: 'repeat'    },    title: {        text: '饼图纹理',        textStyle: {            color: '#235894'        }    },    tooltip: {},    series: [{        name: 'pie',        type: 'pie',        selectedMode: 'single',        selectedOffset: 30,        clockwise: true,        label: {            fontSize: 18,            color: '#235894'        },        labelLine: {            lineStyle: {                color: '#235894'            }        },        data: [            {value: 335, name: '直接访问'},            {value: 310, name: '邮件营销'},            {value: 234, name: '联盟广告'},            {value: 135, name: '视频广告'},            {value: 1548, name: '搜索引擎'}        ],        itemStyle: itemStyle    }]};        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><h3 id="地理坐标-地图GEO-Map"><a href="#地理坐标-地图GEO-Map" class="headerlink" title="地理坐标&#x2F;地图GEO&#x2F;Map"></a>地理坐标&#x2F;地图GEO&#x2F;Map</h3><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=effectScatter-bmap">Air Quality - Baidu Map</a></li></ul><iframe src="https://pxxyyz.com/html-file/echarts/lines-bmap-bus.html" width="100%" height="600" name="topFrame" scrolling="yes" noresize="noresize" frameborder="0" id="topFrame"></iframe><p>可进入<a href="https://pxxyyz.com/html-file/echarts/lines-bmap-bus.html">页面查看</a></p><h3 id="K-线图Candlestick"><a href="#K-线图Candlestick" class="headerlink" title="K 线图Candlestick"></a>K 线图Candlestick</h3><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=candlestick-brush">Candlestick Brush</a></li></ul><iframe src="https://pxxyyz.com/html-file/echarts/candlestick-brush.html" width="100%" height="600" name="topFrame" scrolling="yes" noresize="noresize" frameborder="0" id="topFrame"></iframe><p>可进入<a href="https://pxxyyz.com/html-file/echarts/candlestick-brush.html">页面查看</a></p><h3 id="雷达图Radar"><a href="#雷达图Radar" class="headerlink" title="雷达图Radar"></a>雷达图Radar</h3><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=radar2">Proportion of Browsers</a></li></ul><div id="echarts6433" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts6433'));        // 指定图表的配置项和数据        var option = option = {    title: {        text: '浏览器占比变化',        subtext: '纯属虚构',        top: 10,        left: 10    },    tooltip: {        trigger: 'item',        backgroundColor: 'rgba(0,0,250,0.2)'    },    legend: {        type: 'scroll',        bottom: 10,        data: (function (){            var list = [];            for (var i = 1; i <=28; i++) {                list.push(i + 2000 + '');            }            return list;        })()    },    visualMap: {        top: 'middle',        right: 10,        color: ['red', 'yellow'],        calculable: true    },    radar: {        indicator: [            { text: 'IE8-', max: 400},            { text: 'IE9+', max: 400},            { text: 'Safari', max: 400},            { text: 'Firefox', max: 400},            { text: 'Chrome', max: 400}        ]    },    series: (function (){        var series = [];        for (var i = 1; i <= 28; i++) {            series.push({                name: '浏览器（数据纯属虚构）',                type: 'radar',                symbol: 'none',                lineStyle: {                    width: 1                },                emphasis: {                    areaStyle: {                        color: 'rgba(0,250,0,0.3)'                    }                },                data: [{                    value: [                        (40 - i) * 10,                        (38 - i) * 4 + 60,                        i * 5 + 10,                        i * 9,                        i * i /2                    ],                    name: i + 2000 + ''                }]            });        }        return series;    })()};        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><h3 id="关系图Graph"><a href="#关系图Graph" class="headerlink" title="关系图Graph"></a>关系图Graph</h3><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=graph-webkit-dep">Graph Webkit Dep</a></li></ul><iframe src="https://pxxyyz.com/html-file/echarts/graph-webkit-dep.html" width="100%" height="600" name="topFrame" scrolling="yes" noresize="noresize" frameborder="0" id="topFrame"></iframe><p>可进入<a href="https://pxxyyz.com/html-file/echarts/graph-webkit-dep.html">页面查看</a></p><h3 id="树图Tree"><a href="#树图Tree" class="headerlink" title="树图Tree"></a>树图Tree</h3><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=tree-legend">Multiple Trees</a></li></ul><script>var data = {    "name": "flare",    "children": [        {            "name": "data",            "children": [                {                     "name": "converters",                     "children": [                      {"name": "Converters", "value": 721},                      {"name": "DelimitedTextConverter", "value": 4294}                     ]                },                {                    "name": "DataUtil",                    "value": 3322                }            ]        },        {            "name": "display",            "children": [                {"name": "DirtySprite", "value": 8833},                {"name": "LineSprite", "value": 1732},                {"name": "RectSprite", "value": 3623}           ]        },        {            "name": "flex",            "children": [                {"name": "FlareVis", "value": 4116}            ]        },        {           "name": "query",           "children": [            {"name": "AggregateExpression", "value": 1616},            {"name": "And", "value": 1027},            {"name": "Arithmetic", "value": 3891},            {"name": "Average", "value": 891},            {"name": "BinaryExpression", "value": 2893},            {"name": "Comparison", "value": 5103},            {"name": "CompositeExpression", "value": 3677},            {"name": "Count", "value": 781},            {"name": "DateUtil", "value": 4141},            {"name": "Distinct", "value": 933},            {"name": "Expression", "value": 5130},            {"name": "ExpressionIterator", "value": 3617},            {"name": "Fn", "value": 3240},            {"name": "If", "value": 2732},            {"name": "IsA", "value": 2039},            {"name": "Literal", "value": 1214},            {"name": "Match", "value": 3748},            {"name": "Maximum", "value": 843},            {             "name": "methods",             "children": [              {"name": "add", "value": 593},              {"name": "and", "value": 330},              {"name": "average", "value": 287},              {"name": "count", "value": 277},              {"name": "distinct", "value": 292},              {"name": "div", "value": 595},              {"name": "eq", "value": 594},              {"name": "fn", "value": 460},              {"name": "gt", "value": 603},              {"name": "gte", "value": 625},              {"name": "iff", "value": 748},              {"name": "isa", "value": 461},              {"name": "lt", "value": 597},              {"name": "lte", "value": 619},              {"name": "max", "value": 283},              {"name": "min", "value": 283},              {"name": "mod", "value": 591},              {"name": "mul", "value": 603},              {"name": "neq", "value": 599},              {"name": "not", "value": 386},              {"name": "or", "value": 323},              {"name": "orderby", "value": 307},              {"name": "range", "value": 772},              {"name": "select", "value": 296},              {"name": "stddev", "value": 363},              {"name": "sub", "value": 600},              {"name": "sum", "value": 280},              {"name": "update", "value": 307},              {"name": "variance", "value": 335},              {"name": "where", "value": 299},              {"name": "xor", "value": 354},              {"name": "_", "value": 264}             ]            },            {"name": "Minimum", "value": 843},            {"name": "Not", "value": 1554},            {"name": "Or", "value": 970},            {"name": "Query", "value": 13896},            {"name": "Range", "value": 1594},            {"name": "StringUtil", "value": 4130},            {"name": "Sum", "value": 791},            {"name": "Variable", "value": 1124},            {"name": "Variance", "value": 1876},            {"name": "Xor", "value": 1101}           ]          },        {           "name": "scale",           "children": [            {"name": "IScaleMap", "value": 2105},            {"name": "LinearScale", "value": 1316},            {"name": "LogScale", "value": 3151},            {"name": "OrdinalScale", "value": 3770},            {"name": "QuantileScale", "value": 2435},            {"name": "QuantitativeScale", "value": 4839},            {"name": "RootScale", "value": 1756},            {"name": "Scale", "value": 4268},            {"name": "ScaleType", "value": 1821},            {"name": "TimeScale", "value": 5833}           ]        }    ]};var data2 = {    "name": "flare",    "children": [        {            "name": "flex",            "children": [                {"name": "FlareVis", "value": 4116}            ]        },        {            "name": "scale",            "children": [                {"name": "IScaleMap", "value": 2105},                {"name": "LinearScale", "value": 1316},                {"name": "LogScale", "value": 3151},                {"name": "OrdinalScale", "value": 3770},                {"name": "QuantileScale", "value": 2435},                {"name": "QuantitativeScale", "value": 4839},                {"name": "RootScale", "value": 1756},                {"name": "Scale", "value": 4268},                {"name": "ScaleType", "value": 1821},                {"name": "TimeScale", "value": 5833}           ]        },        {            "name": "display",            "children": [                {"name": "DirtySprite", "value": 8833}           ]        }    ]};</script><div id="echarts3167" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts3167'));        // 指定图表的配置项和数据        var option = option = {    tooltip: {        trigger: 'item',        triggerOn: 'mousemove'    },    legend: {        top: '2%',        left: '3%',        orient: 'vertical',        data: [{            name: 'tree1',            icon: 'rectangle'        },        {            name: 'tree2',            icon: 'rectangle'        }],        borderColor: '#c23531'    },    series:[        {            type: 'tree',            name: 'tree1',                data: [data],                top: '5%',            left: '7%',            bottom: '2%',            right: '60%',                symbolSize: 7,                label: {                position: 'left',                verticalAlign: 'middle',                align: 'right'            },                leaves: {                label: {                    position: 'right',                    verticalAlign: 'middle',                    align: 'left'                }            },                expandAndCollapse: true,                animationDuration: 550,            animationDurationUpdate: 750            },        {            type: 'tree',            name: 'tree2',            data: [data2],                top: '20%',            left: '60%',            bottom: '22%',            right: '18%',                symbolSize: 7,                label: {                position: 'left',                verticalAlign: 'middle',                align: 'right'            },                leaves: {                label: {                    position: 'right',                    verticalAlign: 'middle',                    align: 'left'                }            },                expandAndCollapse: true,                animationDuration: 550,            animationDurationUpdate: 750        }    ]}        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><h3 id="日历坐标系Calendar"><a href="#日历坐标系Calendar" class="headerlink" title="日历坐标系Calendar"></a>日历坐标系Calendar</h3><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=calendar-horizontal">Calendar Heatmap Horizontal</a></li></ul><script>function getVirtulData(year) {    year = year || '2017';    var date = +echarts.number.parseDate(year + '-01-01');    var end = +echarts.number.parseDate((+year + 1) + '-01-01');    var dayTime = 3600 * 24 * 1000;    var data = [];    for (var time = date; time < end; time += dayTime) {        data.push([            echarts.format.formatTime('yyyy-MM-dd', time),            Math.floor(Math.random() * 1000)        ]);    }    return data;}</script><div id="echarts8560" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts8560'));        // 指定图表的配置项和数据        var option = option = {    tooltip: {        position: 'top'    },    visualMap: {        min: 0,        max: 1000,        calculable: true,        orient: 'horizontal',        left: 'center',        top: 'top'    },    calendar: [{        range: '2020',        cellSize: ['auto', 15]    },    {        top: 260,        range: '2019',        cellSize: ['auto', 15]    }],        series: [{        type: 'heatmap',        coordinateSystem: 'calendar',        calendarIndex: 0,        data: getVirtulData(2020)    }, {        type: 'heatmap',        coordinateSystem: 'calendar',        calendarIndex: 1,        data: getVirtulData(2019)    }]};        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><h3 id="3D"><a href="#3D" class="headerlink" title="3D"></a>3D</h3><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=bar3d-simplex-noise&gl=1&theme=dark">Bar3D - Simplex Noise</a></li></ul><iframe src="https://pxxyyz.com/html-file/echarts/bar-3D-simplex-noise.html" width="100%" height="600" name="topFrame" scrolling="yes" noresize="noresize" frameborder="0" id="topFrame"></iframe><p>可进入<a href="https://pxxyyz.com/html-file/echarts/bar-3D-simplex-noise.html">页面查看</a></p><ul><li><a href="https://echarts.apache.org/examples/zh/editor.html?c=surface-wave&gl=1">Surface Wave</a></li></ul><div id="echarts4976" style="width: 85%;height: 400px;margin: 0 auto"></div><script type="text/javascript">        // 基于准备好的dom，初始化echarts实例        var myChart = echarts.init(document.getElementById('echarts4976'));        // 指定图表的配置项和数据        var option = option = {    tooltip: {},    backgroundColor: '#fff',    visualMap: {        show: false,        dimension: 2,        min: -1,        max: 1,        inRange: {            color: ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#ffffbf', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']        }    },    xAxis3D: {        type: 'value'    },    yAxis3D: {        type: 'value'    },    zAxis3D: {        type: 'value',        max: 1,        splitNumber: 2    },    grid3D: {        viewControl: {            // projection: 'orthographic'        },        boxHeight: 40    },    series: [{        type: 'surface',        wireframe: {            show: false        },        shading: 'color',        equation: {            x: {                step: 0.05,                min: -3,                max: 3,            },            y: {                step: 0.05,                min: -3,                max: 3,            },            z: function (x, y) {                return Math.sin(x * x + y * y) * x / 3.14            }        }    }]}        // 使用刚指定的配置项和数据显示图表。        myChart.setOption(option);</script><h2 id="pyecharts"><a href="#pyecharts" class="headerlink" title="pyecharts"></a>pyecharts</h2><p>$$<br>\text{py} + \text{echarts} &#x3D; \text{pyecharts}<br>$$</p><h3 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h3><blockquote><p>Echarts 是一个由百度开源的数据可视化，凭借着良好的交互性，精巧的图表设计，得到了众多开发者的认可。而 Python 是一门富有表达力的语言，很适合用于数据处理。当数据分析遇上数据可视化时，pyecharts 诞生了<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="[pyecharts仓库](https://github.com/pyecharts/pyecharts)">[2]</span></a></sup>。</p></blockquote><h3 id="怎么用–py或jupyter"><a href="#怎么用–py或jupyter" class="headerlink" title="怎么用–py或jupyter"></a>怎么用–py或jupyter</h3><ul><li>pip 安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ pip install pyecharts -U<br></code></pre></td></tr></table></figure><ul><li>生成 HTML</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pyecharts.charts <span class="hljs-keyword">import</span> Bar<br><span class="hljs-keyword">from</span> pyecharts <span class="hljs-keyword">import</span> options <span class="hljs-keyword">as</span> opts<br><br><span class="hljs-comment"># V1 版本开始支持链式调用</span><br>bar = (<br>    Bar()<br>    .add_xaxis([<span class="hljs-string">&quot;衬衫&quot;</span>, <span class="hljs-string">&quot;毛衣&quot;</span>, <span class="hljs-string">&quot;领带&quot;</span>, <span class="hljs-string">&quot;裤子&quot;</span>, <span class="hljs-string">&quot;风衣&quot;</span>, <span class="hljs-string">&quot;高跟鞋&quot;</span>, <span class="hljs-string">&quot;袜子&quot;</span>])<br>    .add_yaxis(<span class="hljs-string">&quot;商家A&quot;</span>, [<span class="hljs-number">114</span>, <span class="hljs-number">55</span>, <span class="hljs-number">27</span>, <span class="hljs-number">101</span>, <span class="hljs-number">125</span>, <span class="hljs-number">27</span>, <span class="hljs-number">105</span>])<br>    .add_yaxis(<span class="hljs-string">&quot;商家B&quot;</span>, [<span class="hljs-number">57</span>, <span class="hljs-number">134</span>, <span class="hljs-number">137</span>, <span class="hljs-number">129</span>, <span class="hljs-number">145</span>, <span class="hljs-number">60</span>, <span class="hljs-number">49</span>])<br>    .set_global_opts(title_opts=opts.TitleOpts(title=<span class="hljs-string">&quot;某商场销售情况&quot;</span>))<br>)<br>bar.render()<br><br><span class="hljs-comment"># 不习惯链式调用的开发者依旧可以单独调用方法</span><br>bar = Bar()<br>bar.add_xaxis([<span class="hljs-string">&quot;衬衫&quot;</span>, <span class="hljs-string">&quot;毛衣&quot;</span>, <span class="hljs-string">&quot;领带&quot;</span>, <span class="hljs-string">&quot;裤子&quot;</span>, <span class="hljs-string">&quot;风衣&quot;</span>, <span class="hljs-string">&quot;高跟鞋&quot;</span>, <span class="hljs-string">&quot;袜子&quot;</span>])<br>bar.add_yaxis(<span class="hljs-string">&quot;商家A&quot;</span>, [<span class="hljs-number">114</span>, <span class="hljs-number">55</span>, <span class="hljs-number">27</span>, <span class="hljs-number">101</span>, <span class="hljs-number">125</span>, <span class="hljs-number">27</span>, <span class="hljs-number">105</span>])<br>bar.add_yaxis(<span class="hljs-string">&quot;商家B&quot;</span>, [<span class="hljs-number">57</span>, <span class="hljs-number">134</span>, <span class="hljs-number">137</span>, <span class="hljs-number">129</span>, <span class="hljs-number">145</span>, <span class="hljs-number">60</span>, <span class="hljs-number">49</span>])<br>bar.set_global_opts(title_opts=opts.TitleOpts(title=<span class="hljs-string">&quot;某商场销售情况&quot;</span>))<br>bar.render()<br></code></pre></td></tr></table></figure><ul><li><strong>Demo</strong>：pyecharts 画廊<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="[pyecharts 画廊](https://github.com/pyecharts/pyecharts-gallery)">[3]</span></a></sup></li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://echarts.apache.org/zh/index.html">echarts 官网</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://github.com/pyecharts/pyecharts">pyecharts仓库</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://github.com/pyecharts/pyecharts-gallery">pyecharts 画廊</a><a href="#fnref:3" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>主题示例</category>
      
    </categories>
    
    
    <tags>
      
      <tag>用户经验</tag>
      
      <tag>花里胡哨</tag>
      
      <tag>Hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello Fluid</title>
    <link href="/2020/04/22/-9-hexo%E6%A0%B7%E4%BE%8B%E6%96%87%E4%BB%B6/hello-fluid/"/>
    <url>/2020/04/22/-9-hexo%E6%A0%B7%E4%BE%8B%E6%96%87%E4%BB%B6/hello-fluid/</url>
    
    <content type="html"><![CDATA[<blockquote><p>欢迎体验 <a href="https://github.com/fluid-dev/hexo-theme-fluid">Fluid</a> ，这是一款 Material Design 风格的 Hexo 主题，以简约的设计帮助你专注于写作，本篇文章可预览主题的样式及功能。</p></blockquote><span id="more"></span><h2 id="文字"><a href="#文字" class="headerlink" title="文字"></a>文字</h2><p>文章大部分使用的是 github-markdown 样式，并加入了一些 Material 风格。</p><h3 id="H3-标题"><a href="#H3-标题" class="headerlink" title="H3 标题"></a>H3 标题</h3><h4 id="H4-标题"><a href="#H4-标题" class="headerlink" title="H4 标题"></a>H4 标题</h4><p><strong>粗体</strong></p><p><em>斜体</em></p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>行内代码：<code>$ hexo new post &quot;My New Post&quot;</code></p><p>代码高亮使用的是 highlight.js，支持 185 种语言和 91 种高亮样式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fib</span>(<span class="hljs-params">n</span>):<br>    a, b = <span class="hljs-number">0</span>, <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> a &lt; n:<br>        <span class="hljs-built_in">print</span>(a, end=<span class="hljs-string">&#x27; &#x27;</span>)<br>        a, b = b, a+b<br>    <span class="hljs-built_in">print</span>()<br>fib(<span class="hljs-number">1000</span>)<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Map <span class="hljs-keyword">struct</span> &#123;<br>    mu Mutex<br>    read atomic.Value<br>    dirty <span class="hljs-keyword">map</span>[<span class="hljs-keyword">interface</span>&#123;&#125;]*entry<br>    misses <span class="hljs-type">int</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h2><table><thead><tr><th align="left">Left</th><th align="center">Center</th><th align="right">Right</th></tr></thead><tbody><tr><td align="left">Key 1</td><td align="center">Value 1</td><td align="right">Comment 1</td></tr><tr><td align="left">Key 2</td><td align="center">Value 2</td><td align="right">Comment 2</td></tr><tr><td align="left">Key 3</td><td align="center">Value 3</td><td align="right">Comment 3</td></tr></tbody></table><h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><h3 id="有序列表"><a href="#有序列表" class="headerlink" title="有序列表"></a>有序列表</h3><p>Fluid 相较于其他主题的优势：</p><ol><li>设计遵循简洁至上，同时具有轻快的体验，和优雅的颜值；</li><li>提供大量定制化配置项，使每个用户使用该主题都能具有独特的样式；</li><li>响应式页面，适配手机、平板等设备；</li></ol><h3 id="无序列表"><a href="#无序列表" class="headerlink" title="无序列表"></a>无序列表</h3><p>Fluid 功能特性：</p><ul><li>无比详实的<a href="https://hexo.fluid-dev.com/docs/">用户文档</a></li><li>页面组件懒加载</li><li>多种代码高亮方案</li><li>多语言配置</li><li>内置多款评论插件</li><li>内置网页访问统计</li><li>内置文章本地搜索</li><li>支持暗色模式</li><li>支持脚注语法</li><li>支持 LaTeX 数学公式</li><li>支持 mermaid 流程图</li></ul><h2 id="图片"><a href="#图片" class="headerlink" title="图片"></a>图片</h2><p><img src="https://fluid.s3.bitiful.net/bg/post.png?w=1280&fmt=webp" alt="这是图片描述"></p><h2 id="LaTex"><a href="#LaTex" class="headerlink" title="LaTex"></a>LaTex</h2><p>基于 MathJax 引擎：</p><p>$$<br>\Gamma _ { \epsilon } ( x ) &#x3D; [ 1- e ^ { - 2\pi \epsilon } ] ^ { 1- x } \prod _ { n &#x3D; 0} ^ { \infty } \frac { 1- \operatorname{exp} ( - 2\pi \epsilon ( n + 1) ) } { 1- \operatorname{exp} ( - 2\pi \epsilon ( x + n ) ) }<br>$$</p><p>$$<br>\left( \begin{array} c t ^ { \prime } \ x ^ { \prime } \ y ^ { \prime } \ z ^ { \prime } \end{array} \right) &#x3D; \left( \begin{array} { c c c c } { \gamma } &amp; { - \gamma \beta } &amp; { 0 } &amp; { 0 } \ { - \gamma \beta } &amp; { \gamma } &amp; { 0 } &amp; { 0 } \ { 0 } &amp; { 0 } &amp; { 1 } &amp; { 0 } \ { 0 } &amp; { 0 } &amp; { 0 } &amp; { 1 } \end{array} \right) \left( \begin{array} c t \ x \ y \ z \end{array} \right)<br>$$</p><p>$$<br>6 \mathrm { CO } _ { 2 } + 6 \mathrm { H } _ { 2 } \mathrm { O } \rightarrow \mathrm { C } _ { 6 } \mathrm { H } _ { 12 } \mathrm { O } _ { 6 } + 6 \mathrm { O } _ { 2 }<br>$$</p><h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><p>基于 mermaid 语法：</p><pre><code class=" mermaid">sequenceDiagramparticipant Aliceparticipant BobAlice-&gt;&gt;John: Hello John, how are you?loop Healthcheck    John-&gt;&gt;John: Fight against hypochondriaendNote right of John: Rational thoughts &lt;br/&gt;prevail...John--&gt;&gt;Alice: Great!John-&gt;&gt;Bob: How about you?Bob--&gt;&gt;John: Jolly good!</code></pre><pre><code class=" mermaid">ganttdateFormat  YYYY-MM-DDtitle Adding GANTT diagram to mermaidsection A sectionCompleted task            :done,    des1, 2014-01-06,2014-01-08Active task               :active,  des2, 2014-01-09, 3dFuture task               :         des3, after des2, 5dFuture task2               :         des4, after des3, 5d</code></pre><pre><code class=" mermaid">classDiagramClass01 &lt;|-- AveryLongClass : CoolClass03 *-- Class04Class05 o-- Class06Class07 .. Class08Class09 --&gt; C2 : Where am i?Class09 --* C3Class09 --|&gt; Class07Class07 : equals()Class07 : Object[] elementDataClass01 : size()Class01 : int chimpClass01 : int gorillaClass08 &lt;--&gt; C2: Cool label</code></pre><h2 id="内置-Tag-插件"><a href="#内置-Tag-插件" class="headerlink" title="内置 Tag 插件"></a>内置 Tag 插件</h2><p>内置了一些 Tag 插件，用于实现 Markdown 不容易生成的样式，具体使用方式请见 <a href="https://hexo.fluid-dev.com/docs/guide/#tag-%E6%8F%92%E4%BB%B6">用户指南</a>。</p><h3 id="便签"><a href="#便签" class="headerlink" title="便签"></a>便签</h3><div class="note note-primary">            <p>这里可以写文字 或者 <code>markdown</code></p>          </div><div class="note note-warning">            <p>这里可以写文字 或者 <code>markdown</code></p>          </div><div class="note note-danger">            <p>这里可以写文字 或者 <code>markdown</code></p>          </div><h3 id="行内标签"><a href="#行内标签" class="headerlink" title="行内标签"></a>行内标签</h3><span class="label label-primary">行内标签</span> <span class="label label-warning">行内标签</span> <span class="label label-danger">行内标签</span><h3 id="勾选框"><a href="#勾选框" class="headerlink" title="勾选框"></a>勾选框</h3><div>            <input type="checkbox"  checked="checked">内置插件，主要是解决一些 Renderer 不支持勾选          </div><div>            <input type="checkbox"  checked="checked">内置插件，主要是解决一些 Renderer 不支持勾选          </div><h3 id="按钮"><a href="#按钮" class="headerlink" title="按钮"></a>按钮</h3><a class="btn" href="javascript:;"  target="_blank">支持链接</a><h3 id="折叠块"><a href="#折叠块" class="headerlink" title="折叠块"></a>折叠块</h3>    <div class="fold">      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-22afdab2" role="button" aria-expanded="false" aria-controls="collapse-22afdab2">        <div class="fold-arrow">▶</div>折叠块的标题      </div>      <div class="fold-collapse collapse" id="collapse-22afdab2">        <div class="fold-content">          <p>折叠内容，可以写文字 或者 <code>markdown</code></p>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-90469042" role="button" aria-expanded="false" aria-controls="collapse-90469042">        <div class="fold-arrow">▶</div>折叠代码块      </div>      <div class="fold-collapse collapse" id="collapse-90469042">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fib</span>(<span class="hljs-params">n</span>):<br>    a, b = <span class="hljs-number">0</span>, <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> a &lt; n:<br>        <span class="hljs-built_in">print</span>(a, end=<span class="hljs-string">&#x27; &#x27;</span>)<br>        a, b = b, a+b<br>    <span class="hljs-built_in">print</span>()<br>fib(<span class="hljs-number">1000</span>)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h3 id="组图"><a href="#组图" class="headerlink" title="组图"></a>组图</h3><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://fluid.s3.bitiful.net/hello-fluid/cover.png?w=480&fmt=webp" alt="图1"></div><div class="group-image-wrap"><img src="https://fluid.s3.bitiful.net/hello-fluid/cover.png?w=480&fmt=webp" alt="图2"></div><div class="group-image-wrap"><img src="https://fluid.s3.bitiful.net/hello-fluid/cover.png?w=480&fmt=webp" alt="图3"></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://fluid.s3.bitiful.net/hello-fluid/cover.png?w=480&fmt=webp" alt="图4"></div><div class="group-image-wrap"><img src="https://fluid.s3.bitiful.net/hello-fluid/cover.png?w=480&fmt=webp" alt="图5"></div></div></div><h3 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h3><p>以下是脚注演示<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="脚注演示">[1]</span></a></sup>：</p><p>如果你有 Fluid 主题或 Hexo 博客相关的文章，可以通过 Pull Request 方式投稿<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="投稿具体详见[https://github.com/fluid-dev/hexo-fluid-blog](https://github.com/fluid-dev/hexo-fluid-blog)">[2]</span></a></sup>。</p><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>脚注演示<a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span>投稿具体详见<a href="https://github.com/fluid-dev/hexo-fluid-blog">https://github.com/fluid-dev/hexo-fluid-blog</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>主题示例</category>
      
    </categories>
    
    
    <tags>
      
      <tag>示例</tag>
      
      <tag>Fluid</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
