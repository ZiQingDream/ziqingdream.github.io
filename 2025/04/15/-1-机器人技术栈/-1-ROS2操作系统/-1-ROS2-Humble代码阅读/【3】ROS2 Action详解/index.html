

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/introduce/avatar.jpg">
  <link rel="icon" href="/img/introduce/avatar.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="工程课代表[B站] / ZiQingDream[Github]">
  <meta name="keywords" content="">
  
    <meta name="description" content="通过代码分析Humble版本ROS2动作服务器细节，解释动作服务器工作机理">
<meta property="og:type" content="article">
<meta property="og:title" content="ROS2 Action详解">
<meta property="og:url" content="https://ziqingdream.github.io/2025/04/15/-1-%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%80%E6%9C%AF%E6%A0%88/-1-ROS2%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/-1-ROS2-Humble%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/%E3%80%903%E3%80%91ROS2%20Action%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="工程课代表 Blog">
<meta property="og:description" content="通过代码分析Humble版本ROS2动作服务器细节，解释动作服务器工作机理">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ziqingdream.github.io/img/ros2-action/Action-SingleActionClient.gif">
<meta property="article:published_time" content="2025-04-14T16:00:00.000Z">
<meta property="article:modified_time" content="2025-06-02T16:29:46.989Z">
<meta property="article:author" content="工程课代表">
<meta property="article:tag" content="ROS2">
<meta property="article:tag" content="Humble">
<meta property="article:tag" content="Action">
<meta property="article:tag" content="ROS2-Action">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://ziqingdream.github.io/img/ros2-action/Action-SingleActionClient.gif">
  
  
  
  <title>ROS2 Action详解 - 工程课代表 Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"ziqingdream.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"LyT8mpSI2Jq9CRhOtNOgBXkE-9Nh9j0Va","app_key":"fUOlkXhD9wcmxOTed9NdlqPH","server_url":"https://lyt8mpsi.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>工程课代表 Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://fluid.s3.bitiful.net/bg/dojm2h.png?w=1920&q=100&fmt=webp') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ROS2 Action详解"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-04-15 00:00" pubdate>
          2025年4月15日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          11k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          89 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">ROS2 Action详解</h1>
            
            
              <div class="markdown-body">
                
                <div class="note note-success">
            <p>本文由 ZiQingDream 编写，未经允许禁止转载。</p><p>本文作者：工程课代表[B站] &#x2F; ZiQingDream[Github]</p>
          </div>

<p>在《ROS2 Executor详解》文章中，我们理解了调度器怎么处理回调和回调组。在《ROS2 Service详解》文章中，我们解释了同步、异步服务操作流程和底层细节。本文将分析ROS2动作服务器架构，以阐述动作服务器复杂的回调、反馈、中断等操作。<br>由于动作服务器本质上是“服务+话题”综合体，之前对于回调、服务等机制，这里就不再赘述，仅结合Action的场景，重点关注动作服务器的回调流程。</p>
<div class="note note-success">
            <p>阅读本文需要你有一定ROS2基本理解，至少要有关于动作服务器基础知识。</p>
          </div>

<h1 id="动作服务器"><a href="#动作服务器" class="headerlink" title="动作服务器"></a>动作服务器</h1><h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;example_interfaces/action/fibonacci.hpp&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp/rclcpp.hpp&quot;</span></span><br><span class="hljs-comment">// TODO(jacobperron): Remove this once it is included as part of &#x27;rclcpp.hpp&#x27;</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp_action/rclcpp_action.hpp&quot;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MinimalActionServer</span> : <span class="hljs-keyword">public</span> rclcpp::Node<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">// 类型重命名，可以有效减少代码长度</span><br>  <span class="hljs-keyword">using</span> Fibonacci = example_interfaces::action::Fibonacci;<br>  <span class="hljs-keyword">using</span> GoalHandleFibonacci = rclcpp_action::ServerGoalHandle&lt;Fibonacci&gt;;<br><br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">MinimalActionServer</span><span class="hljs-params">(<span class="hljs-type">const</span> rclcpp::NodeOptions &amp; options = rclcpp::NodeOptions())</span></span><br><span class="hljs-function">  : Node(<span class="hljs-string">&quot;minimal_action_server&quot;</span>, options)</span><br><span class="hljs-function">  &#123;</span><br>    <span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std::placeholders;<br>    <span class="hljs-comment">// 创建动作服务器服务端：</span><br>    <span class="hljs-comment">// 包含有三个回调：handle_goal用于处理请求到达回调</span><br>    <span class="hljs-comment">//              handle_cancel用于处理取消的回调</span><br>    <span class="hljs-comment">//              handle_accepted用于处理请求被接收回调</span><br>    <span class="hljs-keyword">this</span>-&gt;action_server_ = rclcpp_action::<span class="hljs-built_in">create_server</span>&lt;Fibonacci&gt;(<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_base_interface</span>(),<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_clock_interface</span>(),<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_logging_interface</span>(),<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_waitables_interface</span>(),<br>      <span class="hljs-string">&quot;fibonacci&quot;</span>,<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionServer::handle_goal, <span class="hljs-keyword">this</span>, _1, _2),<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionServer::handle_cancel, <span class="hljs-keyword">this</span>, _1),<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionServer::handle_accepted, <span class="hljs-keyword">this</span>, _1));<br>  &#125;<br><br><span class="hljs-keyword">private</span>:<br>  rclcpp_action::Server&lt;Fibonacci&gt;::SharedPtr action_server_;<br><br>  <span class="hljs-function">rclcpp_action::GoalResponse <span class="hljs-title">handle_goal</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> rclcpp_action::GoalUUID &amp; uuid,</span></span><br><span class="hljs-params"><span class="hljs-function">    std::shared_ptr&lt;<span class="hljs-type">const</span> Fibonacci::Goal&gt; goal)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Received goal request with order %d&quot;</span>, goal-&gt;order);<br>    (<span class="hljs-type">void</span>)uuid;<br>    <span class="hljs-comment">// 拒绝9000以上的计算</span><br>    <span class="hljs-keyword">if</span> (goal-&gt;order &gt; <span class="hljs-number">9000</span>) &#123;<br>      <span class="hljs-keyword">return</span> rclcpp_action::GoalResponse::REJECT;<br>    &#125;<br>    <span class="hljs-keyword">return</span> rclcpp_action::GoalResponse::ACCEPT_AND_EXECUTE;<br>  &#125;<br><br>  <span class="hljs-function">rclcpp_action::CancelResponse <span class="hljs-title">handle_cancel</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::shared_ptr&lt;GoalHandleFibonacci&gt; goal_handle)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-comment">// cancel不做任何处理</span><br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Received request to cancel goal&quot;</span>);<br>    (<span class="hljs-type">void</span>)goal_handle;<br>    <span class="hljs-keyword">return</span> rclcpp_action::CancelResponse::ACCEPT;<br>  &#125;<br><br>  <span class="hljs-comment">// 异步执行流程</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(<span class="hljs-type">const</span> std::shared_ptr&lt;GoalHandleFibonacci&gt; goal_handle)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Executing goal&quot;</span>);<br>    <span class="hljs-function">rclcpp::Rate <span class="hljs-title">loop_rate</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span>;<br><br>    <span class="hljs-comment">// 首先获取goal、feedback</span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> goal = goal_handle-&gt;<span class="hljs-built_in">get_goal</span>();<br>    <span class="hljs-keyword">auto</span> feedback = std::<span class="hljs-built_in">make_shared</span>&lt;Fibonacci::Feedback&gt;();<br>    <span class="hljs-keyword">auto</span> &amp; sequence = feedback-&gt;sequence;<br>    sequence.<span class="hljs-built_in">push_back</span>(<span class="hljs-number">0</span>);<br>    sequence.<span class="hljs-built_in">push_back</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">auto</span> result = std::<span class="hljs-built_in">make_shared</span>&lt;Fibonacci::Result&gt;();<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; (i &lt; goal-&gt;order) &amp;&amp; rclcpp::<span class="hljs-built_in">ok</span>(); ++i) &#123;<br>      <span class="hljs-comment">// 检查是否需要取消，执行取消流程，并反馈已经取消完成</span><br>      <span class="hljs-keyword">if</span> (goal_handle-&gt;<span class="hljs-built_in">is_canceling</span>()) &#123;<br>        result-&gt;sequence = sequence;<br>        goal_handle-&gt;<span class="hljs-built_in">canceled</span>(result);<br>        <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Goal Canceled&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>      <span class="hljs-comment">// Update sequence</span><br>      sequence.<span class="hljs-built_in">push_back</span>(sequence[i] + sequence[i - <span class="hljs-number">1</span>]);<br>      <span class="hljs-comment">// 发布feedback（这个可以不断进行）</span><br>      goal_handle-&gt;<span class="hljs-built_in">publish_feedback</span>(feedback);<br>      <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Publish Feedback&quot;</span>);<br><br>      loop_rate.<span class="hljs-built_in">sleep</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// 成功，反馈最后结果</span><br>    <span class="hljs-keyword">if</span> (rclcpp::<span class="hljs-built_in">ok</span>()) &#123;<br>      result-&gt;sequence = sequence;<br>      goal_handle-&gt;<span class="hljs-built_in">succeed</span>(result);<br>      <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Goal Succeeded&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_accepted</span><span class="hljs-params">(<span class="hljs-type">const</span> std::shared_ptr&lt;GoalHandleFibonacci&gt; goal_handle)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std::placeholders;<br>    <span class="hljs-comment">// 接收不能阻塞，这里直接通过新建一个线程，异步处理计算过程（这个过程可能会很耗时）</span><br>    std::thread&#123;std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionServer::execute, <span class="hljs-keyword">this</span>, _1), goal_handle&#125;.<span class="hljs-built_in">detach</span>();<br>  &#125;<br>&#125;;  <span class="hljs-comment">// class MinimalActionServer</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">init</span>(argc, argv);<br><br>  <span class="hljs-keyword">auto</span> action_server = std::<span class="hljs-built_in">make_shared</span>&lt;MinimalActionServer&gt;();<br><br>  rclcpp::<span class="hljs-built_in">spin</span>(action_server);<br><br>  rclcpp::<span class="hljs-built_in">shutdown</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cinttypes&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;future&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;example_interfaces/action/fibonacci.hpp&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp/rclcpp.hpp&quot;</span></span><br><span class="hljs-comment">// TODO(jacobperron): Remove this once it is included as part of &#x27;rclcpp.hpp&#x27;</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rclcpp_action/rclcpp_action.hpp&quot;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MinimalActionClient</span> : <span class="hljs-keyword">public</span> rclcpp::Node<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-keyword">using</span> Fibonacci = example_interfaces::action::Fibonacci;<br>  <span class="hljs-keyword">using</span> GoalHandleFibonacci = rclcpp_action::ClientGoalHandle&lt;Fibonacci&gt;;<br><br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">MinimalActionClient</span><span class="hljs-params">(<span class="hljs-type">const</span> rclcpp::NodeOptions &amp; node_options = rclcpp::NodeOptions())</span></span><br><span class="hljs-function">  : Node(<span class="hljs-string">&quot;minimal_action_client&quot;</span>, node_options), goal_done_(false)</span><br><span class="hljs-function">  &#123;</span><br>    <span class="hljs-comment">// 创建客户端</span><br>    <span class="hljs-keyword">this</span>-&gt;client_ptr_ = rclcpp_action::<span class="hljs-built_in">create_client</span>&lt;Fibonacci&gt;(<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_base_interface</span>(),<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_graph_interface</span>(),<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_logging_interface</span>(),<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_node_waitables_interface</span>(),<br>      <span class="hljs-string">&quot;fibonacci&quot;</span>);<br><br>    <span class="hljs-keyword">this</span>-&gt;timer_ = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_wall_timer</span>(<br>      std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">500</span>),<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::send_goal, <span class="hljs-keyword">this</span>));<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">is_goal_done</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>-&gt;goal_done_;<br>  &#125;<br><br>  <span class="hljs-comment">// 定时回调函数，每隔500ms，由于会取消定时器，其实只执行了一次</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">send_goal</span><span class="hljs-params">()</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std::placeholders;<br><br>    <span class="hljs-keyword">this</span>-&gt;timer_-&gt;<span class="hljs-built_in">cancel</span>();<br><br>    <span class="hljs-keyword">this</span>-&gt;goal_done_ = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>-&gt;client_ptr_) &#123;<br>      <span class="hljs-built_in">RCLCPP_ERROR</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Action client not initialized&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 等待动作服务被建立</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>-&gt;client_ptr_-&gt;<span class="hljs-built_in">wait_for_action_server</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">10</span>))) &#123;<br>      <span class="hljs-built_in">RCLCPP_ERROR</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Action server not available after waiting&quot;</span>);<br>      <span class="hljs-keyword">this</span>-&gt;goal_done_ = <span class="hljs-literal">true</span>;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 建立计算目标</span><br>    <span class="hljs-keyword">auto</span> goal_msg = Fibonacci::<span class="hljs-built_in">Goal</span>();<br>    goal_msg.order = <span class="hljs-number">10</span>;<br><br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Sending goal&quot;</span>);<br><br>    <span class="hljs-comment">// 执行异步发送，注意这里并没有处理future，直接通过回调处理：</span><br>    <span class="hljs-comment">// 1. goal_response_callback 目标被接受或拒绝的反馈</span><br>    <span class="hljs-comment">// 2. feedback_callback 不断反馈中间结果的反馈</span><br>    <span class="hljs-comment">// 3. result_callback 结果反馈</span><br>    <span class="hljs-keyword">auto</span> send_goal_options = rclcpp_action::Client&lt;Fibonacci&gt;::<span class="hljs-built_in">SendGoalOptions</span>();<br>    send_goal_options.goal_response_callback =<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::goal_response_callback, <span class="hljs-keyword">this</span>, _1);<br>    send_goal_options.feedback_callback =<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::feedback_callback, <span class="hljs-keyword">this</span>, _1, _2);<br>    send_goal_options.result_callback =<br>      std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::result_callback, <span class="hljs-keyword">this</span>, _1);<br>    <span class="hljs-keyword">auto</span> goal_handle_future = <span class="hljs-keyword">this</span>-&gt;client_ptr_-&gt;<span class="hljs-built_in">async_send_goal</span>(goal_msg, send_goal_options);<br>  &#125;<br><br><span class="hljs-keyword">private</span>:<br>  rclcpp_action::Client&lt;Fibonacci&gt;::SharedPtr client_ptr_;<br>  rclcpp::TimerBase::SharedPtr timer_;<br>  <span class="hljs-type">bool</span> goal_done_;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">goal_response_callback</span><span class="hljs-params">(GoalHandleFibonacci::SharedPtr goal_handle)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">if</span> (!goal_handle) &#123;<br>      <span class="hljs-built_in">RCLCPP_ERROR</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Goal was rejected by server&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Goal accepted by server, waiting for result&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">feedback_callback</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    GoalHandleFibonacci::SharedPtr,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::shared_ptr&lt;<span class="hljs-type">const</span> Fibonacci::Feedback&gt; feedback)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(),<br>      <span class="hljs-string">&quot;Next number in sequence received: %&quot;</span> PRId32,<br>      feedback-&gt;sequence.<span class="hljs-built_in">back</span>());<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">result_callback</span><span class="hljs-params">(<span class="hljs-type">const</span> GoalHandleFibonacci::WrappedResult &amp; result)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">this</span>-&gt;goal_done_ = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">switch</span> (result.code) &#123;<br>      <span class="hljs-keyword">case</span> rclcpp_action::ResultCode::SUCCEEDED:<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> rclcpp_action::ResultCode::ABORTED:<br>        <span class="hljs-built_in">RCLCPP_ERROR</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Goal was aborted&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>      <span class="hljs-keyword">case</span> rclcpp_action::ResultCode::CANCELED:<br>        <span class="hljs-built_in">RCLCPP_ERROR</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Goal was canceled&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">RCLCPP_ERROR</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Unknown result code&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Result received&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> number : result.result-&gt;sequence) &#123;<br>      <span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;%&quot;</span> PRId32, number);<br>    &#125;<br>  &#125;<br>&#125;;  <span class="hljs-comment">// class MinimalActionClient</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span></span><br><span class="hljs-function"></span>&#123;<br>  rclcpp::<span class="hljs-built_in">init</span>(argc, argv);<br>  <span class="hljs-keyword">auto</span> action_client = std::<span class="hljs-built_in">make_shared</span>&lt;MinimalActionClient&gt;();<br><br>  <span class="hljs-keyword">while</span> (!action_client-&gt;<span class="hljs-built_in">is_goal_done</span>()) &#123;<br>    rclcpp::<span class="hljs-built_in">spin_some</span>(action_client);<br>  &#125;<br><br>  rclcpp::<span class="hljs-built_in">shutdown</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h1 id="动作服务器处理机制"><a href="#动作服务器处理机制" class="headerlink" title="动作服务器处理机制"></a>动作服务器处理机制</h1><p>在ROS2官方网站有动作服务器可视化介绍，整个处理流程如图（<a target="_blank" rel="noopener" href="https://docs.ros.org/en/humble/Tutorials/Beginner-CLI-Tools/Understanding-ROS2-Actions/Understanding-ROS2-Actions.html">Understanding actions — ROS 2 Documentation: Humble documentation</a>）：</p>
<p><img src="/img/ros2-action/Action-SingleActionClient.gif" srcset="/img/loading.gif" lazyload></p>
<p>动作服务器正常情况下的复杂交互流程可以总结为以下5个阶段：</p>
<ol>
<li>Goal Service客户端向Goal Service服务端发送请求</li>
<li>Goal Service服务端反馈目标接受状态：接收或拒绝</li>
<li>Result Service客户端向Result Service服务端发送请求</li>
<li>动作服务器开始计算，并通过Feedback Topic反馈中间结果</li>
<li>最终结果计算完毕后，Result Service服务端反馈结果给Result Service客户端<br>由以上的交互流程可知：</li>
</ol>
<ul>
<li>动作服务器<strong>客户端</strong>至少包含以下组合：“Goal Service Client + Feedback Subscriber + Result Service Client”；</li>
<li>动作服务器<strong>服务端</strong>至少包含以下组合：“Goal Service Server + Feedback Publisher + Result Service Server”。</li>
</ul>
<h1 id="动作服务器拆分"><a href="#动作服务器拆分" class="headerlink" title="动作服务器拆分"></a>动作服务器拆分</h1><p>为了清楚说明以上交互逻辑，我们将详细拆解“动作服务器服务端+动作服务器客户端”代码，由于整个流程冗长和复杂，读者可以分部阅读：</p>
<h2 id="动作服务器创建"><a href="#动作服务器创建" class="headerlink" title="动作服务器创建"></a>动作服务器创建</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 客户端创建代码</span><br><span class="hljs-keyword">this</span>-&gt;client_ptr_ = rclcpp_action::create_client&lt;Fibonacci&gt;(<br>  <span class="hljs-keyword">this</span>-&gt;get_node_base_interface(),<br>  <span class="hljs-keyword">this</span>-&gt;get_node_graph_interface(),<br>  <span class="hljs-keyword">this</span>-&gt;get_node_logging_interface(),<br>  <span class="hljs-keyword">this</span>-&gt;get_node_waitables_interface(),<br>  <span class="hljs-string">&quot;fibonacci&quot;</span>);<br><br><span class="hljs-comment">// 服务端创建代码</span><br><span class="hljs-keyword">this</span>-&gt;action_server_ = rclcpp_action::create_server&lt;Fibonacci&gt;(<br>  <span class="hljs-keyword">this</span>-&gt;get_node_base_interface(),<br>  <span class="hljs-keyword">this</span>-&gt;get_node_clock_interface(),<br>  <span class="hljs-keyword">this</span>-&gt;get_node_logging_interface(),<br>  <span class="hljs-keyword">this</span>-&gt;get_node_waitables_interface(),<br>  <span class="hljs-string">&quot;fibonacci&quot;</span>,<br>  std::bind(&amp;MinimalActionServer::handle_goal, <span class="hljs-keyword">this</span>, _1, _2),<br>  std::bind(&amp;MinimalActionServer::handle_cancel, <span class="hljs-keyword">this</span>, _1),<br>  std::bind(&amp;MinimalActionServer::handle_accepted, <span class="hljs-keyword">this</span>, _1));<br></code></pre></td></tr></table></figure>

<h2 id="动作服务器服务端"><a href="#动作服务器服务端" class="headerlink" title="动作服务器服务端"></a>动作服务器服务端</h2><p>其中rclcpp_action::create_server()执行服务端创建，代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/create_server.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">typename</span> Server&lt;ActionT&gt;::<span class="hljs-function">SharedPtr</span><br><span class="hljs-function"><span class="hljs-title">create_server</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeClockInterface::SharedPtr node_clock_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeWaitablesInterface::SharedPtr node_waitables_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> std::string &amp; name,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-keyword">typename</span> Server&lt;ActionT&gt;::GoalCallback handle_goal,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-keyword">typename</span> Server&lt;ActionT&gt;::CancelCallback handle_cancel,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-keyword">typename</span> Server&lt;ActionT&gt;::AcceptedCallback handle_accepted,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_server_options_t</span> &amp; options = rcl_action_server_get_default_options(),</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::CallbackGroup::SharedPtr group = <span class="hljs-literal">nullptr</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  std::weak_ptr&lt;rclcpp::node_interfaces::NodeWaitablesInterface&gt; weak_node =<br>    node_waitables_interface;<br>  std::weak_ptr&lt;rclcpp::CallbackGroup&gt; weak_group = group;<br>  <span class="hljs-type">bool</span> group_is_null = (<span class="hljs-literal">nullptr</span> == group.<span class="hljs-built_in">get</span>());<br><br>  <span class="hljs-keyword">auto</span> deleter = [weak_node, weak_group, group_is_null](Server&lt;ActionT&gt; * ptr)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> == ptr) &#123;<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>      <span class="hljs-keyword">auto</span> shared_node = weak_node.<span class="hljs-built_in">lock</span>();<br>      <span class="hljs-keyword">if</span> (shared_node) &#123;<br>        <span class="hljs-comment">// API expects a shared pointer, give it one with a deleter that does nothing.</span><br>        std::shared_ptr&lt;Server&lt;ActionT&gt;&gt; <span class="hljs-built_in">fake_shared_ptr</span>(ptr, [](Server&lt;ActionT&gt; *) &#123;&#125;);<br><br>        <span class="hljs-keyword">if</span> (group_is_null) &#123;<br>          <span class="hljs-comment">// Was added to default group</span><br>          shared_node-&gt;<span class="hljs-built_in">remove_waitable</span>(fake_shared_ptr, <span class="hljs-literal">nullptr</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// Was added to a specific group</span><br>          <span class="hljs-keyword">auto</span> shared_group = weak_group.<span class="hljs-built_in">lock</span>();<br>          <span class="hljs-keyword">if</span> (shared_group) &#123;<br>            shared_node-&gt;<span class="hljs-built_in">remove_waitable</span>(fake_shared_ptr, shared_group);<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">delete</span> ptr;<br>    &#125;;<br><br>  std::shared_ptr&lt;Server&lt;ActionT&gt;&gt; <span class="hljs-built_in">action_server</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Server</span>&lt;ActionT&gt;(<br>      node_base_interface,<br>      node_clock_interface,<br>      node_logging_interface,<br>      name,<br>      options,<br>      handle_goal,<br>      handle_cancel,<br>      handle_accepted), deleter);<br><br>  node_waitables_interface-&gt;<span class="hljs-built_in">add_waitable</span>(action_server, group);<br>  <span class="hljs-keyword">return</span> action_server;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>从create_server()代码中可以看出，程序直接新建Server&lt; ActionT &gt;对象并返回，该对象就是动作服务器内部表示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> : <span class="hljs-keyword">public</span> ServerBase, <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;Server&lt;ActionT&gt;&gt;<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">RCLCPP_SMART_PTR_DEFINITIONS_NOT_COPYABLE</span>(Server)<br><br>  <span class="hljs-comment">/// Signature of a callback that accepts or rejects goal requests.</span><br>  <span class="hljs-keyword">using</span> GoalCallback = std::function&lt;<span class="hljs-built_in">GoalResponse</span>(<br>        <span class="hljs-type">const</span> GoalUUID &amp;, std::shared_ptr&lt;<span class="hljs-type">const</span> <span class="hljs-keyword">typename</span> ActionT::Goal&gt;)&gt;;<br>  <span class="hljs-comment">/// Signature of a callback that accepts or rejects requests to cancel a goal.</span><br>  <span class="hljs-keyword">using</span> CancelCallback = std::function&lt;<span class="hljs-built_in">CancelResponse</span>(std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;<br>  <span class="hljs-comment">/// Signature of a callback that is used to notify when the goal has been accepted.</span><br>  <span class="hljs-keyword">using</span> AcceptedCallback = std::function&lt;<span class="hljs-built_in">void</span> (std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;<br><br>  <span class="hljs-comment">/// Construct an action server.</span><br>  <span class="hljs-built_in">Server</span>(<br>    rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,<br>    rclcpp::node_interfaces::NodeClockInterface::SharedPtr node_clock,<br>    rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,<br>    <span class="hljs-type">const</span> std::string &amp; name,<br>    <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_server_options_t</span> &amp; options,<br>    GoalCallback handle_goal,<br>    CancelCallback handle_cancel,<br>    AcceptedCallback handle_accepted<br>  )<br>  : <span class="hljs-built_in">ServerBase</span>(<br>      node_base,<br>      node_clock,<br>      node_logging,<br>      name,<br>      rosidl_typesupport_cpp::<span class="hljs-built_in">get_action_type_support_handle</span>&lt;ActionT&gt;(),<br>      options),<br>    <span class="hljs-built_in">handle_goal_</span>(handle_goal),<br>    <span class="hljs-built_in">handle_cancel_</span>(handle_cancel),<br>    <span class="hljs-built_in">handle_accepted_</span>(handle_accepted)<br>  &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Server</span>() = <span class="hljs-keyword">default</span>;<br>  ...... <span class="hljs-comment">// 其他代码逻辑</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>在Server构造函数中构建了ServerBase类，这个类继承自rclcpp::Waitable，表示RCL可等待对象，本质上和ROS2话题等类似，可以被调度、等待。从这个角度看，任何一个动作服务器，都是一个可等待的对象。在ServerBase构造函数中，执行服务初始化动作，具体流程如下代码注释：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/server.hpp</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ServerBase</span> : <span class="hljs-keyword">public</span> rclcpp::Waitable<br>&#123;<br>...... <span class="hljs-comment">// 其他代码</span><br><span class="hljs-keyword">public</span>:<br>  RCLCPP_ACTION_PUBLIC<br>  <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">ServerBase</span>();<br><br><span class="hljs-keyword">protected</span>:<br>  <span class="hljs-function">RCLCPP_ACTION_PUBLIC</span><br><span class="hljs-function">  <span class="hljs-title">ServerBase</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,</span></span><br><span class="hljs-params"><span class="hljs-function">    rclcpp::node_interfaces::NodeClockInterface::SharedPtr node_clock,</span></span><br><span class="hljs-params"><span class="hljs-function">    rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::string &amp; name,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_server_options_t</span> &amp; options)</span></span>;<br>...... <span class="hljs-comment">// 其他代码</span><br>&#125;;<br><br><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/src/server.cpp</span><br>ServerBase::<span class="hljs-built_in">ServerBase</span>(<br>  rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,<br>  rclcpp::node_interfaces::NodeClockInterface::SharedPtr node_clock,<br>  rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,<br>  <span class="hljs-type">const</span> std::string &amp; name,<br>  <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,<br>  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_server_options_t</span> &amp; options<br>)<br><span class="hljs-comment">// 这里初始化内部数据结果ServerBaseImpl</span><br>: <span class="hljs-built_in">pimpl_</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ServerBaseImpl</span>(<br>      node_clock-&gt;<span class="hljs-built_in">get_clock</span>(), node_logging-&gt;<span class="hljs-built_in">get_logger</span>().<span class="hljs-built_in">get_child</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>)))<br>&#123;<br>  <span class="hljs-keyword">auto</span> deleter = [node_base](<span class="hljs-type">rcl_action_server_t</span> * ptr)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> != ptr) &#123;<br>        <span class="hljs-type">rcl_node_t</span> * rcl_node = node_base-&gt;<span class="hljs-built_in">get_rcl_node_handle</span>();<br>        <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_server_fini</span>(ptr, rcl_node);<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>          <span class="hljs-built_in">RCLCPP_DEBUG</span>(<br>            rclcpp::<span class="hljs-built_in">get_logger</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>),<br>            <span class="hljs-string">&quot;failed to fini rcl_action_server_t in deleter&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">delete</span> ptr;<br>      &#125;<br>    &#125;;<br><br>  <span class="hljs-comment">// 首先创建一个动作服务器，并清理服务器数据结构</span><br>  <span class="hljs-comment">// 值得注意的是这里的pimpl_本质上就是动作服务器（PIMPL模式）</span><br>  pimpl_-&gt;action_server_.<span class="hljs-built_in">reset</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">rcl_action_server_t</span>, deleter);<br>  *(pimpl_-&gt;action_server_) = <span class="hljs-built_in">rcl_action_get_zero_initialized_server</span>();<br><br>  <span class="hljs-type">rcl_node_t</span> * rcl_node = node_base-&gt;<span class="hljs-built_in">get_rcl_node_handle</span>();<br>  <span class="hljs-type">rcl_clock_t</span> * rcl_clock = pimpl_-&gt;clock_-&gt;<span class="hljs-built_in">get_clock_handle</span>();<br><br>  <span class="hljs-comment">// 执行动作服务器的初始化（RCL层）</span><br>  <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_server_init</span>(<br>    pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), rcl_node, rcl_clock, type_support, name.<span class="hljs-built_in">c_str</span>(), &amp;options);<br><br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br><br>  ret = <span class="hljs-built_in">rcl_action_server_wait_set_get_num_entities</span>(<br>    pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(),<br>    &amp;pimpl_-&gt;num_subscriptions_,<br>    &amp;pimpl_-&gt;num_guard_conditions_,<br>    &amp;pimpl_-&gt;num_timers_,<br>    &amp;pimpl_-&gt;num_clients_,<br>    &amp;pimpl_-&gt;num_services_);<br><br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ServerBase::ServerBase()程序通过rcl_action_server_init()初始化RCL动作服务器：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rcl/rcl_action/src/rcl_action/action_server_impl.h</span><br><span class="hljs-comment">/// rcl动作服务器内部实现结构体</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcl_action_server_impl_s</span><br>&#123;<br>  <span class="hljs-type">rcl_service_t</span> goal_service;<br>  <span class="hljs-type">rcl_service_t</span> cancel_service;<br>  <span class="hljs-type">rcl_service_t</span> result_service;<br>  <span class="hljs-type">rcl_publisher_t</span> feedback_publisher;<br>  <span class="hljs-type">rcl_publisher_t</span> status_publisher;<br>  <span class="hljs-type">rcl_timer_t</span> expire_timer;<br>  <span class="hljs-type">char</span> * action_name;<br>  <span class="hljs-type">rcl_action_server_options_t</span> options;<br>  <span class="hljs-comment">// Array of goal handles</span><br>  <span class="hljs-type">rcl_action_goal_handle_t</span> ** goal_handles;<br>  <span class="hljs-type">size_t</span> num_goal_handles;<br>  <span class="hljs-comment">// Clock</span><br>  <span class="hljs-type">rcl_clock_t</span> * clock;<br>  <span class="hljs-comment">// Wait set records</span><br>  <span class="hljs-type">size_t</span> wait_set_goal_service_index;<br>  <span class="hljs-type">size_t</span> wait_set_cancel_service_index;<br>  <span class="hljs-type">size_t</span> wait_set_result_service_index;<br>  <span class="hljs-type">size_t</span> wait_set_expire_timer_index;<br>&#125; <span class="hljs-type">rcl_action_server_impl_t</span>;<br><br><span class="hljs-comment">// src/ros2/rcl/rcl_action/include/rcl_action/action_server.h</span><br><span class="hljs-comment">/// Internal rcl_action implementation struct.</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcl_action_server_impl_s</span> <span class="hljs-type">rcl_action_server_impl_t</span>;<br><br><span class="hljs-comment">/// Structure which encapsulates a ROS Action Server.</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcl_action_server_s</span><br>&#123;<br>  <span class="hljs-comment">/// Pointer to the action server implementation</span><br>  <span class="hljs-type">rcl_action_server_impl_t</span> * impl;<br>&#125; <span class="hljs-type">rcl_action_server_t</span>;<br><br><span class="hljs-comment">// src/ros2/rcl/rcl_action/src/rcl_action/action_server.c（注意这里是C代码）</span><br><span class="hljs-function"><span class="hljs-type">rcl_ret_t</span></span><br><span class="hljs-function"><span class="hljs-title">rcl_action_server_init</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">rcl_action_server_t</span> * action_server,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">rcl_node_t</span> * node,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">rcl_clock_t</span> * clock,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">char</span> * action_name,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_server_options_t</span> * options)</span></span><br><span class="hljs-function"></span>&#123;<br>  ......<span class="hljs-comment">// 参数检查代码</span><br>  <span class="hljs-comment">// 为动作服务内部数据结构申请内存</span><br>  action_server-&gt;impl = (<span class="hljs-type">rcl_action_server_impl_t</span> *)allocator.<span class="hljs-built_in">allocate</span>(<br>    <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">rcl_action_server_impl_t</span>), allocator.state);<br>  <span class="hljs-built_in">RCL_CHECK_FOR_NULL_WITH_MSG</span>(<br>    action_server-&gt;impl, <span class="hljs-string">&quot;allocating memory failed&quot;</span>, <span class="hljs-keyword">return</span> RCL_RET_BAD_ALLOC);<br><br>  <span class="hljs-comment">// 对新申请内存进行零初始化</span><br>  action_server-&gt;impl-&gt;goal_service = <span class="hljs-built_in">rcl_get_zero_initialized_service</span>();<br>  action_server-&gt;impl-&gt;cancel_service = <span class="hljs-built_in">rcl_get_zero_initialized_service</span>();<br>  action_server-&gt;impl-&gt;result_service = <span class="hljs-built_in">rcl_get_zero_initialized_service</span>();<br>  action_server-&gt;impl-&gt;expire_timer = <span class="hljs-built_in">rcl_get_zero_initialized_timer</span>();<br>  action_server-&gt;impl-&gt;feedback_publisher = <span class="hljs-built_in">rcl_get_zero_initialized_publisher</span>();<br>  action_server-&gt;impl-&gt;status_publisher = <span class="hljs-built_in">rcl_get_zero_initialized_publisher</span>();<br>  action_server-&gt;impl-&gt;action_name = <span class="hljs-literal">NULL</span>;<br>  action_server-&gt;impl-&gt;options = *options;  <span class="hljs-comment">// copy options</span><br>  action_server-&gt;impl-&gt;goal_handles = <span class="hljs-literal">NULL</span>;<br>  action_server-&gt;impl-&gt;num_goal_handles = <span class="hljs-number">0u</span>;<br>  action_server-&gt;impl-&gt;clock = <span class="hljs-literal">NULL</span>;<br><br>  <span class="hljs-type">rcl_ret_t</span> ret = RCL_RET_OK;<br>  <span class="hljs-comment">// 以下部分是通过C宏函数来初始化rcl变量，这里就不展开了</span><br>  <span class="hljs-comment">// 初始化action_server-&gt;impl-&gt;goal_service</span><br>  <span class="hljs-built_in">SERVICE_INIT</span>(goal);<br>  <span class="hljs-comment">// 初始化action_server-&gt;impl-&gt;cancel_service</span><br>  <span class="hljs-built_in">SERVICE_INIT</span>(cancel);<br>  <span class="hljs-comment">// 初始化action_server-&gt;impl-&gt;result_service</span><br>  <span class="hljs-built_in">SERVICE_INIT</span>(result);<br><br>  <span class="hljs-comment">// 初始化action_server-&gt;impl-&gt;feedback_publisher</span><br>  <span class="hljs-built_in">PUBLISHER_INIT</span>(feedback);<br>  <span class="hljs-comment">// 初始化action_server-&gt;impl-&gt;status_publisher</span><br>  <span class="hljs-built_in">PUBLISHER_INIT</span>(status);<br><br>  <span class="hljs-comment">// Store reference to clock</span><br>  action_server-&gt;impl-&gt;clock = clock;<br><br><span class="hljs-comment">// 初始化action_server-&gt;impl-&gt;expire_timer超时定时器</span><br>  ret = <span class="hljs-built_in">rcl_timer_init</span>(<br>    &amp;action_server-&gt;impl-&gt;expire_timer, action_server-&gt;impl-&gt;clock, node-&gt;context,<br>    options-&gt;result_timeout.nanoseconds, <span class="hljs-literal">NULL</span>, allocator);<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    <span class="hljs-keyword">goto</span> fail;<br>  &#125;<br>  <span class="hljs-comment">// Cancel timer so it doesn&#x27;t start firing</span><br>  ret = <span class="hljs-built_in">rcl_timer_cancel</span>(&amp;action_server-&gt;impl-&gt;expire_timer);<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    <span class="hljs-keyword">goto</span> fail;<br>  &#125;<br><br>  <span class="hljs-comment">// Copy action name</span><br>  action_server-&gt;impl-&gt;action_name = <span class="hljs-built_in">rcutils_strdup</span>(action_name, allocator);<br>  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == action_server-&gt;impl-&gt;action_name) &#123;<br>    ret = RCL_RET_BAD_ALLOC;<br>    <span class="hljs-keyword">goto</span> fail;<br>  &#125;<br>  <span class="hljs-keyword">return</span> ret;<br>fail:<br>  &#123;<br>    <span class="hljs-comment">// Finalize any services/publishers that were initialized and deallocate action_server-&gt;impl</span><br>    <span class="hljs-type">rcl_ret_t</span> ret_throwaway = <span class="hljs-built_in">rcl_action_server_fini</span>(action_server, node);<br>    <span class="hljs-comment">// Since there is already a failure, it is likely that finalize will error on one or more of</span><br>    <span class="hljs-comment">// the action servers members</span><br>    (<span class="hljs-type">void</span>)ret_throwaway;<br>  &#125;<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>rcl_action_server_init()对动作服务器服务端初始化，该函数在RCL层建立了多个调用对象，如前所述包括：</p>
<ul>
<li>Goal Service Server：目标服务器服务端，用于Goal接收，并确定是接收还是拒绝目标</li>
<li>Cancel Service Server：取消服务器服务端，用于Goal取消操作</li>
<li>Result Service Server：结果服务器服务端，用于Result请求接收，并反馈最后结果</li>
<li>Feedback Publisher：反馈发布者，用于Feedback的不断反馈</li>
<li>Status Publiser：状态发布者，用于自身状态发布</li>
<li>Expire timer：超时定时器</li>
</ul>
<h2 id="动作服务器客户端"><a href="#动作服务器客户端" class="headerlink" title="动作服务器客户端"></a>动作服务器客户端</h2><p>rclcpp_action::create_client()创建动作服务器客户端，具体代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/create_client.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">typename</span> Client&lt;ActionT&gt;::<span class="hljs-function">SharedPtr</span><br><span class="hljs-function"><span class="hljs-title">create_client</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeGraphInterface::SharedPtr node_graph_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::node_interfaces::NodeWaitablesInterface::SharedPtr node_waitables_interface,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> std::string &amp; name,</span></span><br><span class="hljs-params"><span class="hljs-function">  rclcpp::CallbackGroup::SharedPtr group = <span class="hljs-literal">nullptr</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_client_options_t</span> &amp; options = rcl_action_client_get_default_options())</span></span><br><span class="hljs-function"></span>&#123;<br>  std::weak_ptr&lt;rclcpp::node_interfaces::NodeWaitablesInterface&gt; weak_node =<br>    node_waitables_interface;<br>  std::weak_ptr&lt;rclcpp::CallbackGroup&gt; weak_group = group;<br>  <span class="hljs-type">bool</span> group_is_null = (<span class="hljs-literal">nullptr</span> == group.<span class="hljs-built_in">get</span>());<br><br>  <span class="hljs-keyword">auto</span> deleter = [weak_node, weak_group, group_is_null](Client&lt;ActionT&gt; * ptr)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> == ptr) &#123;<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>      <span class="hljs-keyword">auto</span> shared_node = weak_node.<span class="hljs-built_in">lock</span>();<br>      <span class="hljs-keyword">if</span> (shared_node) &#123;<br>        <span class="hljs-comment">// API expects a shared pointer, give it one with a deleter that does nothing.</span><br>        std::shared_ptr&lt;Client&lt;ActionT&gt;&gt; <span class="hljs-built_in">fake_shared_ptr</span>(ptr, [](Client&lt;ActionT&gt; *) &#123;&#125;);<br><br>        <span class="hljs-keyword">if</span> (group_is_null) &#123;<br>          <span class="hljs-comment">// Was added to default group</span><br>          shared_node-&gt;<span class="hljs-built_in">remove_waitable</span>(fake_shared_ptr, <span class="hljs-literal">nullptr</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// Was added to a specific group</span><br>          <span class="hljs-keyword">auto</span> shared_group = weak_group.<span class="hljs-built_in">lock</span>();<br>          <span class="hljs-keyword">if</span> (shared_group) &#123;<br>            shared_node-&gt;<span class="hljs-built_in">remove_waitable</span>(fake_shared_ptr, shared_group);<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">delete</span> ptr;<br>    &#125;;<br><br>  std::shared_ptr&lt;Client&lt;ActionT&gt;&gt; <span class="hljs-built_in">action_client</span>(<br>    <span class="hljs-keyword">new</span> <span class="hljs-built_in">Client</span>&lt;ActionT&gt;(<br>      node_base_interface,<br>      node_graph_interface,<br>      node_logging_interface,<br>      name,<br>      options),<br>    deleter);<br><br>  node_waitables_interface-&gt;<span class="hljs-built_in">add_waitable</span>(action_client, group);<br>  <span class="hljs-keyword">return</span> action_client;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码基本和动作服务器服务端类似，代码新建的Client&lt; ActionT &gt;对象指针， 同样的每一个客户端也是一个可等待对象：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/client.hpp</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> : <span class="hljs-keyword">public</span> ClientBase<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">RCLCPP_SMART_PTR_DEFINITIONS_NOT_COPYABLE</span>(Client&lt;ActionT&gt;)<br><br>  <span class="hljs-keyword">using</span> Goal = <span class="hljs-keyword">typename</span> ActionT::Goal;<br>  <span class="hljs-keyword">using</span> Feedback = <span class="hljs-keyword">typename</span> ActionT::Feedback;<br>  <span class="hljs-keyword">using</span> GoalHandle = ClientGoalHandle&lt;ActionT&gt;;<br>  <span class="hljs-keyword">using</span> WrappedResult = <span class="hljs-keyword">typename</span> GoalHandle::WrappedResult;<br>  <span class="hljs-keyword">using</span> GoalResponseCallback = std::function&lt;<span class="hljs-built_in">void</span> (<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr)&gt;;<br>  <span class="hljs-keyword">using</span> FeedbackCallback = <span class="hljs-keyword">typename</span> GoalHandle::FeedbackCallback;<br>  <span class="hljs-keyword">using</span> ResultCallback = <span class="hljs-keyword">typename</span> GoalHandle::ResultCallback;<br>  <span class="hljs-keyword">using</span> CancelRequest = <span class="hljs-keyword">typename</span> ActionT::Impl::CancelGoalService::Request;<br>  <span class="hljs-keyword">using</span> CancelResponse = <span class="hljs-keyword">typename</span> ActionT::Impl::CancelGoalService::Response;<br>  <span class="hljs-keyword">using</span> CancelCallback = std::function&lt;<span class="hljs-built_in">void</span> (<span class="hljs-keyword">typename</span> CancelResponse::SharedPtr)&gt;;<br><br>  <span class="hljs-comment">/// Options for sending a goal.</span><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * This struct is used to pass parameters to the function `async_send_goal`.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SendGoalOptions</span><br>  &#123;<br>    <span class="hljs-built_in">SendGoalOptions</span>()<br>    : <span class="hljs-built_in">goal_response_callback</span>(<span class="hljs-literal">nullptr</span>),<br>      <span class="hljs-built_in">feedback_callback</span>(<span class="hljs-literal">nullptr</span>),<br>      <span class="hljs-built_in">result_callback</span>(<span class="hljs-literal">nullptr</span>)<br>    &#123;<br>    &#125;<br><br>    <span class="hljs-comment">/// Function called when the goal is accepted or rejected.</span><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Takes a single argument that is a goal handle shared pointer.</span><br><span class="hljs-comment">     * If the goal is accepted, then the pointer points to a valid goal handle.</span><br><span class="hljs-comment">     * If the goal is rejected, then pointer has the value `nullptr`.</span><br><span class="hljs-comment">     */</span><br>    GoalResponseCallback goal_response_callback;<br><br>    <span class="hljs-comment">/// Function called whenever feedback is received for the goal.</span><br>    FeedbackCallback feedback_callback;<br><br>    <span class="hljs-comment">/// Function called when the result for the goal is received.</span><br>    ResultCallback result_callback;<br>  &#125;;<br><br>  <span class="hljs-comment">/// Construct an action client.</span><br>  <span class="hljs-built_in">Client</span>(<br>    rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,<br>    rclcpp::node_interfaces::NodeGraphInterface::SharedPtr node_graph,<br>    rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,<br>    <span class="hljs-type">const</span> std::string &amp; action_name,<br>    <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_client_options_t</span> &amp; client_options = <span class="hljs-built_in">rcl_action_client_get_default_options</span>()<br>  )<br>  : <span class="hljs-built_in">ClientBase</span>(<br>      node_base, node_graph, node_logging, action_name,<br>      rosidl_typesupport_cpp::<span class="hljs-built_in">get_action_type_support_handle</span>&lt;ActionT&gt;(),<br>      client_options)<br>  &#123;<br>  &#125;<br>  ......<span class="hljs-comment">// 其他代码</span><br>&#125;;<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientBase</span> : <span class="hljs-keyword">public</span> rclcpp::Waitable<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  RCLCPP_ACTION_PUBLIC<br>  <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">ClientBase</span>();<br><br>  <span class="hljs-comment">/// Enum to identify entities belonging to the action client</span><br>  <span class="hljs-keyword">enum class</span> <span class="hljs-title class_">EntityType</span> : std::<span class="hljs-type">size_t</span><br>  &#123;<br>    GoalClient,<br>    ResultClient,<br>    CancelClient,<br>    FeedbackSubscription,<br>    StatusSubscription,<br>  &#125;;<br><br><span class="hljs-keyword">protected</span>:<br>  <span class="hljs-function">RCLCPP_ACTION_PUBLIC</span><br><span class="hljs-function">  <span class="hljs-title">ClientBase</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,</span></span><br><span class="hljs-params"><span class="hljs-function">    rclcpp::node_interfaces::NodeGraphInterface::SharedPtr node_graph,</span></span><br><span class="hljs-params"><span class="hljs-function">    rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::string &amp; action_name,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_client_options_t</span> &amp; options)</span></span>;<br>  ......<span class="hljs-comment">// 其他代码逻辑</span><br>&#125;;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientBaseImpl</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">ClientBaseImpl</span>(<br>    rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,<br>    rclcpp::node_interfaces::NodeGraphInterface::SharedPtr node_graph,<br>    rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,<br>    <span class="hljs-type">const</span> std::string &amp; action_name,<br>    <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,<br>    <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_client_options_t</span> &amp; client_options)<br>  : <span class="hljs-built_in">node_graph_</span>(node_graph),<br>    <span class="hljs-built_in">node_handle</span>(node_base-&gt;<span class="hljs-built_in">get_shared_rcl_node_handle</span>()),<br>    <span class="hljs-built_in">logger</span>(node_logging-&gt;<span class="hljs-built_in">get_logger</span>().<span class="hljs-built_in">get_child</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>)),<br>    <span class="hljs-built_in">random_bytes_generator</span>(std::random_device&#123;&#125;())<br>  &#123;<br>    <span class="hljs-function">std::weak_ptr&lt;<span class="hljs-type">rcl_node_t</span>&gt; <span class="hljs-title">weak_node_handle</span><span class="hljs-params">(node_handle)</span></span>;<br>    client_handle = std::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-type">rcl_action_client_t</span>&gt;(<br>      <span class="hljs-keyword">new</span> <span class="hljs-type">rcl_action_client_t</span>, [weak_node_handle](<span class="hljs-type">rcl_action_client_t</span> * client)<br>      &#123;<br>        <span class="hljs-keyword">auto</span> handle = weak_node_handle.<span class="hljs-built_in">lock</span>();<br>        <span class="hljs-keyword">if</span> (handle) &#123;<br>          <span class="hljs-keyword">if</span> (RCL_RET_OK != <span class="hljs-built_in">rcl_action_client_fini</span>(client, handle.<span class="hljs-built_in">get</span>())) &#123;<br>            <span class="hljs-built_in">RCLCPP_ERROR</span>(<br>              rclcpp::<span class="hljs-built_in">get_logger</span>(<span class="hljs-built_in">rcl_node_get_logger_name</span>(handle.<span class="hljs-built_in">get</span>())).<span class="hljs-built_in">get_child</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>),<br>              <span class="hljs-string">&quot;Error in destruction of rcl action client handle: %s&quot;</span>, <span class="hljs-built_in">rcl_get_error_string</span>().str);<br>            <span class="hljs-built_in">rcl_reset_error</span>();<br>          &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-built_in">RCLCPP_ERROR</span>(<br>            rclcpp::<span class="hljs-built_in">get_logger</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>),<br>            <span class="hljs-string">&quot;Error in destruction of rcl action client handle: &quot;</span><br>            <span class="hljs-string">&quot;the Node Handle was destructed too early. You will leak memory&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">delete</span> client;<br>      &#125;);<br>    *client_handle = <span class="hljs-built_in">rcl_action_get_zero_initialized_client</span>();<br>    <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_client_init</span>(<br>      client_handle.<span class="hljs-built_in">get</span>(), node_handle.<span class="hljs-built_in">get</span>(), type_support,<br>      action_name.<span class="hljs-built_in">c_str</span>(), &amp;client_options);<br>    <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>      rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(<br>        ret, <span class="hljs-string">&quot;could not initialize rcl action client&quot;</span>);<br>    &#125;<br><br>    ret = <span class="hljs-built_in">rcl_action_client_wait_set_get_num_entities</span>(<br>      client_handle.<span class="hljs-built_in">get</span>(),<br>      &amp;num_subscriptions,<br>      &amp;num_guard_conditions,<br>      &amp;num_timers,<br>      &amp;num_clients,<br>      &amp;num_services);<br>    <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>      rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(<br>        ret, <span class="hljs-string">&quot;could not retrieve rcl action client details&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-type">size_t</span> num_subscriptions&#123;<span class="hljs-number">0u</span>&#125;;<br>  <span class="hljs-type">size_t</span> num_guard_conditions&#123;<span class="hljs-number">0u</span>&#125;;<br>  <span class="hljs-type">size_t</span> num_timers&#123;<span class="hljs-number">0u</span>&#125;;<br>  <span class="hljs-type">size_t</span> num_clients&#123;<span class="hljs-number">0u</span>&#125;;<br>  <span class="hljs-type">size_t</span> num_services&#123;<span class="hljs-number">0u</span>&#125;;<br><br>  <span class="hljs-comment">// Lock for action_client_</span><br>  std::recursive_mutex action_client_mutex_;<br><br>  <span class="hljs-comment">// next ready event for taking, will be set by is_ready and will be processed by take_data</span><br>  std::atomic&lt;<span class="hljs-type">size_t</span>&gt; next_ready_event;<br>  <span class="hljs-comment">// used to indicate that next_ready_event has no ready event for processing</span><br>  <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> NO_EVENT_READY = std::numeric_limits&lt;<span class="hljs-type">size_t</span>&gt;::<span class="hljs-built_in">max</span>();<br><br>  rclcpp::Context::SharedPtr context_;<br>  rclcpp::node_interfaces::NodeGraphInterface::WeakPtr node_graph_;<br>  <span class="hljs-comment">// node_handle must be destroyed after client_handle to prevent memory leak</span><br>  std::shared_ptr&lt;<span class="hljs-type">rcl_node_t</span>&gt; node_handle&#123;<span class="hljs-literal">nullptr</span>&#125;;<br>  std::shared_ptr&lt;<span class="hljs-type">rcl_action_client_t</span>&gt; client_handle&#123;<span class="hljs-literal">nullptr</span>&#125;;<br>  rclcpp::Logger logger;<br><br>  <span class="hljs-keyword">using</span> ResponseCallback = std::function&lt;<span class="hljs-built_in">void</span> (std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response)&gt;;<br><br>  std::map&lt;<span class="hljs-type">int64_t</span>, ResponseCallback&gt; pending_goal_responses;<br>  std::mutex goal_requests_mutex;<br><br>  std::map&lt;<span class="hljs-type">int64_t</span>, ResponseCallback&gt; pending_result_responses;<br>  std::mutex result_requests_mutex;<br><br>  std::map&lt;<span class="hljs-type">int64_t</span>, ResponseCallback&gt; pending_cancel_responses;<br>  std::mutex cancel_requests_mutex;<br><br>  std::independent_bits_engine&lt;<br>    std::default_random_engine, <span class="hljs-number">8</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>&gt; random_bytes_generator;<br>&#125;;<br><br>ClientBase::<span class="hljs-built_in">ClientBase</span>(<br>  rclcpp::node_interfaces::NodeBaseInterface::SharedPtr node_base,<br>  rclcpp::node_interfaces::NodeGraphInterface::SharedPtr node_graph,<br>  rclcpp::node_interfaces::NodeLoggingInterface::SharedPtr node_logging,<br>  <span class="hljs-type">const</span> std::string &amp; action_name,<br>  <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,<br>  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_client_options_t</span> &amp; client_options)<br>: <span class="hljs-built_in">pimpl_</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ClientBaseImpl</span>(<br>      node_base, node_graph, node_logging, action_name, type_support, client_options))<br>&#123;<br>&#125;<br><br>ClientBase::~<span class="hljs-built_in">ClientBase</span>()<br>&#123;<br>  <span class="hljs-built_in">clear_on_ready_callback</span>();<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>ClientBase::ClientBase()整个代码结构和ServerBase类似，rcl_action_client_init() 负责初始化客户端底层数据结构：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rcl/rcl_action/src/rcl_action/action_client_impl.h</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcl_action_client_impl_s</span><br>&#123;<br>  <span class="hljs-type">rcl_client_t</span> goal_client;<br>  <span class="hljs-type">rcl_client_t</span> cancel_client;<br>  <span class="hljs-type">rcl_client_t</span> result_client;<br>  <span class="hljs-type">rcl_subscription_t</span> feedback_subscription;<br>  <span class="hljs-type">rcl_subscription_t</span> status_subscription;<br>  <span class="hljs-type">rcl_action_client_options_t</span> options;<br>  <span class="hljs-type">char</span> * action_name;<br>  <span class="hljs-comment">// Wait set records</span><br>  <span class="hljs-type">size_t</span> wait_set_goal_client_index;<br>  <span class="hljs-type">size_t</span> wait_set_cancel_client_index;<br>  <span class="hljs-type">size_t</span> wait_set_result_client_index;<br>  <span class="hljs-type">size_t</span> wait_set_feedback_subscription_index;<br>  <span class="hljs-type">size_t</span> wait_set_status_subscription_index;<br>&#125; <span class="hljs-type">rcl_action_client_impl_t</span>;<br><br><span class="hljs-comment">// src/ros2/rcl/rcl_action/include/rcl_action/action_client.h</span><br><span class="hljs-comment">/// Internal action client implementation struct.</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcl_action_client_impl_s</span> <span class="hljs-type">rcl_action_client_impl_t</span>;<br><br><span class="hljs-comment">/// Structure which encapsulates a ROS action client.</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcl_action_client_s</span><br>&#123;<br>  <span class="hljs-comment">/// Pointer to the action client implementation</span><br>  <span class="hljs-type">rcl_action_client_impl_t</span> * impl;<br>&#125; <span class="hljs-type">rcl_action_client_t</span>;<br><br><span class="hljs-comment">// src/ros2/rcl/rcl_action/src/rcl_action/action_client.c（注意C代码）</span><br><span class="hljs-function"><span class="hljs-type">rcl_ret_t</span></span><br><span class="hljs-function"><span class="hljs-title">rcl_action_client_init</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">rcl_action_client_t</span> * action_client,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">rcl_node_t</span> * node,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rosidl_action_type_support_t</span> * type_support,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">char</span> * action_name,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_client_options_t</span> * options)</span></span><br><span class="hljs-function"></span>&#123;<br>  ......<span class="hljs-comment">// 检查代码逻辑</span><br>  <br>  <span class="hljs-comment">// 申请客户端内存数据结构存储，并做零初始化</span><br>  action_client-&gt;impl = allocator.<span class="hljs-built_in">allocate</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">rcl_action_client_impl_t</span>), allocator.state);<br>  <span class="hljs-built_in">RCL_CHECK_FOR_NULL_WITH_MSG</span>(<br>    action_client-&gt;impl, <span class="hljs-string">&quot;allocating memory failed&quot;</span>, <span class="hljs-keyword">return</span> RCL_RET_BAD_ALLOC);<br><br>  <span class="hljs-comment">// Avoid uninitialized pointers should initialization fail</span><br>  *action_client-&gt;impl = _rcl_action_get_zero_initialized_client_impl();<br>  <span class="hljs-comment">// Copy action client name and options.</span><br>  action_client-&gt;impl-&gt;action_name = <span class="hljs-built_in">rcutils_strdup</span>(action_name, allocator);<br>  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == action_client-&gt;impl-&gt;action_name) &#123;<br>    <span class="hljs-built_in">RCL_SET_ERROR_MSG</span>(<span class="hljs-string">&quot;failed to duplicate action name&quot;</span>);<br>    ret = RCL_RET_BAD_ALLOC;<br>    <span class="hljs-keyword">goto</span> fail;<br>  &#125;<br>  action_client-&gt;impl-&gt;options = *options;<br><br>  <span class="hljs-comment">// 初始化action_client-&gt;impl-&gt;goal_client</span><br>  <span class="hljs-built_in">CLIENT_INIT</span>(goal);<br>  <span class="hljs-comment">// 初始化action_client-&gt;impl-&gt;cancel_client</span><br>  <span class="hljs-built_in">CLIENT_INIT</span>(cancel);<br>  <span class="hljs-comment">// 初始化action_client-&gt;impl-&gt;result_client</span><br>  <span class="hljs-built_in">CLIENT_INIT</span>(result);<br><br>  <span class="hljs-comment">// 初始化action_client-&gt;impl-&gt;feedback_subscription</span><br>  <span class="hljs-built_in">SUBSCRIPTION_INIT</span>(feedback);<br>  <span class="hljs-comment">// 初始化action_client-&gt;impl-&gt;status_subscription</span><br>  <span class="hljs-built_in">SUBSCRIPTION_INIT</span>(status);<br><br>  <span class="hljs-built_in">RCUTILS_LOG_DEBUG_NAMED</span>(ROS_PACKAGE_NAME, <span class="hljs-string">&quot;Action client initialized&quot;</span>);<br>  <span class="hljs-keyword">return</span> ret;<br>fail:<br>  fini_ret = _rcl_action_client_fini_impl(action_client, node, allocator);<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != fini_ret) &#123;<br>    <span class="hljs-built_in">RCL_SET_ERROR_MSG</span>(<span class="hljs-string">&quot;failed to cleanup action client&quot;</span>);<br>    ret = RCL_RET_ERROR;<br>  &#125;<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>对动作服务器客户端初始化时，我们在RCL底层建立了多个可调用对象，如前所述包括：</p>
<ul>
<li>Goal Service Client：目标服务器客户端，用于发送目标请求、接收请求回复</li>
<li>Cancel Service Client：取消服务器客户端，用于发送取消请求</li>
<li>Result Service Client：结果服务器客户端，用于发送结果请求，接收结果回复</li>
<li>Feedback Subscription：反馈订阅者，用于反馈消息的接收</li>
<li>Status Subscription：动作服务器状态订阅者</li>
</ul>
<h1 id="请求处理过程"><a href="#请求处理过程" class="headerlink" title="请求处理过程"></a>请求处理过程</h1><h2 id="动作服务器客户端发送Goal请求"><a href="#动作服务器客户端发送Goal请求" class="headerlink" title="动作服务器客户端发送Goal请求"></a>动作服务器客户端发送Goal请求</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">auto</span> goal_msg = Fibonacci::<span class="hljs-built_in">Goal</span>();<br>goal_msg.order = <span class="hljs-number">10</span>;<br><br><span class="hljs-built_in">RCLCPP_INFO</span>(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(), <span class="hljs-string">&quot;Sending goal&quot;</span>);<br><br><span class="hljs-keyword">auto</span> send_goal_options = rclcpp_action::Client&lt;Fibonacci&gt;::<span class="hljs-built_in">SendGoalOptions</span>();<br>send_goal_options.goal_response_callback =<br>  std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::goal_response_callback, <span class="hljs-keyword">this</span>, _1);<br>send_goal_options.feedback_callback =<br>  std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::feedback_callback, <span class="hljs-keyword">this</span>, _1, _2);<br>send_goal_options.result_callback =<br>  std::<span class="hljs-built_in">bind</span>(&amp;MinimalActionClient::result_callback, <span class="hljs-keyword">this</span>, _1);<br><span class="hljs-keyword">auto</span> goal_handle_future = <span class="hljs-keyword">this</span>-&gt;client_ptr_-&gt;<span class="hljs-built_in">async_send_goal</span>(goal_msg, send_goal_options);<br></code></pre></td></tr></table></figure>

<p>服务端和客户端初始化完毕后，客户端调用async_send_goal()发送请求，参数除了目标消息外，还有回调用的callback。由于代码比较复杂，这里直接在代码中注释逻辑：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/client.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> : <span class="hljs-keyword">public</span> ClientBase<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">RCLCPP_SMART_PTR_DEFINITIONS_NOT_COPYABLE</span>(Client&lt;ActionT&gt;)<br><br>  <span class="hljs-keyword">using</span> Goal = <span class="hljs-keyword">typename</span> ActionT::Goal;<br>  <span class="hljs-keyword">using</span> Feedback = <span class="hljs-keyword">typename</span> ActionT::Feedback;<br>  <span class="hljs-keyword">using</span> GoalHandle = ClientGoalHandle&lt;ActionT&gt;;<br>  <span class="hljs-keyword">using</span> WrappedResult = <span class="hljs-keyword">typename</span> GoalHandle::WrappedResult;<br>  <span class="hljs-keyword">using</span> GoalResponseCallback = std::function&lt;<span class="hljs-built_in">void</span> (<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr)&gt;;<br>  <span class="hljs-keyword">using</span> FeedbackCallback = <span class="hljs-keyword">typename</span> GoalHandle::FeedbackCallback;<br>  <span class="hljs-keyword">using</span> ResultCallback = <span class="hljs-keyword">typename</span> GoalHandle::ResultCallback;<br>  <span class="hljs-keyword">using</span> CancelRequest = <span class="hljs-keyword">typename</span> ActionT::Impl::CancelGoalService::Request;<br>  <span class="hljs-keyword">using</span> CancelResponse = <span class="hljs-keyword">typename</span> ActionT::Impl::CancelGoalService::Response;<br>  <span class="hljs-keyword">using</span> CancelCallback = std::function&lt;<span class="hljs-built_in">void</span> (<span class="hljs-keyword">typename</span> CancelResponse::SharedPtr)&gt;;<br>  .....<span class="hljs-comment">// 其他代码逻辑</span><br>  <br>  <span class="hljs-function">std::shared_future&lt;<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr&gt;</span><br><span class="hljs-function">  <span class="hljs-title">async_send_goal</span><span class="hljs-params">(<span class="hljs-type">const</span> Goal &amp; goal, <span class="hljs-type">const</span> SendGoalOptions &amp; options = SendGoalOptions())</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-comment">// 建立promise，反馈内容GoalHandle</span><br>    <span class="hljs-keyword">auto</span> promise = std::make_shared&lt;std::promise&lt;<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr&gt;&gt;();<br>    <span class="hljs-comment">// 获取promise的future，注意这个future回复反馈给用户，以便用户等待goal通知</span><br>    <span class="hljs-function">std::shared_future&lt;<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr&gt; <span class="hljs-title">future</span><span class="hljs-params">(promise-&gt;get_future())</span></span>;<br><br>    <span class="hljs-comment">// 填充目标请求，这里每隔goal都有一个uuid</span><br>    <span class="hljs-keyword">using</span> GoalRequest = <span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Request;<br>    <span class="hljs-keyword">auto</span> goal_request = std::<span class="hljs-built_in">make_shared</span>&lt;GoalRequest&gt;();<br>    goal_request-&gt;goal_id.uuid = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">generate_goal_id</span>();<br>    goal_request-&gt;goal = goal;<br><br>    <span class="hljs-comment">// 发送goal请求</span><br>    <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">send_goal_request</span>(<br>      std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(goal_request),<br>      <span class="hljs-comment">// Goal响应，由于调用流程在其他地方，我们暂时不谈</span><br>      [<span class="hljs-keyword">this</span>, goal_request, options, promise](std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response) <span class="hljs-keyword">mutable</span><br>      &#123;<br>        <span class="hljs-keyword">using</span> GoalResponse = <span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Response;<br>        <span class="hljs-keyword">auto</span> goal_response = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;GoalResponse&gt;(response);<br><br>        <span class="hljs-comment">// 如果goal被拒绝（goal响应消息中accepted==false）</span><br>        <span class="hljs-keyword">if</span> (!goal_response-&gt;accepted) &#123;<br>          <span class="hljs-comment">// 通知future goal设置为空</span><br>          promise-&gt;<span class="hljs-built_in">set_value</span>(<span class="hljs-literal">nullptr</span>);<br>          <span class="hljs-comment">// 然后调用goal的回调函数，填充为空</span><br>          <span class="hljs-keyword">if</span> (options.goal_response_callback) &#123;<br>            options.<span class="hljs-built_in">goal_response_callback</span>(<span class="hljs-literal">nullptr</span>);<br>          &#125;<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 到此处goal被接受了</span><br>        GoalInfo goal_info;<br>        goal_info.goal_id.uuid = goal_request-&gt;goal_id.uuid;<br>        goal_info.stamp = goal_response-&gt;stamp;<br>        <span class="hljs-comment">// Do not use std::make_shared as friendship cannot be forwarded.</span><br>        std::shared_ptr&lt;GoalHandle&gt; <span class="hljs-built_in">goal_handle</span>(<br>          <span class="hljs-keyword">new</span> <span class="hljs-built_in">GoalHandle</span>(goal_info, options.feedback_callback, options.result_callback));<br>        &#123;<br>          std::lock_guard&lt;std::mutex&gt; <span class="hljs-built_in">guard</span>(goal_handles_mutex_);<br>          goal_handles_[goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>()] = goal_handle;<br>        &#125;<br><br>        <span class="hljs-comment">// 新建goal_handle，并且通知promise，goal被接受了</span><br>        promise-&gt;<span class="hljs-built_in">set_value</span>(goal_handle);<br>        <br>        <span class="hljs-comment">// 调用goal的回调，此时参数有效</span><br>        <span class="hljs-keyword">if</span> (options.goal_response_callback) &#123;<br>          options.<span class="hljs-built_in">goal_response_callback</span>(goal_handle);<br>        &#125;<br>        <br>        <span class="hljs-comment">// 向服务端发送goal result请求</span><br>        <span class="hljs-keyword">if</span> (options.result_callback) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">make_result_aware</span>(goal_handle);<br>        &#125;<br>      &#125;);<br><br>    <span class="hljs-comment">// 清除不再使用goal，暂不关心</span><br>    &#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(goal_handles_mutex_)</span></span>;<br>      <span class="hljs-keyword">auto</span> goal_handle_it = goal_handles_.<span class="hljs-built_in">begin</span>();<br>      <span class="hljs-keyword">while</span> (goal_handle_it != goal_handles_.<span class="hljs-built_in">end</span>()) &#123;<br>        <span class="hljs-keyword">if</span> (!goal_handle_it-&gt;second.<span class="hljs-built_in">lock</span>()) &#123;<br>          <span class="hljs-built_in">RCLCPP_DEBUG</span>(<br>            <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(),<br>            <span class="hljs-string">&quot;Dropping weak reference to goal handle during send_goal()&quot;</span>);<br>          goal_handle_it = goal_handles_.<span class="hljs-built_in">erase</span>(goal_handle_it);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          ++goal_handle_it;<br>        &#125;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> future;<br>  &#125;<br>  <br>  <span class="hljs-comment">/// \internal</span><br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">make_result_aware</span><span class="hljs-params">(<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr goal_handle)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-comment">// Avoid making more than one request</span><br>    <span class="hljs-keyword">if</span> (goal_handle-&gt;<span class="hljs-built_in">set_result_awareness</span>(<span class="hljs-literal">true</span>)) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">using</span> GoalResultRequest = <span class="hljs-keyword">typename</span> ActionT::Impl::GetResultService::Request;<br>    <span class="hljs-keyword">auto</span> goal_result_request = std::<span class="hljs-built_in">make_shared</span>&lt;GoalResultRequest&gt;();<br>    goal_result_request-&gt;goal_id.uuid = goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 这里发送结果请求</span><br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">send_result_request</span>(<br>        std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(goal_result_request),<br>        [goal_handle, <span class="hljs-keyword">this</span>](std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response) <span class="hljs-keyword">mutable</span><br>        &#123;<br>          <span class="hljs-comment">// Wrap the response in a struct with the fields a user cares about</span><br>          WrappedResult wrapped_result;<br>          <span class="hljs-keyword">using</span> GoalResultResponse = <span class="hljs-keyword">typename</span> ActionT::Impl::GetResultService::Response;<br>          <span class="hljs-comment">// 处理结果，拷贝到wrapped_result</span><br>          <span class="hljs-keyword">auto</span> result_response = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;GoalResultResponse&gt;(response);<br>          wrapped_result.result = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-keyword">typename</span> ActionT::Result&gt;();<br>          *wrapped_result.result = result_response-&gt;result;<br>          wrapped_result.goal_id = goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>();<br>          wrapped_result.code = <span class="hljs-built_in">static_cast</span>&lt;ResultCode&gt;(result_response-&gt;status);<br>          <span class="hljs-comment">// 这里将结果也放到goal_handle中</span><br>          goal_handle-&gt;<span class="hljs-built_in">set_result</span>(wrapped_result);<br>          std::lock_guard&lt;std::mutex&gt; <span class="hljs-built_in">lock</span>(goal_handles_mutex_);<br>          goal_handles_.<span class="hljs-built_in">erase</span>(goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>());<br>        &#125;);<br>    &#125; <span class="hljs-built_in">catch</span> (rclcpp::exceptions::RCLError &amp; ex) &#123;<br>      <span class="hljs-comment">// This will cause an exception when the user tries to access the result</span><br>      goal_handle-&gt;<span class="hljs-built_in">invalidate</span>(exceptions::<span class="hljs-built_in">UnawareGoalHandleError</span>(ex.message));<br>    &#125;<br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/client_goal_handle.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientGoalHandle</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">RCLCPP_SMART_PTR_DEFINITIONS_NOT_COPYABLE</span>(ClientGoalHandle)<br><br>  <span class="hljs-comment">// A wrapper that defines the result of an action</span><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">WrappedResult</span><br>  &#123;<br>    <span class="hljs-comment">/// The unique identifier of the goal</span><br>    GoalUUID goal_id;<br>    <span class="hljs-comment">/// A status to indicate if the goal was canceled, aborted, or suceeded</span><br>    ResultCode code;<br>    <span class="hljs-comment">/// User defined fields sent back with an action</span><br>    <span class="hljs-keyword">typename</span> ActionT::Result::SharedPtr result;<br>  &#125;;<br><br>  <span class="hljs-keyword">using</span> Feedback = <span class="hljs-keyword">typename</span> ActionT::Feedback;<br>  <span class="hljs-keyword">using</span> Result = <span class="hljs-keyword">typename</span> ActionT::Result;<br>  <span class="hljs-keyword">using</span> FeedbackCallback =<br>    std::function&lt;<span class="hljs-built_in">void</span> (<br>        <span class="hljs-keyword">typename</span> ClientGoalHandle&lt;ActionT&gt;::SharedPtr,<br>        <span class="hljs-type">const</span> std::shared_ptr&lt;<span class="hljs-type">const</span> Feedback&gt;)&gt;;<br>  <span class="hljs-keyword">using</span> ResultCallback = std::function&lt;<span class="hljs-built_in">void</span> (<span class="hljs-type">const</span> WrappedResult &amp; result)&gt;;<br><br>  <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">ClientGoalHandle</span>();<br><br>    .....<span class="hljs-comment">// 其他代码逻辑</span><br><br><span class="hljs-keyword">private</span>:<br>  <span class="hljs-comment">// The templated Client creates goal handles</span><br>  <span class="hljs-keyword">friend</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span>&lt;ActionT&gt;;<br><br>  <span class="hljs-built_in">ClientGoalHandle</span>(<br>    <span class="hljs-type">const</span> GoalInfo &amp; info,<br>    FeedbackCallback feedback_callback,<br>    ResultCallback result_callback);<br><br>  .....<span class="hljs-comment">// 其他代码逻辑</span><br>  <br>  GoalInfo info_;<br><br>  std::exception_ptr invalidate_exception_&#123;<span class="hljs-literal">nullptr</span>&#125;;<br><br>  <span class="hljs-type">bool</span> is_result_aware_&#123;<span class="hljs-literal">false</span>&#125;;<br>  std::promise&lt;WrappedResult&gt; result_promise_;<br>  std::shared_future&lt;WrappedResult&gt; result_future_;<br><br>  FeedbackCallback feedback_callback_&#123;<span class="hljs-literal">nullptr</span>&#125;;<br>  ResultCallback result_callback_&#123;<span class="hljs-literal">nullptr</span>&#125;;<br>  <span class="hljs-type">int8_t</span> status_&#123;GoalStatus::STATUS_ACCEPTED&#125;;<br><br>  std::mutex handle_mutex_;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>客户端send_goal_request()调用通过Goal Service发送目标请求，具体代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/src/client.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ClientBase::send_goal_request</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; request, ResponseCallback callback)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(pimpl_-&gt;goal_requests_mutex)</span></span>;<br>  <span class="hljs-type">int64_t</span> sequence_number;<br>  <span class="hljs-comment">// 发送请求到rcl层</span><br>  <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_send_goal_request</span>(<br>    pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), request.<span class="hljs-built_in">get</span>(), &amp;sequence_number);<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret, <span class="hljs-string">&quot;failed to send goal request&quot;</span>);<br>  &#125;<br>  <span class="hljs-built_in">assert</span>(pimpl_-&gt;pending_goal_responses.<span class="hljs-built_in">count</span>(sequence_number) == <span class="hljs-number">0</span>);<br>  <span class="hljs-comment">// 建立序列号到callback映射</span><br>  pimpl_-&gt;pending_goal_responses[sequence_number] = callback;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>动作服务器客户端通过ClientBase调用rcl_action_send_goal_request()将goal发送出去，发送后函数返回代表goal的序列号，动作服务器依据此序列号，建立序列号到callback映射，以便在goal反馈后，执行对应callback函数。</p>
<h2 id="动作服务器服务端接收到Goal请求"><a href="#动作服务器服务端接收到Goal请求" class="headerlink" title="动作服务器服务端接收到Goal请求"></a>动作服务器服务端接收到Goal请求</h2><p>我们之前说过，动作服务器本身是一个Waitable，当请求到来时，会触发Waitable的数据处理函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp/src/rclcpp/executor.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">Executor::execute_any_executable</span><span class="hljs-params">(AnyExecutable &amp; any_exec)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!spinning.<span class="hljs-built_in">load</span>()) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  ....<span class="hljs-comment">//其他代码逻辑</span><br>  <span class="hljs-keyword">if</span> (any_exec.waitable) &#123;<br>    any_exec.waitable-&gt;<span class="hljs-built_in">execute</span>(any_exec.data);<br>  &#125;<br>  <span class="hljs-comment">// Reset the callback_group, regardless of type</span><br>  any_exec.callback_group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">store</span>(<span class="hljs-literal">true</span>);<br>  ....<span class="hljs-comment">//其他代码逻辑</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span></span><br><span class="hljs-function"><span class="hljs-title">Executor::get_next_ready_executable_from_map</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  AnyExecutable &amp; any_executable,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> rclcpp::memory_strategy::MemoryStrategy::WeakCallbackGroupsToNodesMap &amp;</span></span><br><span class="hljs-params"><span class="hljs-function">  weak_groups_to_nodes)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">TRACEPOINT</span>(rclcpp_executor_get_next_ready);<br>  <span class="hljs-type">bool</span> success = <span class="hljs-literal">false</span>;<br>  std::lock_guard&lt;std::mutex&gt; guard&#123;mutex_&#125;;<br>  ......<span class="hljs-comment">//其他代码逻辑</span><br>  <span class="hljs-keyword">if</span> (!success) &#123;<br>    <span class="hljs-comment">// Check the waitables to see if there are any that are ready</span><br>    memory_strategy_-&gt;<span class="hljs-built_in">get_next_waitable</span>(any_executable, weak_groups_to_nodes);<br>    <span class="hljs-keyword">if</span> (any_executable.waitable) &#123;<br>      any_executable.data = any_executable.waitable-&gt;<span class="hljs-built_in">take_data</span>();<br>      success = <span class="hljs-literal">true</span>;<br>    &#125;<br>  &#125;<br>  ......<span class="hljs-comment">// 其他代码逻辑</span><br>  <span class="hljs-keyword">if</span> (success) &#123;<br>    <span class="hljs-comment">// If it is valid, check to see if the group is mutually exclusive or</span><br>    <span class="hljs-comment">// not, then mark it accordingly ..Check if the callback_group belongs to this executor</span><br>    <span class="hljs-keyword">if</span> (any_executable.callback_group &amp;&amp; any_executable.callback_group-&gt;<span class="hljs-built_in">type</span>() == \<br>      CallbackGroupType::MutuallyExclusive)<br>    &#123;<br>      <span class="hljs-comment">// It should not have been taken otherwise</span><br>      <span class="hljs-built_in">assert</span>(any_executable.callback_group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">load</span>());<br>      <span class="hljs-comment">// Set to false to indicate something is being run from this group</span><br>      <span class="hljs-comment">// This is reset to true either when the any_executable is executed or when the</span><br>      <span class="hljs-comment">// any_executable is destructued</span><br>      any_executable.callback_group-&gt;<span class="hljs-built_in">can_be_taken_from</span>().<span class="hljs-built_in">store</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// If there is no ready executable, return false</span><br>  <span class="hljs-keyword">return</span> success;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当动作服务器客户端请求到来，首先get_next_executable()调用get_next_ready_executable_from_map()，执行Waitable的take_data()首先根据到来请求的类型，做数据处理，然后execute_any_executable()执行Waitable的execute()函数，这两者代码如下，由于代码较长，直接在代码中注释：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;</span><br><span class="hljs-function"><span class="hljs-title">ServerBase::take_data</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">size_t</span> next_ready_event = pimpl_-&gt;next_ready_event.<span class="hljs-built_in">exchange</span>(ServerBaseImpl::NO_EVENT_READY);<br><br>  <span class="hljs-keyword">if</span> (next_ready_event == ServerBaseImpl::NO_EVENT_READY) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Taking data from action server but no ready event&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">// 调用take_data_by_entity_id处理数据</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">take_data_by_entity_id</span>(next_ready_event);<br>&#125;<br><br><span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;</span><br><span class="hljs-function"><span class="hljs-title">ServerBase::take_data_by_entity_id</span><span class="hljs-params">(<span class="hljs-type">size_t</span> id)</span></span><br><span class="hljs-function"></span>&#123;<br>  .....<span class="hljs-comment">//校验逻辑</span><br><br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr;<br>  <span class="hljs-comment">// Mark as ready the entity from which we want to take data</span><br>  <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">static_cast</span>&lt;ActionEventType&gt;(id)) &#123;<br>    <span class="hljs-comment">// GoalService类型</span><br>    <span class="hljs-comment">// </span><br>    <span class="hljs-keyword">case</span> ActionEventType::GoalService:<br>      &#123;<br>        <span class="hljs-type">rcl_ret_t</span> ret;<br>        <span class="hljs-type">rcl_action_goal_info_t</span> goal_info = <span class="hljs-built_in">rcl_action_get_zero_initialized_goal_info</span>();<br>        <span class="hljs-type">rmw_request_id_t</span> request_header;<br><br>        <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br><br>        <span class="hljs-comment">// 调用rcl层处理goal请求，并返回request_header</span><br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; message = <span class="hljs-built_in">create_goal_request</span>();<br>        ret = <span class="hljs-built_in">rcl_action_take_goal_request</span>(<br>          pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(),<br>          &amp;request_header,<br>          message.<span class="hljs-built_in">get</span>());<br><br>        <span class="hljs-comment">// 构建ServerBaseData</span><br>        data_ptr = std::<span class="hljs-built_in">make_shared</span>&lt;ServerBaseData&gt;(<br>          ServerBaseData::<span class="hljs-built_in">GoalRequestData</span>(ret, goal_info, request_header, message));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> ActionEventType::ResultService:<br>      &#123;<br>        <span class="hljs-type">rcl_ret_t</span> ret;<br>        <span class="hljs-comment">// 调用rcl层处理goal请求，并返回request_header</span><br>        <span class="hljs-type">rmw_request_id_t</span> request_header;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_request = <span class="hljs-built_in">create_result_request</span>();<br>        <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>        ret = <span class="hljs-built_in">rcl_action_take_result_request</span>(<br>          pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;request_header, result_request.<span class="hljs-built_in">get</span>());<br><br>         <span class="hljs-comment">// 构建ServerBaseData</span><br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ServerBaseData&gt;(<br>          ServerBaseData::<span class="hljs-built_in">ResultRequestData</span>(ret, result_request, request_header));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> ActionEventType::CancelService:<br>      &#123;<br>        <span class="hljs-type">rcl_ret_t</span> ret;<br>        <span class="hljs-type">rmw_request_id_t</span> request_header;<br><br>        <span class="hljs-comment">// Initialize cancel request</span><br>        <span class="hljs-keyword">auto</span> request = std::<span class="hljs-built_in">make_shared</span>&lt;action_msgs::srv::CancelGoal::Request&gt;();<br><br>        <span class="hljs-comment">// 调用rcl层处理goal请求，并返回request_header</span><br>        <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>        ret = <span class="hljs-built_in">rcl_action_take_cancel_request</span>(<br>          pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(),<br>          &amp;request_header,<br>          request.<span class="hljs-built_in">get</span>());<br>        <span class="hljs-comment">// 调用rcl层处理goal请求，并返回request_header</span><br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ServerBaseData&gt;(<br>          ServerBaseData::<span class="hljs-built_in">CancelRequestData</span>(ret, request, request_header));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> ActionEventType::Expired:<br>      &#123;<br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ServerBaseData&gt;(ServerBaseData::<span class="hljs-built_in">GoalExpiredData</span>());<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(data_ptr);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::execute</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data_in)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!data_in) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Executing action server but &#x27;data&#x27; is empty&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// 首先获取到ServerBaseData</span><br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ServerBaseData&gt;(data_in);<br><br>  <span class="hljs-comment">// 分发请求</span><br>  std::<span class="hljs-built_in">visit</span>(<br>    [&amp;](<span class="hljs-keyword">auto</span> &amp;&amp; data) -&gt; <span class="hljs-type">void</span> &#123;<br>      <span class="hljs-keyword">using</span> T = std::<span class="hljs-type">decay_t</span>&lt;<span class="hljs-keyword">decltype</span>(data)&gt;;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::GoalRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_goal_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::CancelRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_cancel_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::ResultRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_result_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::GoalExpiredData&gt;) &#123;<br>        <span class="hljs-built_in">execute_check_expired_goals</span>();<br>      &#125;<br>    &#125;,<br>    data_ptr-&gt;data);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在获取到动作服务器Goal请求后，服务端先建立包含GoalRequestData类型的ServerBaseData，然后调用execute_goal_request_received()执行回调：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::execute_goal_request_received</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// 解包数据</span><br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ServerBaseData&gt;(data);<br>  <span class="hljs-function"><span class="hljs-type">const</span> ServerBaseData::GoalRequestData &amp; <span class="hljs-title">gData</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    std::get&lt;ServerBaseData::GoalRequestData&gt;(data_ptr-&gt;data))</span></span>;<br><br>  <span class="hljs-type">rcl_ret_t</span> ret = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">0</span>&gt;(gData);<br>  <span class="hljs-type">rcl_action_goal_info_t</span> goal_info = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">1</span>&gt;(gData);<br>  <span class="hljs-type">rmw_request_id_t</span> request_header = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">2</span>&gt;(gData);<br>  <span class="hljs-type">const</span> std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; message = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">3</span>&gt;(gData);<br><br>  <span class="hljs-keyword">if</span> (RCL_RET_ACTION_SERVER_TAKE_FAILED == ret) &#123;<br>    <span class="hljs-comment">// Ignore take failure because connext fails if it receives a sample without valid data.</span><br>    <span class="hljs-comment">// This happens when a client shuts down and connext receives a sample saying the client is</span><br>    <span class="hljs-comment">// no longer alive.</span><br>    <span class="hljs-keyword">return</span>;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br><br>  <span class="hljs-comment">// 根据goal信息，获取UUID</span><br>  GoalUUID uuid = <span class="hljs-built_in">get_goal_id_from_goal_request</span>(message.<span class="hljs-built_in">get</span>());<br>  <span class="hljs-built_in">convert</span>(uuid, &amp;goal_info);<br><br>  <span class="hljs-comment">// 调用用户的回调函数</span><br>  <span class="hljs-keyword">auto</span> response_pair = <span class="hljs-built_in">call_handle_goal_callback</span>(uuid, message);<br><br>  <span class="hljs-comment">// 调用rcl给客户端反馈服务端响应</span><br>  <span class="hljs-comment">// 注意：给动作服务器客户端反馈是在调用了用户的goal_handle_后，在goal_accepted_前</span><br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>    ret = <span class="hljs-built_in">rcl_action_send_goal_response</span>(<br>      pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(),<br>      &amp;request_header,<br>      response_pair.second.<span class="hljs-built_in">get</span>());<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    <span class="hljs-keyword">if</span> (ret == RCL_RET_TIMEOUT) &#123;<br>      <span class="hljs-built_in">RCLCPP_WARN</span>(<br>        pimpl_-&gt;logger_,<br>        <span class="hljs-string">&quot;Failed to send goal response %s (timeout): %s&quot;</span>,<br>        <span class="hljs-built_in">to_string</span>(uuid).<span class="hljs-built_in">c_str</span>(), <span class="hljs-built_in">rcl_get_error_string</span>().str);<br>      <span class="hljs-built_in">rcl_reset_error</span>();<br>      <span class="hljs-keyword">return</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> status = response_pair.first;<br><br>  <span class="hljs-comment">// if goal is accepted, create a goal handle, and store it</span><br>  <span class="hljs-keyword">if</span> (GoalResponse::ACCEPT_AND_EXECUTE == status || GoalResponse::ACCEPT_AND_DEFER == status) &#123;<br>    <span class="hljs-built_in">RCLCPP_DEBUG</span>(pimpl_-&gt;logger_, <span class="hljs-string">&quot;Accepted goal %s&quot;</span>, <span class="hljs-built_in">to_string</span>(uuid).<span class="hljs-built_in">c_str</span>());<br>    <span class="hljs-comment">// rcl_action will set time stamp</span><br>    <span class="hljs-keyword">auto</span> deleter = [](<span class="hljs-type">rcl_action_goal_handle_t</span> * ptr)<br>      &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> != ptr) &#123;<br>          <span class="hljs-type">rcl_ret_t</span> fail_ret = <span class="hljs-built_in">rcl_action_goal_handle_fini</span>(ptr);<br>          <span class="hljs-keyword">if</span> (RCL_RET_OK != fail_ret) &#123;<br>            <span class="hljs-built_in">RCLCPP_DEBUG</span>(<br>              rclcpp::<span class="hljs-built_in">get_logger</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>),<br>              <span class="hljs-string">&quot;failed to fini rcl_action_goal_handle_t in deleter&quot;</span>);<br>          &#125;<br>          <span class="hljs-keyword">delete</span> ptr;<br>        &#125;<br>      &#125;;<br>    <span class="hljs-comment">// 当Goal被用户接受，调用rcl创建Goal Handle</span><br>    <span class="hljs-type">rcl_action_goal_handle_t</span> * rcl_handle;<br>    &#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>      rcl_handle = <span class="hljs-built_in">rcl_action_accept_new_goal</span>(pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;goal_info);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!rcl_handle) &#123;<br>      <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Failed to accept new goal\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">rcl_action_goal_handle_t</span>&gt; <span class="hljs-title">handle</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">rcl_action_goal_handle_t</span>, deleter)</span></span>;<br>    <span class="hljs-comment">// Copy out goal handle since action server storage disappears when it is fini&#x27;d</span><br>    *handle = *rcl_handle;<br><br>    <span class="hljs-comment">// 将Goal Handle根据UUID存入Server</span><br>    &#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;unordered_map_mutex_)</span></span>;<br>      pimpl_-&gt;goal_handles_[uuid] = handle;<br>    &#125;<br><br>    <span class="hljs-comment">// 更新底层rcl，表示Goal正在执行</span><br>    <span class="hljs-keyword">if</span> (GoalResponse::ACCEPT_AND_EXECUTE == status) &#123;<br>      <span class="hljs-comment">// Change status to executing</span><br>      ret = <span class="hljs-built_in">rcl_action_update_goal_state</span>(handle.<span class="hljs-built_in">get</span>(), GOAL_EVENT_EXECUTE);<br>      <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>        rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">// publish status since a goal&#x27;s state has changed (was accepted or has begun execution)</span><br>    <span class="hljs-comment">// 将Goal状态发不出去，这个就会使用服务端建立Status Publisher，这个暂不关注</span><br>    <span class="hljs-built_in">publish_status</span>();<br><br>    <span class="hljs-comment">// 调用用户自定义Accepted回调函数</span><br>    <span class="hljs-built_in">call_goal_accepted_callback</span>(handle, uuid, message);<br>  &#125;<br>  data.<span class="hljs-built_in">reset</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如上述代码，执行器在收到Goal后，首先调用call_handle_goal_callback()，该函数内部调用handle_goal_()，就是我们MinimalActionServer::handle_goal()。然后动作服务器给客户端发送响应。同时开始处理Goal目标，如果接受（Accepted）Goal目标，那么就建立Goal Handle，并通过call_goal_accepted_callback()调用用户handle_accepted_()回调。</p>
<div class="note note-warning">
            <p>给动作服务器客户端反馈是在调用了用户的goal_handle_后，在goal_accepted_前</p>
          </div>

<h2 id="动作服务器服务端发送到Goal回应"><a href="#动作服务器服务端发送到Goal回应" class="headerlink" title="动作服务器服务端发送到Goal回应"></a>动作服务器服务端发送到Goal回应</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> : <span class="hljs-keyword">public</span> ServerBase, <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;Server&lt;ActionT&gt;&gt;<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">RCLCPP_SMART_PTR_DEFINITIONS_NOT_COPYABLE</span>(Server)<br><br>  <span class="hljs-comment">/// Signature of a callback that accepts or rejects goal requests.</span><br>  <span class="hljs-keyword">using</span> GoalCallback = std::function&lt;<span class="hljs-built_in">GoalResponse</span>(<br>        <span class="hljs-type">const</span> GoalUUID &amp;, std::shared_ptr&lt;<span class="hljs-type">const</span> <span class="hljs-keyword">typename</span> ActionT::Goal&gt;)&gt;;<br>  <span class="hljs-comment">/// Signature of a callback that accepts or rejects requests to cancel a goal.</span><br>  <span class="hljs-keyword">using</span> CancelCallback = std::function&lt;<span class="hljs-built_in">CancelResponse</span>(std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;<br>  <span class="hljs-comment">/// Signature of a callback that is used to notify when the goal has been accepted.</span><br>  <span class="hljs-keyword">using</span> AcceptedCallback = std::function&lt;<span class="hljs-built_in">void</span> (std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;<br><br><span class="hljs-keyword">protected</span>:<br>  std::pair&lt;GoalResponse, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;&gt;<br>  <span class="hljs-built_in">call_handle_goal_callback</span>(GoalUUID &amp; uuid, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; message) <span class="hljs-keyword">override</span><br>  &#123;<br>    <span class="hljs-keyword">auto</span> request = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<br>      <span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Request&gt;(message);<br>    <span class="hljs-keyword">auto</span> goal = std::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-keyword">typename</span> ActionT::Goal&gt;(request, &amp;request-&gt;goal);<br>    <span class="hljs-comment">// 调用用户自定义的回调函数</span><br>    GoalResponse user_response = <span class="hljs-built_in">handle_goal_</span>(uuid, goal);<br><br>    <span class="hljs-comment">// 如果返回状态为GoalResponse::ACCEPT_AND_EXECUTE或者GoalResponse::ACCEPT_AND_DEFER，表示Goal被接受</span><br>    <span class="hljs-keyword">auto</span> ros_response = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Response&gt;();<br>    ros_response-&gt;accepted = GoalResponse::ACCEPT_AND_EXECUTE == user_response ||<br>      GoalResponse::ACCEPT_AND_DEFER == user_response;<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_pair</span>(user_response, ros_response);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>如果Goal被用户决定了Accepted，程序会调用用户自定义的Accepted回调handle_goal_()，也就是MinimalActionServer::handle_accepted()，来做用户自定义后处理：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> : <span class="hljs-keyword">public</span> ServerBase, <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;Server&lt;ActionT&gt;&gt;<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">RCLCPP_SMART_PTR_DEFINITIONS_NOT_COPYABLE</span>(Server)<br><br>  <span class="hljs-comment">/// Signature of a callback that accepts or rejects goal requests.</span><br>  <span class="hljs-keyword">using</span> GoalCallback = std::function&lt;<span class="hljs-built_in">GoalResponse</span>(<br>        <span class="hljs-type">const</span> GoalUUID &amp;, std::shared_ptr&lt;<span class="hljs-type">const</span> <span class="hljs-keyword">typename</span> ActionT::Goal&gt;)&gt;;<br>  <span class="hljs-comment">/// Signature of a callback that accepts or rejects requests to cancel a goal.</span><br>  <span class="hljs-keyword">using</span> CancelCallback = std::function&lt;<span class="hljs-built_in">CancelResponse</span>(std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;<br>  <span class="hljs-comment">/// Signature of a callback that is used to notify when the goal has been accepted.</span><br>  <span class="hljs-keyword">using</span> AcceptedCallback = std::function&lt;<span class="hljs-built_in">void</span> (std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;<br><br><span class="hljs-keyword">protected</span>:<br><span class="hljs-comment">/// \internal</span><br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">call_goal_accepted_callback</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    std::shared_ptr&lt;<span class="hljs-type">rcl_action_goal_handle_t</span>&gt; rcl_goal_handle,</span></span><br><span class="hljs-params"><span class="hljs-function">    GoalUUID uuid, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; goal_request_message)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function">  </span>&#123;<br>    std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt; goal_handle;<br>    std::weak_ptr&lt;Server&lt;ActionT&gt;&gt; weak_this = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">shared_from_this</span>();<br><br>    std::function&lt;<span class="hljs-type">void</span>(<span class="hljs-type">const</span> GoalUUID &amp;, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;)&gt; on_terminal_state =<br>      [weak_this](<span class="hljs-type">const</span> GoalUUID &amp; goal_uuid, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_message)<br>      &#123;<br>        std::shared_ptr&lt;Server&lt;ActionT&gt;&gt; shared_this = weak_this.<span class="hljs-built_in">lock</span>();<br>        <span class="hljs-keyword">if</span> (!shared_this) &#123;<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// Send result message to anyone that asked</span><br>        shared_this-&gt;<span class="hljs-built_in">publish_result</span>(goal_uuid, result_message);<br>        <span class="hljs-comment">// Publish a status message any time a goal handle changes state</span><br>        shared_this-&gt;<span class="hljs-built_in">publish_status</span>();<br>        <span class="hljs-comment">// notify base so it can recalculate the expired goal timer</span><br>        shared_this-&gt;<span class="hljs-built_in">notify_goal_terminal_state</span>();<br>        <span class="hljs-comment">// Delete data now (ServerBase and rcl_action_server_t keep data until goal handle expires)</span><br>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(shared_this-&gt;goal_handles_mutex_)</span></span>;<br>        shared_this-&gt;goal_handles_.<span class="hljs-built_in">erase</span>(goal_uuid);<br>      &#125;;<br><br>    std::function&lt;<span class="hljs-type">void</span>(<span class="hljs-type">const</span> GoalUUID &amp;)&gt; on_executing =<br>      [weak_this](<span class="hljs-type">const</span> GoalUUID &amp; goal_uuid)<br>      &#123;<br>        std::shared_ptr&lt;Server&lt;ActionT&gt;&gt; shared_this = weak_this.<span class="hljs-built_in">lock</span>();<br>        <span class="hljs-keyword">if</span> (!shared_this) &#123;<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br>        (<span class="hljs-type">void</span>)goal_uuid;<br>        <span class="hljs-comment">// Publish a status message any time a goal handle changes state</span><br>        shared_this-&gt;<span class="hljs-built_in">publish_status</span>();<br>      &#125;;<br><br>    std::function&lt;<span class="hljs-type">void</span>(std::shared_ptr&lt;<span class="hljs-keyword">typename</span> ActionT::Impl::FeedbackMessage&gt;)&gt; publish_feedback =<br>      [weak_this](std::shared_ptr&lt;<span class="hljs-keyword">typename</span> ActionT::Impl::FeedbackMessage&gt; feedback_msg)<br>      &#123;<br>        std::shared_ptr&lt;Server&lt;ActionT&gt;&gt; shared_this = weak_this.<span class="hljs-built_in">lock</span>();<br>        <span class="hljs-keyword">if</span> (!shared_this) &#123;<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br>        shared_this-&gt;<span class="hljs-built_in">publish_feedback</span>(std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(feedback_msg));<br>      &#125;;<br><br>    <span class="hljs-keyword">auto</span> request = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<br>      <span class="hljs-type">const</span> <span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Request&gt;(goal_request_message);<br>    <span class="hljs-keyword">auto</span> goal = std::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-type">const</span> <span class="hljs-keyword">typename</span> ActionT::Goal&gt;(request, &amp;request-&gt;goal);<br>    goal_handle.<span class="hljs-built_in">reset</span>(<br>      <span class="hljs-keyword">new</span> <span class="hljs-built_in">ServerGoalHandle</span>&lt;ActionT&gt;(<br>        rcl_goal_handle, uuid, goal, on_terminal_state, on_executing, publish_feedback));<br>    &#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(goal_handles_mutex_)</span></span>;<br>      goal_handles_[uuid] = goal_handle;<br>    &#125;<br><br>    <span class="hljs-comment">// 调用handle_accepted_，注意这里goal_handle，作为参数传递到函数中</span><br>    <span class="hljs-built_in">handle_accepted_</span>(goal_handle);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h2 id="动作服务器客户端接收到Goal回应"><a href="#动作服务器客户端接收到Goal回应" class="headerlink" title="动作服务器客户端接收到Goal回应"></a>动作服务器客户端接收到Goal回应</h2><p>由于动作服务器客户端也是Waitable，其在执行器层处理是一致的，只不过执行器调用的是动作服务器客户端的take_data()和execute()。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/src/client.cpp</span><br><span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;</span><br><span class="hljs-function"><span class="hljs-title">ClientBase::take_data</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// next_ready_event is an atomic, caching localy</span><br>  <span class="hljs-type">size_t</span> next_ready_event = pimpl_-&gt;next_ready_event.<span class="hljs-built_in">exchange</span>(ClientBaseImpl::NO_EVENT_READY);<br><br>  <span class="hljs-keyword">if</span> (next_ready_event == ClientBaseImpl::NO_EVENT_READY) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Taking data from action client but no ready event&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">take_data_by_entity_id</span>(next_ready_event);<br>&#125;<br><br><span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;</span><br><span class="hljs-function"><span class="hljs-title">ClientBase::take_data_by_entity_id</span><span class="hljs-params">(<span class="hljs-type">size_t</span> id)</span></span><br><span class="hljs-function"></span>&#123;<br>  std::shared_ptr&lt;ClientBaseData&gt; data_ptr;<br>  <span class="hljs-type">rcl_ret_t</span> ret;<br><br>  <span class="hljs-comment">// Mark as ready the entity from which we want to take data</span><br>  <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">static_cast</span>&lt;EntityType&gt;(id)) &#123;<br>    <span class="hljs-comment">// Goal响应</span><br>    <span class="hljs-keyword">case</span> EntityType::GoalClient:<br>      &#123;<br>        <span class="hljs-type">rmw_request_id_t</span> response_header;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; goal_response;<br>        &#123;<br>          <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_client_mutex_)</span></span>;<br><br>          goal_response = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_goal_response</span>();<br>          ret = <span class="hljs-built_in">rcl_action_take_goal_response</span>(<br>            pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), &amp;response_header, goal_response.<span class="hljs-built_in">get</span>());<br>        &#125;<br>        data_ptr = std::<span class="hljs-built_in">make_shared</span>&lt;ClientBaseData&gt;(<br>          ClientBaseData::<span class="hljs-built_in">GoalResponseData</span>(<br>            ret, response_header, goal_response));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> EntityType::ResultClient:<br>      &#123;<br>        <span class="hljs-type">rmw_request_id_t</span> response_header;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_response;<br>        &#123;<br>          <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_client_mutex_)</span></span>;<br>          result_response = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_result_response</span>();<br>          ret = <span class="hljs-built_in">rcl_action_take_result_response</span>(<br>            pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), &amp;response_header, result_response.<span class="hljs-built_in">get</span>());<br>        &#125;<br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ClientBaseData&gt;(<br>          ClientBaseData::<span class="hljs-built_in">ResultResponseData</span>(<br>            ret, response_header, result_response));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> EntityType::CancelClient:<br>      &#123;<br>        <span class="hljs-type">rmw_request_id_t</span> response_header;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; cancel_response;<br>        &#123;<br>          <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_client_mutex_)</span></span>;<br>          cancel_response = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_cancel_response</span>();<br>          ret = <span class="hljs-built_in">rcl_action_take_cancel_response</span>(<br>            pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), &amp;response_header, cancel_response.<span class="hljs-built_in">get</span>());<br>        &#125;<br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ClientBaseData&gt;(<br>          ClientBaseData::<span class="hljs-built_in">CancelResponseData</span>(<br>            ret, response_header, cancel_response));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> EntityType::FeedbackSubscription:<br>      &#123;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; feedback_message;<br>        &#123;<br>          <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_client_mutex_)</span></span>;<br>          feedback_message = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_feedback_message</span>();<br>          ret = <span class="hljs-built_in">rcl_action_take_feedback</span>(<br>            pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), feedback_message.<span class="hljs-built_in">get</span>());<br>        &#125;<br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ClientBaseData&gt;(<br>          ClientBaseData::<span class="hljs-built_in">FeedbackReadyData</span>(<br>            ret, feedback_message));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> EntityType::StatusSubscription:<br>      &#123;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; status_message;<br>        &#123;<br>          <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_client_mutex_)</span></span>;<br>          status_message = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">create_status_message</span>();<br>          ret = <span class="hljs-built_in">rcl_action_take_status</span>(<br>            pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), status_message.<span class="hljs-built_in">get</span>());<br>        &#125;<br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ClientBaseData&gt;(<br>          ClientBaseData::<span class="hljs-built_in">StatusReadyData</span>(<br>            ret, status_message));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(data_ptr);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ClientBase::execute</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data_in)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!data_in) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Executing action client but &#x27;data&#x27; is empty&quot;</span>);<br>  &#125;<br><br>  std::shared_ptr&lt;ClientBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ClientBaseData&gt;(data_in);<br><br>  std::<span class="hljs-built_in">visit</span>(<br>    [&amp;](<span class="hljs-keyword">auto</span> &amp;&amp; data) -&gt; <span class="hljs-type">void</span> &#123;<br>      <span class="hljs-keyword">using</span> T = std::<span class="hljs-type">decay_t</span>&lt;<span class="hljs-keyword">decltype</span>(data)&gt;;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::FeedbackReadyData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_feedback_message</span>(data.feedback_message);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking feedback&quot;</span>);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::StatusReadyData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_status_message</span>(data.status_message);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking status&quot;</span>);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::GoalResponseData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_goal_response</span>(data.response_header, data.goal_response);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking goal response&quot;</span>);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::ResultResponseData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_result_response</span>(data.response_header, data.result_response);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking result response&quot;</span>);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::CancelResponseData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_cancel_response</span>(data.response_header, data.cancel_response);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking cancel response&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;, data_ptr-&gt;data);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>整个过程类似于服务端，构建ClientBaseData，并在execute()执行handle_goal_response函数，该函数知道了Goal被服务端正确处理。此时客户端调用之前send_goal_request()注册回调函数，然后将请求从pending列表中删除：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ClientBase::handle_goal_response</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rmw_request_id_t</span> &amp; response_header,</span></span><br><span class="hljs-params"><span class="hljs-function">  std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(pimpl_-&gt;goal_requests_mutex)</span></span>;<br>  <span class="hljs-type">const</span> <span class="hljs-type">int64_t</span> &amp; sequence_number = response_header.sequence_number;<br>  <span class="hljs-keyword">if</span> (pimpl_-&gt;pending_goal_responses.<span class="hljs-built_in">count</span>(sequence_number) == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">RCLCPP_ERROR</span>(pimpl_-&gt;logger, <span class="hljs-string">&quot;unknown goal response, ignoring...&quot;</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-comment">// 这里回调send_goal_request() 注册回调函数</span><br>  pimpl_-&gt;pending_goal_responses[sequence_number](response);<br>  pimpl_-&gt;pending_goal_responses.<span class="hljs-built_in">erase</span>(sequence_number);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>我们回顾下send_goal_request()回调函数：</p>
<ul>
<li>如果Goal被拒绝了，就用nullptr调用options.goal_response_callback()</li>
<li>如果Goal被接受了，就用Goal 反馈调用options.goal_response_callback()</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">std::shared_future&lt;<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr&gt;</span><br><span class="hljs-function"><span class="hljs-title">async_send_goal</span><span class="hljs-params">(<span class="hljs-type">const</span> Goal &amp; goal, <span class="hljs-type">const</span> SendGoalOptions &amp; options = SendGoalOptions())</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// Put promise in the heap to move it around.</span><br>  <span class="hljs-keyword">auto</span> promise = std::make_shared&lt;std::promise&lt;<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr&gt;&gt;();<br>  <span class="hljs-function">std::shared_future&lt;<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr&gt; <span class="hljs-title">future</span><span class="hljs-params">(promise-&gt;get_future())</span></span>;<br>  <span class="hljs-keyword">using</span> GoalRequest = <span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Request;<br>  <span class="hljs-keyword">auto</span> goal_request = std::<span class="hljs-built_in">make_shared</span>&lt;GoalRequest&gt;();<br>  goal_request-&gt;goal_id.uuid = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">generate_goal_id</span>();<br>  goal_request-&gt;goal = goal;<br>  <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">send_goal_request</span>(<br>    std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(goal_request),<br>    [<span class="hljs-keyword">this</span>, goal_request, options, promise](std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response) <span class="hljs-keyword">mutable</span><br>    &#123;<br>      <span class="hljs-keyword">using</span> GoalResponse = <span class="hljs-keyword">typename</span> ActionT::Impl::SendGoalService::Response;<br>      <span class="hljs-keyword">auto</span> goal_response = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;GoalResponse&gt;(response);<br>      <span class="hljs-keyword">if</span> (!goal_response-&gt;accepted) &#123;<br>        promise-&gt;<span class="hljs-built_in">set_value</span>(<span class="hljs-literal">nullptr</span>);<br>        <span class="hljs-keyword">if</span> (options.goal_response_callback) &#123;<br>          options.<span class="hljs-built_in">goal_response_callback</span>(<span class="hljs-literal">nullptr</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>      GoalInfo goal_info;<br>      goal_info.goal_id.uuid = goal_request-&gt;goal_id.uuid;<br>      goal_info.stamp = goal_response-&gt;stamp;<br>      <span class="hljs-comment">// Do not use std::make_shared as friendship cannot be forwarded.</span><br>      std::shared_ptr&lt;GoalHandle&gt; <span class="hljs-built_in">goal_handle</span>(<br>        <span class="hljs-keyword">new</span> <span class="hljs-built_in">GoalHandle</span>(goal_info, options.feedback_callback, options.result_callback));<br>      &#123;<br>        std::lock_guard&lt;std::mutex&gt; <span class="hljs-built_in">guard</span>(goal_handles_mutex_);<br>        goal_handles_[goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>()] = goal_handle;<br>      &#125;<br>      promise-&gt;<span class="hljs-built_in">set_value</span>(goal_handle);<br>      <span class="hljs-keyword">if</span> (options.goal_response_callback) &#123;<br>        options.<span class="hljs-built_in">goal_response_callback</span>(goal_handle);<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (options.result_callback) &#123;<br>        <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">make_result_aware</span>(goal_handle);<br>      &#125;<br>    &#125;);<br><br>  ....<span class="hljs-comment">//其他代码逻辑</span><br><br>  <span class="hljs-keyword">return</span> future;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="动作服务器客户端发送Result请求"><a href="#动作服务器客户端发送Result请求" class="headerlink" title="动作服务器客户端发送Result请求"></a>动作服务器客户端发送Result请求</h2><p>在调用options.goal_response_callback()响应回调后，make_result_aware()会发送Result请求，并注册Result响应回调：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/client.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> : <span class="hljs-keyword">public</span> ClientBase<br>&#123;<br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">make_result_aware</span><span class="hljs-params">(<span class="hljs-keyword">typename</span> GoalHandle::SharedPtr goal_handle)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">    <span class="hljs-title">ClientBase::send_result_request</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; request, ResponseCallback callback)</span></span><br><span class="hljs-function">    </span>&#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(pimpl_-&gt;result_requests_mutex)</span></span>;<br>      <span class="hljs-type">int64_t</span> sequence_number;<br>      <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_send_result_request</span>(<br>        pimpl_-&gt;client_handle.<span class="hljs-built_in">get</span>(), request.<span class="hljs-built_in">get</span>(), &amp;sequence_number);<br>      <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>        rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret, <span class="hljs-string">&quot;failed to send result request&quot;</span>);<br>      &#125;<br>      <span class="hljs-built_in">assert</span>(pimpl_-&gt;pending_result_responses.<span class="hljs-built_in">count</span>(sequence_number) == <span class="hljs-number">0</span>);<br>      pimpl_-&gt;pending_result_responses[sequence_number] = callback;<br>    &#125;<br><br>    <span class="hljs-comment">// Avoid making more than one request</span><br>    <span class="hljs-keyword">if</span> (goal_handle-&gt;<span class="hljs-built_in">set_result_awareness</span>(<span class="hljs-literal">true</span>)) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">using</span> GoalResultRequest = <span class="hljs-keyword">typename</span> ActionT::Impl::GetResultService::Request;<br>    <span class="hljs-keyword">auto</span> goal_result_request = std::<span class="hljs-built_in">make_shared</span>&lt;GoalResultRequest&gt;();<br>    goal_result_request-&gt;goal_id.uuid = goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 异步发送Result请求</span><br>      <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">send_result_request</span>(<br>        std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(goal_result_request),<br>        [goal_handle, <span class="hljs-keyword">this</span>](std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response) <span class="hljs-keyword">mutable</span><br>        &#123;<br>          <span class="hljs-comment">// Wrap the response in a struct with the fields a user cares about</span><br>          WrappedResult wrapped_result;<br>          <span class="hljs-keyword">using</span> GoalResultResponse = <span class="hljs-keyword">typename</span> ActionT::Impl::GetResultService::Response;<br>          <span class="hljs-keyword">auto</span> result_response = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;GoalResultResponse&gt;(response);<br>          wrapped_result.result = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-keyword">typename</span> ActionT::Result&gt;();<br>          *wrapped_result.result = result_response-&gt;result;<br>          wrapped_result.goal_id = goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>();<br>          wrapped_result.code = <span class="hljs-built_in">static_cast</span>&lt;ResultCode&gt;(result_response-&gt;status);<br>          goal_handle-&gt;<span class="hljs-built_in">set_result</span>(wrapped_result);<br>          std::lock_guard&lt;std::mutex&gt; <span class="hljs-built_in">lock</span>(goal_handles_mutex_);<br>          goal_handles_.<span class="hljs-built_in">erase</span>(goal_handle-&gt;<span class="hljs-built_in">get_goal_id</span>());<br>        &#125;);<br>    &#125; <span class="hljs-built_in">catch</span> (rclcpp::exceptions::RCLError &amp; ex) &#123;<br>      <span class="hljs-comment">// This will cause an exception when the user tries to access the result</span><br>      goal_handle-&gt;<span class="hljs-built_in">invalidate</span>(exceptions::<span class="hljs-built_in">UnawareGoalHandleError</span>(ex.message));<br>    &#125;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>整个过程和Goal请求类似，这里就不在赘述了，回调函数保存在pimpl_-&gt;pending_result_responses。</p>
<h2 id="动作服务器服务端接收Result请求"><a href="#动作服务器服务端接收Result请求" class="headerlink" title="动作服务器服务端接收Result请求"></a>动作服务器服务端接收Result请求</h2><p>当动作服务器服务端接收到来自客户端请求，同样会触发execute()执行，进而调用到execute_result_request_received()：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;</span><br><span class="hljs-function"><span class="hljs-title">ServerBase::take_data_by_entity_id</span><span class="hljs-params">(<span class="hljs-type">size_t</span> id)</span></span><br><span class="hljs-function"></span>&#123;<br>    .......<span class="hljs-comment">//其他代码逻辑</span><br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr;<br>  <span class="hljs-comment">// Mark as ready the entity from which we want to take data</span><br>  <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">static_cast</span>&lt;ActionEventType&gt;(id)) &#123;<br>    .......<span class="hljs-comment">//其他代码逻辑</span><br>    <span class="hljs-keyword">case</span> ActionEventType::ResultService:<br>      &#123;<br>        <span class="hljs-type">rcl_ret_t</span> ret;<br>        <span class="hljs-comment">// Get the result request message</span><br>        <span class="hljs-type">rmw_request_id_t</span> request_header;<br>        std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_request = <span class="hljs-built_in">create_result_request</span>();<br>        <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>        ret = <span class="hljs-built_in">rcl_action_take_result_request</span>(<br>          pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;request_header, result_request.<span class="hljs-built_in">get</span>());<br><br>        data_ptr =<br>          std::<span class="hljs-built_in">make_shared</span>&lt;ServerBaseData&gt;(<br>          ServerBaseData::<span class="hljs-built_in">ResultRequestData</span>(ret, result_request, request_header));<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    .......<span class="hljs-comment">//其他代码逻辑</span><br>  &#125;<br><br>  <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">static_pointer_cast</span>&lt;<span class="hljs-type">void</span>&gt;(data_ptr);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::execute</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data_in)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!data_in) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Executing action server but &#x27;data&#x27; is empty&quot;</span>);<br>  &#125;<br><br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ServerBaseData&gt;(data_in);<br><br>  std::<span class="hljs-built_in">visit</span>(<br>    [&amp;](<span class="hljs-keyword">auto</span> &amp;&amp; data) -&gt; <span class="hljs-type">void</span> &#123;<br>      <span class="hljs-keyword">using</span> T = std::<span class="hljs-type">decay_t</span>&lt;<span class="hljs-keyword">decltype</span>(data)&gt;;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::GoalRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_goal_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::CancelRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_cancel_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::ResultRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_result_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::GoalExpiredData&gt;) &#123;<br>        <span class="hljs-built_in">execute_check_expired_goals</span>();<br>      &#125;<br>    &#125;,<br>    data_ptr-&gt;data);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>execute_result_request_received()处理请求数据，注意当对应的Goal没有找到或者结果已经存在，就直接反馈，否则需要等到结果计算出来，才能回复。这里先把request存起来，因为接下来要发送Feedback。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::execute_result_request_received</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data)</span></span><br><span class="hljs-function"></span>&#123;<br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ServerBaseData&gt;(data);<br>  <span class="hljs-function"><span class="hljs-type">const</span> ServerBaseData::ResultRequestData &amp; <span class="hljs-title">gData</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    std::get&lt;ServerBaseData::ResultRequestData&gt;(data_ptr-&gt;data))</span></span>;<br><br>  <span class="hljs-type">rcl_ret_t</span> ret = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">0</span>&gt;(gData);<br>  std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_request = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">1</span>&gt;(gData);<br>  <span class="hljs-type">rmw_request_id_t</span> request_header = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">2</span>&gt;(gData);<br><br>  <span class="hljs-keyword">if</span> (RCL_RET_ACTION_SERVER_TAKE_FAILED == ret) &#123;<br>    <span class="hljs-comment">// Ignore take failure because connext fails if it receives a sample without valid data.</span><br>    <span class="hljs-comment">// This happens when a client shuts down and connext receives a sample saying the client is</span><br>    <span class="hljs-comment">// no longer alive.</span><br>    <span class="hljs-keyword">return</span>;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br><br>  std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_response;<br><br>  <span class="hljs-comment">// 根据uuid检查Goal是否存在</span><br>  GoalUUID uuid = <span class="hljs-built_in">get_goal_id_from_result_request</span>(result_request.<span class="hljs-built_in">get</span>());<br>  <span class="hljs-type">rcl_action_goal_info_t</span> goal_info;<br>  <span class="hljs-built_in">convert</span>(uuid, &amp;goal_info);<br>  <span class="hljs-type">bool</span> goal_exists;<br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>    goal_exists = <span class="hljs-built_in">rcl_action_server_goal_exists</span>(pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;goal_info);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (!goal_exists) &#123;<br>    <span class="hljs-comment">// 如果goal不存在，则返回STATUS_UNKNOWN表示错误</span><br>    result_response = <span class="hljs-built_in">create_result_response</span>(action_msgs::msg::GoalStatus::STATUS_UNKNOWN);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 如果Goal存在，并且结果也存在（多次请求?)，也立刻返回结果</span><br>    std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-built_in">lock</span>(pimpl_-&gt;unordered_map_mutex_);<br>    <span class="hljs-keyword">auto</span> iter = pimpl_-&gt;goal_results_.<span class="hljs-built_in">find</span>(uuid);<br>    <span class="hljs-keyword">if</span> (iter != pimpl_-&gt;goal_results_.<span class="hljs-built_in">end</span>()) &#123;<br>      result_response = iter-&gt;second;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 如果Goal存在，且没有结果，等待结果计算</span><br>      pimpl_-&gt;result_requests_[uuid].<span class="hljs-built_in">push_back</span>(request_header);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 如果Goal不存在或者Result已存在，立刻发送响应返回</span><br>  <span class="hljs-keyword">if</span> (result_response) &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>    <span class="hljs-type">rcl_ret_t</span> rcl_ret = <span class="hljs-built_in">rcl_action_send_result_response</span>(<br>      pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;request_header, result_response.<span class="hljs-built_in">get</span>());<br>    <span class="hljs-keyword">if</span> (rcl_ret == RCL_RET_TIMEOUT) &#123;<br>      <span class="hljs-built_in">RCLCPP_WARN</span>(<br>        pimpl_-&gt;logger_,<br>        <span class="hljs-string">&quot;Failed to send result response %s (timeout): %s&quot;</span>,<br>        <span class="hljs-built_in">to_string</span>(uuid).<span class="hljs-built_in">c_str</span>(), <span class="hljs-built_in">rcl_get_error_string</span>().str);<br>      <span class="hljs-built_in">rcl_reset_error</span>();<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (RCL_RET_OK != rcl_ret) &#123;<br>      rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(rcl_ret);<br>    &#125;<br>  &#125;<br>  data.<span class="hljs-built_in">reset</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="动作服务器服务端计算并Feedback"><a href="#动作服务器服务端计算并Feedback" class="headerlink" title="动作服务器服务端计算并Feedback"></a>动作服务器服务端计算并Feedback</h2><p>在动作服务器正在计算时，可以通过publish_feedback()发送中间结果反馈，可以通过succeed()告知计算结果已经完成：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// 反馈中间结果</span><br>goal_handle-&gt;<span class="hljs-built_in">publish_feedback</span>(feedback);<br><br><span class="hljs-comment">// 发送最后计算结果</span><br>goal_handle-&gt;<span class="hljs-built_in">succeed</span>(result);<br></code></pre></td></tr></table></figure>

<p>其中feedback反馈是通过话题发送回客户端：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ServerGoalHandle</span> : <span class="hljs-keyword">public</span> ServerGoalHandleBase<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">/// Send an update about the progress of a goal.</span><br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">publish_feedback</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-keyword">typename</span> ActionT::Feedback&gt; feedback_msg)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">auto</span> feedback_message = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-keyword">typename</span> ActionT::Impl::FeedbackMessage&gt;();<br>    feedback_message-&gt;goal_id.uuid = uuid_;<br>    feedback_message-&gt;feedback = *feedback_msg;<br>    <span class="hljs-comment">// 这里publish_feedback_对应于ServerBase::publish_feedback</span><br>    <span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/server.hpp:call_goal_accepted_callback()</span><br>    <span class="hljs-built_in">publish_feedback_</span>(feedback_message);<br>  &#125;<br>  ......<span class="hljs-comment">//其他代码逻辑</span><br>&#125;;<br><br><span class="hljs-comment">//src/ros2/rclcpp/rclcpp_action/src/server.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::publish_feedback</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; feedback_msg)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>  <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_publish_feedback</span>(pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), feedback_msg.<span class="hljs-built_in">get</span>());<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret, <span class="hljs-string">&quot;Failed to publish feedback&quot;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// src/ros2/rcl/rcl_action/src/rcl_action/action_server.c</span><br><span class="hljs-function"><span class="hljs-type">rcl_ret_t</span></span><br><span class="hljs-function"><span class="hljs-title">rcl_action_publish_feedback</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_server_t</span> * action_server,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">void</span> * ros_feedback)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">rcl_action_server_is_valid</span>(action_server)) &#123;<br>    <span class="hljs-keyword">return</span> RCL_RET_ACTION_SERVER_INVALID;  <span class="hljs-comment">// error already set</span><br>  &#125;<br>  <span class="hljs-built_in">RCL_CHECK_ARGUMENT_FOR_NULL</span>(ros_feedback, RCL_RET_INVALID_ARGUMENT);<br>  <span class="hljs-comment">// 这里调用rcl层直接发送话题到客户端</span><br>  <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_publish</span>(&amp;action_server-&gt;impl-&gt;feedback_publisher, ros_feedback, <span class="hljs-literal">NULL</span>);<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    <span class="hljs-keyword">return</span> RCL_RET_ERROR;  <span class="hljs-comment">// error already set</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> RCL_RET_OK;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="动作服务器客户端接收Feedback"><a href="#动作服务器客户端接收Feedback" class="headerlink" title="动作服务器客户端接收Feedback"></a>动作服务器客户端接收Feedback</h2><p>在接收到Feedback的时候，处理过程类似于Goal响应过程：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/src/client.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ClientBase::execute</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data_in)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!data_in) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Executing action client but &#x27;data&#x27; is empty&quot;</span>);<br>  &#125;<br><br>  std::shared_ptr&lt;ClientBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ClientBaseData&gt;(data_in);<br><br>  std::<span class="hljs-built_in">visit</span>(<br>    [&amp;](<span class="hljs-keyword">auto</span> &amp;&amp; data) -&gt; <span class="hljs-type">void</span> &#123;<br>      <span class="hljs-keyword">using</span> T = std::<span class="hljs-type">decay_t</span>&lt;<span class="hljs-keyword">decltype</span>(data)&gt;;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::FeedbackReadyData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_feedback_message</span>(data.feedback_message);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking feedback&quot;</span>);<br>        &#125;<br>      &#125;<br>      ......<span class="hljs-comment">//其他代码逻辑</span><br>    &#125;, data_ptr-&gt;data);<br>&#125;<br><br><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/client.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> : <span class="hljs-keyword">public</span> ClientBase<br>&#123;<br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">handle_feedback_message</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; message)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(goal_handles_mutex_)</span></span>;<br>    <span class="hljs-keyword">using</span> FeedbackMessage = <span class="hljs-keyword">typename</span> ActionT::Impl::FeedbackMessage;<br>    <span class="hljs-keyword">typename</span> FeedbackMessage::SharedPtr feedback_message =<br>      std::<span class="hljs-built_in">static_pointer_cast</span>&lt;FeedbackMessage&gt;(message);<br>    <span class="hljs-type">const</span> GoalUUID &amp; goal_id = feedback_message-&gt;goal_id.uuid;<br>    <span class="hljs-keyword">if</span> (goal_handles_.<span class="hljs-built_in">count</span>(goal_id) == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">RCLCPP_DEBUG</span>(<br>        <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(),<br>        <span class="hljs-string">&quot;Received feedback for unknown goal. Ignoring...&quot;</span>);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">typename</span> GoalHandle::SharedPtr goal_handle = goal_handles_[goal_id].<span class="hljs-built_in">lock</span>();<br>    <span class="hljs-comment">// Forget about the goal if there are no more user references</span><br>    <span class="hljs-keyword">if</span> (!goal_handle) &#123;<br>      <span class="hljs-built_in">RCLCPP_DEBUG</span>(<br>        <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">get_logger</span>(),<br>        <span class="hljs-string">&quot;Dropping weak reference to goal handle during feedback callback&quot;</span>);<br>      goal_handles_.<span class="hljs-built_in">erase</span>(goal_id);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 调用用户自定义feedback回调函数</span><br>    <span class="hljs-keyword">auto</span> feedback = std::<span class="hljs-built_in">make_shared</span>&lt;Feedback&gt;();<br>    *feedback = feedback_message-&gt;feedback;<br>    goal_handle-&gt;<span class="hljs-built_in">call_feedback_callback</span>(goal_handle, feedback);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>接收到feedback，客户端会调用用户自定义feedback回调，也就是MinimalActionClient::feedback_callback()。</p>
<h2 id="动作服务器服务端发送Result回应"><a href="#动作服务器服务端发送Result回应" class="headerlink" title="动作服务器服务端发送Result回应"></a>动作服务器服务端发送Result回应</h2><p>当最终的结果计算成后，succeed()负责将结果传递给服务端，并反馈给客户端：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// </span><br><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/src/server_goal_handle.cpp</span><br><span class="hljs-type">void</span><br>ServerGoalHandleBase::_succeed()<br>&#123;<br>  <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(rcl_handle_mutex_)</span></span>;<br>  <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_update_goal_state</span>(rcl_handle_.<span class="hljs-built_in">get</span>(), GOAL_EVENT_SUCCEED);<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/server_goal_handle.hpp</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ServerGoalHandle</span> : <span class="hljs-keyword">public</span> ServerGoalHandleBase<br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">succeed</span><span class="hljs-params">(<span class="hljs-keyword">typename</span> ActionT::Result::SharedPtr result_msg)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-comment">// 更新rcl内部goal状态</span><br>    _succeed();<br>    <span class="hljs-keyword">auto</span> response = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-keyword">typename</span> ActionT::Impl::GetResultService::Response&gt;();<br>    response-&gt;status = action_msgs::msg::GoalStatus::STATUS_SUCCEEDED;<br>    response-&gt;result = *result_msg;<br><br>    <span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/include/rclcpp_action/server.hpp:call_goal_accepted_callback()</span><br>    <span class="hljs-built_in">on_terminal_state_</span>(uuid_, response);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>on_terminal_state_是在ServerGoalHandle构建的时候填充的，回调函数在call_goal_accepted_callback()定义：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> : <span class="hljs-keyword">public</span> ServerBase, <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;Server&lt;ActionT&gt;&gt;<br>&#123;<br><span class="hljs-keyword">public</span>:<br> <span class="hljs-comment">/// \internal</span><br>  <span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function">  <span class="hljs-title">call_goal_accepted_callback</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    std::shared_ptr&lt;<span class="hljs-type">rcl_action_goal_handle_t</span>&gt; rcl_goal_handle,</span></span><br><span class="hljs-params"><span class="hljs-function">    GoalUUID uuid, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; goal_request_message)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function">  </span>&#123;<br>    std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt; goal_handle;<br>    std::weak_ptr&lt;Server&lt;ActionT&gt;&gt; weak_this = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">shared_from_this</span>();<br><br>    std::function&lt;<span class="hljs-type">void</span>(<span class="hljs-type">const</span> GoalUUID &amp;, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt;)&gt; on_terminal_state =<br>      [weak_this](<span class="hljs-type">const</span> GoalUUID &amp; goal_uuid, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_message)<br>      &#123;<br>        std::shared_ptr&lt;Server&lt;ActionT&gt;&gt; shared_this = weak_this.<span class="hljs-built_in">lock</span>();<br>        <span class="hljs-keyword">if</span> (!shared_this) &#123;<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// Send result message to anyone that asked</span><br>        shared_this-&gt;<span class="hljs-built_in">publish_result</span>(goal_uuid, result_message);<br>        <span class="hljs-comment">// Publish a status message any time a goal handle changes state</span><br>        shared_this-&gt;<span class="hljs-built_in">publish_status</span>();<br>        <span class="hljs-comment">// notify base so it can recalculate the expired goal timer</span><br>        shared_this-&gt;<span class="hljs-built_in">notify_goal_terminal_state</span>();<br>        <span class="hljs-comment">// Delete data now (ServerBase and rcl_action_server_t keep data until goal handle expires)</span><br>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(shared_this-&gt;goal_handles_mutex_)</span></span>;<br>        shared_this-&gt;goal_handles_.<span class="hljs-built_in">erase</span>(goal_uuid);<br>      &#125;;<br>  ......<span class="hljs-comment">// 其他代码逻辑</span><br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>回调函数中将结果反馈给客户端，并且从goal_handles_移除当前goal，因为已经计算完毕了：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::publish_result</span><span class="hljs-params">(<span class="hljs-type">const</span> GoalUUID &amp; uuid, std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; result_msg)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// 由于要发送结果给客户端，首先检查服务端Goal是否存在</span><br>  <span class="hljs-type">rcl_action_goal_info_t</span> goal_info;<br>  <span class="hljs-built_in">convert</span>(uuid, &amp;goal_info);<br>  <span class="hljs-type">bool</span> goal_exists;<br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>    goal_exists = <span class="hljs-built_in">rcl_action_server_goal_exists</span>(pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;goal_info);<br>  &#125;<br><br>  <span class="hljs-comment">// 不存在就抛出异常（不应该发生）</span><br>  <span class="hljs-keyword">if</span> (!goal_exists) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Asked to publish result for goal that does not exist&quot;</span>);<br>  &#125;<br><br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">unordered_map_lock</span><span class="hljs-params">(pimpl_-&gt;unordered_map_mutex_)</span></span>;<br>    pimpl_-&gt;goal_results_[uuid] = result_msg;<br><br>    <span class="hljs-comment">// if there are clients who already asked for the result, send it to them</span><br>    <span class="hljs-keyword">auto</span> iter = pimpl_-&gt;result_requests_.<span class="hljs-built_in">find</span>(uuid);<br>    <span class="hljs-keyword">if</span> (iter != pimpl_-&gt;result_requests_.<span class="hljs-built_in">end</span>()) &#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> &amp; request_header : iter-&gt;second) &#123;<br><br>        <span class="hljs-comment">// 给客户端发送结果响应</span><br>        <span class="hljs-type">rcl_ret_t</span> ret = <span class="hljs-built_in">rcl_action_send_result_response</span>(<br>          pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;request_header, result_msg.<span class="hljs-built_in">get</span>());<br>        <span class="hljs-keyword">if</span> (ret == RCL_RET_TIMEOUT) &#123;<br>          <span class="hljs-built_in">RCLCPP_WARN</span>(<br>            pimpl_-&gt;logger_,<br>            <span class="hljs-string">&quot;Failed to send result response %s (timeout): %s&quot;</span>,<br>            <span class="hljs-built_in">to_string</span>(uuid).<span class="hljs-built_in">c_str</span>(), <span class="hljs-built_in">rcl_get_error_string</span>().str);<br>          <span class="hljs-built_in">rcl_reset_error</span>();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="动作服务器客户端接收到Result回应"><a href="#动作服务器客户端接收到Result回应" class="headerlink" title="动作服务器客户端接收到Result回应"></a>动作服务器客户端接收到Result回应</h2><p>类似的动作服务器Goal处理回应过程，结果回应的处理如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// src/ros2/rclcpp/rclcpp_action/src/client.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ClientBase::handle_result_response</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">rmw_request_id_t</span> &amp; response_header,</span></span><br><span class="hljs-params"><span class="hljs-function">  std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; response)</span></span><br><span class="hljs-function"></span>&#123;<br>  ResponseCallback response_callback;<br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(pimpl_-&gt;result_requests_mutex)</span></span>;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int64_t</span> &amp; sequence_number = response_header.sequence_number;<br>    <span class="hljs-keyword">if</span> (pimpl_-&gt;pending_result_responses.<span class="hljs-built_in">count</span>(sequence_number) == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">RCLCPP_ERROR</span>(pimpl_-&gt;logger, <span class="hljs-string">&quot;unknown result response, ignoring...&quot;</span>);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    response_callback = std::<span class="hljs-built_in">move</span>(pimpl_-&gt;pending_result_responses[sequence_number]);<br>    pimpl_-&gt;pending_result_responses.<span class="hljs-built_in">erase</span>(sequence_number);<br>  &#125;<br>  <span class="hljs-built_in">response_callback</span>(response);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ClientBase::execute</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data_in)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!data_in) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Executing action client but &#x27;data&#x27; is empty&quot;</span>);<br>  &#125;<br><br>  std::shared_ptr&lt;ClientBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ClientBaseData&gt;(data_in);<br><br>  std::<span class="hljs-built_in">visit</span>(<br>    [&amp;](<span class="hljs-keyword">auto</span> &amp;&amp; data) -&gt; <span class="hljs-type">void</span> &#123;<br>      <span class="hljs-keyword">using</span> T = std::<span class="hljs-type">decay_t</span>&lt;<span class="hljs-keyword">decltype</span>(data)&gt;;<br>      ......<span class="hljs-comment">//其他代码逻辑</span><br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ClientBaseData::ResultResponseData&gt;) &#123;<br>        <span class="hljs-keyword">if</span> (RCL_RET_OK == data.ret) &#123;<br>          <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handle_result_response</span>(data.response_header, data.result_response);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_ACTION_CLIENT_TAKE_FAILED != data.ret) &#123;<br>          rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(data.ret, <span class="hljs-string">&quot;error taking result response&quot;</span>);<br>        &#125;<br>      &#125;<br>      ......<span class="hljs-comment">//其他代码逻辑</span><br>    &#125;, data_ptr-&gt;data);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>客户端首先擦除了pimpl_-&gt;pending_result_responses对应结果响应，然后调用response_callback()，该函数就是客户端注册的回调MinimalActionClient::result_callback()，即用户可以针对结果的回调函数。</p>
<h2 id="动作服务器客户端发送Cancel请求"><a href="#动作服务器客户端发送Cancel请求" class="headerlink" title="动作服务器客户端发送Cancel请求"></a>动作服务器客户端发送Cancel请求</h2><p>从之前代码可以看到，除了Goal Service和Result Service，还有一个Cancel Service，由于Cancel对于服务端影响较大，所以这里我们重点关注服务端行为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::execute</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data_in)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (!data_in) &#123;<br>    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Executing action server but &#x27;data&#x27; is empty&quot;</span>);<br>  &#125;<br><br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ServerBaseData&gt;(data_in);<br><br>  std::<span class="hljs-built_in">visit</span>(<br>    [&amp;](<span class="hljs-keyword">auto</span> &amp;&amp; data) -&gt; <span class="hljs-type">void</span> &#123;<br>      <span class="hljs-keyword">using</span> T = std::<span class="hljs-type">decay_t</span>&lt;<span class="hljs-keyword">decltype</span>(data)&gt;;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::GoalRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_goal_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::CancelRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_cancel_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::ResultRequestData&gt;) &#123;<br>        <span class="hljs-built_in">execute_result_request_received</span>(data_in);<br>      &#125;<br>      <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;T, ServerBaseData::GoalExpiredData&gt;) &#123;<br>        <span class="hljs-built_in">execute_check_expired_goals</span>();<br>      &#125;<br>    &#125;,<br>    data_ptr-&gt;data);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>当接收到Cancel消息后，动作服务器客户端则执行execute_result_request_received()，尝试取消当前正在进行的goal：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">ServerBase::execute_cancel_request_received</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">void</span>&gt; &amp; data)</span></span><br><span class="hljs-function"></span>&#123;<br>  std::shared_ptr&lt;ServerBaseData&gt; data_ptr = std::<span class="hljs-built_in">static_pointer_cast</span>&lt;ServerBaseData&gt;(data);<br>  <span class="hljs-function"><span class="hljs-type">const</span> ServerBaseData::CancelRequestData &amp; <span class="hljs-title">gData</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    std::get&lt;ServerBaseData::CancelRequestData&gt;(data_ptr-&gt;data))</span></span>;<br><br>  <span class="hljs-type">rcl_ret_t</span> ret = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">0</span>&gt;(gData);<br>  std::shared_ptr&lt;action_msgs::srv::CancelGoal::Request&gt; request = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">1</span>&gt;(gData);<br>  <span class="hljs-type">rmw_request_id_t</span> request_header = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">2</span>&gt;(gData);<br><br><br>  <span class="hljs-keyword">if</span> (RCL_RET_ACTION_SERVER_TAKE_FAILED == ret) &#123;<br>    <span class="hljs-comment">// Ignore take failure because connext fails if it receives a sample without valid data.</span><br>    <span class="hljs-comment">// This happens when a client shuts down and connext receives a sample saying the client is</span><br>    <span class="hljs-comment">// no longer alive.</span><br>    <span class="hljs-keyword">return</span>;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br><br>  <span class="hljs-comment">// Convert c++ message to C message</span><br>  <span class="hljs-type">rcl_action_cancel_request_t</span> cancel_request = <span class="hljs-built_in">rcl_action_get_zero_initialized_cancel_request</span>();<br>  <span class="hljs-built_in">convert</span>(request-&gt;goal_info.goal_id.uuid, &amp;cancel_request.goal_info);<br>  cancel_request.goal_info.stamp.sec = request-&gt;goal_info.stamp.sec;<br>  cancel_request.goal_info.stamp.nanosec = request-&gt;goal_info.stamp.nanosec;<br><br>  <span class="hljs-comment">// Get a list of goal info that should be attempted to be cancelled</span><br>  <span class="hljs-type">rcl_action_cancel_response_t</span> cancel_response = <span class="hljs-built_in">rcl_action_get_zero_initialized_cancel_response</span>();<br><br>  <span class="hljs-comment">// 首先底层判断是否可以取消当前Goal，并且初始化cancel_response</span><br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>    ret = <span class="hljs-built_in">rcl_action_process_cancel_request</span>(<br>      pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(),<br>      &amp;cancel_request,<br>      &amp;cancel_response);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br>  <span class="hljs-comment">// 这段代码在退出的时候执行，销毁cancel_response</span><br>  <span class="hljs-built_in">RCPPUTILS_SCOPE_EXIT</span>(<br>  &#123;<br>    ret = <span class="hljs-built_in">rcl_action_cancel_response_fini</span>(&amp;cancel_response);<br>    <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>      <span class="hljs-built_in">RCLCPP_ERROR</span>(pimpl_-&gt;logger_, <span class="hljs-string">&quot;Failed to fini cancel response&quot;</span>);<br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-keyword">auto</span> response = std::<span class="hljs-built_in">make_shared</span>&lt;action_msgs::srv::CancelGoal::Response&gt;();<br><br>  response-&gt;return_code = cancel_response.msg.return_code;<br>  <span class="hljs-keyword">auto</span> &amp; goals = cancel_response.msg.goals_canceling;<br>  <span class="hljs-comment">// 对于每一个Goal，调用用户自定义的取消函数：MinimalActionServer::handle_cancel</span><br>  <span class="hljs-comment">// 这里有个疑问，会有多个Goal同时存在？</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; goals.size; ++i) &#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">rcl_action_goal_info_t</span> &amp; goal_info = goals.data[i];<br>    GoalUUID uuid;<br>    <span class="hljs-built_in">convert</span>(goal_info, &amp;uuid);<br>    <span class="hljs-keyword">auto</span> response_code = <span class="hljs-built_in">call_handle_cancel_callback</span>(uuid);<br>    <span class="hljs-keyword">if</span> (CancelResponse::ACCEPT == response_code) &#123;<br>      action_msgs::msg::GoalInfo cpp_info;<br>      cpp_info.goal_id.uuid = uuid;<br>      cpp_info.stamp.sec = goal_info.stamp.sec;<br>      cpp_info.stamp.nanosec = goal_info.stamp.nanosec;<br>      response-&gt;goals_canceling.<span class="hljs-built_in">push_back</span>(cpp_info);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// If the user rejects all individual requests to cancel goals,</span><br>  <span class="hljs-comment">// then we consider the top-level cancel request as rejected.</span><br>  <span class="hljs-keyword">if</span> (goals.size &gt;= <span class="hljs-number">1u</span> &amp;&amp; <span class="hljs-number">0u</span> == response-&gt;goals_canceling.<span class="hljs-built_in">size</span>()) &#123;<br>    response-&gt;return_code = action_msgs::srv::CancelGoal::Response::ERROR_REJECTED;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (!response-&gt;goals_canceling.<span class="hljs-built_in">empty</span>()) &#123;<br>    <span class="hljs-comment">// 有Goal状态改变了，这里通知变更</span><br>    <span class="hljs-built_in">publish_status</span>();<br>  &#125;<br><br>  <span class="hljs-comment">// 发送取消反馈给客户端，告知客户端取消已经完成</span><br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(pimpl_-&gt;action_server_reentrant_mutex_)</span></span>;<br>    ret = <span class="hljs-built_in">rcl_action_send_cancel_response</span>(<br>      pimpl_-&gt;action_server_.<span class="hljs-built_in">get</span>(), &amp;request_header, response.<span class="hljs-built_in">get</span>());<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (ret == RCL_RET_TIMEOUT) &#123;<br>    GoalUUID uuid = request-&gt;goal_info.goal_id.uuid;<br>    <span class="hljs-built_in">RCLCPP_WARN</span>(<br>      pimpl_-&gt;logger_,<br>      <span class="hljs-string">&quot;Failed to send cancel response %s (timeout): %s&quot;</span>,<br>      <span class="hljs-built_in">to_string</span>(uuid).<span class="hljs-built_in">c_str</span>(), <span class="hljs-built_in">rcl_get_error_string</span>().str);<br>    <span class="hljs-built_in">rcl_reset_error</span>();<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (RCL_RET_OK != ret) &#123;<br>    rclcpp::exceptions::<span class="hljs-built_in">throw_from_rcl_error</span>(ret);<br>  &#125;<br>  data.<span class="hljs-built_in">reset</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中call_handle_cancel_callback()，调用用户自定义的回调函数handle_cancel_()，即用户注册的MinimalActionServer::handle_cancel()</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ActionT&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> : <span class="hljs-keyword">public</span> ServerBase, <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;Server&lt;ActionT&gt;&gt;<br>&#123;<br><span class="hljs-comment">/// \internal</span><br>  <span class="hljs-function">CancelResponse</span><br><span class="hljs-function">  <span class="hljs-title">call_handle_cancel_callback</span><span class="hljs-params">(<span class="hljs-type">const</span> GoalUUID &amp; uuid)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function">  </span>&#123;<br>    std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt; goal_handle;<br>    &#123;<br>      <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(goal_handles_mutex_)</span></span>;<br>      <span class="hljs-keyword">auto</span> element = goal_handles_.<span class="hljs-built_in">find</span>(uuid);<br>      <span class="hljs-keyword">if</span> (element != goal_handles_.<span class="hljs-built_in">end</span>()) &#123;<br>        goal_handle = element-&gt;second.<span class="hljs-built_in">lock</span>();<br>      &#125;<br>    &#125;<br><br>    CancelResponse resp = CancelResponse::REJECT;<br>    <span class="hljs-keyword">if</span> (goal_handle) &#123;<br>      resp = <span class="hljs-built_in">handle_cancel_</span>(goal_handle);<br>      <span class="hljs-keyword">if</span> (CancelResponse::ACCEPT == resp) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          goal_handle-&gt;_cancel_goal();<br>        &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> rclcpp::exceptions::RCLError &amp; ex) &#123;<br>          <span class="hljs-built_in">RCLCPP_DEBUG</span>(<br>            rclcpp::<span class="hljs-built_in">get_logger</span>(<span class="hljs-string">&quot;rclcpp_action&quot;</span>),<br>            <span class="hljs-string">&quot;Failed to cancel goal in call_handle_cancel_callback: %s&quot;</span>, ex.<span class="hljs-built_in">what</span>());<br>          <span class="hljs-keyword">return</span> CancelResponse::REJECT;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> resp;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>至此动作服务器整体行为已经了解清楚，在细节上还有一些疑问，如Cancel如果发生在边界之类位置，会导致什么后果等，留待以后分析。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/ROS2/" class="category-chain-item">ROS2</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/ROS2/" class="print-no-link">#ROS2</a>
      
        <a href="/tags/Humble/" class="print-no-link">#Humble</a>
      
        <a href="/tags/Action/" class="print-no-link">#Action</a>
      
        <a href="/tags/ROS2-Action/" class="print-no-link">#ROS2-Action</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ROS2 Action详解</div>
      <div>https://ziqingdream.github.io/2025/04/15/-1-机器人技术栈/-1-ROS2操作系统/-1-ROS2-Humble代码阅读/【3】ROS2 Action详解/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>工程课代表[B站] / ZiQingDream[Github]</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年4月15日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="SA - 相同方式共享">
                    <i class="iconfont icon-cc-sa"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/04/14/-1-%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%80%E6%9C%AF%E6%A0%88/-1-ROS2%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/-1-ROS2-Humble%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/%E3%80%902%E3%80%91ROS2%20Service%E8%AF%A6%E8%A7%A3/" title="ROS2 Service详解">
                        <span class="hidden-mobile">ROS2 Service详解</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"LyT8mpSI2Jq9CRhOtNOgBXkE-9Nh9j0Va","appKey":"fUOlkXhD9wcmxOTed9NdlqPH","path":"window.location.pathname","placeholder":"留言仅限讨论，禁止广告等行为","avatar":"robohash","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://lyt8mpsi.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appid":"LyT8mpSI2Jq9CRhOtNOgBXkE-9Nh9j0Va","appkey":"fUOlkXhD9wcmxOTed9NdlqPH"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/custom.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
